/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
var N=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var re=Object.prototype.hasOwnProperty;var oe=(u,s)=>{for(var e in s)N(u,e,{get:s[e],enumerable:!0})},ae=(u,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of ne(s))!re.call(u,i)&&i!==e&&N(u,i,{get:()=>s[i],enumerable:!(t=ie(s,i))||t.enumerable});return u};var le=u=>ae(N({},"__esModule",{value:!0}),u);var Ce={};oe(Ce,{default:()=>O});module.exports=le(Ce);var J=require("obsidian"),g=require("fs"),v=require("path");var z=require("obsidian");var ce=/\[\[[^\]]+\]\]/,de=/\[[^\]]+\]\([^)]+\)/,y=class{evaluate(s){let e=s.split(/\r?\n/),t=!1,i=!1,n=0,r=0,a=0,o=[];for(let c of e){let d=c.trim();if(!d)continue;if(d.startsWith("```")){t=!t;continue}if(t)continue;if(/^#{1,6}\s+/u.test(d)){i=/source/iu.test(d);continue}if(i){this.hasCitation(d)&&(n+=1);continue}let h=this.normalizeClaimLine(d);if(h){if(r+=1,this.hasCitation(h)){a+=1;continue}o.length<5&&o.push(this.shortenClaim(h))}}let l=r>0?a/r:n>0?1:0;return{totalClaims:r,citedClaims:a,uncitedClaims:o,sourceCount:n,coverage:l}}normalizeClaimLine(s){return/^(confidence|level|gaps|scope|total findings|high priority)\s*:/iu.test(s)?"":/^[-*+]\s+/u.test(s)?s.replace(/^[-*+]\s+/u,"").trim():/^\d+\.\s+/u.test(s)?s.replace(/^\d+\.\s+/u,"").trim():s}hasCitation(s){return ce.test(s)||de.test(s)}shortenClaim(s){return s.length<=120?s:`${s.slice(0,117)}...`}};var k=require("obsidian"),ue=5,he=1200,C=class{constructor(s){this.app=s}resolveSnapshot(s,e){let t=this.app.workspace.getActiveFile(),i=this.parseMentionPaths(s),n=this.resolveMentionPaths(i),r=this.collectContextFiles(t,n.existing),a=this.getRecentMarkdownFiles(r.map(d=>d.path)),o=e?this.retrieveRelatedFiles(e):[],l=this.getEditorSelection(),c=this.extractFrontmatterTags(t);return{activeFilePath:(t==null?void 0:t.path)||null,activeFileTags:c,selection:l,mentionPaths:i,missingMentionPaths:n.missing,contextFiles:r,recentFiles:a,relatedFiles:o}}buildContextBlock(s){let e=["## Workspace Context"];if(s.activeFilePath?e.push(`- Active note: [[${s.activeFilePath}]]`):e.push("- Active note: (none)"),s.activeFileTags.length>0&&e.push(`- Active note tags: ${s.activeFileTags.map(t=>`#${t}`).join(", ")}`),s.selection&&(e.push("- Selected excerpt:"),e.push("```text"),e.push(s.selection),e.push("```")),s.contextFiles.length>0){e.push("- Priority context files:");for(let t of s.contextFiles)e.push(`  - [[${t.path}]] (${t.source})`)}if(s.relatedFiles.length>0){e.push("- Related notes (search results):");for(let t of s.relatedFiles)e.push(`  - [[${t.path}]]`)}if(s.recentFiles.length>0){e.push("- Recently updated notes:");for(let t of s.recentFiles)e.push(`  - [[${t}]]`)}if(s.missingMentionPaths.length>0){e.push("- Missing @ references (not found in vault):");for(let t of s.missingMentionPaths)e.push(`  - ${t}`)}return e.push("- Citation policy: use `[[path/to/note]]` for every key claim."),e.join(`
`)}retrieveRelatedFiles(s){let e=s.toLowerCase().split(/\s+/).filter(i=>i.length>2);return e.length===0?[]:this.app.vault.getMarkdownFiles().map(i=>{let n=0,r=i.basename.toLowerCase();return e.forEach(a=>{r===a?n+=10:r.includes(a)&&(n+=3)}),{file:i,score:n}}).filter(i=>i.score>0).sort((i,n)=>n.score-i.score||n.file.stat.mtime-i.file.stat.mtime).slice(0,5).map(i=>({path:i.file.path,source:"search"}))}parseMentionPaths(s){let e=[],t=/@(?:"([^"]+)"|([^\s@]+))/g,i=t.exec(s);for(;i;){let n=(i[1]||i[2]||"").trim();n.length>0&&e.push(n),i=t.exec(s)}return[...new Set(e)]}resolveMentionPaths(s){let e=[],t=[];for(let i of s){let n=i.replace(/^"+|"+$/g,""),r=this.app.vault.getAbstractFileByPath(n);r instanceof k.TFile?e.push(r.path):t.push(n)}return{existing:e,missing:t}}collectContextFiles(s,e){let t=[],i=new Set;s&&(t.push({path:s.path,source:"active"}),i.add(s.path));for(let n of e)i.has(n)||(t.push({path:n,source:"mention"}),i.add(n));return t}getRecentMarkdownFiles(s){let e=new Set(s);return this.app.vault.getMarkdownFiles().filter(t=>!e.has(t.path)).sort((t,i)=>i.stat.mtime-t.stat.mtime).slice(0,ue).map(t=>t.path)}getEditorSelection(){var t;let s=this.app.workspace.getActiveViewOfType(k.MarkdownView),e=((t=s==null?void 0:s.editor)==null?void 0:t.getSelection())||"";return this.truncateText(e.trim(),he)}extractFrontmatterTags(s){var n;if(!s)return[];let e=this.app.metadataCache.getFileCache(s),t=(n=e==null?void 0:e.frontmatter)==null?void 0:n.tags;return t?(Array.isArray(t)?t:[t]).map(r=>String(r).trim()).filter(r=>r.length>0).map(r=>r.startsWith("#")?r.slice(1):r):[]}truncateText(s,e){return s.length<=e?s:`${s.slice(0,e)}
...[truncated]`}};var _=require("obsidian"),pe=40,ge=50,me=10,b=class{constructor(s){this.app=s}gatherVaultContext(){return{folderTree:this.collectFolderTree(),tagTaxonomy:this.collectTagTaxonomy(),recentNotePaths:this.collectRecentNotePaths()}}buildPublishContextBlock(s){let e=["## Vault Metadata (for publish suggestions)"];if(s.folderTree.length>0){e.push("### Folder Structure"),e.push("Use these existing folders when suggesting an output path:");for(let t of s.folderTree)e.push(`- ${t}/`)}else e.push("### Folder Structure"),e.push("- (root only \u2014 no subdirectories)");if(s.tagTaxonomy.length>0&&(e.push("### Existing Tag Taxonomy"),e.push("Prefer reusing existing tags. Only suggest new tags when no existing tag fits:"),e.push(s.tagTaxonomy.map(t=>`#${t}`).join(", "))),s.recentNotePaths.length>0){e.push("### Recent Note Paths (naming pattern reference)");for(let t of s.recentNotePaths)e.push(`- ${t}`)}return e.join(`
`)}collectFolderTree(){let s=this.app.vault.getRoot(),e=[];return this.walkFolders(s,0,e),e.slice(0,pe)}walkFolders(s,e,t){if(!(e>2)){for(let i of s.children)if(i instanceof _.TFolder){let n=i.name;if(n.startsWith(".")||n==="node_modules")continue;t.push(i.path),this.walkFolders(i,e+1,t)}}}collectTagTaxonomy(){var t;let s=new Map,e=this.app.vault.getMarkdownFiles();for(let i of e){let n=this.app.metadataCache.getFileCache(i);if(!n)continue;let r=(t=n.frontmatter)==null?void 0:t.tags;if(r){let a=Array.isArray(r)?r:[r];for(let o of a){let l=this.normalizeTag(String(o));l&&s.set(l,(s.get(l)||0)+1)}}if(n.tags)for(let a of n.tags){let o=this.normalizeTag(a.tag);o&&s.set(o,(s.get(o)||0)+1)}}return Array.from(s.entries()).sort((i,n)=>n[1]-i[1]).slice(0,ge).map(([i])=>i)}normalizeTag(s){let e=s.trim();return e?e.startsWith("#")?e.slice(1):e:""}collectRecentNotePaths(){return this.app.vault.getMarkdownFiles().sort((s,e)=>e.stat.mtime-s.stat.mtime).slice(0,me).map(s=>s.path)}};var T=class{constructor(s){this.app=s}async runAudit(){let s=this.app.vault.getMarkdownFiles(),e=[],t={},i=new Set(s.map(o=>o.path)),n={};for(let o of s){n[o.basename]||(n[o.basename]=[]),n[o.basename].push(o),t[o.path]===void 0&&(t[o.path]=0);let l=this.app.metadataCache.getFileCache(o);if(l!=null&&l.links)for(let c of l.links){let d=this.app.metadataCache.getFirstLinkpathDest(c.link,o.path);d?t[d.path]=(t[d.path]||0)+1:e.push({type:"broken-link",file:o,detail:`Link to "${c.link}" not found`,severity:"high"})}if(l!=null&&l.embeds)for(let c of l.embeds){let d=this.app.metadataCache.getFirstLinkpathDest(c.link,o.path);d?t[d.path]=(t[d.path]||0)+1:e.push({type:"broken-link",file:o,detail:`Embed "${c.link}" not found`,severity:"high"})}}for(let o of s)!t[o.path]&&o.stat.size>0&&e.push({type:"orphan",file:o,detail:"No incoming links from other notes",severity:"low"});for(let o in n)if(n[o].length>1)for(let l of n[o])e.push({type:"duplicate-title",file:l,detail:`Title clash with ${n[o].length-1} other file(s)`,severity:"medium"});let r=365*24*60*60*1e3,a=Date.now();for(let o of s)a-o.stat.mtime>r&&e.push({type:"stale",file:o,detail:`Last modified ${new Date(o.stat.mtime).toLocaleDateString()}`,severity:"low"});return{timestamp:Date.now(),totalFiles:s.length,issues:e,summary:{brokenLinks:e.filter(o=>o.type==="broken-link").length,orphans:e.filter(o=>o.type==="orphan").length,duplicates:e.filter(o=>o.type==="duplicate-title").length,stale:e.filter(o=>o.type==="stale").length}}}formatReport(s){let e=`# Knowledge Base Health Report
`;if(e+=`**Date:** ${new Date(s.timestamp).toLocaleString()}
`,e+=`**Total Files:** ${s.totalFiles}

`,e+=`## Summary
`,e+=`- \u{1F534} Broken Links: **${s.summary.brokenLinks}**
`,e+=`- \u{1F7E0} Duplicate Titles: **${s.summary.duplicates}**
`,e+=`- \u{1F7E1} Orphan Notes: **${s.summary.orphans}**
`,e+=`- \u26AA Stale Notes (>1yr): **${s.summary.stale}**

`,s.issues.length===0)return e+=`\u{1F389} **Excellent! No issues found.**
`,e;e+=`## Issues Detail
`;let t=s.issues.filter(r=>r.type==="broken-link");if(t.length>0){e+=`### \u{1F534} Broken Links (${t.length})
`,e+=`> Links pointing to non-existent files.

`;for(let r of t.slice(0,50))e+=`- [[${r.file.path}]] : ${r.detail}
`;t.length>50&&(e+=`- ... and ${t.length-50} more
`),e+=`
`}let i=s.issues.filter(r=>r.type==="duplicate-title");if(i.length>0){e+=`### \u{1F7E0} Duplicate Titles (${i.length})
`,e+=`> Files with same basename but different folders.

`;for(let r of i.slice(0,20))e+=`- [[${r.file.path}]]
`;i.length>20&&(e+=`- ... and ${i.length-20} more
`),e+=`
`}let n=s.issues.filter(r=>r.type==="orphan");if(n.length>0){e+=`### \u{1F7E1} Orphan Notes (${n.length})
`,e+=`> Notes not linked from anywhere else.

`;for(let r of n.slice(0,20))e+=`- [[${r.file.path}]]
`;n.length>20&&(e+=`- ... and ${n.length-20} more
`),e+=`
`}return e}};var j={discover:{label:"Discovery",goal:"Clarify scope, audience, constraints, and missing evidence before writing.",outputContract:["## Task Brief","- Objective:","- Audience:","- Key questions:","","## Information Gaps","- Gap:","- Why it matters:","- Suggested retrieval action:","","## Execution Plan","1. ...","2. ..."].join(`
`)},outline:{label:"Outline",goal:"Build a structured outline tied to evidence and intended reader flow.",outputContract:["## Proposed Title","- ...","","## Outline","1. Section","   - Key point","   - Evidence link: [[path/to/note]]","","## Source Map","- Claim -> [[path/to/note]]"].join(`
`)},draft:{label:"Draft",goal:"Write a complete draft grounded in available notes and explicit citations.",outputContract:["## Draft","<full article or document>","","## Sources","- [[path/to/note-a]]","- [[path/to/note-b]]","","## Citation Coverage","- Claims without direct evidence: <count and list>"].join(`
`)},evidence:{label:"Evidence Review",goal:"Audit each key claim for source coverage and confidence level.",outputContract:["## Claim Audit","- Claim:","  - Source:","  - Confidence: high | medium | low","  - Gap:","","## Risky Claims","- ...","","## Remediation Actions","1. ...","2. ..."].join(`
`)},polish:{label:"Polish",goal:"Improve readability, coherence, and style while preserving factual grounding.",outputContract:["## Polished Version","<improved content>","","## Major Edits","- Edit:","- Reason:","","## Source Integrity Check","- Any citation removed/changed and why"].join(`
`)},publish:{label:"Publish",goal:"Package final output for vault publishing with complete YAML frontmatter, metadata, and action checklist. Use the vault metadata section (if present) to suggest tags from existing taxonomy and a file path matching the vault folder structure.",outputContract:["## Final Title","- ...","","## YAML Frontmatter","```yaml","---","title: <final title>","date: <YYYY-MM-DD>","tags:","  - <prefer existing tags from vault taxonomy>","  - <only add new tags when no existing tag fits>","summary: <1-2 sentence summary>","author: <author or leave blank>","---","```","","## Final Content","<ready-to-publish markdown content>","","## Metadata","- Tags: <list, preferring existing vault tags>","- Summary: <1-2 sentences>","- Suggested file path: <match vault folder structure>","","## Publish Checklist","- [ ] Citation validation","- [ ] Link validation","- [ ] Style review","- [ ] Frontmatter completeness"].join(`
`)}},x=class{constructor(){this.tasksBySession=new Map}hydrateTask(s,e){var n;if(!e){this.tasksBySession.delete(s);return}let t=(e.draftVersions||[]).map(r=>({...r,createdAt:new Date(r.createdAt)})),i=(e.stageHistory||[]).map(r=>({...r,timestamp:new Date(r.timestamp)}));this.tasksBySession.set(s,{...e,draftVersions:t,stageHistory:i,currentDraftVersionId:e.currentDraftVersionId||((n=t[t.length-1])==null?void 0:n.id)||null,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)})}createTask(s,e){let t=new Date,i=e.trim(),n={id:`task-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,title:this.toTaskTitle(i),objective:i,audience:"General knowledge workers",tone:"Clear, concise, evidence-driven",targetLength:"1200-1800 words",stage:"discover",status:"active",draftVersions:[],currentDraftVersionId:null,stageHistory:[],createdAt:t,updatedAt:t};return this.tasksBySession.set(s,n),n}ensureTask(s,e){let t=this.tasksBySession.get(s);return t||this.createTask(s,e)}getTask(s){return this.tasksBySession.get(s)||null}getCurrentDraftVersion(s){let e=this.tasksBySession.get(s);return!e||!e.currentDraftVersionId?null:e.draftVersions.find(t=>t.id===e.currentDraftVersionId)||null}updateStage(s,e){let t=this.tasksBySession.get(s);if(!t)return null;let i=t.stage;return i!==e&&t.stageHistory.push({from:i,to:e,timestamp:new Date}),t.stage=e,t.updatedAt=new Date,t}addDraftVersion(s,e,t,i){let n=this.tasksBySession.get(s);if(!n)return null;let r=t.trim();if(!r)return null;let a=this.getCurrentDraftVersion(s);if(a&&a.content.trim()===r)return{task:n,version:a,created:!1};let o=new Date,l=n.draftVersions.length+1,c={id:`draft-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,stage:e,label:`${this.stageLabel(e)} v${l}`,content:r,createdAt:o,citationCoverage:i==null?void 0:i.citationCoverage,sourceCount:i==null?void 0:i.sourceCount};return n.draftVersions.push(c),n.currentDraftVersionId=c.id,n.updatedAt=o,{task:n,version:c,created:!0}}rollbackToDraftVersion(s,e){let t=this.tasksBySession.get(s);if(!t)return null;let i=t.draftVersions.find(r=>r.id===e);if(!i)return null;let n=t.stage;return t.currentDraftVersionId=i.id,t.stage=i.stage,t.status="active",t.updatedAt=new Date,n!==i.stage&&t.stageHistory.push({from:n,to:i.stage,timestamp:new Date}),{task:t,version:i}}buildStagePrompt(s,e,t,i,n,r){let a=j[s],o=e.trim()||"(no additional request)",l=this.getTaskBaseline(i),c=["You are a writing and knowledge-base management agent for an Obsidian vault.","Work in a rigorous, source-grounded way. Do not invent facts.","","## Core Constraints","1. Every key claim must have a source link in `[[path/to/note]]` form.","2. If evidence is missing, explicitly mark as `[MISSING-EVIDENCE]`.","3. Keep conclusions traceable, concise, and actionable.","","## Current Writing Task",`- Task ID: ${i.id}`,`- Title: ${i.title}`,`- Objective: ${i.objective}`,`- Audience: ${i.audience}`,`- Tone: ${i.tone}`,`- Target Length: ${i.targetLength}`,`- Current Stage: ${a.label}`,"","## Stage Goal",`- ${a.goal}`,"","## User Request",o,"",n,"","## Output Contract",a.outputContract,"","## Missing Evidence Policy","- If evidence is insufficient, provide the safest partial answer and list what to retrieve next.",`- Mention unresolved @ references if any: ${t.missingMentionPaths.join(", ")||"(none)"}`];return l&&(c.push(""),c.push("## Current Draft Baseline"),c.push(`- Active version: ${l.label}`),c.push("```markdown"),c.push(this.trimBaselineContent(l.content)),c.push("```")),r&&(c.push(""),c.push(r)),c.join(`
`)}buildEvidencePrompt(s,e){return["Use the `evidence-qa` behavior with strict citations.",'If the provided context is insufficient, explicitly state "Low Confidence" and explain why.',"Do not hallucinate sources or facts not present in the context.","","## User Question",s.trim()||"Please run a full evidence audit for the current draft.","",e,"","## Required Output","```markdown","## Conclusion","- ...","","## Evidence","- Claim:","  - Evidence:","  - Why it supports:","","## Sources","- [[path/to/note]]","","## Confidence","- Level: high | medium | low","- Gaps:","```"].join(`
`)}buildKbAuditPrompt(s,e,t,i){let n=e.trim()||"(no additional constraints)",r=["Use the `kb-health-audit` behavior and return concise actionable findings.","","## Audit Scope",`- ${s}`,"","## User Constraints",n,"",t];return i&&(r.push(""),r.push("## Automated Audit Report (System Generated)"),r.push("The following report was generated by scanning the vault metadata. Use this as your primary source of truth."),r.push(i),r.push(""),r.push("## Task"),r.push("Analyze the above report and provide a prioritized action plan. Do not halllucinate new issues.")),r.push(""),r.push("## Required Output"),r.push("```markdown"),r.push("## Summary"),r.push("- Scope:"),r.push("- Total findings:"),r.push("- High priority:"),r.push(""),r.push("## Findings"),r.push("### Broken Links"),r.push("- ..."),r.push("### Orphan Notes"),r.push("- ..."),r.push("### Potential Duplicates"),r.push("- ..."),r.push("### Stale Notes"),r.push("- ..."),r.push(""),r.push("## Priority Actions"),r.push("1. [high] ..."),r.push("2. [medium] ..."),r.push("3. [low] ..."),r.push("```"),r.join(`
`)}buildWorkflowHelp(){return["## Writing + KB Workflow Commands","- `/write start <topic>`: create/reset a writing task and run discovery.","- `/write outline [extra requirements]`: generate evidence-aware outline.","- `/write draft [extra requirements]`: generate full draft with sources.","- `/write evidence [question]`: run evidence QA for current draft/question.","- `/write polish [style hints]`: improve writing quality while preserving claims.","- `/write publish [release notes]`: package publish-ready version and checklist.","- `/kb audit [full|broken|orphan|duplicate|stale] [constraints]`: run knowledge health audit.","- `/qa <question>`: ask an evidence-backed QA question.","","Use `@file` mentions to pin specific notes into the context bundle."].join(`
`)}toTaskTitle(s){return s?s.length<=48?s:`${s.slice(0,45)}...`:"Untitled Writing Task"}stageLabel(s){return j[s].label}getTaskBaseline(s){return s.currentDraftVersionId&&s.draftVersions.find(e=>e.id===s.currentDraftVersionId)||null}trimBaselineContent(s){return s.length<=6e3?s:`${s.slice(0,6e3)}
...[baseline truncated]`}};var M=class{constructor(s,e,t,i){this.app=e;this.stopButtonEl=null;this.commandHistory=[];this.historyIndex=-1;this.tempInput="";this.mentionCandidates=[];this.mentionSelectedIndex=0;this.mentionStartIndex=-1;this.mentionEndIndex=-1;this.maxMentionResults=8;this.containerEl=s,this.onSubmit=t,this.onStop=i,this.render()}render(){let s=this.containerEl.createEl("div",{cls:"claude-chat-input-container"});this.inputWrapperEl=s.createEl("div",{cls:"claude-chat-input-wrapper"}),this.inputEl=this.inputWrapperEl.createEl("textarea",{cls:"claude-chat-input",attr:{placeholder:"Ask OpenCode, or use /write /kb /qa workflows... (type @ to reference files)",rows:"1"}}),this.inputEl.addEventListener("input",()=>{this.autoResize(),this.updateMentionSuggestions()}),this.inputEl.addEventListener("click",()=>{this.updateMentionSuggestions()}),this.inputEl.addEventListener("keyup",e=>{(e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Home"||e.key==="End")&&this.updateMentionSuggestions()}),this.inputEl.addEventListener("blur",()=>{window.setTimeout(()=>{document.activeElement!==this.inputEl&&this.closeMentionMenu()},100)}),this.sendButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-send-button"}),this.sendButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            <span>Send</span>
        `,this.sendButtonEl.addEventListener("click",()=>{this.handleSubmit()}),this.inputEl.addEventListener("keydown",e=>{this.handleMentionKeydown(e)||(e.key==="Enter"&&!e.shiftKey&&!e.isComposing?(e.preventDefault(),this.handleSubmit()):e.key==="ArrowUp"?(e.preventDefault(),this.navigateHistory(-1)):e.key==="ArrowDown"&&(e.preventDefault(),this.navigateHistory(1)))}),this.mentionMenuEl=s.createEl("div",{cls:"claude-chat-mention-menu"}),this.mentionMenuEl.style.display="none",s.addEventListener("click",e=>{(e.target===s||e.target===this.inputWrapperEl)&&this.inputEl.focus()})}createStopButton(){this.stopButtonEl||(this.stopButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-stop-button"}),this.stopButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            <span>Stop</span>
        `,this.stopButtonEl.addEventListener("click",()=>{this.onStop()}))}removeStopButton(){this.stopButtonEl&&(this.stopButtonEl.remove(),this.stopButtonEl=null)}async handleSubmit(){let s=this.inputEl.value.trim();s&&!this.sendButtonEl.disabled&&(this.commandHistory[this.commandHistory.length-1]!==s&&(this.commandHistory.push(s),this.commandHistory.length>100&&this.commandHistory.shift()),this.inputEl.value="",this.autoResize(),this.historyIndex=-1,this.tempInput="",this.closeMentionMenu(),await this.onSubmit(s))}navigateHistory(s){if(this.commandHistory.length===0)return;if(this.historyIndex===-1&&(this.tempInput=this.inputEl.value),this.historyIndex+=s,this.historyIndex<0)this.historyIndex=0;else if(this.historyIndex>=this.commandHistory.length){this.historyIndex=-1,this.setValue(this.tempInput);return}let e=this.commandHistory[this.commandHistory.length-1-this.historyIndex];this.setValue(e),this.inputEl.setSelectionRange(0,e.length)}autoResize(){this.inputEl.style.height="auto";let s=Math.min(Math.max(this.inputEl.scrollHeight,44),140);this.inputEl.style.height=`${s}px`}focus(){this.inputEl.focus()}setDisabled(s){this.inputEl.disabled=s,this.sendButtonEl.disabled=s,s&&this.closeMentionMenu()}setProcessing(s){s?(this.sendButtonEl.classList.add("claude-hidden"),this.createStopButton(),this.inputEl.disabled=!0,this.closeMentionMenu()):(this.sendButtonEl.classList.remove("claude-hidden"),this.removeStopButton(),this.inputEl.disabled=!1)}getValue(){return this.inputEl.value}setValue(s){this.inputEl.value=s,this.autoResize(),this.updateMentionSuggestions()}handleMentionKeydown(s){return this.isMentionMenuOpen()?s.key==="ArrowDown"?(s.preventDefault(),this.moveMentionSelection(1),!0):s.key==="ArrowUp"?(s.preventDefault(),this.moveMentionSelection(-1),!0):s.key==="Enter"||s.key==="Tab"?(s.preventDefault(),this.selectMention(this.mentionSelectedIndex),!0):s.key==="Escape"?(s.preventDefault(),this.closeMentionMenu(),!0):!1:!1}updateMentionSuggestions(){let s=this.getMentionContext();if(!s){this.closeMentionMenu();return}let e=this.getMentionCandidates(s.query);if(e.length===0){this.closeMentionMenu();return}this.mentionStartIndex=s.start,this.mentionEndIndex=s.end,this.mentionCandidates=e,this.mentionSelectedIndex=0,this.renderMentionMenu()}getMentionContext(){var r;if(this.inputEl.selectionStart!==this.inputEl.selectionEnd)return null;let s=(r=this.inputEl.selectionStart)!=null?r:this.inputEl.value.length,t=this.inputEl.value.slice(0,s).match(/(^|\s)@([^\s@]*)$/);if(!t)return null;let i=t[2]||"",n=s-i.length-1;return n<0?null:{start:n,end:s,query:i}}getMentionCandidates(s){let e=s.replace(/^"+/,"").replace(/"/g,"").toLowerCase(),t=this.app.vault.getFiles();return e.length===0?t.slice().sort((n,r)=>r.stat.mtime-n.stat.mtime).slice(0,this.maxMentionResults).map(n=>n.path):t.map(n=>{let r=n.path,a=r.toLowerCase(),o=n.basename.toLowerCase(),l=-1;return o===e?l=0:o.startsWith(e)?l=1:a.startsWith(e)?l=2:o.includes(e)?l=3:a.includes(e)&&(l=4),{path:r,score:l}}).filter(n=>n.score>=0).sort((n,r)=>n.score!==r.score?n.score-r.score:n.path.length!==r.path.length?n.path.length-r.path.length:n.path.localeCompare(r.path)).slice(0,this.maxMentionResults).map(n=>n.path)}renderMentionMenu(){this.mentionMenuEl.empty(),this.mentionCandidates.forEach((s,e)=>{var r;let t=(s||"").trim()||"(unknown file)",i=((r=t.split("/").pop())==null?void 0:r.trim())||t,n=this.mentionMenuEl.createEl("div",{cls:"claude-chat-mention-item"});n.setAttribute("role","option"),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label",t),n.setAttribute("title",t),n.setAttribute("data-name",i),n.setAttribute("data-path",t),e===this.mentionSelectedIndex&&n.addClass("is-selected"),n.addEventListener("mouseenter",()=>{this.mentionSelectedIndex=e,this.updateMentionSelectionClasses()}),n.addEventListener("mousedown",a=>{a.preventDefault(),this.selectMention(e)})}),this.mentionMenuEl.style.display="block"}updateMentionSelectionClasses(){let s=this.mentionMenuEl.querySelectorAll(".claude-chat-mention-item");s.forEach((t,i)=>{t.classList.toggle("is-selected",i===this.mentionSelectedIndex)});let e=s[this.mentionSelectedIndex];e==null||e.scrollIntoView({block:"nearest"})}moveMentionSelection(s){if(this.mentionCandidates.length===0)return;let e=this.mentionCandidates.length;this.mentionSelectedIndex=(this.mentionSelectedIndex+s+e)%e,this.updateMentionSelectionClasses()}selectMention(s){let e=this.mentionCandidates[s];if(!e||this.mentionStartIndex<0||this.mentionEndIndex<0)return;let t=this.inputEl.value.slice(0,this.mentionStartIndex),i=this.inputEl.value.slice(this.mentionEndIndex),n=this.formatMentionText(e),r=i.length>0&&!/^\s/.test(i)?" ":"",a=`${t}${n}${r}${i}`,o=t.length+n.length+r.length;this.inputEl.value=a,this.autoResize(),this.inputEl.focus(),this.inputEl.setSelectionRange(o,o),this.closeMentionMenu()}formatMentionText(s){return/\s/.test(s)?`@"${s}"`:`@${s}`}closeMentionMenu(){this.mentionCandidates=[],this.mentionSelectedIndex=0,this.mentionStartIndex=-1,this.mentionEndIndex=-1,this.mentionMenuEl.empty(),this.mentionMenuEl.style.display="none"}isMentionMenuOpen(){return this.mentionMenuEl.style.display!=="none"&&this.mentionCandidates.length>0}};var m=require("obsidian");var L=class{constructor(s,e){this.timerInterval=null;this.isCollapsed=!0;this.part=e,this.containerEl=s.createEl("div",{cls:"claude-tool-call"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-tool-call-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.statusIconEl=this.headerEl.createEl("span",{cls:"claude-tool-call-icon"}),this.nameEl=this.headerEl.createEl("span",{cls:"claude-tool-call-name"}),this.titleEl=this.headerEl.createEl("span",{cls:"claude-tool-call-title"}),this.timerEl=this.headerEl.createEl("span",{cls:"claude-tool-call-timer"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-tool-call-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-tool-call-body"}),this.bodyEl.style.display="none";let t=this.bodyEl.createEl("div",{cls:"claude-tool-call-input"});t.createEl("div",{cls:"claude-tool-call-section-label",text:"Input"}),this.inputEl=t.createEl("pre",{cls:"claude-tool-call-code"});let i=this.bodyEl.createEl("div",{cls:"claude-tool-call-output"});i.createEl("div",{cls:"claude-tool-call-section-label",text:"Output"}),this.outputEl=i.createEl("pre",{cls:"claude-tool-call-code"}),i.style.display="none",this.update(e)}update(s){let e=this.part.state.status;this.part=s;let t=s.state;this.containerEl.classList.remove("claude-tool-call-pending","claude-tool-call-running","claude-tool-call-completed","claude-tool-call-error"),this.containerEl.classList.add(`claude-tool-call-${t.status}`),this.nameEl.setText(s.tool);let i="\u23F3",n="";t.status==="pending"?i="\u23F3":t.status==="running"?(i="\u2699\uFE0F",n=t.title||""):t.status==="completed"?(i="\u2705",n=t.title||"Completed"):t.status==="error"&&(i="\u274C",n="Error"),this.statusIconEl.setText(i),this.titleEl.setText(n),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC"),this.inputEl.setText(JSON.stringify(t.input,null,2));let r=this.outputEl.parentElement;t.status==="completed"?(r&&(r.style.display="block"),this.outputEl.setText(t.output||"")):t.status==="error"?(r&&(r.style.display="block"),this.outputEl.setText(t.error||"")):r&&(r.style.display="none"),this.handleTimer(t)}handleTimer(s){if(s.status==="running")this.timerInterval||(this.timerInterval=setInterval(()=>{let e=(Date.now()-s.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)},100));else if(s.status==="completed"||s.status==="error"){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null);let e=(s.time.end-s.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)}else this.timerEl.setText(""),this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.containerEl.remove()}};var I=class{constructor(s,e,t){this.request=e;this.onReply=t;this.buttons=[];this.resolved=!1;this.containerEl=s.createEl("div",{cls:"claude-permission-dialog"});let i=this.containerEl.createEl("div",{cls:"claude-permission-header"});i.createEl("span",{cls:"claude-permission-icon",text:"\u{1F510}"}),i.createEl("span",{cls:"claude-permission-title",text:"Permission Required"});let n=this.containerEl.createEl("div",{cls:"claude-permission-body"});n.createEl("div",{cls:"claude-permission-type",text:`${this.request.permission}: ${this.request.patterns.join(", ")}`});let r=n.createEl("div",{cls:"claude-permission-metadata"});for(let[o,l]of Object.entries(this.request.metadata)){let c=r.createEl("div",{cls:"claude-permission-meta-item"});c.createEl("strong",{text:`${o}: `});let d;typeof l=="object"&&l!==null?d=JSON.stringify(l):d=String(l),c.createEl("span",{text:d})}let a=this.containerEl.createEl("div",{cls:"claude-permission-actions"});this.createButton(a,"Allow Once","claude-permission-btn-allow",()=>{this.handleReply("once","Allowed \u2713")}),this.createButton(a,"Allow Always","claude-permission-btn-always",()=>{this.handleReply("always","Allowed Always \u2713")}),this.createButton(a,"Reject","claude-permission-btn-reject",()=>{this.handleReply("reject","Rejected \u2717")})}createButton(s,e,t,i){let n=s.createEl("button",{cls:`claude-permission-btn ${t}`,text:e});n.addEventListener("click",i),this.buttons.push(n)}handleReply(s,e){this.resolved||(this.resolve(),this.onReply(s))}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-permission-resolved"),this.buttons.forEach(s=>{s.disabled=!0})}destroy(){this.containerEl.remove()}};var D=class{constructor(s,e,t,i){this.request=e;this.onReply=t;this.onReject=i;this.resolved=!1;this.inputs=[];this.customInputs=[];this.containerEl=s.createEl("div",{cls:"claude-question-dialog"});let n=this.containerEl.createEl("div",{cls:"claude-question-header"});n.createEl("span",{cls:"claude-question-icon",text:"\u2753"}),n.createEl("span",{cls:"claude-question-title",text:"Question"}),this.request.questions.forEach((l,c)=>{this.renderQuestion(l,c)});let r=this.containerEl.createEl("div",{cls:"claude-question-actions"});r.createEl("button",{cls:"claude-question-btn claude-question-btn-submit",text:"Submit"}).addEventListener("click",()=>this.handleSubmit()),r.createEl("button",{cls:"claude-question-btn claude-question-btn-reject",text:"Skip"}).addEventListener("click",()=>{this.resolved||(this.resolve(),this.onReject())})}renderQuestion(s,e){let t=this.containerEl.createEl("div",{cls:"claude-question-item"});t.createEl("div",{cls:"claude-question-text",text:`${s.header}: ${s.question}`});let i=t.createEl("div",{cls:"claude-question-options"});if(s.options.forEach(n=>{let r=i.createEl("label",{cls:"claude-question-option"}),a=r.createEl("input",{type:s.multiple?"checkbox":"radio",attr:{name:`q-${this.request.id}-${e}`,value:n.label}});this.inputs.push(a),r.createEl("span",{cls:"claude-question-option-label",text:n.label}),n.description&&r.createEl("span",{cls:"claude-question-option-desc",text:n.description})}),s.custom){let r=t.createEl("div",{cls:"claude-question-custom"}).createEl("input",{type:"text",cls:"claude-question-custom-input",attr:{placeholder:"Type your answer...","data-q-index":String(e)}});this.customInputs.push(r)}}handleSubmit(){if(this.resolved)return;let s=[];for(let e=0;e<this.request.questions.length;e++){let t=[];this.inputs.filter(r=>r.name===`q-${this.request.id}-${e}`&&r.checked).forEach(r=>t.push(r.value));let n=this.customInputs.find(r=>r.getAttribute("data-q-index")===String(e));n&&n.value.trim()&&t.push(n.value.trim()),s.push(t)}this.resolve(),this.onReply(s)}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-question-resolved"),this.inputs.forEach(e=>e.disabled=!0),this.customInputs.forEach(e=>e.disabled=!0),this.containerEl.querySelectorAll("button").forEach(e=>e.disabled=!0)}destroy(){this.containerEl.remove()}};var A=class{constructor(s,e){this.isCollapsed=!0;this.containerEl=s.createEl("div",{cls:"claude-file-diff"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-file-diff-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.iconEl=this.headerEl.createEl("span",{cls:"claude-file-diff-icon",text:"\u0394"}),this.pathEl=this.headerEl.createEl("span",{cls:"claude-file-diff-path"}),this.statsEl=this.headerEl.createEl("span",{cls:"claude-file-diff-stats"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-file-diff-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-file-diff-body"}),this.bodyEl.style.display="none";let t=this.bodyEl.createEl("div",{cls:"claude-file-diff-table-header"});t.createEl("span",{cls:"claude-file-diff-table-title",text:"Before"}),t.createEl("span",{cls:"claude-file-diff-table-title",text:"After"}),this.tableEl=this.bodyEl.createEl("div",{cls:"claude-file-diff-table"}),this.update(e)}update(s){this.pathEl.setText(s.file),this.renderStats(s),this.renderRows(s),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.containerEl.remove()}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}renderStats(s){this.statsEl.empty(),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-additions",text:`+${s.additions}`}),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-deletions",text:`-${s.deletions}`})}renderRows(s){this.tableEl.empty();let e=this.buildDisplayRows(s.before,s.after),t=e.slice(0,800);for(let i of t)this.renderRow(i);if(e.length>800){let i=e.length-800;this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:`... omitted ${i} additional rows ...`})}e.length===0&&this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:"No textual changes."})}renderRow(s){var t;let e=this.tableEl.createEl("div",{cls:`claude-file-diff-row claude-file-diff-row-${s.type}`});if(s.type==="context"){e.createEl("div",{cls:"claude-file-diff-context",text:`... ${(t=s.hiddenCount)!=null?t:0} unchanged lines ...`});return}e.createEl("span",{cls:"claude-file-diff-line-number",text:s.beforeLineNumber!==null?String(s.beforeLineNumber):""}),e.createEl("span",{cls:"claude-file-diff-line-content",text:s.beforeText}),e.createEl("span",{cls:"claude-file-diff-line-number",text:s.afterLineNumber!==null?String(s.afterLineNumber):""}),e.createEl("span",{cls:"claude-file-diff-line-content",text:s.afterText})}buildDisplayRows(s,e){let t=this.toLines(s),i=this.toLines(e),n=this.alignLines(t,i);return this.collapseUnchanged(n)}toLines(s){if(!s)return[];let t=s.replace(/\r\n/g,`
`).split(`
`);return t.length>0&&t[t.length-1]===""&&t.pop(),t}alignLines(s,e){let i=s.length*e.length<=25e4?this.computeLcsOperations(s,e):this.computeHeuristicOperations(s,e);return this.operationsToRows(i)}computeLcsOperations(s,e){let t=s.length,i=e.length,n=i+1,r=new Uint32Array((t+1)*(i+1));for(let c=1;c<=t;c+=1)for(let d=1;d<=i;d+=1){let h=c*n+d;if(s[c-1]===e[d-1]){r[h]=r[(c-1)*n+(d-1)]+1;continue}let f=r[(c-1)*n+d],S=r[c*n+(d-1)];r[h]=f>=S?f:S}let a=[],o=t,l=i;for(;o>0&&l>0;){let c=s[o-1],d=e[l-1];if(c===d){a.push({type:"unchanged",text:c}),o-=1,l-=1;continue}let h=r[(o-1)*n+l];r[o*n+(l-1)]>h?(a.push({type:"added",text:d}),l-=1):(a.push({type:"removed",text:c}),o-=1)}for(;o>0;)a.push({type:"removed",text:s[o-1]}),o-=1;for(;l>0;)a.push({type:"added",text:e[l-1]}),l-=1;return a.reverse(),a}computeHeuristicOperations(s,e){let t=[],i=0,n=0;for(;i<s.length&&n<e.length;){let r=s[i],a=e[n];if(r===a){t.push({type:"unchanged",text:r}),i+=1,n+=1;continue}if(i+1<s.length&&s[i+1]===a){t.push({type:"removed",text:r}),i+=1;continue}if(n+1<e.length&&r===e[n+1]){t.push({type:"added",text:a}),n+=1;continue}t.push({type:"removed",text:r}),t.push({type:"added",text:a}),i+=1,n+=1}for(;i<s.length;)t.push({type:"removed",text:s[i]}),i+=1;for(;n<e.length;)t.push({type:"added",text:e[n]}),n+=1;return t}operationsToRows(s){let e=[],t=1,i=1,n=[],r=[],a=()=>{if(n.length===0&&r.length===0)return;let o=Math.min(n.length,r.length);for(let l=0;l<o;l+=1)e.push({type:"modified",beforeLineNumber:t,afterLineNumber:i,beforeText:n[l],afterText:r[l]}),t+=1,i+=1;for(let l=o;l<n.length;l+=1)e.push({type:"removed",beforeLineNumber:t,afterLineNumber:null,beforeText:n[l],afterText:""}),t+=1;for(let l=o;l<r.length;l+=1)e.push({type:"added",beforeLineNumber:null,afterLineNumber:i,beforeText:"",afterText:r[l]}),i+=1;n=[],r=[]};for(let o of s){if(o.type==="unchanged"){a(),e.push({type:"unchanged",beforeLineNumber:t,afterLineNumber:i,beforeText:o.text,afterText:o.text}),t+=1,i+=1;continue}o.type==="removed"?n.push(o.text):r.push(o.text)}return a(),e}collapseUnchanged(s){let e=[],t=-1,i=n=>{if(t<0)return;let r=s.slice(t,n);if(r.length<8)e.push(...r);else{e.push(...r.slice(0,3));let a=r.length-3*2;a>0&&e.push({type:"context",beforeLineNumber:null,afterLineNumber:null,beforeText:"",afterText:"",hiddenCount:a}),e.push(...r.slice(-3))}t=-1};return s.forEach((n,r)=>{if(n.type==="unchanged"){t<0&&(t=r);return}i(r),e.push(n)}),i(s.length),e}};var R=class{constructor(s,e){this.app=e;this.currentMessageTextEl=null;this.currentMessageBuffer="";this.currentCursorEl=null;this.currentMessageEl=null;this.currentActivitiesEl=null;this.scrollLocked=!1;this.scrollBottomButton=null;this.messages=[];this.messageElements=new Map;this.toolCallViews=new Map;this.fileDiffViews=new Map;this.activeDiffHostEl=null;this.permissionDialogs=new Map;this.questionDialogs=new Map;this.containerEl=s,this.messagesEl=this.containerEl.createEl("div",{cls:"claude-chat-messages"}),this.setupLinkClickHandler(),this.setupScrollLock(),this.setupEditHandler()}setOnEditMessage(s){this.onEditMessage=s}setupScrollLock(){this.messagesEl.addEventListener("scroll",()=>{let s=this.messagesEl.scrollHeight-this.messagesEl.scrollTop<=this.messagesEl.clientHeight+50;!s&&!this.scrollLocked?(this.scrollLocked=!0,this.showScrollBottomButton()):s&&this.scrollLocked&&(this.scrollLocked=!1,this.hideScrollBottomButton())})}showScrollBottomButton(){this.scrollBottomButton||(this.scrollBottomButton=this.containerEl.createEl("button",{cls:"claude-scroll-bottom-button"}),this.scrollBottomButton.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>New messages</span>
        `,this.scrollBottomButton.addEventListener("click",()=>{this.scrollToBottomNow()}))}hideScrollBottomButton(){this.scrollBottomButton&&(this.scrollBottomButton.remove(),this.scrollBottomButton=null)}setupLinkClickHandler(){this.messagesEl.addEventListener("click",s=>{let e=s.target,t=e.closest("a");if(t){s.preventDefault(),this.handleLinkClick(t,s);return}let i=e.closest(".internal-link");if(i){s.preventDefault(),this.handleInternalLinkClick(i,s);return}let n=e.closest("code.claude-inline-reference");n&&(s.preventDefault(),this.handleInlineReferenceClick(n,s))})}handleLinkClick(s,e){let t=s.getAttribute("href");if(!(!t||t.startsWith("#"))){if(this.isExternalHref(t)){window.open(t,"_blank");return}if(this.isModifierClick(e)){this.showFilePreview(t,e,s);return}this.tryOpenFile(t)}}handleInternalLinkClick(s,e){let t=s.getAttribute("data-href")||s.textContent;if(t){if(this.isModifierClick(e)){this.showFilePreview(t,e,s);return}this.tryOpenFile(t)}}isModifierClick(s){return s.metaKey||s.ctrlKey}isExternalHref(s){return/^(https?:\/\/|mailto:|obsidian:\/\/)/i.test(s)}showFilePreview(s,e,t){let i=this.resolveFileLink(s);if(!i){let r=this.normalizeFileLink(s);r&&new m.Notice(`File not found: ${r}`);return}let n=this.app.workspace.getActiveFile();this.app.workspace.trigger("hover-link",{event:e,source:"opencode-chat",hoverParent:this.messagesEl,targetEl:t,linktext:i.path,sourcePath:(n==null?void 0:n.path)||""})}tryOpenFile(s){let e=this.resolveFileLink(s);if(e instanceof m.TFile){this.openFileInMainPane(e);return}let t=this.normalizeFileLink(s);new m.Notice(`File not found: ${t||s}`)}resolveFileLink(s){let e=this.normalizeFileLink(s);if(!e)return null;let t=this.app.metadataCache,i=this.app.vault,n=t.getFirstLinkpathDest(e,"");return!n&&!e.endsWith(".md")&&(n=t.getFirstLinkpathDest(`${e}.md`,"")),n||(n=i.getMarkdownFiles().find(a=>{let o=a.basename.toLowerCase(),l=e.toLowerCase();return o===l||o.includes(l)})||null),n instanceof m.TFile?n:null}normalizeFileLink(s){return this.safeDecodeURIComponent(s).replace(/^\[\[/,"").replace(/\]\]$/,"").replace(/\|.*$/,"").replace(/#.*/,"").trim()}safeDecodeURIComponent(s){try{return decodeURIComponent(s)}catch(e){return s}}handleInlineReferenceClick(s,e){var n;let t=(n=s.textContent)==null?void 0:n.trim();if(!t||!this.isModifierClick(e))return;let i=this.safeDecodeURIComponent(t);if(this.isExternalHref(i)){window.open(i,"_blank");return}this.showFilePreview(i,e,s)}enhanceInlineReferences(s){s.querySelectorAll("code").forEach(t=>{var r;if(t.closest("pre"))return;let i=((r=t.textContent)==null?void 0:r.trim())||"";if(!i)return;let n=this.safeDecodeURIComponent(i);(this.isExternalHref(n)||this.looksLikeFileReference(n))&&(t.classList.add("claude-inline-reference"),t.setAttribute("title","Cmd/Ctrl + click to preview/open"))})}looksLikeFileReference(s){return!s||s.includes(`
`)||s.length>240||this.isExternalHref(s)||s.startsWith("#")||/^[a-zA-Z0-9_-]+\(\)$/.test(s)?!1:s.startsWith("./")||s.startsWith("../")||s.startsWith("/")||s.includes("/")?!0:/\.[a-zA-Z0-9_-]{1,12}$/.test(s)}openFileInMainPane(s){let e=this.app.workspace,t=e.getLeavesOfType("markdown"),i=t.length>0?t[0]:null;if(i)i.openFile(s);else{let n=e.getLeaf(!1);n&&n.openFile(s)}}addMessage(s){s.role!=="system"&&this.messages.push(s);let e=this.messagesEl.createEl("div",{cls:`claude-chat-message claude-chat-message-${s.role}`});if(s.role!=="system"){this.messageElements.set(e,s);let r=this.messages.length-1;e.dataset.messageIndex=r.toString()}let i=e.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});i.innerHTML=this.formatContent(s.content);let n=e.createEl("div",{cls:"claude-chat-message-timestamp"});return n.textContent=this.formatTime(s.timestamp),this.addMessageCopyButton(e,s.content),s.role==="user"&&this.addEditButton(e),this.scrollToBottom(),i}addMessageCopyButton(s,e){let t=s.createEl("button",{cls:"claude-message-copy-button"});t.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        `,t.addEventListener("click",async i=>{i.stopPropagation(),await navigator.clipboard.writeText(e),t.classList.add("copied"),t.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            `,setTimeout(()=>{t.classList.remove("copied"),t.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                `},2e3)})}setupEditHandler(){this.messagesEl.addEventListener("click",s=>{let t=s.target.closest(".claude-message-edit-button");if(t){s.preventDefault(),s.stopPropagation();let i=t.closest(".claude-chat-message");i&&this.enterEditMode(i)}})}addEditButton(s){let e=s.createEl("button",{cls:"claude-message-edit-button"});e.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        `}enterEditMode(s){let e=s.querySelector(".claude-chat-message-text");if(!e)return;let t=parseInt(s.dataset.messageIndex||"-1");if(t<0)return;let i=this.messages[t];if(!i)return;let n=e.createEl("textarea",{cls:"claude-message-edit-textarea"});n.value=i.content;let r=e.createEl("div",{cls:"claude-message-edit-buttons"}),a=r.createEl("button",{cls:"claude-message-edit-save",text:"Save & Resend"}),o=r.createEl("button",{cls:"claude-message-edit-cancel",text:"Cancel"});e.querySelectorAll(":scope > :not(textarea):not(.claude-message-edit-buttons)").forEach(h=>h.style.display="none"),n.focus(),n.setSelectionRange(n.value.length,n.value.length);let c=()=>{let h=n.value.trim();h&&h!==i.content?(i.content=h,e.innerHTML=this.formatContent(h),this.onEditMessage&&this.onEditMessage(t,h)):this.exitEditMode(s,e)},d=()=>{this.exitEditMode(s,e)};a.addEventListener("click",c),o.addEventListener("click",d),n.addEventListener("keydown",h=>{h.key==="Enter"&&!h.shiftKey?(h.preventDefault(),c()):h.key==="Escape"&&(h.preventDefault(),d())})}exitEditMode(s,e){let t=e.querySelector(".claude-message-edit-textarea"),i=e.querySelector(".claude-message-edit-buttons");t&&t.remove(),i&&i.remove(),e.querySelectorAll(":scope > *").forEach(r=>r.style.display="")}addUserMessage(s){return this.addMessage({role:"user",content:s,timestamp:new Date})}createAssistantMessage(){let s=this.messagesEl.createEl("div",{cls:"claude-chat-message claude-chat-message-assistant"});this.currentMessageEl=s,this.fileDiffViews.clear(),this.activeDiffHostEl=null;let e=s.createEl("div",{cls:"claude-chat-message-activities"});this.currentActivitiesEl=e;let i=s.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});this.addThinkingIndicator(i);let n=s.createEl("div",{cls:"claude-chat-message-timestamp"});return n.textContent=this.formatTime(new Date),this.currentMessageTextEl=i,this.currentMessageBuffer="",this.scrollToBottom(),i}appendToAssistantMessage(s){this.currentMessageTextEl&&(this.removeThinkingIndicator(),this.currentMessageBuffer+=s,this.currentMessageTextEl.textContent=this.currentMessageBuffer,this.addTypingCursor(),this.scrollToBottom())}finalizeAssistantMessage(){if(this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentMessageBuffer)){this.currentMessageBuffer.endsWith(`
`)||(this.currentMessageBuffer+=`
`),this.currentMessageTextEl.empty();let s=this.app.workspace.getActiveFile(),e=(s==null?void 0:s.path)||"";m.MarkdownRenderer.renderMarkdown(this.currentMessageBuffer,this.currentMessageTextEl,e,new m.Component),this.enhanceInlineReferences(this.currentMessageTextEl),this.addCopyButtonsToCodeBlocks(this.currentMessageTextEl),this.messages.push({role:"assistant",content:this.currentMessageBuffer,timestamp:new Date})}this.currentMessageEl&&this.addMessageCopyButton(this.currentMessageEl,this.currentMessageBuffer),this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentMessageEl=null,this.currentActivitiesEl=null}addCopyButtonsToCodeBlocks(s){s.querySelectorAll("pre").forEach(t=>{if(t.querySelector(".claude-code-copy-button"))return;let i=t.createEl("button",{cls:"claude-code-copy-button"});i.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span>Copy</span>
            `,i.addEventListener("click",async()=>{let n=t.querySelector("code");if(n){let r=n.textContent||"";await navigator.clipboard.writeText(r),i.classList.add("copied"),i.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>Copied!</span>
                    `,setTimeout(()=>{i.classList.remove("copied"),i.innerHTML=`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copy</span>
                        `},2e3)}})})}showThinking(){this.currentMessageTextEl&&!this.currentMessageBuffer&&this.addThinkingIndicator(this.currentMessageTextEl)}hideThinking(){this.removeThinkingIndicator()}addThinkingIndicator(s){if(s.querySelector(".claude-chat-message-thinking"))return;let t=s.createEl("div",{cls:"claude-chat-message-thinking"}),i=t.createEl("div",{cls:"claude-thinking-dots"});for(let r=0;r<3;r++)i.createEl("span",{cls:"claude-thinking-dot"});let n=t.createEl("span",{cls:"claude-thinking-text",text:"Thinking"})}removeThinkingIndicator(){if(this.currentMessageTextEl){let s=this.currentMessageTextEl.querySelector(".claude-chat-message-thinking");s&&s.remove()}}addTypingCursor(){this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentCursorEl=this.currentMessageTextEl.createEl("span",{cls:"claude-typing-cursor"}))}removeTypingCursor(){this.currentCursorEl&&(this.currentCursorEl.remove(),this.currentCursorEl=null)}formatContent(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}formatTime(s){return s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}scrollToBottom(){this.scrollLocked||(this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}scrollToBottomNow(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight,this.scrollLocked=!1,this.hideScrollBottomButton()}addToolCall(s){let e=this.toolCallViews.get(s.id);if(e)return e.update(s),e;let t=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl,i=new L(t,s);return this.toolCallViews.set(s.id,i),this.scrollToBottom(),i}addFileDiffs(s,e){if(e.length===0)return;let t=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl;this.activeDiffHostEl!==t&&(this.fileDiffViews.clear(),this.activeDiffHostEl=t);for(let n of e){let r=`${s}:${n.file}`,a=this.fileDiffViews.get(r);if(a){a.update(n);continue}let o=new A(t,n);this.fileDiffViews.set(r,o)}this.scrollToBottom()}addPermissionDialog(s,e){let t=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl,i=new I(t,s,e);return this.permissionDialogs.set(s.id,i),this.scrollToBottom(),i}addQuestionDialog(s,e,t){let i=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl,n=new D(i,s,e,t);return this.questionDialogs.set(s.id,n),this.scrollToBottom(),n}addStepIndicator(s){let e=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl;if(s.type==="step-start"){let t=e.createEl("div",{cls:"claude-step-indicator claude-step-start"});t.createEl("span",{cls:"claude-step-icon",text:"\u25B6"}),t.createEl("span",{cls:"claude-step-label",text:s.step||"Step started"})}else{let t=e.createEl("div",{cls:"claude-step-indicator claude-step-finish"});t.createEl("span",{cls:"claude-step-icon",text:"\u25A0"});let i=s.reason||"Step finished";if(s.tokens){let n=s.tokens.input+s.tokens.output;i+=` (${n} tokens)`}s.cost!==void 0&&(i+=` \xB7 $${s.cost.toFixed(4)}`),t.createEl("span",{cls:"claude-step-label",text:i})}this.scrollToBottom()}clear(){for(let s of this.toolCallViews.values())s.destroy();this.toolCallViews.clear();for(let s of this.fileDiffViews.values())s.destroy();this.fileDiffViews.clear(),this.activeDiffHostEl=null;for(let s of this.permissionDialogs.values())s.destroy();this.permissionDialogs.clear();for(let s of this.questionDialogs.values())s.destroy();this.questionDialogs.clear(),this.messagesEl.empty(),this.messages=[],this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentActivitiesEl=null,this.scrollLocked=!1,this.hideScrollBottomButton()}getMessages(){return[...this.messages]}removeMessagesAfter(s){this.messages=this.messages.slice(0,s+1),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((i,n)=>{n>s&&i.remove()}),this.messageElements.clear(),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((i,n)=>{n<this.messages.length&&(this.messageElements.set(i,this.messages[n]),i.dataset.messageIndex=n.toString())})}};var P=class{constructor(s,e){this.sessions=[];this.currentSessionId=null;this.containerEl=s,this.onSessionSelect=e.onSessionSelect,this.onNewSession=e.onNewSession,this.onSessionDelete=e.onSessionDelete,this.onSessionRename=e.onSessionRename,this.render()}updateSessions(s,e){this.sessions=s,this.currentSessionId=e,this.render()}render(){this.containerEl.empty(),this.containerEl.addClass("claude-session-tabs");let s=this.containerEl.createEl("div",{cls:"claude-session-tabs-container"}),t=s.createEl("div",{cls:"claude-session-tabs-scroll"}).createEl("div",{cls:"claude-session-tabs-list"});if(this.sessions.length===0){let n=t.createEl("div",{cls:"claude-session-tabs-empty"});n.textContent="No sessions"}else for(let n of this.sessions){let r=this.createTab(n);t.appendChild(r)}let i=s.createEl("button",{cls:"claude-session-tab-new"});i.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"></path>
            </svg>
        `,i.setAttribute("aria-label","New session"),i.addEventListener("click",()=>{this.onNewSession&&this.onNewSession()})}createTab(s){let e=s.id===this.currentSessionId,t=document.createElement("div");t.className="claude-session-tab",e&&t.classList.add("claude-session-tab-active");let i=t.createEl("div",{cls:"claude-session-tab-content"}),n=i.createEl("span",{cls:"claude-session-tab-name"});if(n.textContent=s.name,this.sessions.length>1){let r=i.createEl("button",{cls:"claude-session-tab-close"});r.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            `,r.setAttribute("aria-label","Close session"),r.addEventListener("click",a=>{a.stopPropagation(),this.confirmClose(s.id)})}return i.addEventListener("click",()=>{this.onSessionSelect&&!e&&this.onSessionSelect(s.id)}),i.addEventListener("dblclick",()=>{this.promptRename(s.id)}),t}promptRename(s){let e=this.sessions.find(i=>i.id===s);if(!e)return;let t=prompt("Enter session name:",e.name);t&&t.trim()&&t!==e.name&&this.onSessionRename&&this.onSessionRename(s,t.trim())}confirmClose(s){let e=this.sessions.find(t=>t.id===s);e&&this.sessions.length!==1&&confirm(`Close session "${e.name}"?`)&&this.onSessionDelete&&this.onSessionDelete(s)}};var fe=["discover","outline","draft","evidence","polish","publish"],B={discover:"Discover",outline:"Outline",draft:"Draft",evidence:"Evidence",polish:"Polish",publish:"Publish"},H=class{constructor(s,e){this.callbacks=e;this.panelEl=s.createEl("div",{cls:"claude-writing-task-panel"}),this.headerEl=this.panelEl.createEl("div",{cls:"claude-writing-task-header"}),this.titleEl=this.headerEl.createEl("div",{cls:"claude-writing-task-title",text:"Writing Agent"}),this.statusEl=this.headerEl.createEl("span",{cls:"claude-writing-task-status"}),this.bodyEl=this.panelEl.createEl("div",{cls:"claude-writing-task-body"}),this.objectiveEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-objective"}),this.metadataEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-metadata"}),this.stagesEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-stages"}),this.stageHistoryEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-stage-history"}),this.metricsEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-metrics"}),this.versionsEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-versions"}),this.emptyEl=this.panelEl.createEl("div",{cls:"claude-writing-task-empty"}),this.emptyEl.createEl("div",{cls:"claude-writing-task-empty-title",text:"No active writing task"}).setAttribute("aria-hidden","true"),this.emptyEl.createEl("div",{cls:"claude-writing-task-empty-text",text:"Start with `/write start <topic>` to create a structured writing workflow."}),this.emptyEl.createEl("button",{cls:"claude-writing-task-empty-action",text:"Start Task"}).addEventListener("click",()=>this.callbacks.onStartTask())}update(s,e){if(!s){this.panelEl.classList.add("is-empty"),this.statusEl.setText("Idle"),this.titleEl.setText("Writing Agent"),this.bodyEl.style.display="none",this.emptyEl.style.display="block";return}this.panelEl.classList.remove("is-empty"),this.bodyEl.style.display="block",this.emptyEl.style.display="none",this.titleEl.setText(s.title),this.statusEl.setText(`${s.status} \xB7 ${B[s.stage]}`),this.statusEl.classList.toggle("is-paused",s.status==="paused"),this.statusEl.classList.toggle("is-completed",s.status==="completed"),this.objectiveEl.empty(),this.objectiveEl.createEl("div",{cls:"claude-writing-task-label",text:"Objective"}),this.objectiveEl.createEl("div",{cls:"claude-writing-task-value",text:s.objective}),this.metadataEl.empty(),this.renderInlineEditField(this.metadataEl,"Audience","audience",s.audience),this.renderInlineEditField(this.metadataEl,"Tone","tone",s.tone),this.renderInlineEditField(this.metadataEl,"Length","targetLength",s.targetLength),this.renderStageButtons(s.stage),this.renderStageHistory(s.stageHistory||[]),this.renderDraftVersions(s),this.renderMetrics(e)}destroy(){this.panelEl.remove()}renderInlineEditField(s,e,t,i){let n=s.createEl("div",{cls:"claude-writing-inline-edit"});n.createEl("span",{cls:"claude-writing-inline-edit-label",text:`${e}: `});let r=n.createEl("span",{cls:"claude-writing-inline-edit-value",text:i});r.setAttribute("tabindex","0"),r.setAttribute("role","button"),r.setAttribute("aria-label",`Edit ${e}`);let a=()=>{let o=n.createEl("input",{cls:"claude-writing-inline-edit-input",type:"text",value:i});r.style.display="none",o.focus(),o.select();let l=()=>{var d,h;let c=o.value.trim();c&&c!==i&&((h=(d=this.callbacks).onUpdateTaskProperty)==null||h.call(d,t,c)),o.remove(),r.style.display=""};o.addEventListener("blur",l),o.addEventListener("keydown",c=>{c.key==="Enter"?(c.preventDefault(),o.blur()):c.key==="Escape"&&(o.removeEventListener("blur",l),o.remove(),r.style.display="")})};r.addEventListener("click",a),r.addEventListener("keydown",o=>{(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),a())})}renderStageHistory(s){if(this.stageHistoryEl.empty(),s.length===0)return;this.stageHistoryEl.createEl("div",{cls:"claude-writing-task-label",text:"Stage History"});let e=this.stageHistoryEl.createEl("div",{cls:"claude-writing-stage-history-list"}),t=s.slice(-5).reverse();for(let i of t){let n=e.createEl("div",{cls:"claude-writing-stage-history-item"});n.createEl("span",{cls:"claude-writing-stage-history-from",text:B[i.from]}),n.createEl("span",{cls:"claude-writing-stage-history-arrow",text:"\u2192"}),n.createEl("span",{cls:"claude-writing-stage-history-to",text:B[i.to]}),n.createEl("span",{cls:"claude-writing-stage-history-time",text:this.formatTime(i.timestamp)})}}renderStageButtons(s){this.stagesEl.empty();let e=this.stagesEl.createEl("div",{cls:"claude-writing-stage-actions"});for(let a of fe){let o=e.createEl("button",{cls:"claude-writing-stage-button",text:B[a]});a===s&&o.addClass("is-active"),o.addEventListener("click",()=>this.callbacks.onRunStage(a))}let t=this.stagesEl.createEl("div",{cls:"claude-writing-state-actions"});t.createEl("button",{cls:"claude-writing-state-button",text:"Pause"}).addEventListener("click",()=>this.callbacks.onPauseTask()),t.createEl("button",{cls:"claude-writing-state-button",text:"Resume"}).addEventListener("click",()=>this.callbacks.onResumeTask()),t.createEl("button",{cls:"claude-writing-state-button is-primary",text:"Complete"}).addEventListener("click",()=>this.callbacks.onCompleteTask())}renderMetrics(s){if(this.metricsEl.empty(),this.metricsEl.createEl("div",{cls:"claude-writing-task-label",text:"Citation Coverage"}),!s||s.totalClaims===0){this.metricsEl.createEl("div",{cls:"claude-writing-task-value",text:"No citation report yet. Run `/write draft` or `/write evidence`."});return}let e=Math.round(s.coverage*100),t=`${e}% (${s.citedClaims}/${s.totalClaims})`;this.metricsEl.createEl("div",{cls:"claude-writing-task-value",text:`${t} \xB7 Sources: ${s.sourceCount}`});let n=this.metricsEl.createEl("div",{cls:"claude-writing-metrics-bar-container"}).createEl("div",{cls:"claude-writing-metrics-bar"}),r=e>=80?"claude-writing-metrics-severity-low":e>=50?"claude-writing-metrics-severity-medium":"claude-writing-metrics-severity-high";if(n.addClass(r),n.style.width=`${e}%`,s.uncitedClaims.length>0){this.metricsEl.createEl("div",{cls:"claude-writing-task-label claude-writing-metrics-uncited-label",text:`Uncited Claims (${s.uncitedClaims.length})`}).addClass(r);let o=this.metricsEl.createEl("ul",{cls:"claude-writing-task-uncited-list"});for(let l of s.uncitedClaims.slice(0,3))o.createEl("li",{text:l})}}renderDraftVersions(s){if(this.versionsEl.empty(),this.versionsEl.createEl("div",{cls:"claude-writing-task-label",text:"Draft Versions"}),s.draftVersions.length===0){this.versionsEl.createEl("div",{cls:"claude-writing-task-value",text:"No versions yet. Run `/write draft` to capture first snapshot."});return}let e=this.versionsEl.createEl("div",{cls:"claude-writing-version-list"}),t=s.draftVersions.slice(-5).reverse();for(let i of t)this.renderVersionRow(e,i,s.currentDraftVersionId===i.id)}renderVersionRow(s,e,t){let i=s.createEl("div",{cls:"claude-writing-version-row"});t&&i.addClass("is-current");let n=i.createEl("div",{cls:"claude-writing-version-meta"}),r=n.createEl("div",{cls:"claude-writing-version-label",text:e.label});t&&r.createEl("span",{cls:"claude-writing-version-current",text:"Current"});let a=[e.stage,this.formatTime(e.createdAt)];typeof e.citationCoverage=="number"&&a.push(`cite ${Math.round(e.citationCoverage*100)}%`),n.createEl("div",{cls:"claude-writing-version-detail",text:a.join(" \xB7 ")});let o=i.createEl("div",{cls:"claude-writing-version-actions"}),l=o.createEl("button",{cls:"claude-writing-version-compare",text:"Compare"});l.disabled=t,l.addEventListener("click",()=>this.callbacks.onCompareDraftVersion(e.id));let c=o.createEl("button",{cls:"claude-writing-version-rollback",text:"Rollback"});c.disabled=t,c.addEventListener("click",()=>this.callbacks.onRollbackDraftVersion(e.id))}formatTime(s){return s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}};var p="claude-chat-view";function ve(u,s){let e=u.length,t=s.length,i=Array.from({length:e+1},()=>new Array(t+1).fill(0));for(let n=1;n<=e;n++)for(let r=1;r<=t;r++)u[n-1]===s[r-1]?i[n][r]=i[n-1][r-1]+1:i[n][r]=Math.max(i[n-1][r],i[n][r-1]);return i}function $(u,s,e,t,i,n){t>0&&i>0&&s[t-1]===e[i-1]?($(u,s,e,t-1,i-1,n),n.push({type:"equal",line:s[t-1],oldIdx:t,newIdx:i})):i>0&&(t===0||u[t][i-1]>=u[t-1][i])?($(u,s,e,t,i-1,n),n.push({type:"insert",line:e[i-1],oldIdx:t,newIdx:i})):t>0&&($(u,s,e,t-1,i,n),n.push({type:"delete",line:s[t-1],oldIdx:t,newIdx:i}))}function Ee(u,s){let e=[];for(let r=0;r<u.length;r++)u[r].type!=="equal"&&e.push(r);if(e.length===0)return[];let t=[],i=Math.max(0,e[0]-s),n=Math.min(u.length-1,e[0]+s);for(let r=1;r<e.length;r++){let a=Math.max(0,e[r]-s);a<=n+1||(t.push(K(u,i,n)),i=a),n=Math.min(u.length-1,e[r]+s)}return t.push(K(u,i,n)),t}function K(u,s,e){let t=[],i=0,n=0,r=0,a=0,o=!0,l=!0;for(let c=s;c<=e;c++){let d=u[c];switch(d.type){case"equal":t.push(` ${d.line}`),o&&(i=d.oldIdx,o=!1),l&&(r=d.newIdx,l=!1),n++,a++;break;case"delete":t.push(`-${d.line}`),o&&(i=d.oldIdx,o=!1),n++;break;case"insert":t.push(`+${d.line}`),l&&(r=d.newIdx,l=!1),a++;break}}return{oldStart:i,oldCount:n,newStart:r,newCount:a,lines:t}}function Q(u,s,e,t,i=3){let n=u.split(`
`),r=s.split(`
`),a=ve(n,r),o=[];$(a,n,r,n.length,r.length,o);let l=Ee(o,i);if(l.length===0)return null;let c=[`--- ${e}`,`+++ ${t}`];for(let d of l)c.push(`@@ -${d.oldStart},${d.oldCount} +${d.newStart},${d.newCount} @@`),c.push(...d.lines);return c.join(`
`)}var we=[{permission:"bash",pattern:"*",action:"ask"},{permission:"write",pattern:"*",action:"ask"},{permission:"edit",pattern:"*",action:"ask"}],Se={start:"discover",discover:"discover",outline:"outline",draft:"draft",evidence:"evidence",polish:"polish",publish:"publish"},ye=["full","broken","orphan","duplicate","stale"],q=class extends z.ItemView{constructor(e,t){super(e);this.writingTaskPanel=null;this.isProcessing=!1;this.statusBadgeEl=null;this.pendingMetaByServerSessionId=new Map;this.citationReportBySessionId=new Map;this.plugin=t,this.sessionManager=t.sessionManager,this.contextResolver=new C(t.app),this.writingWorkflow=new x,this.citationQualityService=new y,this.publishAssistant=new b(t.app),this.knowledgeBaseService=new T(t.app),this.boundHandlers={onTextDelta:this.handleTextDelta.bind(this),onSessionIdle:this.handleSessionIdle.bind(this),onSessionStatus:this.handleSessionStatus.bind(this),onSessionError:this.handleSessionError.bind(this),onToolUpdated:this.handleToolUpdated.bind(this),onDiffUpdated:this.handleDiffUpdated.bind(this),onPermissionAsked:this.handlePermissionAsked.bind(this),onQuestionAsked:this.handleQuestionAsked.bind(this),onStepStart:this.handleStepStart.bind(this),onStepFinish:this.handleStepFinish.bind(this),onConnected:this.handleConnected.bind(this),onDisconnected:this.handleDisconnected.bind(this),onError:this.handleError.bind(this)}}getViewType(){return p}getDisplayText(){return"OpenCode Chat"}getIcon(){return"message-square"}get server(){return this.plugin.server}get currentServerSessionId(){return this.sessionManager.getCurrentServerSessionId()}isCurrentSession(e){return this.currentServerSessionId===e}async onOpen(){var a;let e=this.containerEl.children[1];e.empty(),e.addClass("claude-chat-container");let i=e.createEl("div",{cls:"claude-chat-main-layout"}).createEl("div",{cls:"claude-chat-content"}),n=i.createEl("div",{cls:"claude-session-tabs-wrapper"});this.sessionTabs=new P(n,{onSessionSelect:o=>this.loadSession(o),onNewSession:()=>this.createNewSession(),onSessionDelete:o=>this.deleteSession(o),onSessionRename:(o,l)=>this.renameSession(o,l)}),this.updateSessionList(),this.statusBadgeEl=i.createEl("div",{cls:"claude-server-status claude-server-status-connecting"}),this.statusBadgeEl.setText("Connecting..."),this.writingTaskPanel=new H(i,{onStartTask:()=>this.queueCommandTemplate("/write start "),onRunStage:o=>this.queueCommandTemplate(`/write ${o} `),onPauseTask:()=>this.updateCurrentWritingTaskStatus("paused"),onResumeTask:()=>this.updateCurrentWritingTaskStatus("active"),onCompleteTask:()=>this.updateCurrentWritingTaskStatus("completed"),onRollbackDraftVersion:o=>this.rollbackToDraftVersion(o),onCompareDraftVersion:o=>this.compareDraftVersion(o),onUpdateTaskProperty:(o,l)=>{let c=this.sessionManager.getCurrentWritingTask();c&&(o==="audience"||o==="tone"||o==="targetLength")&&(c[o]=l,this.sessionManager.setCurrentWritingTask(c),this.refreshWritingTaskPanel())}}),this.syncWorkflowTaskFromSession(),this.refreshWritingTaskPanel(),this.messageContainer=new R(i,this.app),this.messageContainer.setOnEditMessage(async(o,l)=>{await this.handleEditMessage(o,l)}),this.loadCurrentSessionMessages();let r=i.createEl("div",{cls:"claude-chat-input-actions"});this.createActionButton(r,"Export","Export conversation to Markdown (Ctrl+Shift+E)",()=>this.exportConversation()),this.createActionButton(r,"Clear","Clear chat history (Ctrl+K)",()=>this.clearHistory()),this.createActionButton(r,"Regenerate","Regenerate last response",()=>this.regenerateLast()),this.createActionButton(r,"Write","Create a writing task template",()=>this.queueCommandTemplate("/write start ")),this.createActionButton(r,"Outline","Generate evidence-aware outline",()=>this.queueCommandTemplate("/write outline ")),this.createActionButton(r,"Draft","Generate first draft with citations",()=>this.queueCommandTemplate("/write draft ")),this.createActionButton(r,"Evidence","Run evidence review workflow",()=>this.queueCommandTemplate("/write evidence ")),this.createActionButton(r,"KB Audit","Run knowledge base health audit",()=>this.queueCommandTemplate("/kb audit full ")),this.chatInput=new M(i,this.app,async o=>{await this.handleCommand(o)},()=>{this.handleStop()}),this.subscribeToServer(),(a=this.server)!=null&&a.connected&&this.updateStatusBadge(!0)}createActionButton(e,t,i,n){let r=e.createEl("button",{cls:"claude-chat-action-button"});r.textContent=t,r.setAttribute("aria-label",i),r.setAttribute("title",i),r.addEventListener("click",n)}queueCommandTemplate(e){!this.chatInput||this.isProcessing||(this.chatInput.setValue(e),this.chatInput.focus())}subscribeToServer(){let e=this.server;e&&(e.on("text.delta",this.boundHandlers.onTextDelta),e.on("session.idle",this.boundHandlers.onSessionIdle),e.on("session.status",this.boundHandlers.onSessionStatus),e.on("session.error",this.boundHandlers.onSessionError),e.on("tool.updated",this.boundHandlers.onToolUpdated),e.on("diff.updated",this.boundHandlers.onDiffUpdated),e.on("permission.asked",this.boundHandlers.onPermissionAsked),e.on("question.asked",this.boundHandlers.onQuestionAsked),e.on("step.start",this.boundHandlers.onStepStart),e.on("step.finish",this.boundHandlers.onStepFinish),e.on("connected",this.boundHandlers.onConnected),e.on("disconnected",this.boundHandlers.onDisconnected),e.on("error",this.boundHandlers.onError))}unsubscribeFromServer(){let e=this.server;e&&(e.off("text.delta",this.boundHandlers.onTextDelta),e.off("session.idle",this.boundHandlers.onSessionIdle),e.off("session.status",this.boundHandlers.onSessionStatus),e.off("session.error",this.boundHandlers.onSessionError),e.off("tool.updated",this.boundHandlers.onToolUpdated),e.off("diff.updated",this.boundHandlers.onDiffUpdated),e.off("permission.asked",this.boundHandlers.onPermissionAsked),e.off("question.asked",this.boundHandlers.onQuestionAsked),e.off("step.start",this.boundHandlers.onStepStart),e.off("step.finish",this.boundHandlers.onStepFinish),e.off("connected",this.boundHandlers.onConnected),e.off("disconnected",this.boundHandlers.onDisconnected),e.off("error",this.boundHandlers.onError))}handleTextDelta(e,t,i,n){this.isCurrentSession(e)&&this.messageContainer.appendToAssistantMessage(i)}handleSessionIdle(e){let t=this.pendingMetaByServerSessionId.get(e);if(this.pendingMetaByServerSessionId.delete(e),!this.isCurrentSession(e))return;this.messageContainer.finalizeAssistantMessage();let i=this.messageContainer.getMessages(),n=i[i.length-1];if(n&&n.role==="assistant"){this.sessionManager.addMessage(n);let r=null;t!=null&&t.requiresCitationCheck&&(r=this.citationQualityService.evaluate(n.content),this.citationReportBySessionId.set(e,r),this.addSystemNotice(this.buildCitationCoverageNotice(r))),t!=null&&t.shouldCaptureDraftVersion&&t.stage&&this.captureDraftVersionFromAssistant(t.stage,n.content,r)}this.updateSessionList(),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}handleSessionStatus(e,t){this.isCurrentSession(e)&&t.type==="busy"&&(this.isProcessing=!0,this.chatInput.setProcessing(!0))}handleSessionError(e,t){if(e&&this.pendingMetaByServerSessionId.delete(e),e&&!this.isCurrentSession(e))return;let i=(t==null?void 0:t.message)||"Unknown error";console.error("OpenCodeChatView: Session error:",i),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${i}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),r=n[n.length-1];r&&r.role==="assistant"&&this.sessionManager.addMessage(r),this.isProcessing=!1,this.chatInput.setProcessing(!1)}handleToolUpdated(e,t){this.isCurrentSession(e)&&this.messageContainer.addToolCall(t)}handleDiffUpdated(e,t){this.isCurrentSession(e)&&this.messageContainer.addFileDiffs(e,t)}handlePermissionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let t=this.server;t&&this.messageContainer.addPermissionDialog(e,i=>{t.approvePermission(e.sessionID,e.id,i).catch(n=>{console.error("OpenCodeChatView: Failed to reply to permission:",n)})})}handleQuestionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let t=this.server;t&&this.messageContainer.addQuestionDialog(e,i=>{t.replyToQuestion(e.sessionID,e.id,i).catch(n=>{console.error("OpenCodeChatView: Failed to reply to question:",n)})},()=>{t.rejectQuestion(e.id).catch(i=>{console.error("OpenCodeChatView: Failed to reject question:",i)})})}handleStepStart(e,t){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(t)}handleStepFinish(e,t){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(t)}handleConnected(){this.updateStatusBadge(!0)}handleDisconnected(){this.updateStatusBadge(!1)}handleError(e){console.error("OpenCodeChatView: Server error:",e)}updateStatusBadge(e){this.statusBadgeEl&&(this.statusBadgeEl.classList.remove("claude-server-status-connected","claude-server-status-disconnected","claude-server-status-connecting"),e?(this.statusBadgeEl.classList.add("claude-server-status-connected"),this.statusBadgeEl.setText("Connected")):(this.statusBadgeEl.classList.add("claude-server-status-disconnected"),this.statusBadgeEl.setText("Disconnected")))}loadCurrentSessionMessages(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - Enter commands to interact with OpenCode\n\n**Keyboard Shortcuts:**\n\u2022 `Ctrl+Shift+N` - New session\n\u2022 `Ctrl+Shift+E` - Export conversation\n\u2022 `Ctrl+K` - Clear history\n\u2022 `Ctrl+L` - Focus input\n\u2022 `\u2191/\u2193` - Browse command history\n\u2022 `Shift+Enter` - New line\n\u2022 `Escape` - Stop generation\n\n**Workflow Commands:**\n\u2022 `/write start <topic>` - Start a writing task discovery\n\u2022 `/write outline [requirements]` - Create source-aware outline\n\u2022 `/write draft [requirements]` - Produce full draft with citations\n\u2022 `/write evidence [question]` - Run evidence QA audit\n\u2022 `/kb audit [full|broken|orphan|duplicate|stale]` - Run KB health audit\n\u2022 `/qa <question>` - Ask source-backed QA in current context\n\n**Tips:**\n\u2022 Click on user messages to edit and resend\n\u2022 Hover over messages to copy content\n\u2022 Type `@` in input to reference vault files\n\u2022 Use the toolbar buttons for quick actions\n\u2022 Tool calls and permissions will appear inline",timestamp:new Date});else for(let t of e)this.messageContainer.addMessage(t)}updateSessionList(){var e;this.sessionTabs.updateSessions(this.sessionManager.getSessions(),((e=this.sessionManager.getCurrentSession())==null?void 0:e.id)||null),this.refreshWritingTaskPanel()}addSystemNotice(e){this.messageContainer.addMessage({role:"system",content:e,timestamp:new Date})}getCurrentSessionKey(){var e;return((e=this.sessionManager.getCurrentSession())==null?void 0:e.id)||"default-session"}getCurrentWritingTask(){return this.sessionManager.getCurrentWritingTask()}syncWorkflowTaskFromSession(){let e=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(e,this.getCurrentWritingTask())}refreshWritingTaskPanel(){if(!this.writingTaskPanel)return;let e=this.currentServerSessionId||"",t=e&&this.citationReportBySessionId.get(e)||null;this.writingTaskPanel.update(this.getCurrentWritingTask(),t)}updateCurrentWritingTaskStatus(e){let t=this.getCurrentWritingTask();if(!t){this.addSystemNotice("No active writing task. Use `/write start <topic>` first."),this.queueCommandTemplate("/write start ");return}let i={...t,status:e,updatedAt:new Date},n=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(n,i),this.sessionManager.setCurrentWritingTask(i),this.refreshWritingTaskPanel(),this.addSystemNotice(`Writing task status updated to **${e}**.`)}rollbackToDraftVersion(e){let t=this.getCurrentSessionKey();this.syncWorkflowTaskFromSession();let i=this.writingWorkflow.rollbackToDraftVersion(t,e);if(!i){this.addSystemNotice("Rollback failed: draft version not found.");return}this.sessionManager.setCurrentWritingTask(i.task),this.refreshWritingTaskPanel(),this.addSystemNotice(`Rolled back to **${i.version.label}**. Use \`/write ${i.version.stage}\` to continue from this baseline.`)}compareDraftVersion(e){let t=this.getCurrentWritingTask();if(!t){this.addSystemNotice("No active writing task.");return}let i=t.draftVersions.find(o=>o.id===e);if(!i){this.addSystemNotice("Draft version not found.");return}let n=t.draftVersions.find(o=>o.id===t.currentDraftVersionId);if(!n){this.addSystemNotice("No current draft version to compare against.");return}let r=Q(i.content,n.content,i.label,n.label);if(!r){this.addSystemNotice(`**${i.label}** and **${n.label}** are identical.`);return}let a=["## Draft Comparison",`Comparing **${i.label}** \u2192 **${n.label}**`,"","```diff",r,"```"].join(`
`);this.addSystemNotice(a)}captureDraftVersionFromAssistant(e,t,i){let n=this.getCurrentSessionKey();this.syncWorkflowTaskFromSession();let r=this.writingWorkflow.addDraftVersion(n,e,t,{citationCoverage:i==null?void 0:i.coverage,sourceCount:i==null?void 0:i.sourceCount});r&&(this.sessionManager.setCurrentWritingTask(r.task),this.refreshWritingTaskPanel(),r.created&&this.addSystemNotice(`Saved draft version: **${r.version.label}**`))}buildCitationCoverageNotice(e){let t=["## Citation Coverage Report",`- Coverage: ${Math.round(e.coverage*100)}% (${e.citedClaims}/${e.totalClaims})`,`- Sources listed: ${e.sourceCount}`];if(e.totalClaims===0)return t.push("- No claim lines detected for citation scoring."),t.join(`
`);if(e.uncitedClaims.length===0)return t.push("- Uncited claims: none"),t.join(`
`);t.push("### Uncited Claims");for(let i of e.uncitedClaims.slice(0,3))t.push(`- ${i}`);return t.push("- Action: add `[[source-note]]` links for uncited claims."),t.join(`
`)}async prepareWorkflowCommand(e){let t=e.trim();return/^\/help(?:\s+workflow)?$/i.test(t)?{displayCommand:t,promptToSend:null,localNotice:this.writingWorkflow.buildWorkflowHelp(),meta:{source:"plain",requiresCitationCheck:!1}}:/^\/write\b/i.test(t)?this.prepareWriteWorkflowCommand(t):/^\/kb\s+audit\b/i.test(t)?await this.prepareKbAuditCommand(t):/^\/qa\b/i.test(t)?this.prepareEvidenceQaCommand(t):{displayCommand:t,promptToSend:t,meta:{source:"plain",requiresCitationCheck:!1}}}prepareWriteWorkflowCommand(e){let t=e.match(/^\/write\s+([^\s]+)(?:\s+([\s\S]+))?$/i);if(!t)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/write start <topic>` or `/write outline|draft|evidence|polish|publish [requirements]`",meta:{source:"write",requiresCitationCheck:!1}};let i=t[1].toLowerCase(),n=(t[2]||"").trim(),r=Se[i];if(!r)return{displayCommand:e,promptToSend:null,localNotice:`Unknown /write action: ${i}. Use \`/help workflow\` for available commands.`,meta:{source:"write",requiresCitationCheck:!1}};let a=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(a,this.getCurrentWritingTask());let o=this.contextResolver.resolveSnapshot(e),l=this.contextResolver.buildContextBlock(o),c=this.writingWorkflow.getTask(a);if(r==="discover"){if(!n&&!c)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/write start <topic>` (or create one task first, then use `/write discover`)",meta:{source:"write",stage:r,requiresCitationCheck:!1}};let w={...n?this.writingWorkflow.createTask(a,n):this.writingWorkflow.ensureTask(a,(c==null?void 0:c.objective)||"Untitled writing objective"),stage:"discover",status:"active",updatedAt:new Date};this.writingWorkflow.hydrateTask(a,w),this.sessionManager.setCurrentWritingTask(w),n&&this.currentServerSessionId&&this.citationReportBySessionId.delete(this.currentServerSessionId);let te=n||`Re-run discovery for writing task "${w.title}".`,se=this.writingWorkflow.buildStagePrompt("discover",te,o,w,l);return{displayCommand:e,promptToSend:se,localNotice:n?`Writing task created: **${w.title}**`:`Workflow stage: **discover** \xB7 Task: **${w.title}**`,meta:{source:"write",stage:r,requiresCitationCheck:!1}}}let d=this.writingWorkflow.ensureTask(a,n||"Untitled writing objective");this.writingWorkflow.updateStage(a,r);let h={...d,stage:r,status:"active",updatedAt:new Date};if(this.writingWorkflow.hydrateTask(a,h),this.sessionManager.setCurrentWritingTask(h),r==="evidence"){let U=n||`Audit factual grounding for writing task "${h.title}".`;return{displayCommand:e,promptToSend:this.writingWorkflow.buildEvidencePrompt(U,l),localNotice:`Workflow stage: **evidence** \xB7 Task: **${h.title}**`,meta:{source:"write",stage:r,requiresCitationCheck:!0}}}let f=n||`Continue task "${h.title}" in ${r} stage.`,S=r==="publish"?this.publishAssistant.buildPublishContextBlock(this.publishAssistant.gatherVaultContext()):void 0,Z=this.writingWorkflow.buildStagePrompt(r,f,o,h,l,S),ee=r==="draft"||r==="polish"||r==="publish";return{displayCommand:e,promptToSend:Z,localNotice:`Workflow stage: **${r}** \xB7 Task: **${h.title}**`,meta:{source:"write",stage:r,requiresCitationCheck:!0,shouldCaptureDraftVersion:ee}}}async prepareKbAuditCommand(e){let t=e.match(/^\/kb\s+audit(?:\s+([^\s]+))?(?:\s+([\s\S]+))?$/i);if(!t)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/kb audit [full|broken|orphan|duplicate|stale] [extra requirements]`",meta:{source:"kb",requiresCitationCheck:!1}};let i=(t[1]||"").toLowerCase(),n=(t[2]||"").trim(),r="full",a="";ye.includes(i)?(r=i,a=n):a=[i,n].filter(f=>f.length>0).join(" ").trim();let o=await this.knowledgeBaseService.runAudit(),l=this.knowledgeBaseService.formatReport(o),c=this.contextResolver.resolveSnapshot(e),d=this.contextResolver.buildContextBlock(c),h=this.writingWorkflow.buildKbAuditPrompt(r,a,d,l);return{displayCommand:e,promptToSend:h,localNotice:`Knowledge base audit scope: **${r}** (Found ${o.issues.length} issues)`,meta:{source:"kb",requiresCitationCheck:!1}}}prepareEvidenceQaCommand(e){let t=e.match(/^\/qa(?:\s+([\s\S]+))?$/i),i=((t==null?void 0:t[1])||"").trim();if(!i)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/qa <question>`",meta:{source:"qa",requiresCitationCheck:!1}};let n=this.contextResolver.resolveSnapshot(e,i),r=this.contextResolver.buildContextBlock(n),a=this.writingWorkflow.buildEvidencePrompt(i,r);return{displayCommand:e,promptToSend:a,localNotice:"Running evidence QA workflow with strict citation checks.",meta:{source:"qa",requiresCitationCheck:!0}}}async handleCommand(e){if(this.isProcessing)return;let t=await this.prepareWorkflowCommand(e);if(!t.promptToSend){t.localNotice&&this.addSystemNotice(t.localNotice),this.refreshWritingTaskPanel();return}if(this.refreshWritingTaskPanel(),!this.server){console.error("OpenCodeChatView: Server not available");return}this.isProcessing=!0,this.chatInput.setProcessing(!0),this.messageContainer.addUserMessage(t.displayCommand),this.sessionManager.addMessage({role:"user",content:t.displayCommand,timestamp:new Date}),t.localNotice&&this.addSystemNotice(t.localNotice),this.messageContainer.createAssistantMessage();try{let i=this.currentServerSessionId;i||(i=(await this.server.createSession(we)).id,this.sessionManager.updateServerSessionId(i)),await this.server.sendMessage(i,t.promptToSend),this.pendingMetaByServerSessionId.set(i,t.meta||{source:"plain",requiresCitationCheck:!1})}catch(i){console.error("OpenCodeChatView: Command error:",i),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${i.message}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),r=n[n.length-1];r&&r.role==="assistant"&&this.sessionManager.addMessage(r),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}}handleStop(){if(!this.isProcessing)return;let e=this.currentServerSessionId;e&&this.pendingMetaByServerSessionId.delete(e),e&&this.server&&this.server.abortSession(e).catch(t=>{console.error("OpenCodeChatView: Failed to abort session:",t)}),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

_Stopped by user_`),this.messageContainer.finalizeAssistantMessage(),this.isProcessing=!1,this.chatInput.setProcessing(!1)}clearHistory(){let e=this.getCurrentSessionKey();this.sessionManager.clearCurrentSession(),this.sessionManager.setCurrentWritingTask(null),this.writingWorkflow.hydrateTask(e,null);let t=this.currentServerSessionId;t&&(this.citationReportBySessionId.delete(t),this.pendingMetaByServerSessionId.delete(t)),this.messageContainer.clear(),this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - History cleared",timestamp:new Date}),this.updateSessionList()}focusInput(){this.chatInput.focus()}loadSession(e){if(!this.sessionManager.switchSession(e)){console.error("OpenCodeChatView: Failed to switch to session:",e);return}this.syncWorkflowTaskFromSession(),this.messageContainer.clear(),this.loadCurrentSessionMessages(),this.updateSessionList(),this.chatInput.focus()}createNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length}`);this.loadSession(e.id)}deleteSession(e){if(this.writingWorkflow.hydrateTask(e,null),!this.sessionManager.deleteSession(e)){console.error("OpenCodeChatView: Failed to delete session:",e);return}let i=this.sessionManager.getCurrentSession();i?this.loadSession(i.id):this.createNewSession()}renameSession(e,t){this.sessionManager.updateSessionName(e,t)&&this.updateSessionList()}async exportConversation(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)return;let t=this.sessionManager.getCurrentSession(),i=(t==null?void 0:t.name)||"Conversation",n=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),a=`opencode-chat-${i.replace(/[^a-zA-Z0-9]/g,"-")}-${n}.md`,o=`# OpenCode Chat Conversation

`;o+=`**Session:** ${i}

`,o+=`*Exported: ${new Date().toLocaleString()}*

`,o+=`*Server Session ID: ${(t==null?void 0:t.serverSessionId)||"N/A"}*

`,o+=`---

`;for(let d of e){if(d.role==="system")continue;let h=d.role==="user"?"\u{1F464} User":"\u{1F916} Assistant",f=d.timestamp.toLocaleTimeString();o+=`## ${h}

`,o+=`*${f}*

`,o+=`${d.content}

`,o+=`---

`}let l=this.app.vault;await l.create(a,o),l.getAbstractFileByPath(a)&&await this.app.workspace.openLinkText(a,"",!0)}async handleEditMessage(e,t){this.messageContainer.removeMessagesAfter(e),await this.handleCommand(t)}async regenerateLast(){let e=this.messageContainer.getMessages(),t=-1;for(let i=e.length-1;i>=0;i--)if(e[i].role==="user"){t=i;break}t>=0&&(this.messageContainer.removeMessagesAfter(t-1),await this.handleCommand(e[t].content))}async onClose(){this.writingTaskPanel&&(this.writingTaskPanel.destroy(),this.writingTaskPanel=null),this.unsubscribeFromServer()}};var W=class{constructor(){this.sessions=[];this.currentSessionId=null;this.onChangeCallbacks=[];this.loadSessions()}loadSessions(s=[],e=null){this.sessions=s.map(t=>({...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),writingTask:t.writingTask?{...t.writingTask,draftVersions:(t.writingTask.draftVersions||[]).map(i=>({...i,createdAt:new Date(i.createdAt)})),stageHistory:(t.writingTask.stageHistory||[]).map(i=>({...i,timestamp:new Date(i.timestamp)})),currentDraftVersionId:t.writingTask.currentDraftVersionId||null,createdAt:new Date(t.writingTask.createdAt),updatedAt:new Date(t.writingTask.updatedAt)}:null,messages:t.messages.map(i=>({...i,timestamp:new Date(i.timestamp)}))})),this.currentSessionId=e,this.sessions.length===0?this.createSession("Default Session"):this.currentSessionId||(this.currentSessionId=this.sessions[0].id)}getSessions(){return[...this.sessions]}getCurrentSession(){return this.currentSessionId&&this.sessions.find(s=>s.id===this.currentSessionId)||null}getSession(s){return this.sessions.find(e=>e.id===s)||null}createSession(s){let e={id:this.generateId(),name:s,sessionId:null,serverSessionId:null,writingTask:null,createdAt:new Date,updatedAt:new Date,messages:[]};return this.sessions.push(e),this.currentSessionId=e.id,this.notifyChange(),e}updateSessionName(s,e){let t=this.getSession(s);return t?(t.name=e,t.updatedAt=new Date,this.notifyChange(),!0):!1}deleteSession(s){let e=this.sessions.findIndex(t=>t.id===s);return e!==-1?(this.sessions.splice(e,1),this.currentSessionId===s&&(this.currentSessionId=this.sessions.length>0?this.sessions[0].id:null,this.sessions.length===0&&this.createSession("Default Session")),this.notifyChange(),!0):!1}switchSession(s){return this.getSession(s)?(this.currentSessionId=s,this.notifyChange(),!0):!1}addMessage(s){let e=this.getCurrentSession();e&&(e.messages.push(s),e.updatedAt=new Date,this.notifyChange())}updateCliSessionId(s){let e=this.getCurrentSession();e&&(e.sessionId=s,e.updatedAt=new Date,this.notifyChange())}updateServerSessionId(s){let e=this.getCurrentSession();e&&(e.serverSessionId=s,e.updatedAt=new Date,this.notifyChange())}getCurrentServerSessionId(){let s=this.getCurrentSession();return s?s.serverSessionId:null}getCurrentWritingTask(){let s=this.getCurrentSession();return(s==null?void 0:s.writingTask)||null}setCurrentWritingTask(s){let e=this.getCurrentSession();if(e){if(!s){e.writingTask=null,e.updatedAt=new Date,this.notifyChange();return}e.writingTask={...s,draftVersions:(s.draftVersions||[]).map(t=>({...t,createdAt:new Date(t.createdAt)})),stageHistory:(s.stageHistory||[]).map(t=>({...t,timestamp:new Date(t.timestamp)})),currentDraftVersionId:s.currentDraftVersionId||null,createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt)},e.updatedAt=new Date,this.notifyChange()}}clearCurrentSession(){let s=this.getCurrentSession();s&&(s.messages=[],s.updatedAt=new Date,this.notifyChange())}getCurrentMessages(){let s=this.getCurrentSession();return s?s.messages:[]}getCurrentCliSessionId(){let s=this.getCurrentSession();return s?s.sessionId:null}onChange(s){this.onChangeCallbacks.push(s)}exportForSave(){return{sessions:this.sessions,currentSessionId:this.currentSessionId}}notifyChange(){for(let s of this.onChangeCallbacks)s()}generateId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}};var G=require("child_process"),X=require("http"),Y=require("obsidian"),V=class{constructor(){this.listeners={}}on(s,e){let t=this.listeners[s];if(t){t.add(e);return}this.listeners[s]=new Set([e])}off(s,e){let t=this.listeners[s];t&&(t.delete(e),t.size===0&&delete this.listeners[s])}emit(s,...e){let t=this.listeners[s];if(t)for(let i of t)i(...e)}removeAllListeners(){this.listeners={}}},E=class E extends V{constructor(e){super();this.serverProcess=null;this.sseRequest=null;this.port=0;this.baseUrl="";this.isConnected=!1;this.reconnectTimer=null;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.sseBuffer="";this.textAccumulator=new Map;this.messageRoles=new Map;this.stopping=!1;this.vaultPath=e}static getInstance(e){return E.instance||(E.instance=new E(e)),E.instance}get connected(){return this.isConnected}get serverPort(){return this.port}async start(){if(this.serverProcess)return;this.stopping=!1;let e=null,t=3;for(let i=0;i<t;i+=1){let n=14e3+i;try{await this.startServerOnPort(n);return}catch(r){let a=r instanceof Error?r:new Error("Failed to start OpenCode server");if(e=a,console.error(`OpenCodeServer: Port ${n} failed:`,a.message),a.message.includes("ENOENT"))throw new Error("OpenCode CLI not found. Please install it: curl -fsSL https://opencode.ai/install | bash")}}throw e||new Error("Failed to start OpenCode server")}async stop(){this.stopping=!0,this.disconnectSSE(),this.textAccumulator.clear(),this.messageRoles.clear(),this.isConnected=!1,await this.killServerProcess(),this.port=0,this.baseUrl="",this.reconnectAttempts=0,this.stopping=!1}async startServerOnPort(e){var i,n,r,a;this.port=e,this.baseUrl=`http://127.0.0.1:${e}`,console.log(`OpenCodeServer: Starting on port ${e}, cwd: ${this.vaultPath}`);let t=(0,G.spawn)("opencode",["serve","--port",String(e)],{cwd:this.vaultPath,env:{...process.env,PATH:this.buildAugmentedPath()},stdio:["ignore","pipe","pipe"],windowsHide:!0});this.serverProcess=t,(i=t.stdout)==null||i.setEncoding("utf8"),(n=t.stderr)==null||n.setEncoding("utf8"),(r=t.stdout)==null||r.on("data",()=>{}),(a=t.stderr)==null||a.on("data",o=>{let l=o.toString().trim();l&&console.error("OpenCodeServer: stderr:",l)}),t.on("exit",(o,l)=>{console.error(`OpenCodeServer: Process exited (code: ${o}, signal: ${l})`)});try{await this.waitForServerReady(t)}catch(o){throw await this.stop(),o}console.log(`OpenCodeServer: Server ready on port ${e}`),await this.connectSSE()}buildAugmentedPath(){let e=process.env.HOME||process.env.USERPROFILE||"",t=e?`${e}/.opencode/bin`:"",i=process.env.PATH||"";return t&&!i.includes(t)?`${t}:${i}`:i}async waitForServerReady(e){let t=Date.now(),i=1e4,n=null,r=(o,l)=>{n=new Error(`OpenCode server exited before ready (code: ${o!=null?o:"unknown"}, signal: ${l!=null?l:"none"})`)},a=o=>{n=o};e.once("exit",r),e.once("error",a);try{for(;Date.now()-t<i;){if(n)throw n;try{await this.httpRequest("GET","/session");return}catch(o){await this.delay(500)}}}finally{e.off("exit",r),e.off("error",a)}throw n||new Error("OpenCode server did not become ready in time")}delay(e){return new Promise(t=>setTimeout(t,e))}async connectSSE(){this.disconnectSSE(),this.sseBuffer="",await new Promise((e,t)=>{let i=(0,X.request)(`${this.baseUrl}/event`,{method:"GET",headers:{Accept:"text/event-stream"}},n=>{var l;let r=(l=n.statusCode)!=null?l:0;if(r>=400){let c=new Error(`SSE connection failed with status ${r}`);this.handleSseDisconnect(c),t(c);return}let a=!1,o=c=>{a||(a=!0,this.handleSseDisconnect(c))};console.log("OpenCodeServer: SSE connected"),this.reconnectAttempts=0,this.markConnected(),n.setEncoding("utf8"),n.on("data",c=>{this.handleSseData(c.toString())}),n.once("end",()=>{o(new Error("SSE connection ended"))}),n.once("close",()=>{o(new Error("SSE connection closed"))}),n.once("error",c=>{o(c)}),e()});this.sseRequest=i,i.on("error",n=>{this.handleSseDisconnect(n),t(n)}),i.end()})}disconnectSSE(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.sseRequest&&(this.sseRequest.destroy(),this.sseRequest=null),this.sseBuffer="",this.isConnected&&(this.isConnected=!1,this.emit("disconnected"))}markConnected(){this.isConnected||(this.isConnected=!0,this.emit("connected"))}handleSseDisconnect(e){this.disconnectSSE(),!this.stopping&&(e?(console.error("OpenCodeServer: SSE disconnected",e),this.emit("error",e)):console.log("OpenCodeServer: SSE disconnected"),this.scheduleReconnect())}scheduleReconnect(){this.stopping||!this.serverProcess||this.reconnectAttempts>=this.maxReconnectAttempts||this.reconnectTimer||(this.reconnectAttempts+=1,this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connectSSE().catch(e=>{let t=e instanceof Error?e:new Error("Failed to reconnect SSE");this.handleSseDisconnect(t)})},2e3))}handleSseData(e){var i;this.sseBuffer+=e;let t=this.sseBuffer.split(/\r?\n\r?\n/);this.sseBuffer=(i=t.pop())!=null?i:"";for(let n of t){let r=n.split(/\r?\n/).filter(o=>o.startsWith("data:")).map(o=>o.replace(/^data:\s?/,""));if(r.length===0)continue;let a=r.join(`
`);this.handleSsePayload(a)}}handleSsePayload(e){try{let t=JSON.parse(e);this.handleEvent(t)}catch(t){let i=t instanceof Error?t:new Error("Failed to parse SSE payload");this.emit("error",i)}}handleEvent(e){switch(e.type){case"session.status":{let{sessionID:t,status:i}=e.properties;this.emit("session.status",t,i);break}case"session.idle":{this.emit("session.idle",e.properties.sessionID);break}case"session.error":{this.emit("session.error",e.properties.sessionID,e.properties.error);break}case"session.diff":{let{sessionID:t,diff:i}=e.properties;this.emit("diff.updated",t,i);break}case"message.updated":{let t=e.properties.info;t.role&&this.messageRoles.set(t.id,t.role),this.emit("message.updated",t);break}case"message.part.updated":{this.handlePartUpdated(e.properties.part,e.properties.delta);break}case"permission.asked":{this.emit("permission.asked",e.properties);break}case"question.asked":{this.emit("question.asked",e.properties);break}case"todo.updated":{let{sessionID:t,todos:i}=e.properties;this.emit("todo.updated",t,i);break}case"server.connected":{this.markConnected();break}default:break}}handlePartUpdated(e,t){var i,n;if(e.type==="text"){if(this.messageRoles.get(e.messageID)==="user")return;let a=e.id,o=(i=this.textAccumulator.get(a))!=null?i:"",l=o,c="";typeof t=="string"?(c=t,l=o+t):typeof e.text=="string"&&(l=e.text,e.text.startsWith(o)?c=e.text.slice(o.length):c=e.text),this.textAccumulator.set(a,l),this.emit("text.delta",e.sessionID,a,c,l),((n=e.time)==null?void 0:n.end)!==void 0&&this.emit("text.done",e.sessionID,a,l);return}if(e.type==="tool"){this.emit("tool.updated",e.sessionID,e);return}if(e.type==="step-start"){this.emit("step.start",e.sessionID,e);return}e.type==="step-finish"&&this.emit("step.finish",e.sessionID,e)}async httpRequest(e,t,i){if(!this.baseUrl)throw new Error("OpenCode server is not started");let n=`${this.baseUrl}${t}`,r={"Content-Type":"application/json"},a=i!==void 0?JSON.stringify(i):void 0,o=await(0,Y.requestUrl)({url:n,method:e,headers:r,body:a,throw:!1});if(o.status>=400)throw new Error(`HTTP ${o.status}: ${o.text||"Request failed"}`);if(!(o.status===204||o.text.trim()===""))try{return JSON.parse(o.text)}catch(l){throw l instanceof Error?l:new Error("Failed to parse JSON response")}}async createSession(e){let t=e?{permission:e}:{};return this.httpRequest("POST","/session",t)}async listSessions(){return this.httpRequest("GET","/session")}async sendMessage(e,t){let i={parts:[{type:"text",text:t}]};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/prompt_async`,i)}async getMessages(e){return this.httpRequest("GET",`/session/${encodeURIComponent(e)}/message`)}async abortSession(e){await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/abort`)}async approvePermission(e,t,i){let n={response:i};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/permissions/${encodeURIComponent(t)}`,n)}async replyToQuestion(e,t,i){let{requestId:n,answers:r}=this.normalizeQuestionReplyArgs(e,t,i),a={answers:r};await this.httpRequest("POST",`/question/${encodeURIComponent(n)}/reply`,a)}async rejectQuestion(e){await this.httpRequest("POST",`/question/${encodeURIComponent(e)}/reject`)}normalizeQuestionReplyArgs(e,t,i){if(Array.isArray(t))return{requestId:e,answers:t};if(!i)throw new Error("Question reply requires answers");return{requestId:t,answers:i}}async killServerProcess(){let e=this.serverProcess;e&&(this.serverProcess=null,await new Promise(t=>{let i=!1,n=()=>{i||(i=!0,clearTimeout(r),t())},r=setTimeout(()=>{if(!i)try{e.kill("SIGKILL")}catch(a){n()}},3e3);e.once("exit",n),e.once("close",n);try{e.kill("SIGTERM")}catch(a){n()}}))}};E.instance=null;var F=E;var O=class extends J.Plugin{constructor(){super(...arguments);this.data={sessionId:null,version:"1.0.0",sessions:[],currentSessionId:null};this.sessionManager=new W;this.server=null}async onload(){await this.loadPluginData(),this.syncBundledSkillsToVault();let e=this.getVaultPath();this.server=F.getInstance(e),this.server.start().then(()=>{var t;console.log("OpenCodeChat: Server started on port",(t=this.server)==null?void 0:t.serverPort)}).catch(t=>{console.error("OpenCodeChat: Failed to start OpenCode server:",t)}),this.registerView(p,t=>new q(t,this)),this.addRibbonIcon("message-square","Open OpenCode Chat",()=>{this.activateView()}),this.addCommand({id:"open-claude-chat",name:"Open OpenCode Chat",callback:()=>this.activateView()}),this.addCommand({id:"claude-chat-clear-history",name:"Clear chat history",hotkeys:[{modifiers:["Mod"],key:"k"}],callback:()=>this.clearChatHistory()}),this.addCommand({id:"claude-chat-focus-input",name:"Focus chat input",hotkeys:[{modifiers:["Mod"],key:"l"}],callback:()=>this.focusInput()}),this.addCommand({id:"claude-chat-stop",name:"Stop generation",hotkeys:[{modifiers:[],key:"Escape"}],callback:()=>this.stopGeneration()}),this.addCommand({id:"claude-chat-new-session",name:"Start new session",hotkeys:[{modifiers:["Mod","Shift"],key:"n"}],callback:()=>this.startNewSession()}),this.addCommand({id:"claude-chat-export",name:"Export conversation to Markdown",hotkeys:[{modifiers:["Mod","Shift"],key:"e"}],callback:()=>this.exportConversation()})}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(p)[0];if(t)e.revealLeaf(t);else{let i=e.getRightLeaf(!1);i&&await i.setViewState({type:p,active:!0})}}onunload(){this.server&&(this.server.stop(),this.server=null)}async loadPluginData(){let e=await this.loadData();if(e){if(this.data=e,!this.data.sessions||this.data.sessions.length===0){let t={id:"session-migrated",name:"Migrated Session",sessionId:this.data.sessionId,serverSessionId:null,writingTask:null,createdAt:new Date,updatedAt:new Date,messages:[]};this.data.sessions=[t],this.data.currentSessionId=t.id}this.sessionManager.loadSessions(this.data.sessions,this.data.currentSessionId),this.sessionManager.onChange(()=>{this.saveSessions()}),console.log("OpenCodeChat: Loaded data, sessions:",this.data.sessions.length)}else console.log("OpenCodeChat: No saved data found, starting fresh"),this.sessionManager.onChange(()=>{this.saveSessions()})}async saveSessions(){let e=this.sessionManager.exportForSave();this.data.sessions=e.sessions,this.data.currentSessionId=e.currentSessionId,await this.saveData(this.data)}async updateSessionId(e){this.sessionManager.updateCliSessionId(e)}getSessionId(){return this.sessionManager.getCurrentCliSessionId()}clearChatHistory(){let{workspace:e}=this.app,t=e.getLeavesOfType(p)[0];if(t){let i=t.view;i.clearHistory&&i.clearHistory()}}focusInput(){let{workspace:e}=this.app,t=e.getLeavesOfType(p)[0];if(t){let i=t.view;i.focusInput&&i.focusInput()}}stopGeneration(){let{workspace:e}=this.app,t=e.getLeavesOfType(p)[0];if(t){let i=t.view;i.handleStop&&i.handleStop()}}startNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length+1}`),{workspace:t}=this.app,i=t.getLeavesOfType(p)[0];if(i){let n=i.view;n.loadSession&&n.loadSession(e.id)}}async exportConversation(){let{workspace:e}=this.app,t=e.getLeavesOfType(p)[0];if(t){let i=t.view;i.exportConversation&&await i.exportConversation()}}getVaultPath(){return this.app.vault.adapter.basePath||""}syncBundledSkillsToVault(){let e=this.getVaultPath();if(!e)return;let t=(0,v.join)(e,".obsidian","plugins",this.manifest.id),i=(0,v.join)(t,"opencode-skills");if(!(0,g.existsSync)(i))return;let n=(0,v.join)(e,".opencode","skills");(0,g.mkdirSync)(n,{recursive:!0});let r=(0,g.readdirSync)(i,{withFileTypes:!0});for(let a of r){if(!a.isDirectory())continue;let o=(0,v.join)(i,a.name),l=(0,v.join)(o,"SKILL.md");if(!(0,g.existsSync)(l))continue;let c=(0,v.join)(n,a.name);this.copyDirectoryRecursive(o,c)}}copyDirectoryRecursive(e,t){(0,g.mkdirSync)(t,{recursive:!0});let i=(0,g.readdirSync)(e,{withFileTypes:!0});for(let n of i){let r=(0,v.join)(e,n.name),a=(0,v.join)(t,n.name);if(n.isDirectory()){this.copyDirectoryRecursive(r,a);continue}n.isFile()&&(0,g.copyFileSync)(r,a)}}};
