/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
var D=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var V=(u,t)=>{for(var e in t)D(u,e,{get:t[e],enumerable:!0})},U=(u,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of N(t))!$.call(u,n)&&n!==e&&D(u,n,{get:()=>t[n],enumerable:!(s=F(t,n))||s.enumerable});return u};var _=u=>U(D({},"__esModule",{value:!0}),u);var j={};V(j,{default:()=>I});module.exports=_(j);var q=require("obsidian"),m=require("fs"),f=require("path");var P=require("obsidian");var S=class{constructor(t,e,s,n){this.app=e;this.stopButtonEl=null;this.commandHistory=[];this.historyIndex=-1;this.tempInput="";this.mentionCandidates=[];this.mentionSelectedIndex=0;this.mentionStartIndex=-1;this.mentionEndIndex=-1;this.maxMentionResults=8;this.containerEl=t,this.onSubmit=s,this.onStop=n,this.render()}render(){let t=this.containerEl.createEl("div",{cls:"claude-chat-input-container"});this.inputWrapperEl=t.createEl("div",{cls:"claude-chat-input-wrapper"}),this.inputEl=this.inputWrapperEl.createEl("textarea",{cls:"claude-chat-input",attr:{placeholder:"Enter a command for OpenCode... (type @ to reference files)",rows:"1"}}),this.inputEl.addEventListener("input",()=>{this.autoResize(),this.updateMentionSuggestions()}),this.inputEl.addEventListener("click",()=>{this.updateMentionSuggestions()}),this.inputEl.addEventListener("keyup",e=>{(e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Home"||e.key==="End")&&this.updateMentionSuggestions()}),this.inputEl.addEventListener("blur",()=>{window.setTimeout(()=>{document.activeElement!==this.inputEl&&this.closeMentionMenu()},100)}),this.sendButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-send-button"}),this.sendButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            <span>Send</span>
        `,this.sendButtonEl.addEventListener("click",()=>{this.handleSubmit()}),this.inputEl.addEventListener("keydown",e=>{this.handleMentionKeydown(e)||(e.key==="Enter"&&!e.shiftKey?(e.preventDefault(),this.handleSubmit()):e.key==="ArrowUp"?(e.preventDefault(),this.navigateHistory(-1)):e.key==="ArrowDown"&&(e.preventDefault(),this.navigateHistory(1)))}),this.mentionMenuEl=t.createEl("div",{cls:"claude-chat-mention-menu"}),this.mentionMenuEl.style.display="none",t.addEventListener("click",e=>{(e.target===t||e.target===this.inputWrapperEl)&&this.inputEl.focus()})}createStopButton(){this.stopButtonEl||(this.stopButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-stop-button"}),this.stopButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            <span>Stop</span>
        `,this.stopButtonEl.addEventListener("click",()=>{this.onStop()}))}removeStopButton(){this.stopButtonEl&&(this.stopButtonEl.remove(),this.stopButtonEl=null)}async handleSubmit(){let t=this.inputEl.value.trim();t&&!this.sendButtonEl.disabled&&(this.commandHistory[this.commandHistory.length-1]!==t&&(this.commandHistory.push(t),this.commandHistory.length>100&&this.commandHistory.shift()),this.inputEl.value="",this.autoResize(),this.historyIndex=-1,this.tempInput="",this.closeMentionMenu(),await this.onSubmit(t))}navigateHistory(t){if(this.commandHistory.length===0)return;if(this.historyIndex===-1&&(this.tempInput=this.inputEl.value),this.historyIndex+=t,this.historyIndex<0)this.historyIndex=0;else if(this.historyIndex>=this.commandHistory.length){this.historyIndex=-1,this.setValue(this.tempInput);return}let e=this.commandHistory[this.commandHistory.length-1-this.historyIndex];this.setValue(e),this.inputEl.setSelectionRange(0,e.length)}autoResize(){this.inputEl.style.height="auto";let t=Math.min(Math.max(this.inputEl.scrollHeight,44),140);this.inputEl.style.height=`${t}px`}focus(){this.inputEl.focus()}setDisabled(t){this.inputEl.disabled=t,this.sendButtonEl.disabled=t,t&&this.closeMentionMenu()}setProcessing(t){t?(this.sendButtonEl.classList.add("claude-hidden"),this.createStopButton(),this.inputEl.disabled=!0,this.closeMentionMenu()):(this.sendButtonEl.classList.remove("claude-hidden"),this.removeStopButton(),this.inputEl.disabled=!1)}getValue(){return this.inputEl.value}setValue(t){this.inputEl.value=t,this.autoResize(),this.updateMentionSuggestions()}handleMentionKeydown(t){return this.isMentionMenuOpen()?t.key==="ArrowDown"?(t.preventDefault(),this.moveMentionSelection(1),!0):t.key==="ArrowUp"?(t.preventDefault(),this.moveMentionSelection(-1),!0):t.key==="Enter"||t.key==="Tab"?(t.preventDefault(),this.selectMention(this.mentionSelectedIndex),!0):t.key==="Escape"?(t.preventDefault(),this.closeMentionMenu(),!0):!1:!1}updateMentionSuggestions(){let t=this.getMentionContext();if(!t){this.closeMentionMenu();return}let e=this.getMentionCandidates(t.query);if(e.length===0){this.closeMentionMenu();return}this.mentionStartIndex=t.start,this.mentionEndIndex=t.end,this.mentionCandidates=e,this.mentionSelectedIndex=0,this.renderMentionMenu()}getMentionContext(){var o;if(this.inputEl.selectionStart!==this.inputEl.selectionEnd)return null;let t=(o=this.inputEl.selectionStart)!=null?o:this.inputEl.value.length,s=this.inputEl.value.slice(0,t).match(/(^|\s)@([^\s@]*)$/);if(!s)return null;let n=s[2]||"",i=t-n.length-1;return i<0?null:{start:i,end:t,query:n}}getMentionCandidates(t){let e=t.replace(/^"+/,"").replace(/"/g,"").toLowerCase(),s=this.app.vault.getFiles();return e.length===0?s.slice().sort((i,o)=>o.stat.mtime-i.stat.mtime).slice(0,this.maxMentionResults).map(i=>i.path):s.map(i=>{let o=i.path,a=o.toLowerCase(),r=i.basename.toLowerCase(),l=-1;return r===e?l=0:r.startsWith(e)?l=1:a.startsWith(e)?l=2:r.includes(e)?l=3:a.includes(e)&&(l=4),{path:o,score:l}}).filter(i=>i.score>=0).sort((i,o)=>i.score!==o.score?i.score-o.score:i.path.length!==o.path.length?i.path.length-o.path.length:i.path.localeCompare(o.path)).slice(0,this.maxMentionResults).map(i=>i.path)}renderMentionMenu(){this.mentionMenuEl.empty(),this.mentionCandidates.forEach((t,e)=>{var o;let s=(t||"").trim()||"(unknown file)",n=((o=s.split("/").pop())==null?void 0:o.trim())||s,i=this.mentionMenuEl.createEl("div",{cls:"claude-chat-mention-item"});i.setAttribute("role","option"),i.setAttribute("tabindex","-1"),i.setAttribute("aria-label",s),i.setAttribute("title",s),i.setAttribute("data-name",n),i.setAttribute("data-path",s),e===this.mentionSelectedIndex&&i.addClass("is-selected"),i.addEventListener("mouseenter",()=>{this.mentionSelectedIndex=e,this.updateMentionSelectionClasses()}),i.addEventListener("mousedown",a=>{a.preventDefault(),this.selectMention(e)})}),this.mentionMenuEl.style.display="block"}updateMentionSelectionClasses(){let t=this.mentionMenuEl.querySelectorAll(".claude-chat-mention-item");t.forEach((s,n)=>{s.classList.toggle("is-selected",n===this.mentionSelectedIndex)});let e=t[this.mentionSelectedIndex];e==null||e.scrollIntoView({block:"nearest"})}moveMentionSelection(t){if(this.mentionCandidates.length===0)return;let e=this.mentionCandidates.length;this.mentionSelectedIndex=(this.mentionSelectedIndex+t+e)%e,this.updateMentionSelectionClasses()}selectMention(t){let e=this.mentionCandidates[t];if(!e||this.mentionStartIndex<0||this.mentionEndIndex<0)return;let s=this.inputEl.value.slice(0,this.mentionStartIndex),n=this.inputEl.value.slice(this.mentionEndIndex),i=this.formatMentionText(e),o=n.length>0&&!/^\s/.test(n)?" ":"",a=`${s}${i}${o}${n}`,r=s.length+i.length+o.length;this.inputEl.value=a,this.autoResize(),this.inputEl.focus(),this.inputEl.setSelectionRange(r,r),this.closeMentionMenu()}formatMentionText(t){return/\s/.test(t)?`@"${t}"`:`@${t}`}closeMentionMenu(){this.mentionCandidates=[],this.mentionSelectedIndex=0,this.mentionStartIndex=-1,this.mentionEndIndex=-1,this.mentionMenuEl.empty(),this.mentionMenuEl.style.display="none"}isMentionMenuOpen(){return this.mentionMenuEl.style.display!=="none"&&this.mentionCandidates.length>0}};var g=require("obsidian");var y=class{constructor(t,e){this.timerInterval=null;this.isCollapsed=!0;this.part=e,this.containerEl=t.createEl("div",{cls:"claude-tool-call"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-tool-call-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.statusIconEl=this.headerEl.createEl("span",{cls:"claude-tool-call-icon"}),this.nameEl=this.headerEl.createEl("span",{cls:"claude-tool-call-name"}),this.titleEl=this.headerEl.createEl("span",{cls:"claude-tool-call-title"}),this.timerEl=this.headerEl.createEl("span",{cls:"claude-tool-call-timer"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-tool-call-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-tool-call-body"}),this.bodyEl.style.display="none";let s=this.bodyEl.createEl("div",{cls:"claude-tool-call-input"});s.createEl("div",{cls:"claude-tool-call-section-label",text:"Input"}),this.inputEl=s.createEl("pre",{cls:"claude-tool-call-code"});let n=this.bodyEl.createEl("div",{cls:"claude-tool-call-output"});n.createEl("div",{cls:"claude-tool-call-section-label",text:"Output"}),this.outputEl=n.createEl("pre",{cls:"claude-tool-call-code"}),n.style.display="none",this.update(e)}update(t){let e=this.part.state.status;this.part=t;let s=t.state;this.containerEl.classList.remove("claude-tool-call-pending","claude-tool-call-running","claude-tool-call-completed","claude-tool-call-error"),this.containerEl.classList.add(`claude-tool-call-${s.status}`),this.nameEl.setText(t.tool);let n="\u23F3",i="";s.status==="pending"?n="\u23F3":s.status==="running"?(n="\u2699\uFE0F",i=s.title||""):s.status==="completed"?(n="\u2705",i=s.title||"Completed"):s.status==="error"&&(n="\u274C",i="Error"),this.statusIconEl.setText(n),this.titleEl.setText(i),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC"),this.inputEl.setText(JSON.stringify(s.input,null,2));let o=this.outputEl.parentElement;s.status==="completed"?(o&&(o.style.display="block"),this.outputEl.setText(s.output||"")):s.status==="error"?(o&&(o.style.display="block"),this.outputEl.setText(s.error||"")):o&&(o.style.display="none"),this.handleTimer(s)}handleTimer(t){if(t.status==="running")this.timerInterval||(this.timerInterval=setInterval(()=>{let e=(Date.now()-t.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)},100));else if(t.status==="completed"||t.status==="error"){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null);let e=(t.time.end-t.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)}else this.timerEl.setText(""),this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.containerEl.remove()}};var C=class{constructor(t,e,s){this.request=e;this.onReply=s;this.buttons=[];this.resolved=!1;this.containerEl=t.createEl("div",{cls:"claude-permission-dialog"});let n=this.containerEl.createEl("div",{cls:"claude-permission-header"});n.createEl("span",{cls:"claude-permission-icon",text:"\u{1F510}"}),n.createEl("span",{cls:"claude-permission-title",text:"Permission Required"});let i=this.containerEl.createEl("div",{cls:"claude-permission-body"});i.createEl("div",{cls:"claude-permission-type",text:`${this.request.permission}: ${this.request.patterns.join(", ")}`});let o=i.createEl("div",{cls:"claude-permission-metadata"});for(let[r,l]of Object.entries(this.request.metadata)){let c=o.createEl("div",{cls:"claude-permission-meta-item"});c.createEl("strong",{text:`${r}: `});let d;typeof l=="object"&&l!==null?d=JSON.stringify(l):d=String(l),c.createEl("span",{text:d})}let a=this.containerEl.createEl("div",{cls:"claude-permission-actions"});this.createButton(a,"Allow Once","claude-permission-btn-allow",()=>{this.handleReply("once","Allowed \u2713")}),this.createButton(a,"Allow Always","claude-permission-btn-always",()=>{this.handleReply("always","Allowed Always \u2713")}),this.createButton(a,"Reject","claude-permission-btn-reject",()=>{this.handleReply("reject","Rejected \u2717")})}createButton(t,e,s,n){let i=t.createEl("button",{cls:`claude-permission-btn ${s}`,text:e});i.addEventListener("click",n),this.buttons.push(i)}handleReply(t,e){this.resolved||(this.resolve(),this.onReply(t))}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-permission-resolved"),this.buttons.forEach(t=>{t.disabled=!0})}destroy(){this.containerEl.remove()}};var w=class{constructor(t,e,s,n){this.request=e;this.onReply=s;this.onReject=n;this.resolved=!1;this.inputs=[];this.customInputs=[];this.containerEl=t.createEl("div",{cls:"claude-question-dialog"});let i=this.containerEl.createEl("div",{cls:"claude-question-header"});i.createEl("span",{cls:"claude-question-icon",text:"\u2753"}),i.createEl("span",{cls:"claude-question-title",text:"Question"}),this.request.questions.forEach((l,c)=>{this.renderQuestion(l,c)});let o=this.containerEl.createEl("div",{cls:"claude-question-actions"});o.createEl("button",{cls:"claude-question-btn claude-question-btn-submit",text:"Submit"}).addEventListener("click",()=>this.handleSubmit()),o.createEl("button",{cls:"claude-question-btn claude-question-btn-reject",text:"Skip"}).addEventListener("click",()=>{this.resolved||(this.resolve(),this.onReject())})}renderQuestion(t,e){let s=this.containerEl.createEl("div",{cls:"claude-question-item"});s.createEl("div",{cls:"claude-question-text",text:`${t.header}: ${t.question}`});let n=s.createEl("div",{cls:"claude-question-options"});if(t.options.forEach(i=>{let o=n.createEl("label",{cls:"claude-question-option"}),a=o.createEl("input",{type:t.multiple?"checkbox":"radio",attr:{name:`q-${this.request.id}-${e}`,value:i.label}});this.inputs.push(a),o.createEl("span",{cls:"claude-question-option-label",text:i.label}),i.description&&o.createEl("span",{cls:"claude-question-option-desc",text:i.description})}),t.custom){let o=s.createEl("div",{cls:"claude-question-custom"}).createEl("input",{type:"text",cls:"claude-question-custom-input",attr:{placeholder:"Type your answer...","data-q-index":String(e)}});this.customInputs.push(o)}}handleSubmit(){if(this.resolved)return;let t=[];for(let e=0;e<this.request.questions.length;e++){let s=[];this.inputs.filter(o=>o.name===`q-${this.request.id}-${e}`&&o.checked).forEach(o=>s.push(o.value));let i=this.customInputs.find(o=>o.getAttribute("data-q-index")===String(e));i&&i.value.trim()&&s.push(i.value.trim()),t.push(s)}this.resolve(),this.onReply(t)}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-question-resolved"),this.inputs.forEach(e=>e.disabled=!0),this.customInputs.forEach(e=>e.disabled=!0),this.containerEl.querySelectorAll("button").forEach(e=>e.disabled=!0)}destroy(){this.containerEl.remove()}};var M=class{constructor(t,e){this.isCollapsed=!0;this.containerEl=t.createEl("div",{cls:"claude-file-diff"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-file-diff-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.iconEl=this.headerEl.createEl("span",{cls:"claude-file-diff-icon",text:"\u0394"}),this.pathEl=this.headerEl.createEl("span",{cls:"claude-file-diff-path"}),this.statsEl=this.headerEl.createEl("span",{cls:"claude-file-diff-stats"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-file-diff-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-file-diff-body"}),this.bodyEl.style.display="none";let s=this.bodyEl.createEl("div",{cls:"claude-file-diff-table-header"});s.createEl("span",{cls:"claude-file-diff-table-title",text:"Before"}),s.createEl("span",{cls:"claude-file-diff-table-title",text:"After"}),this.tableEl=this.bodyEl.createEl("div",{cls:"claude-file-diff-table"}),this.update(e)}update(t){this.pathEl.setText(t.file),this.renderStats(t),this.renderRows(t),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.containerEl.remove()}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}renderStats(t){this.statsEl.empty(),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-additions",text:`+${t.additions}`}),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-deletions",text:`-${t.deletions}`})}renderRows(t){this.tableEl.empty();let e=this.buildDisplayRows(t.before,t.after),s=e.slice(0,800);for(let n of s)this.renderRow(n);if(e.length>800){let n=e.length-800;this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:`... omitted ${n} additional rows ...`})}e.length===0&&this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:"No textual changes."})}renderRow(t){var s;let e=this.tableEl.createEl("div",{cls:`claude-file-diff-row claude-file-diff-row-${t.type}`});if(t.type==="context"){e.createEl("div",{cls:"claude-file-diff-context",text:`... ${(s=t.hiddenCount)!=null?s:0} unchanged lines ...`});return}e.createEl("span",{cls:"claude-file-diff-line-number",text:t.beforeLineNumber!==null?String(t.beforeLineNumber):""}),e.createEl("span",{cls:"claude-file-diff-line-content",text:t.beforeText}),e.createEl("span",{cls:"claude-file-diff-line-number",text:t.afterLineNumber!==null?String(t.afterLineNumber):""}),e.createEl("span",{cls:"claude-file-diff-line-content",text:t.afterText})}buildDisplayRows(t,e){let s=this.toLines(t),n=this.toLines(e),i=this.alignLines(s,n);return this.collapseUnchanged(i)}toLines(t){if(!t)return[];let s=t.replace(/\r\n/g,`
`).split(`
`);return s.length>0&&s[s.length-1]===""&&s.pop(),s}alignLines(t,e){let n=t.length*e.length<=25e4?this.computeLcsOperations(t,e):this.computeHeuristicOperations(t,e);return this.operationsToRows(n)}computeLcsOperations(t,e){let s=t.length,n=e.length,i=n+1,o=new Uint32Array((s+1)*(n+1));for(let c=1;c<=s;c+=1)for(let d=1;d<=n;d+=1){let h=c*i+d;if(t[c-1]===e[d-1]){o[h]=o[(c-1)*i+(d-1)]+1;continue}let E=o[(c-1)*i+d],R=o[c*i+(d-1)];o[h]=E>=R?E:R}let a=[],r=s,l=n;for(;r>0&&l>0;){let c=t[r-1],d=e[l-1];if(c===d){a.push({type:"unchanged",text:c}),r-=1,l-=1;continue}let h=o[(r-1)*i+l];o[r*i+(l-1)]>h?(a.push({type:"added",text:d}),l-=1):(a.push({type:"removed",text:c}),r-=1)}for(;r>0;)a.push({type:"removed",text:t[r-1]}),r-=1;for(;l>0;)a.push({type:"added",text:e[l-1]}),l-=1;return a.reverse(),a}computeHeuristicOperations(t,e){let s=[],n=0,i=0;for(;n<t.length&&i<e.length;){let o=t[n],a=e[i];if(o===a){s.push({type:"unchanged",text:o}),n+=1,i+=1;continue}if(n+1<t.length&&t[n+1]===a){s.push({type:"removed",text:o}),n+=1;continue}if(i+1<e.length&&o===e[i+1]){s.push({type:"added",text:a}),i+=1;continue}s.push({type:"removed",text:o}),s.push({type:"added",text:a}),n+=1,i+=1}for(;n<t.length;)s.push({type:"removed",text:t[n]}),n+=1;for(;i<e.length;)s.push({type:"added",text:e[i]}),i+=1;return s}operationsToRows(t){let e=[],s=1,n=1,i=[],o=[],a=()=>{if(i.length===0&&o.length===0)return;let r=Math.min(i.length,o.length);for(let l=0;l<r;l+=1)e.push({type:"modified",beforeLineNumber:s,afterLineNumber:n,beforeText:i[l],afterText:o[l]}),s+=1,n+=1;for(let l=r;l<i.length;l+=1)e.push({type:"removed",beforeLineNumber:s,afterLineNumber:null,beforeText:i[l],afterText:""}),s+=1;for(let l=r;l<o.length;l+=1)e.push({type:"added",beforeLineNumber:null,afterLineNumber:n,beforeText:"",afterText:o[l]}),n+=1;i=[],o=[]};for(let r of t){if(r.type==="unchanged"){a(),e.push({type:"unchanged",beforeLineNumber:s,afterLineNumber:n,beforeText:r.text,afterText:r.text}),s+=1,n+=1;continue}r.type==="removed"?i.push(r.text):o.push(r.text)}return a(),e}collapseUnchanged(t){let e=[],s=-1,n=i=>{if(s<0)return;let o=t.slice(s,i);if(o.length<8)e.push(...o);else{e.push(...o.slice(0,3));let a=o.length-3*2;a>0&&e.push({type:"context",beforeLineNumber:null,afterLineNumber:null,beforeText:"",afterText:"",hiddenCount:a}),e.push(...o.slice(-3))}s=-1};return t.forEach((i,o)=>{if(i.type==="unchanged"){s<0&&(s=o);return}n(o),e.push(i)}),n(t.length),e}};var b=class{constructor(t,e){this.app=e;this.currentMessageTextEl=null;this.currentMessageBuffer="";this.currentCursorEl=null;this.currentMessageEl=null;this.currentActivitiesEl=null;this.scrollLocked=!1;this.scrollBottomButton=null;this.messages=[];this.messageElements=new Map;this.toolCallViews=new Map;this.fileDiffViews=new Map;this.activeDiffHostEl=null;this.permissionDialogs=new Map;this.questionDialogs=new Map;this.containerEl=t,this.messagesEl=this.containerEl.createEl("div",{cls:"claude-chat-messages"}),this.setupLinkClickHandler(),this.setupScrollLock(),this.setupEditHandler()}setOnEditMessage(t){this.onEditMessage=t}setupScrollLock(){this.messagesEl.addEventListener("scroll",()=>{let t=this.messagesEl.scrollHeight-this.messagesEl.scrollTop<=this.messagesEl.clientHeight+50;!t&&!this.scrollLocked?(this.scrollLocked=!0,this.showScrollBottomButton()):t&&this.scrollLocked&&(this.scrollLocked=!1,this.hideScrollBottomButton())})}showScrollBottomButton(){this.scrollBottomButton||(this.scrollBottomButton=this.containerEl.createEl("button",{cls:"claude-scroll-bottom-button"}),this.scrollBottomButton.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>New messages</span>
        `,this.scrollBottomButton.addEventListener("click",()=>{this.scrollToBottomNow()}))}hideScrollBottomButton(){this.scrollBottomButton&&(this.scrollBottomButton.remove(),this.scrollBottomButton=null)}setupLinkClickHandler(){this.messagesEl.addEventListener("click",t=>{let e=t.target,s=e.closest("a");if(s){t.preventDefault(),this.handleLinkClick(s,t);return}let n=e.closest(".internal-link");if(n){t.preventDefault(),this.handleInternalLinkClick(n,t);return}let i=e.closest("code.claude-inline-reference");i&&(t.preventDefault(),this.handleInlineReferenceClick(i,t))})}handleLinkClick(t,e){let s=t.getAttribute("href");if(!(!s||s.startsWith("#"))){if(this.isExternalHref(s)){window.open(s,"_blank");return}if(this.isModifierClick(e)){this.showFilePreview(s,e,t);return}this.tryOpenFile(s)}}handleInternalLinkClick(t,e){let s=t.getAttribute("data-href")||t.textContent;if(s){if(this.isModifierClick(e)){this.showFilePreview(s,e,t);return}this.tryOpenFile(s)}}isModifierClick(t){return t.metaKey||t.ctrlKey}isExternalHref(t){return/^(https?:\/\/|mailto:|obsidian:\/\/)/i.test(t)}showFilePreview(t,e,s){let n=this.resolveFileLink(t);if(!n){let o=this.normalizeFileLink(t);o&&new g.Notice(`File not found: ${o}`);return}let i=this.app.workspace.getActiveFile();this.app.workspace.trigger("hover-link",{event:e,source:"opencode-chat",hoverParent:this.messagesEl,targetEl:s,linktext:n.path,sourcePath:(i==null?void 0:i.path)||""})}tryOpenFile(t){let e=this.resolveFileLink(t);if(e instanceof g.TFile){this.openFileInMainPane(e);return}let s=this.normalizeFileLink(t);new g.Notice(`File not found: ${s||t}`)}resolveFileLink(t){let e=this.normalizeFileLink(t);if(!e)return null;let s=this.app.metadataCache,n=this.app.vault,i=s.getFirstLinkpathDest(e,"");return!i&&!e.endsWith(".md")&&(i=s.getFirstLinkpathDest(`${e}.md`,"")),i||(i=n.getMarkdownFiles().find(a=>{let r=a.basename.toLowerCase(),l=e.toLowerCase();return r===l||r.includes(l)})||null),i instanceof g.TFile?i:null}normalizeFileLink(t){return this.safeDecodeURIComponent(t).replace(/^\[\[/,"").replace(/\]\]$/,"").replace(/\|.*$/,"").replace(/#.*/,"").trim()}safeDecodeURIComponent(t){try{return decodeURIComponent(t)}catch(e){return t}}handleInlineReferenceClick(t,e){var i;let s=(i=t.textContent)==null?void 0:i.trim();if(!s||!this.isModifierClick(e))return;let n=this.safeDecodeURIComponent(s);if(this.isExternalHref(n)){window.open(n,"_blank");return}this.showFilePreview(n,e,t)}enhanceInlineReferences(t){t.querySelectorAll("code").forEach(s=>{var o;if(s.closest("pre"))return;let n=((o=s.textContent)==null?void 0:o.trim())||"";if(!n)return;let i=this.safeDecodeURIComponent(n);(this.isExternalHref(i)||this.looksLikeFileReference(i))&&(s.classList.add("claude-inline-reference"),s.setAttribute("title","Cmd/Ctrl + click to preview/open"))})}looksLikeFileReference(t){return!t||t.includes(`
`)||t.length>240||this.isExternalHref(t)||t.startsWith("#")||/^[a-zA-Z0-9_-]+\(\)$/.test(t)?!1:t.startsWith("./")||t.startsWith("../")||t.startsWith("/")||t.includes("/")?!0:/\.[a-zA-Z0-9_-]{1,12}$/.test(t)}openFileInMainPane(t){let e=this.app.workspace,s=e.getLeavesOfType("markdown"),n=s.length>0?s[0]:null;if(n)n.openFile(t);else{let i=e.getLeaf(!1);i&&i.openFile(t)}}addMessage(t){t.role!=="system"&&this.messages.push(t);let e=this.messagesEl.createEl("div",{cls:`claude-chat-message claude-chat-message-${t.role}`});if(t.role!=="system"){this.messageElements.set(e,t);let o=this.messages.length-1;e.dataset.messageIndex=o.toString()}let n=e.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});n.innerHTML=this.formatContent(t.content);let i=e.createEl("div",{cls:"claude-chat-message-timestamp"});return i.textContent=this.formatTime(t.timestamp),this.addMessageCopyButton(e,t.content),t.role==="user"&&this.addEditButton(e),this.scrollToBottom(),n}addMessageCopyButton(t,e){let s=t.createEl("button",{cls:"claude-message-copy-button"});s.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        `,s.addEventListener("click",async n=>{n.stopPropagation(),await navigator.clipboard.writeText(e),s.classList.add("copied"),s.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            `,setTimeout(()=>{s.classList.remove("copied"),s.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                `},2e3)})}setupEditHandler(){this.messagesEl.addEventListener("click",t=>{let s=t.target.closest(".claude-message-edit-button");if(s){t.preventDefault(),t.stopPropagation();let n=s.closest(".claude-chat-message");n&&this.enterEditMode(n)}})}addEditButton(t){let e=t.createEl("button",{cls:"claude-message-edit-button"});e.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        `}enterEditMode(t){let e=t.querySelector(".claude-chat-message-text");if(!e)return;let s=parseInt(t.dataset.messageIndex||"-1");if(s<0)return;let n=this.messages[s];if(!n)return;let i=e.createEl("textarea",{cls:"claude-message-edit-textarea"});i.value=n.content;let o=e.createEl("div",{cls:"claude-message-edit-buttons"}),a=o.createEl("button",{cls:"claude-message-edit-save",text:"Save & Resend"}),r=o.createEl("button",{cls:"claude-message-edit-cancel",text:"Cancel"});e.querySelectorAll(":scope > :not(textarea):not(.claude-message-edit-buttons)").forEach(h=>h.style.display="none"),i.focus(),i.setSelectionRange(i.value.length,i.value.length);let c=()=>{let h=i.value.trim();h&&h!==n.content?(n.content=h,e.innerHTML=this.formatContent(h),this.onEditMessage&&this.onEditMessage(s,h)):this.exitEditMode(t,e)},d=()=>{this.exitEditMode(t,e)};a.addEventListener("click",c),r.addEventListener("click",d),i.addEventListener("keydown",h=>{h.key==="Enter"&&!h.shiftKey?(h.preventDefault(),c()):h.key==="Escape"&&(h.preventDefault(),d())})}exitEditMode(t,e){let s=e.querySelector(".claude-message-edit-textarea"),n=e.querySelector(".claude-message-edit-buttons");s&&s.remove(),n&&n.remove(),e.querySelectorAll(":scope > *").forEach(o=>o.style.display="")}addUserMessage(t){return this.addMessage({role:"user",content:t,timestamp:new Date})}createAssistantMessage(){let t=this.messagesEl.createEl("div",{cls:"claude-chat-message claude-chat-message-assistant"});this.currentMessageEl=t,this.fileDiffViews.clear(),this.activeDiffHostEl=null;let e=t.createEl("div",{cls:"claude-chat-message-activities"});this.currentActivitiesEl=e;let n=t.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});this.addThinkingIndicator(n);let i=t.createEl("div",{cls:"claude-chat-message-timestamp"});return i.textContent=this.formatTime(new Date),this.currentMessageTextEl=n,this.currentMessageBuffer="",this.scrollToBottom(),n}appendToAssistantMessage(t){this.currentMessageTextEl&&(this.removeThinkingIndicator(),this.currentMessageBuffer+=t,this.currentMessageTextEl.textContent=this.currentMessageBuffer,this.addTypingCursor(),this.scrollToBottom())}finalizeAssistantMessage(){if(this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentMessageBuffer)){this.currentMessageBuffer.endsWith(`
`)||(this.currentMessageBuffer+=`
`),this.currentMessageTextEl.empty();let t=this.app.workspace.getActiveFile(),e=(t==null?void 0:t.path)||"";g.MarkdownRenderer.renderMarkdown(this.currentMessageBuffer,this.currentMessageTextEl,e,new g.Component),this.enhanceInlineReferences(this.currentMessageTextEl),this.addCopyButtonsToCodeBlocks(this.currentMessageTextEl),this.messages.push({role:"assistant",content:this.currentMessageBuffer,timestamp:new Date})}this.currentMessageEl&&this.addMessageCopyButton(this.currentMessageEl,this.currentMessageBuffer),this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentMessageEl=null,this.currentActivitiesEl=null}addCopyButtonsToCodeBlocks(t){t.querySelectorAll("pre").forEach(s=>{if(s.querySelector(".claude-code-copy-button"))return;let n=s.createEl("button",{cls:"claude-code-copy-button"});n.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span>Copy</span>
            `,n.addEventListener("click",async()=>{let i=s.querySelector("code");if(i){let o=i.textContent||"";await navigator.clipboard.writeText(o),n.classList.add("copied"),n.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>Copied!</span>
                    `,setTimeout(()=>{n.classList.remove("copied"),n.innerHTML=`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copy</span>
                        `},2e3)}})})}showThinking(){this.currentMessageTextEl&&!this.currentMessageBuffer&&this.addThinkingIndicator(this.currentMessageTextEl)}hideThinking(){this.removeThinkingIndicator()}addThinkingIndicator(t){if(t.querySelector(".claude-chat-message-thinking"))return;let s=t.createEl("div",{cls:"claude-chat-message-thinking"}),n=s.createEl("div",{cls:"claude-thinking-dots"});for(let o=0;o<3;o++)n.createEl("span",{cls:"claude-thinking-dot"});let i=s.createEl("span",{cls:"claude-thinking-text",text:"Thinking"})}removeThinkingIndicator(){if(this.currentMessageTextEl){let t=this.currentMessageTextEl.querySelector(".claude-chat-message-thinking");t&&t.remove()}}addTypingCursor(){this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentCursorEl=this.currentMessageTextEl.createEl("span",{cls:"claude-typing-cursor"}))}removeTypingCursor(){this.currentCursorEl&&(this.currentCursorEl.remove(),this.currentCursorEl=null)}formatContent(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}formatTime(t){return t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}scrollToBottom(){this.scrollLocked||(this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}scrollToBottomNow(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight,this.scrollLocked=!1,this.hideScrollBottomButton()}addToolCall(t){let e=this.toolCallViews.get(t.id);if(e)return e.update(t),e;let s=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl,n=new y(s,t);return this.toolCallViews.set(t.id,n),this.scrollToBottom(),n}addFileDiffs(t,e){if(e.length===0)return;let s=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl;this.activeDiffHostEl!==s&&(this.fileDiffViews.clear(),this.activeDiffHostEl=s);for(let i of e){let o=`${t}:${i.file}`,a=this.fileDiffViews.get(o);if(a){a.update(i);continue}let r=new M(s,i);this.fileDiffViews.set(o,r)}this.scrollToBottom()}addPermissionDialog(t,e){let s=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl,n=new C(s,t,e);return this.permissionDialogs.set(t.id,n),this.scrollToBottom(),n}addQuestionDialog(t,e,s){let n=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl,i=new w(n,t,e,s);return this.questionDialogs.set(t.id,i),this.scrollToBottom(),i}addStepIndicator(t){let e=this.currentActivitiesEl||this.currentMessageEl||this.messagesEl;if(t.type==="step-start"){let s=e.createEl("div",{cls:"claude-step-indicator claude-step-start"});s.createEl("span",{cls:"claude-step-icon",text:"\u25B6"}),s.createEl("span",{cls:"claude-step-label",text:t.step||"Step started"})}else{let s=e.createEl("div",{cls:"claude-step-indicator claude-step-finish"});s.createEl("span",{cls:"claude-step-icon",text:"\u25A0"});let n=t.reason||"Step finished";if(t.tokens){let i=t.tokens.input+t.tokens.output;n+=` (${i} tokens)`}t.cost!==void 0&&(n+=` \xB7 $${t.cost.toFixed(4)}`),s.createEl("span",{cls:"claude-step-label",text:n})}this.scrollToBottom()}clear(){for(let t of this.toolCallViews.values())t.destroy();this.toolCallViews.clear();for(let t of this.fileDiffViews.values())t.destroy();this.fileDiffViews.clear(),this.activeDiffHostEl=null;for(let t of this.permissionDialogs.values())t.destroy();this.permissionDialogs.clear();for(let t of this.questionDialogs.values())t.destroy();this.questionDialogs.clear(),this.messagesEl.empty(),this.messages=[],this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentActivitiesEl=null,this.scrollLocked=!1,this.hideScrollBottomButton()}getMessages(){return[...this.messages]}removeMessagesAfter(t){this.messages=this.messages.slice(0,t+1),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((n,i)=>{i>t&&n.remove()}),this.messageElements.clear(),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((n,i)=>{i<this.messages.length&&(this.messageElements.set(n,this.messages[i]),n.dataset.messageIndex=i.toString())})}};var x=class{constructor(t,e){this.sessions=[];this.currentSessionId=null;this.containerEl=t,this.onSessionSelect=e.onSessionSelect,this.onNewSession=e.onNewSession,this.onSessionDelete=e.onSessionDelete,this.onSessionRename=e.onSessionRename,this.render()}updateSessions(t,e){this.sessions=t,this.currentSessionId=e,this.render()}render(){this.containerEl.empty(),this.containerEl.addClass("claude-session-tabs");let t=this.containerEl.createEl("div",{cls:"claude-session-tabs-container"}),s=t.createEl("div",{cls:"claude-session-tabs-scroll"}).createEl("div",{cls:"claude-session-tabs-list"});if(this.sessions.length===0){let i=s.createEl("div",{cls:"claude-session-tabs-empty"});i.textContent="No sessions"}else for(let i of this.sessions){let o=this.createTab(i);s.appendChild(o)}let n=t.createEl("button",{cls:"claude-session-tab-new"});n.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"></path>
            </svg>
        `,n.setAttribute("aria-label","New session"),n.addEventListener("click",()=>{this.onNewSession&&this.onNewSession()})}createTab(t){let e=t.id===this.currentSessionId,s=document.createElement("div");s.className="claude-session-tab",e&&s.classList.add("claude-session-tab-active");let n=s.createEl("div",{cls:"claude-session-tab-content"}),i=n.createEl("span",{cls:"claude-session-tab-name"});if(i.textContent=t.name,this.sessions.length>1){let o=n.createEl("button",{cls:"claude-session-tab-close"});o.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            `,o.setAttribute("aria-label","Close session"),o.addEventListener("click",a=>{a.stopPropagation(),this.confirmClose(t.id)})}return n.addEventListener("click",()=>{this.onSessionSelect&&!e&&this.onSessionSelect(t.id)}),n.addEventListener("dblclick",()=>{this.promptRename(t.id)}),s}promptRename(t){let e=this.sessions.find(n=>n.id===t);if(!e)return;let s=prompt("Enter session name:",e.name);s&&s.trim()&&s!==e.name&&this.onSessionRename&&this.onSessionRename(t,s.trim())}confirmClose(t){let e=this.sessions.find(s=>s.id===t);e&&this.sessions.length!==1&&confirm(`Close session "${e.name}"?`)&&this.onSessionDelete&&this.onSessionDelete(t)}};var p="claude-chat-view";var Q=[{permission:"bash",pattern:"*",action:"ask"},{permission:"write",pattern:"*",action:"ask"},{permission:"edit",pattern:"*",action:"ask"}],T=class extends P.ItemView{constructor(e,s){super(e);this.isProcessing=!1;this.statusBadgeEl=null;this.plugin=s,this.sessionManager=s.sessionManager,this.boundHandlers={onTextDelta:this.handleTextDelta.bind(this),onSessionIdle:this.handleSessionIdle.bind(this),onSessionStatus:this.handleSessionStatus.bind(this),onSessionError:this.handleSessionError.bind(this),onToolUpdated:this.handleToolUpdated.bind(this),onDiffUpdated:this.handleDiffUpdated.bind(this),onPermissionAsked:this.handlePermissionAsked.bind(this),onQuestionAsked:this.handleQuestionAsked.bind(this),onStepStart:this.handleStepStart.bind(this),onStepFinish:this.handleStepFinish.bind(this),onConnected:this.handleConnected.bind(this),onDisconnected:this.handleDisconnected.bind(this),onError:this.handleError.bind(this)}}getViewType(){return p}getDisplayText(){return"OpenCode Chat"}getIcon(){return"message-square"}get server(){return this.plugin.server}get currentServerSessionId(){return this.sessionManager.getCurrentServerSessionId()}isCurrentSession(e){return this.currentServerSessionId===e}async onOpen(){var a;let e=this.containerEl.children[1];e.empty(),e.addClass("claude-chat-container");let n=e.createEl("div",{cls:"claude-chat-main-layout"}).createEl("div",{cls:"claude-chat-content"}),i=n.createEl("div",{cls:"claude-session-tabs-wrapper"});this.sessionTabs=new x(i,{onSessionSelect:r=>this.loadSession(r),onNewSession:()=>this.createNewSession(),onSessionDelete:r=>this.deleteSession(r),onSessionRename:(r,l)=>this.renameSession(r,l)}),this.updateSessionList(),this.statusBadgeEl=n.createEl("div",{cls:"claude-server-status claude-server-status-connecting"}),this.statusBadgeEl.setText("Connecting..."),this.messageContainer=new b(n,this.app),this.messageContainer.setOnEditMessage(async(r,l)=>{await this.handleEditMessage(r,l)}),this.loadCurrentSessionMessages();let o=n.createEl("div",{cls:"claude-chat-input-actions"});this.createActionButton(o,"Export","Export conversation to Markdown (Ctrl+Shift+E)",()=>this.exportConversation()),this.createActionButton(o,"Clear","Clear chat history (Ctrl+K)",()=>this.clearHistory()),this.createActionButton(o,"Regenerate","Regenerate last response",()=>this.regenerateLast()),this.chatInput=new S(n,this.app,async r=>{await this.handleCommand(r)},()=>{this.handleStop()}),this.subscribeToServer(),(a=this.server)!=null&&a.connected&&this.updateStatusBadge(!0)}createActionButton(e,s,n,i){let o=e.createEl("button",{cls:"claude-chat-action-button"});o.textContent=s,o.setAttribute("aria-label",n),o.setAttribute("title",n),o.addEventListener("click",i)}subscribeToServer(){let e=this.server;e&&(e.on("text.delta",this.boundHandlers.onTextDelta),e.on("session.idle",this.boundHandlers.onSessionIdle),e.on("session.status",this.boundHandlers.onSessionStatus),e.on("session.error",this.boundHandlers.onSessionError),e.on("tool.updated",this.boundHandlers.onToolUpdated),e.on("diff.updated",this.boundHandlers.onDiffUpdated),e.on("permission.asked",this.boundHandlers.onPermissionAsked),e.on("question.asked",this.boundHandlers.onQuestionAsked),e.on("step.start",this.boundHandlers.onStepStart),e.on("step.finish",this.boundHandlers.onStepFinish),e.on("connected",this.boundHandlers.onConnected),e.on("disconnected",this.boundHandlers.onDisconnected),e.on("error",this.boundHandlers.onError))}unsubscribeFromServer(){let e=this.server;e&&(e.off("text.delta",this.boundHandlers.onTextDelta),e.off("session.idle",this.boundHandlers.onSessionIdle),e.off("session.status",this.boundHandlers.onSessionStatus),e.off("session.error",this.boundHandlers.onSessionError),e.off("tool.updated",this.boundHandlers.onToolUpdated),e.off("diff.updated",this.boundHandlers.onDiffUpdated),e.off("permission.asked",this.boundHandlers.onPermissionAsked),e.off("question.asked",this.boundHandlers.onQuestionAsked),e.off("step.start",this.boundHandlers.onStepStart),e.off("step.finish",this.boundHandlers.onStepFinish),e.off("connected",this.boundHandlers.onConnected),e.off("disconnected",this.boundHandlers.onDisconnected),e.off("error",this.boundHandlers.onError))}handleTextDelta(e,s,n,i){this.isCurrentSession(e)&&this.messageContainer.appendToAssistantMessage(n)}handleSessionIdle(e){if(!this.isCurrentSession(e))return;this.messageContainer.finalizeAssistantMessage();let s=this.messageContainer.getMessages(),n=s[s.length-1];n&&n.role==="assistant"&&this.sessionManager.addMessage(n),this.updateSessionList(),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}handleSessionStatus(e,s){this.isCurrentSession(e)&&s.type==="busy"&&(this.isProcessing=!0,this.chatInput.setProcessing(!0))}handleSessionError(e,s){if(e&&!this.isCurrentSession(e))return;let n=(s==null?void 0:s.message)||"Unknown error";console.error("OpenCodeChatView: Session error:",n),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${n}`),this.messageContainer.finalizeAssistantMessage();let i=this.messageContainer.getMessages(),o=i[i.length-1];o&&o.role==="assistant"&&this.sessionManager.addMessage(o),this.isProcessing=!1,this.chatInput.setProcessing(!1)}handleToolUpdated(e,s){this.isCurrentSession(e)&&this.messageContainer.addToolCall(s)}handleDiffUpdated(e,s){this.isCurrentSession(e)&&this.messageContainer.addFileDiffs(e,s)}handlePermissionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let s=this.server;s&&this.messageContainer.addPermissionDialog(e,n=>{s.approvePermission(e.sessionID,e.id,n).catch(i=>{console.error("OpenCodeChatView: Failed to reply to permission:",i)})})}handleQuestionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let s=this.server;s&&this.messageContainer.addQuestionDialog(e,n=>{s.replyToQuestion(e.sessionID,e.id,n).catch(i=>{console.error("OpenCodeChatView: Failed to reply to question:",i)})},()=>{s.rejectQuestion(e.id).catch(n=>{console.error("OpenCodeChatView: Failed to reject question:",n)})})}handleStepStart(e,s){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(s)}handleStepFinish(e,s){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(s)}handleConnected(){this.updateStatusBadge(!0)}handleDisconnected(){this.updateStatusBadge(!1)}handleError(e){console.error("OpenCodeChatView: Server error:",e)}updateStatusBadge(e){this.statusBadgeEl&&(this.statusBadgeEl.classList.remove("claude-server-status-connected","claude-server-status-disconnected","claude-server-status-connecting"),e?(this.statusBadgeEl.classList.add("claude-server-status-connected"),this.statusBadgeEl.setText("Connected")):(this.statusBadgeEl.classList.add("claude-server-status-disconnected"),this.statusBadgeEl.setText("Disconnected")))}loadCurrentSessionMessages(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - Enter commands to interact with OpenCode\n\n**Keyboard Shortcuts:**\n\u2022 `Ctrl+Shift+N` - New session\n\u2022 `Ctrl+Shift+E` - Export conversation\n\u2022 `Ctrl+K` - Clear history\n\u2022 `Ctrl+L` - Focus input\n\u2022 `\u2191/\u2193` - Browse command history\n\u2022 `Shift+Enter` - New line\n\u2022 `Escape` - Stop generation\n\n**Tips:**\n\u2022 Click on user messages to edit and resend\n\u2022 Hover over messages to copy content\n\u2022 Type `@` in input to reference vault files\n\u2022 Use the toolbar buttons for quick actions\n\u2022 Tool calls and permissions will appear inline",timestamp:new Date});else for(let s of e)this.messageContainer.addMessage(s)}updateSessionList(){var e;this.sessionTabs.updateSessions(this.sessionManager.getSessions(),((e=this.sessionManager.getCurrentSession())==null?void 0:e.id)||null)}async handleCommand(e){if(!this.isProcessing){if(!this.server){console.error("OpenCodeChatView: Server not available");return}this.isProcessing=!0,this.chatInput.setProcessing(!0),this.messageContainer.addUserMessage(e),this.sessionManager.addMessage({role:"user",content:e,timestamp:new Date}),this.messageContainer.createAssistantMessage();try{let s=this.currentServerSessionId;s||(s=(await this.server.createSession(Q)).id,this.sessionManager.updateServerSessionId(s)),await this.server.sendMessage(s,e)}catch(s){console.error("OpenCodeChatView: Command error:",s),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${s.message}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),i=n[n.length-1];i&&i.role==="assistant"&&this.sessionManager.addMessage(i),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}}}handleStop(){if(!this.isProcessing)return;let e=this.currentServerSessionId;e&&this.server&&this.server.abortSession(e).catch(s=>{console.error("OpenCodeChatView: Failed to abort session:",s)}),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

_Stopped by user_`),this.messageContainer.finalizeAssistantMessage(),this.isProcessing=!1,this.chatInput.setProcessing(!1)}clearHistory(){this.sessionManager.clearCurrentSession(),this.messageContainer.clear(),this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - History cleared",timestamp:new Date}),this.updateSessionList()}focusInput(){this.chatInput.focus()}loadSession(e){if(!this.sessionManager.switchSession(e)){console.error("OpenCodeChatView: Failed to switch to session:",e);return}this.messageContainer.clear(),this.loadCurrentSessionMessages(),this.updateSessionList(),this.chatInput.focus()}createNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length}`);this.loadSession(e.id)}deleteSession(e){if(!this.sessionManager.deleteSession(e)){console.error("OpenCodeChatView: Failed to delete session:",e);return}let n=this.sessionManager.getCurrentSession();n?this.loadSession(n.id):this.createNewSession()}renameSession(e,s){this.sessionManager.updateSessionName(e,s)&&this.updateSessionList()}async exportConversation(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)return;let s=this.sessionManager.getCurrentSession(),n=(s==null?void 0:s.name)||"Conversation",i=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),a=`opencode-chat-${n.replace(/[^a-zA-Z0-9]/g,"-")}-${i}.md`,r=`# OpenCode Chat Conversation

`;r+=`**Session:** ${n}

`,r+=`*Exported: ${new Date().toLocaleString()}*

`,r+=`*Server Session ID: ${(s==null?void 0:s.serverSessionId)||"N/A"}*

`,r+=`---

`;for(let d of e){if(d.role==="system")continue;let h=d.role==="user"?"\u{1F464} User":"\u{1F916} Assistant",E=d.timestamp.toLocaleTimeString();r+=`## ${h}

`,r+=`*${E}*

`,r+=`${d.content}

`,r+=`---

`}let l=this.app.vault;await l.create(a,r),l.getAbstractFileByPath(a)&&await this.app.workspace.openLinkText(a,"",!0)}async handleEditMessage(e,s){this.messageContainer.removeMessagesAfter(e),await this.handleCommand(s)}async regenerateLast(){let e=this.messageContainer.getMessages(),s=-1;for(let n=e.length-1;n>=0;n--)if(e[n].role==="user"){s=n;break}s>=0&&(this.messageContainer.removeMessagesAfter(s-1),await this.handleCommand(e[s].content))}async onClose(){this.unsubscribeFromServer()}};var k=class{constructor(){this.sessions=[];this.currentSessionId=null;this.onChangeCallbacks=[];this.loadSessions()}loadSessions(t=[],e=null){this.sessions=t.map(s=>({...s,createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt),messages:s.messages.map(n=>({...n,timestamp:new Date(n.timestamp)}))})),this.currentSessionId=e,this.sessions.length===0?this.createSession("Default Session"):this.currentSessionId||(this.currentSessionId=this.sessions[0].id)}getSessions(){return[...this.sessions]}getCurrentSession(){return this.currentSessionId&&this.sessions.find(t=>t.id===this.currentSessionId)||null}getSession(t){return this.sessions.find(e=>e.id===t)||null}createSession(t){let e={id:this.generateId(),name:t,sessionId:null,serverSessionId:null,createdAt:new Date,updatedAt:new Date,messages:[]};return this.sessions.push(e),this.currentSessionId=e.id,this.notifyChange(),e}updateSessionName(t,e){let s=this.getSession(t);return s?(s.name=e,s.updatedAt=new Date,this.notifyChange(),!0):!1}deleteSession(t){let e=this.sessions.findIndex(s=>s.id===t);return e!==-1?(this.sessions.splice(e,1),this.currentSessionId===t&&(this.currentSessionId=this.sessions.length>0?this.sessions[0].id:null,this.sessions.length===0&&this.createSession("Default Session")),this.notifyChange(),!0):!1}switchSession(t){return this.getSession(t)?(this.currentSessionId=t,this.notifyChange(),!0):!1}addMessage(t){let e=this.getCurrentSession();e&&(e.messages.push(t),e.updatedAt=new Date,this.notifyChange())}updateCliSessionId(t){let e=this.getCurrentSession();e&&(e.sessionId=t,e.updatedAt=new Date,this.notifyChange())}updateServerSessionId(t){let e=this.getCurrentSession();e&&(e.serverSessionId=t,e.updatedAt=new Date,this.notifyChange())}getCurrentServerSessionId(){let t=this.getCurrentSession();return t?t.serverSessionId:null}clearCurrentSession(){let t=this.getCurrentSession();t&&(t.messages=[],t.updatedAt=new Date,this.notifyChange())}getCurrentMessages(){let t=this.getCurrentSession();return t?t.messages:[]}getCurrentCliSessionId(){let t=this.getCurrentSession();return t?t.sessionId:null}onChange(t){this.onChangeCallbacks.push(t)}exportForSave(){return{sessions:this.sessions,currentSessionId:this.currentSessionId}}notifyChange(){for(let t of this.onChangeCallbacks)t()}generateId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}};var A=require("child_process"),B=require("http"),O=require("obsidian"),H=class{constructor(){this.listeners={}}on(t,e){let s=this.listeners[t];if(s){s.add(e);return}this.listeners[t]=new Set([e])}off(t,e){let s=this.listeners[t];s&&(s.delete(e),s.size===0&&delete this.listeners[t])}emit(t,...e){let s=this.listeners[t];if(s)for(let n of s)n(...e)}removeAllListeners(){this.listeners={}}},v=class v extends H{constructor(e){super();this.serverProcess=null;this.sseRequest=null;this.port=0;this.baseUrl="";this.isConnected=!1;this.reconnectTimer=null;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.sseBuffer="";this.textAccumulator=new Map;this.messageRoles=new Map;this.stopping=!1;this.vaultPath=e}static getInstance(e){return v.instance||(v.instance=new v(e)),v.instance}get connected(){return this.isConnected}get serverPort(){return this.port}async start(){if(this.serverProcess)return;this.stopping=!1;let e=null,s=3;for(let n=0;n<s;n+=1){let i=14e3+n;try{await this.startServerOnPort(i);return}catch(o){let a=o instanceof Error?o:new Error("Failed to start OpenCode server");if(e=a,console.error(`OpenCodeServer: Port ${i} failed:`,a.message),a.message.includes("ENOENT"))throw new Error("OpenCode CLI not found. Please install it: curl -fsSL https://opencode.ai/install | bash")}}throw e||new Error("Failed to start OpenCode server")}async stop(){this.stopping=!0,this.disconnectSSE(),this.textAccumulator.clear(),this.messageRoles.clear(),this.isConnected=!1,await this.killServerProcess(),this.port=0,this.baseUrl="",this.reconnectAttempts=0,this.stopping=!1}async startServerOnPort(e){var n,i,o,a;this.port=e,this.baseUrl=`http://127.0.0.1:${e}`,console.log(`OpenCodeServer: Starting on port ${e}, cwd: ${this.vaultPath}`);let s=(0,A.spawn)("opencode",["serve","--port",String(e)],{cwd:this.vaultPath,env:{...process.env,PATH:this.buildAugmentedPath()},stdio:["ignore","pipe","pipe"],windowsHide:!0});this.serverProcess=s,(n=s.stdout)==null||n.setEncoding("utf8"),(i=s.stderr)==null||i.setEncoding("utf8"),(o=s.stdout)==null||o.on("data",()=>{}),(a=s.stderr)==null||a.on("data",r=>{let l=r.toString().trim();l&&console.error("OpenCodeServer: stderr:",l)}),s.on("exit",(r,l)=>{console.error(`OpenCodeServer: Process exited (code: ${r}, signal: ${l})`)});try{await this.waitForServerReady(s)}catch(r){throw await this.stop(),r}console.log(`OpenCodeServer: Server ready on port ${e}`),await this.connectSSE()}buildAugmentedPath(){let e=process.env.HOME||process.env.USERPROFILE||"",s=e?`${e}/.opencode/bin`:"",n=process.env.PATH||"";return s&&!n.includes(s)?`${s}:${n}`:n}async waitForServerReady(e){let s=Date.now(),n=1e4,i=null,o=(r,l)=>{i=new Error(`OpenCode server exited before ready (code: ${r!=null?r:"unknown"}, signal: ${l!=null?l:"none"})`)},a=r=>{i=r};e.once("exit",o),e.once("error",a);try{for(;Date.now()-s<n;){if(i)throw i;try{await this.httpRequest("GET","/session");return}catch(r){await this.delay(500)}}}finally{e.off("exit",o),e.off("error",a)}throw i||new Error("OpenCode server did not become ready in time")}delay(e){return new Promise(s=>setTimeout(s,e))}async connectSSE(){this.disconnectSSE(),this.sseBuffer="",await new Promise((e,s)=>{let n=(0,B.request)(`${this.baseUrl}/event`,{method:"GET",headers:{Accept:"text/event-stream"}},i=>{var l;let o=(l=i.statusCode)!=null?l:0;if(o>=400){let c=new Error(`SSE connection failed with status ${o}`);this.handleSseDisconnect(c),s(c);return}let a=!1,r=c=>{a||(a=!0,this.handleSseDisconnect(c))};console.log("OpenCodeServer: SSE connected"),this.reconnectAttempts=0,this.markConnected(),i.setEncoding("utf8"),i.on("data",c=>{this.handleSseData(c.toString())}),i.once("end",()=>{r(new Error("SSE connection ended"))}),i.once("close",()=>{r(new Error("SSE connection closed"))}),i.once("error",c=>{r(c)}),e()});this.sseRequest=n,n.on("error",i=>{this.handleSseDisconnect(i),s(i)}),n.end()})}disconnectSSE(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.sseRequest&&(this.sseRequest.destroy(),this.sseRequest=null),this.sseBuffer="",this.isConnected&&(this.isConnected=!1,this.emit("disconnected"))}markConnected(){this.isConnected||(this.isConnected=!0,this.emit("connected"))}handleSseDisconnect(e){this.disconnectSSE(),!this.stopping&&(e?(console.error("OpenCodeServer: SSE disconnected",e),this.emit("error",e)):console.log("OpenCodeServer: SSE disconnected"),this.scheduleReconnect())}scheduleReconnect(){this.stopping||!this.serverProcess||this.reconnectAttempts>=this.maxReconnectAttempts||this.reconnectTimer||(this.reconnectAttempts+=1,this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connectSSE().catch(e=>{let s=e instanceof Error?e:new Error("Failed to reconnect SSE");this.handleSseDisconnect(s)})},2e3))}handleSseData(e){var n;this.sseBuffer+=e;let s=this.sseBuffer.split(/\r?\n\r?\n/);this.sseBuffer=(n=s.pop())!=null?n:"";for(let i of s){let o=i.split(/\r?\n/).filter(r=>r.startsWith("data:")).map(r=>r.replace(/^data:\s?/,""));if(o.length===0)continue;let a=o.join(`
`);this.handleSsePayload(a)}}handleSsePayload(e){try{let s=JSON.parse(e);this.handleEvent(s)}catch(s){let n=s instanceof Error?s:new Error("Failed to parse SSE payload");this.emit("error",n)}}handleEvent(e){switch(e.type){case"session.status":{let{sessionID:s,status:n}=e.properties;this.emit("session.status",s,n);break}case"session.idle":{this.emit("session.idle",e.properties.sessionID);break}case"session.error":{this.emit("session.error",e.properties.sessionID,e.properties.error);break}case"session.diff":{let{sessionID:s,diff:n}=e.properties;this.emit("diff.updated",s,n);break}case"message.updated":{let s=e.properties.info;s.role&&this.messageRoles.set(s.id,s.role),this.emit("message.updated",s);break}case"message.part.updated":{this.handlePartUpdated(e.properties.part,e.properties.delta);break}case"permission.asked":{this.emit("permission.asked",e.properties);break}case"question.asked":{this.emit("question.asked",e.properties);break}case"todo.updated":{let{sessionID:s,todos:n}=e.properties;this.emit("todo.updated",s,n);break}case"server.connected":{this.markConnected();break}default:break}}handlePartUpdated(e,s){var n,i;if(e.type==="text"){if(this.messageRoles.get(e.messageID)==="user")return;let a=e.id,r=(n=this.textAccumulator.get(a))!=null?n:"",l=r,c="";typeof s=="string"?(c=s,l=r+s):typeof e.text=="string"&&(l=e.text,e.text.startsWith(r)?c=e.text.slice(r.length):c=e.text),this.textAccumulator.set(a,l),this.emit("text.delta",e.sessionID,a,c,l),((i=e.time)==null?void 0:i.end)!==void 0&&this.emit("text.done",e.sessionID,a,l);return}if(e.type==="tool"){this.emit("tool.updated",e.sessionID,e);return}if(e.type==="step-start"){this.emit("step.start",e.sessionID,e);return}e.type==="step-finish"&&this.emit("step.finish",e.sessionID,e)}async httpRequest(e,s,n){if(!this.baseUrl)throw new Error("OpenCode server is not started");let i=`${this.baseUrl}${s}`,o={"Content-Type":"application/json"},a=n!==void 0?JSON.stringify(n):void 0,r=await(0,O.requestUrl)({url:i,method:e,headers:o,body:a,throw:!1});if(r.status>=400)throw new Error(`HTTP ${r.status}: ${r.text||"Request failed"}`);if(!(r.status===204||r.text.trim()===""))try{return JSON.parse(r.text)}catch(l){throw l instanceof Error?l:new Error("Failed to parse JSON response")}}async createSession(e){let s=e?{permission:e}:{};return this.httpRequest("POST","/session",s)}async listSessions(){return this.httpRequest("GET","/session")}async sendMessage(e,s){let n={parts:[{type:"text",text:s}]};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/prompt_async`,n)}async getMessages(e){return this.httpRequest("GET",`/session/${encodeURIComponent(e)}/message`)}async abortSession(e){await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/abort`)}async approvePermission(e,s,n){let i={response:n};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/permissions/${encodeURIComponent(s)}`,i)}async replyToQuestion(e,s,n){let{requestId:i,answers:o}=this.normalizeQuestionReplyArgs(e,s,n),a={answers:o};await this.httpRequest("POST",`/question/${encodeURIComponent(i)}/reply`,a)}async rejectQuestion(e){await this.httpRequest("POST",`/question/${encodeURIComponent(e)}/reject`)}normalizeQuestionReplyArgs(e,s,n){if(Array.isArray(s))return{requestId:e,answers:s};if(!n)throw new Error("Question reply requires answers");return{requestId:s,answers:n}}async killServerProcess(){let e=this.serverProcess;e&&(this.serverProcess=null,await new Promise(s=>{let n=!1,i=()=>{n||(n=!0,clearTimeout(o),s())},o=setTimeout(()=>{if(!n)try{e.kill("SIGKILL")}catch(a){i()}},3e3);e.once("exit",i),e.once("close",i);try{e.kill("SIGTERM")}catch(a){i()}}))}};v.instance=null;var L=v;var I=class extends q.Plugin{constructor(){super(...arguments);this.data={sessionId:null,version:"1.0.0",sessions:[],currentSessionId:null};this.sessionManager=new k;this.server=null}async onload(){await this.loadPluginData(),this.syncBundledSkillsToVault();let e=this.getVaultPath();this.server=L.getInstance(e),this.server.start().then(()=>{var s;console.log("OpenCodeChat: Server started on port",(s=this.server)==null?void 0:s.serverPort)}).catch(s=>{console.error("OpenCodeChat: Failed to start OpenCode server:",s)}),this.registerView(p,s=>new T(s,this)),this.addRibbonIcon("message-square","Open OpenCode Chat",()=>{this.activateView()}),this.addCommand({id:"open-claude-chat",name:"Open OpenCode Chat",callback:()=>this.activateView()}),this.addCommand({id:"claude-chat-clear-history",name:"Clear chat history",hotkeys:[{modifiers:["Mod"],key:"k"}],callback:()=>this.clearChatHistory()}),this.addCommand({id:"claude-chat-focus-input",name:"Focus chat input",hotkeys:[{modifiers:["Mod"],key:"l"}],callback:()=>this.focusInput()}),this.addCommand({id:"claude-chat-stop",name:"Stop generation",hotkeys:[{modifiers:[],key:"Escape"}],callback:()=>this.stopGeneration()}),this.addCommand({id:"claude-chat-new-session",name:"Start new session",hotkeys:[{modifiers:["Mod","Shift"],key:"n"}],callback:()=>this.startNewSession()}),this.addCommand({id:"claude-chat-export",name:"Export conversation to Markdown",hotkeys:[{modifiers:["Mod","Shift"],key:"e"}],callback:()=>this.exportConversation()})}async activateView(){let{workspace:e}=this.app,s=e.getLeavesOfType(p)[0];if(s)e.revealLeaf(s);else{let n=e.getRightLeaf(!1);n&&await n.setViewState({type:p,active:!0})}}onunload(){this.server&&(this.server.stop(),this.server=null)}async loadPluginData(){let e=await this.loadData();if(e){if(this.data=e,!this.data.sessions||this.data.sessions.length===0){let s={id:"session-migrated",name:"Migrated Session",sessionId:this.data.sessionId,serverSessionId:null,createdAt:new Date,updatedAt:new Date,messages:[]};this.data.sessions=[s],this.data.currentSessionId=s.id}this.sessionManager.loadSessions(this.data.sessions,this.data.currentSessionId),this.sessionManager.onChange(()=>{this.saveSessions()}),console.log("OpenCodeChat: Loaded data, sessions:",this.data.sessions.length)}else console.log("OpenCodeChat: No saved data found, starting fresh"),this.sessionManager.onChange(()=>{this.saveSessions()})}async saveSessions(){let e=this.sessionManager.exportForSave();this.data.sessions=e.sessions,this.data.currentSessionId=e.currentSessionId,await this.saveData(this.data)}async updateSessionId(e){this.sessionManager.updateCliSessionId(e)}getSessionId(){return this.sessionManager.getCurrentCliSessionId()}clearChatHistory(){let{workspace:e}=this.app,s=e.getLeavesOfType(p)[0];if(s){let n=s.view;n.clearHistory&&n.clearHistory()}}focusInput(){let{workspace:e}=this.app,s=e.getLeavesOfType(p)[0];if(s){let n=s.view;n.focusInput&&n.focusInput()}}stopGeneration(){let{workspace:e}=this.app,s=e.getLeavesOfType(p)[0];if(s){let n=s.view;n.handleStop&&n.handleStop()}}startNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length+1}`),{workspace:s}=this.app,n=s.getLeavesOfType(p)[0];if(n){let i=n.view;i.loadSession&&i.loadSession(e.id)}}async exportConversation(){let{workspace:e}=this.app,s=e.getLeavesOfType(p)[0];if(s){let n=s.view;n.exportConversation&&await n.exportConversation()}}getVaultPath(){return this.app.vault.adapter.basePath||""}syncBundledSkillsToVault(){let e=this.getVaultPath();if(!e)return;let s=(0,f.join)(e,".obsidian","plugins",this.manifest.id),n=(0,f.join)(s,"opencode-skills");if(!(0,m.existsSync)(n))return;let i=(0,f.join)(e,".opencode","skills");(0,m.mkdirSync)(i,{recursive:!0});let o=(0,m.readdirSync)(n,{withFileTypes:!0});for(let a of o){if(!a.isDirectory())continue;let r=(0,f.join)(n,a.name),l=(0,f.join)(r,"SKILL.md");if(!(0,m.existsSync)(l))continue;let c=(0,f.join)(i,a.name);this.copyDirectoryRecursive(r,c)}}copyDirectoryRecursive(e,s){(0,m.mkdirSync)(s,{recursive:!0});let n=(0,m.readdirSync)(e,{withFileTypes:!0});for(let i of n){let o=(0,f.join)(e,i.name),a=(0,f.join)(s,i.name);if(i.isDirectory()){this.copyDirectoryRecursive(o,a);continue}i.isFile()&&(0,m.copyFileSync)(o,a)}}};
