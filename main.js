/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
var ke=Object.create;var R=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var Me=Object.getOwnPropertyNames;var De=Object.getPrototypeOf,Ie=Object.prototype.hasOwnProperty;var Le=(p,i)=>{for(var e in i)R(p,e,{get:i[e],enumerable:!0})},de=(p,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of Me(i))!Ie.call(p,s)&&s!==e&&R(p,s,{get:()=>i[s],enumerable:!(t=Te(i,s))||t.enumerable});return p};var he=(p,i,e)=>(e=p!=null?ke(De(p)):{},de(i||!p||!p.__esModule?R(e,"default",{value:p,enumerable:!0}):e,p)),Ae=p=>de(R({},"__esModule",{value:!0}),p);var ze={};Le(ze,{default:()=>ie});module.exports=Ae(ze);var se=require("obsidian"),w=require("fs"),E=require("path");var k=require("obsidian");var Pe=/\[\[[^\]]+\]\]/,Re=/\[[^\]]+\]\([^)]+\)/,O=class{evaluate(i){let e=i.split(/\r?\n/),t=!1,s=!1,n=0,o=0,a=0,r=[];for(let l of e){let d=l.trim();if(!d)continue;if(d.startsWith("```")){t=!t;continue}if(t)continue;if(/^#{1,6}\s+/u.test(d)){s=/source/iu.test(d);continue}if(s){this.hasCitation(d)&&(n+=1);continue}let h=this.normalizeClaimLine(d);if(h){if(o+=1,this.hasCitation(h)){a+=1;continue}r.length<5&&r.push(this.shortenClaim(h))}}let c=o>0?a/o:n>0?1:0;return{totalClaims:o,citedClaims:a,uncitedClaims:r,sourceCount:n,coverage:c}}normalizeClaimLine(i){return/^(confidence|level|gaps|scope|total findings|high priority)\s*:/iu.test(i)?"":/^[-*+]\s+/u.test(i)?i.replace(/^[-*+]\s+/u,"").trim():/^\d+\.\s+/u.test(i)?i.replace(/^\d+\.\s+/u,"").trim():i}hasCitation(i){return Pe.test(i)||Re.test(i)}shortenClaim(i){return i.length<=120?i:`${i.slice(0,117)}...`}};var B=require("obsidian"),Oe=5,Fe=1200,F=class{constructor(i){this.app=i}resolveSnapshot(i,e){let t=this.app.workspace.getActiveFile(),s=this.parseMentionPaths(i),n=this.resolveMentionPaths(s),o=this.collectContextFiles(t,n.existing),a=this.getRecentMarkdownFiles(o.map(d=>d.path)),r=e?this.retrieveRelatedFiles(e):[],c=this.getEditorSelection(),l=this.extractFrontmatterTags(t);return{activeFilePath:(t==null?void 0:t.path)||null,activeFileTags:l,selection:c,mentionPaths:s,missingMentionPaths:n.missing,contextFiles:o,recentFiles:a,relatedFiles:r}}buildContextBlock(i){let e=["## Workspace Context"];if(i.activeFilePath?e.push(`- Active note: [[${i.activeFilePath}]]`):e.push("- Active note: (none)"),i.activeFileTags.length>0&&e.push(`- Active note tags: ${i.activeFileTags.map(t=>`#${t}`).join(", ")}`),i.selection&&(e.push("- Selected excerpt:"),e.push("```text"),e.push(i.selection),e.push("```")),i.contextFiles.length>0){e.push("- Priority context files:");for(let t of i.contextFiles)e.push(`  - [[${t.path}]] (${t.source})`)}if(i.relatedFiles.length>0){e.push("- Related notes (search results):");for(let t of i.relatedFiles)e.push(`  - [[${t.path}]]`)}if(i.recentFiles.length>0){e.push("- Recently updated notes:");for(let t of i.recentFiles)e.push(`  - [[${t}]]`)}if(i.missingMentionPaths.length>0){e.push("- Missing @ references (not found in vault):");for(let t of i.missingMentionPaths)e.push(`  - ${t}`)}return e.push("- Citation policy: use `[[path/to/note]]` for every key claim."),e.join(`
`)}retrieveRelatedFiles(i){let e=i.toLowerCase().split(/\s+/).filter(s=>s.length>2);return e.length===0?[]:this.app.vault.getMarkdownFiles().map(s=>{let n=0,o=s.basename.toLowerCase();return e.forEach(a=>{o===a?n+=10:o.includes(a)&&(n+=3)}),{file:s,score:n}}).filter(s=>s.score>0).sort((s,n)=>n.score-s.score||n.file.stat.mtime-s.file.stat.mtime).slice(0,5).map(s=>({path:s.file.path,source:"search"}))}parseMentionPaths(i){let e=[],t=/@(?:"([^"]+)"|([^\s@]+))/g,s=t.exec(i);for(;s;){let n=(s[1]||s[2]||"").trim();n.length>0&&e.push(n),s=t.exec(i)}return[...new Set(e)]}resolveMentionPaths(i){let e=[],t=[];for(let s of i){let n=s.replace(/^"+|"+$/g,""),o=this.app.vault.getAbstractFileByPath(n);o instanceof B.TFile?e.push(o.path):t.push(n)}return{existing:e,missing:t}}collectContextFiles(i,e){let t=[],s=new Set;i&&(t.push({path:i.path,source:"active"}),s.add(i.path));for(let n of e)s.has(n)||(t.push({path:n,source:"mention"}),s.add(n));return t}getRecentMarkdownFiles(i){let e=new Set(i);return this.app.vault.getMarkdownFiles().filter(t=>!e.has(t.path)).sort((t,s)=>s.stat.mtime-t.stat.mtime).slice(0,Oe).map(t=>t.path)}getEditorSelection(){var t;let i=this.app.workspace.getActiveViewOfType(B.MarkdownView),e=((t=i==null?void 0:i.editor)==null?void 0:t.getSelection())||"";return this.truncateText(e.trim(),Fe)}extractFrontmatterTags(i){var n;if(!i)return[];let e=this.app.metadataCache.getFileCache(i),t=(n=e==null?void 0:e.frontmatter)==null?void 0:n.tags;return t?(Array.isArray(t)?t:[t]).map(o=>String(o).trim()).filter(o=>o.length>0).map(o=>o.startsWith("#")?o.slice(1):o):[]}truncateText(i,e){return i.length<=e?i:`${i.slice(0,e)}
...[truncated]`}};var C=require("obsidian"),y=require("@codemirror/view"),H=require("@codemirror/state"),W=class{constructor(i){this.activeDiffs=new Map;this.app=i}async showDiffInEditor(i){let e=this.app.vault.getAbstractFileByPath(i.file);if(!(e instanceof C.TFile))return new C.Notice(`File not found: ${i.file}`),!1;let t=this.app.workspace.getLeaf(!1);await t.openFile(e);let s=this.getEditorFromLeaf(t);if(!s)return new C.Notice("Could not access editor"),!1;this.clearDiff(i.file);let n=this.computeDiffRanges(i);if(n.length===0)return new C.Notice("No changes to highlight"),!0;let o=this.applyDecorations(s,n);return this.activeDiffs.set(i.file,{file:i.file,ranges:n,cleanup:o}),this.scrollToFirstChange(s,n),new C.Notice(`Showing ${n.length} changes in ${i.file}`),!0}getEditorFromLeaf(i){var t;let e=i.view;return(t=e.editor)!=null&&t.cm?e.editor.cm:null}computeDiffRanges(i){let e=[],t=this.toLines(i.before),s=this.toLines(i.after),n=this.computeDiffOperations(t,s),o=0,a=[],r=[],c=()=>{let l=Math.min(a.length,r.length);for(let d=0;d<l;d++){let h=a[d],u=r[d];e.push({from:u.newIndex,to:u.newIndex+1,type:"modified",beforeText:h.text,afterText:u.text})}for(let d=l;d<a.length;d++);for(let d=l;d<r.length;d++){let h=r[d];e.push({from:h.newIndex,to:h.newIndex+1,type:"added",afterText:h.text})}a=[],r=[]};for(let l of n)l.type==="unchanged"?(c(),o++):l.type==="removed"?a.push({text:l.text,originalIndex:o}):l.type==="added"&&(r.push({text:l.text,newIndex:o}),o++);return c(),e}toLines(i){if(!i)return[];let e=i.replace(/\r\n/g,`
`).split(`
`);return e.length>0&&e[e.length-1]===""&&e.pop(),e}computeDiffOperations(i,e){let t=[],s=[];for(let a=0;a<=i.length;a++){s[a]=[];for(let r=0;r<=e.length;r++)a===0&&r===0?s[a][r]=0:a===0?s[a][r]=r:r===0?s[a][r]=a:i[a-1]===e[r-1]?s[a][r]=s[a-1][r-1]:s[a][r]=1+Math.min(s[a-1][r],s[a][r-1],s[a-1][r-1])}let n=i.length,o=e.length;for(;n>0||o>0;)n>0&&o>0&&i[n-1]===e[o-1]?(t.unshift({type:"unchanged",text:i[n-1]}),n--,o--):o>0&&(n===0||s[n][o-1]<=s[n-1][o])?(t.unshift({type:"added",text:e[o-1]}),o--):n>0&&(t.unshift({type:"removed",text:i[n-1]}),n--);return t}applyDecorations(i,e){let t=[],s=i.state;for(let a of e){let r=s.doc.line(a.from);if(!r)continue;let c=r.from,l=r.to,d;a.type==="added"?d="cm-diff-highlight-added":a.type==="removed"?d="cm-diff-highlight-removed":d="cm-diff-highlight-modified";let h=y.Decoration.line({class:d,attributes:a.beforeText?{"data-diff-before":a.beforeText}:void 0});if(t.push({from:c,to:c,decoration:h}),a.type==="modified"&&a.beforeText){let u=y.Decoration.widget({widget:new ne(a.beforeText,a.afterText||""),side:-1});t.push({from:c,to:c,decoration:u})}}let n=y.ViewPlugin.fromClass(class{constructor(){let a=new H.RangeSetBuilder,r=[...t].sort((c,l)=>c.from-l.from);for(let c of r)a.add(c.from,c.to,c.decoration);this.decorations=a.finish()}update(a){}},{decorations:a=>a.decorations}),o=this.createCompartment();return i.dispatch({effects:o.reconfigure(n)}),()=>{try{i.dispatch({effects:o.reconfigure([])})}catch(a){}}}createCompartment(){return new H.Compartment}scrollToFirstChange(i,e){if(e.length===0)return;let t=e[0],s=i.state.doc.line(t.from);s&&i.dispatch({effects:y.EditorView.scrollIntoView(s.from,{y:"center"})})}clearDiff(i){let e=this.activeDiffs.get(i);e&&(e.cleanup(),this.activeDiffs.delete(i))}clearAllDiffs(){for(let[i,e]of this.activeDiffs)e.cleanup();this.activeDiffs.clear(),new C.Notice("All diff highlights cleared")}hasActiveDiff(i){return this.activeDiffs.has(i)}getActiveDiffFiles(){return Array.from(this.activeDiffs.keys())}},ne=class extends y.WidgetType{constructor(e,t){super();this.beforeText=e;this.afterText=t}toDOM(){let e=document.createElement("div");e.className="cm-diff-tooltip";let t=e.createEl("div",{cls:"cm-diff-tooltip-before"});t.createEl("span",{cls:"cm-diff-tooltip-label",text:"Before:"}),t.createEl("code",{text:this.beforeText});let s=e.createEl("div",{cls:"cm-diff-tooltip-arrow",text:"\u2192"}),n=e.createEl("div",{cls:"cm-diff-tooltip-after"});return n.createEl("span",{cls:"cm-diff-tooltip-label",text:"After:"}),n.createEl("code",{text:this.afterText}),e}eq(e){return this.beforeText===e.beforeText&&this.afterText===e.afterText}get estimatedHeight(){return 60}};var pe=require("obsidian"),Be=40,We=50,He=10,$=class{constructor(i){this.app=i}gatherVaultContext(){return{folderTree:this.collectFolderTree(),tagTaxonomy:this.collectTagTaxonomy(),recentNotePaths:this.collectRecentNotePaths()}}buildPublishContextBlock(i){let e=["## Vault Metadata (for publish suggestions)"];if(i.folderTree.length>0){e.push("### Folder Structure"),e.push("Use these existing folders when suggesting an output path:");for(let t of i.folderTree)e.push(`- ${t}/`)}else e.push("### Folder Structure"),e.push("- (root only \u2014 no subdirectories)");if(i.tagTaxonomy.length>0&&(e.push("### Existing Tag Taxonomy"),e.push("Prefer reusing existing tags. Only suggest new tags when no existing tag fits:"),e.push(i.tagTaxonomy.map(t=>`#${t}`).join(", "))),i.recentNotePaths.length>0){e.push("### Recent Note Paths (naming pattern reference)");for(let t of i.recentNotePaths)e.push(`- ${t}`)}return e.join(`
`)}collectFolderTree(){let i=this.app.vault.getRoot(),e=[];return this.walkFolders(i,0,e),e.slice(0,Be)}walkFolders(i,e,t){if(!(e>2)){for(let s of i.children)if(s instanceof pe.TFolder){let n=s.name;if(n.startsWith(".")||n==="node_modules")continue;t.push(s.path),this.walkFolders(s,e+1,t)}}}collectTagTaxonomy(){var t;let i=new Map,e=this.app.vault.getMarkdownFiles();for(let s of e){let n=this.app.metadataCache.getFileCache(s);if(!n)continue;let o=(t=n.frontmatter)==null?void 0:t.tags;if(o){let a=Array.isArray(o)?o:[o];for(let r of a){let c=this.normalizeTag(String(r));c&&i.set(c,(i.get(c)||0)+1)}}if(n.tags)for(let a of n.tags){let r=this.normalizeTag(a.tag);r&&i.set(r,(i.get(r)||0)+1)}}return Array.from(i.entries()).sort((s,n)=>n[1]-s[1]).slice(0,We).map(([s])=>s)}normalizeTag(i){let e=i.trim();return e?e.startsWith("#")?e.slice(1):e:""}collectRecentNotePaths(){return this.app.vault.getMarkdownFiles().sort((i,e)=>e.stat.mtime-i.stat.mtime).slice(0,He).map(i=>i.path)}};var q=class{constructor(i){this.app=i}async runAudit(){let i=this.app.vault.getMarkdownFiles(),e=[],t={},s=new Set(i.map(r=>r.path)),n={};for(let r of i){n[r.basename]||(n[r.basename]=[]),n[r.basename].push(r),t[r.path]===void 0&&(t[r.path]=0);let c=this.app.metadataCache.getFileCache(r);if(c!=null&&c.links)for(let l of c.links){let d=this.app.metadataCache.getFirstLinkpathDest(l.link,r.path);d?t[d.path]=(t[d.path]||0)+1:e.push({type:"broken-link",file:r,detail:`Link to "${l.link}" not found`,severity:"high"})}if(c!=null&&c.embeds)for(let l of c.embeds){let d=this.app.metadataCache.getFirstLinkpathDest(l.link,r.path);d?t[d.path]=(t[d.path]||0)+1:e.push({type:"broken-link",file:r,detail:`Embed "${l.link}" not found`,severity:"high"})}}for(let r of i)!t[r.path]&&r.stat.size>0&&e.push({type:"orphan",file:r,detail:"No incoming links from other notes",severity:"low"});for(let r in n)if(n[r].length>1)for(let c of n[r])e.push({type:"duplicate-title",file:c,detail:`Title clash with ${n[r].length-1} other file(s)`,severity:"medium"});let o=365*24*60*60*1e3,a=Date.now();for(let r of i)a-r.stat.mtime>o&&e.push({type:"stale",file:r,detail:`Last modified ${new Date(r.stat.mtime).toLocaleDateString()}`,severity:"low"});return{timestamp:Date.now(),totalFiles:i.length,issues:e,summary:{brokenLinks:e.filter(r=>r.type==="broken-link").length,orphans:e.filter(r=>r.type==="orphan").length,duplicates:e.filter(r=>r.type==="duplicate-title").length,stale:e.filter(r=>r.type==="stale").length}}}formatReport(i){let e=`# Knowledge Base Health Report
`;if(e+=`**Date:** ${new Date(i.timestamp).toLocaleString()}
`,e+=`**Total Files:** ${i.totalFiles}

`,e+=`## Summary
`,e+=`- \u{1F534} Broken Links: **${i.summary.brokenLinks}**
`,e+=`- \u{1F7E0} Duplicate Titles: **${i.summary.duplicates}**
`,e+=`- \u{1F7E1} Orphan Notes: **${i.summary.orphans}**
`,e+=`- \u26AA Stale Notes (>1yr): **${i.summary.stale}**

`,i.issues.length===0)return e+=`\u{1F389} **Excellent! No issues found.**
`,e;e+=`## Issues Detail
`;let t=i.issues.filter(o=>o.type==="broken-link");if(t.length>0){e+=`### \u{1F534} Broken Links (${t.length})
`,e+=`> Links pointing to non-existent files.

`;for(let o of t.slice(0,50))e+=`- [[${o.file.path}]] : ${o.detail}
`;t.length>50&&(e+=`- ... and ${t.length-50} more
`),e+=`
`}let s=i.issues.filter(o=>o.type==="duplicate-title");if(s.length>0){e+=`### \u{1F7E0} Duplicate Titles (${s.length})
`,e+=`> Files with same basename but different folders.

`;for(let o of s.slice(0,20))e+=`- [[${o.file.path}]]
`;s.length>20&&(e+=`- ... and ${s.length-20} more
`),e+=`
`}let n=i.issues.filter(o=>o.type==="orphan");if(n.length>0){e+=`### \u{1F7E1} Orphan Notes (${n.length})
`,e+=`> Notes not linked from anywhere else.

`;for(let o of n.slice(0,20))e+=`- [[${o.file.path}]]
`;n.length>20&&(e+=`- ... and ${n.length-20} more
`),e+=`
`}return e}};var ue={discover:{label:"Discovery",goal:"Clarify scope, audience, constraints, and missing evidence before writing.",outputContract:["## Task Brief","- Objective:","- Audience:","- Key questions:","","## Information Gaps","- Gap:","- Why it matters:","- Suggested retrieval action:","","## Execution Plan","1. ...","2. ..."].join(`
`)},outline:{label:"Outline",goal:"Build a structured outline tied to evidence and intended reader flow.",outputContract:["## Proposed Title","- ...","","## Outline","1. Section","   - Key point","   - Evidence link: [[path/to/note]]","","## Source Map","- Claim -> [[path/to/note]]"].join(`
`)},draft:{label:"Draft",goal:"Write a complete draft grounded in available notes and explicit citations.",outputContract:["## Draft","<full article or document>","","## Sources","- [[path/to/note-a]]","- [[path/to/note-b]]","","## Citation Coverage","- Claims without direct evidence: <count and list>"].join(`
`)},evidence:{label:"Evidence Review",goal:"Audit each key claim for source coverage and confidence level.",outputContract:["## Claim Audit","- Claim:","  - Source:","  - Confidence: high | medium | low","  - Gap:","","## Risky Claims","- ...","","## Remediation Actions","1. ...","2. ..."].join(`
`)},polish:{label:"Polish",goal:"Improve readability, coherence, and style while preserving factual grounding.",outputContract:["## Polished Version","<improved content>","","## Major Edits","- Edit:","- Reason:","","## Source Integrity Check","- Any citation removed/changed and why"].join(`
`)},publish:{label:"Publish",goal:"Package final output for vault publishing with complete YAML frontmatter, metadata, and action checklist. Use the vault metadata section (if present) to suggest tags from existing taxonomy and a file path matching the vault folder structure.",outputContract:["## Final Title","- ...","","## YAML Frontmatter","```yaml","---","title: <final title>","date: <YYYY-MM-DD>","tags:","  - <prefer existing tags from vault taxonomy>","  - <only add new tags when no existing tag fits>","summary: <1-2 sentence summary>","author: <author or leave blank>","---","```","","## Final Content","<ready-to-publish markdown content>","","## Metadata","- Tags: <list, preferring existing vault tags>","- Summary: <1-2 sentences>","- Suggested file path: <match vault folder structure>","","## Publish Checklist","- [ ] Citation validation","- [ ] Link validation","- [ ] Style review","- [ ] Frontmatter completeness"].join(`
`)}},N=class{constructor(){this.tasksBySession=new Map}hydrateTask(i,e){var n;if(!e){this.tasksBySession.delete(i);return}let t=(e.draftVersions||[]).map(o=>({...o,createdAt:new Date(o.createdAt)})),s=(e.stageHistory||[]).map(o=>({...o,timestamp:new Date(o.timestamp)}));this.tasksBySession.set(i,{...e,draftVersions:t,stageHistory:s,currentDraftVersionId:e.currentDraftVersionId||((n=t[t.length-1])==null?void 0:n.id)||null,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)})}createTask(i,e){let t=new Date,s=e.trim(),n={id:`task-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,title:this.toTaskTitle(s),objective:s,audience:"General knowledge workers",tone:"Clear, concise, evidence-driven",targetLength:"1200-1800 words",stage:"discover",status:"active",draftVersions:[],currentDraftVersionId:null,stageHistory:[],createdAt:t,updatedAt:t};return this.tasksBySession.set(i,n),n}ensureTask(i,e){let t=this.tasksBySession.get(i);return t||this.createTask(i,e)}getTask(i){return this.tasksBySession.get(i)||null}getCurrentDraftVersion(i){let e=this.tasksBySession.get(i);return!e||!e.currentDraftVersionId?null:e.draftVersions.find(t=>t.id===e.currentDraftVersionId)||null}updateStage(i,e){let t=this.tasksBySession.get(i);if(!t)return null;let s=t.stage;return s!==e&&t.stageHistory.push({from:s,to:e,timestamp:new Date}),t.stage=e,t.updatedAt=new Date,t}addDraftVersion(i,e,t,s){let n=this.tasksBySession.get(i);if(!n)return null;let o=t.trim();if(!o)return null;let a=this.getCurrentDraftVersion(i);if(a&&a.content.trim()===o)return{task:n,version:a,created:!1};let r=new Date,c=n.draftVersions.length+1,l={id:`draft-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,stage:e,label:`${this.stageLabel(e)} v${c}`,content:o,createdAt:r,citationCoverage:s==null?void 0:s.citationCoverage,sourceCount:s==null?void 0:s.sourceCount};return n.draftVersions.push(l),n.currentDraftVersionId=l.id,n.updatedAt=r,{task:n,version:l,created:!0}}rollbackToDraftVersion(i,e){let t=this.tasksBySession.get(i);if(!t)return null;let s=t.draftVersions.find(o=>o.id===e);if(!s)return null;let n=t.stage;return t.currentDraftVersionId=s.id,t.stage=s.stage,t.status="active",t.updatedAt=new Date,n!==s.stage&&t.stageHistory.push({from:n,to:s.stage,timestamp:new Date}),{task:t,version:s}}buildStagePrompt(i,e,t,s,n,o){let a=ue[i],r=e.trim()||"(no additional request)",c=this.getTaskBaseline(s),l=["You are a writing and knowledge-base management agent for an Obsidian vault.","Work in a rigorous, source-grounded way. Do not invent facts.","","## Core Constraints","1. Every key claim must have a source link in `[[path/to/note]]` form.","2. If evidence is missing, explicitly mark as `[MISSING-EVIDENCE]`.","3. Keep conclusions traceable, concise, and actionable.","","## Current Writing Task",`- Task ID: ${s.id}`,`- Title: ${s.title}`,`- Objective: ${s.objective}`,`- Audience: ${s.audience}`,`- Tone: ${s.tone}`,`- Target Length: ${s.targetLength}`,`- Current Stage: ${a.label}`,"","## Stage Goal",`- ${a.goal}`,"","## User Request",r,"",n,"","## Output Contract",a.outputContract,"","## Stage Completion Protocol","When you have fully satisfied the goal of this stage, you MUST end your response with a specific tag:",`<stage_completed>${i}</stage_completed>`,"Do NOT include this tag if the work is partial or you have follow-up questions.","","## Missing Evidence Policy","- If evidence is insufficient, provide the safest partial answer and list what to retrieve next.",`- Mention unresolved @ references if any: ${t.missingMentionPaths.join(", ")||"(none)"}`];c&&(l.push(""),l.push("## Current Draft Baseline"),l.push(`- Active version: ${c.label}`),l.push("```markdown"),l.push(this.trimBaselineContent(c.content)),l.push("```")),o&&(l.push(""),l.push(o));let d=/wechat|微信|公众号|public account/i.test(r);return i==="publish"&&d&&(l.push(""),l.push("## \u{1F7E2} WECHAT/PUBLIC ACCOUNT MODE ACTIVATED"),l.push("The user wants to publish this to a WeChat Official Account. You MUST override the standard Output Contract with these specific rules:"),l.push(""),l.push("1. **NO YAML Frontmatter**: Do not include `---` metadata headers."),l.push("2. **Link Handling**: WeChat articles cannot have external links in the body."),l.push("   - Convert ALL external links `[text](url)` into inline text with a reference number `text [^1]`."),l.push('   - Add a "References" (\u53C2\u8003\u6587\u732E) section at the very bottom listing the URLs.'),l.push("3. **Formatting & Layout**:"),l.push("   - Use **short paragraphs** (1-3 sentences max) for mobile readability."),l.push("   - Use **bolding** for key insights freely."),l.push("   - Use `---` or visual separators between sections."),l.push("   - Remove `[[WikiLinks]]` and replace with plain text (unless it is a logical emphasis)."),l.push("4. **Tone**: Engaging, conversational, yet professional."),l.push("5. **Structure**:"),l.push("   - **Catchy Title**: Suggest 3 viral/engaging title options at the top."),l.push("   - **Lead-in**: A hook summary at the start."),l.push("   - **Body**: The main content formatted as requested."),l.push('   - **CTA**: A "Call to Action" or conclusion inviting comments/follows.'),l.push(""),l.push("## \u{1F4E6} FINAL OUTPUT FORMAT - CRITICAL"),l.push("You MUST wrap the final article content inside XML tags exactly like this:"),l.push("<final_article>"),l.push("(The full article content goes here)"),l.push("</final_article>"),l.push("Do NOT put the article inside a markdown code block (```). Output raw text inside the tags."),l.push("Do NOT include any conversation text outside the tags.")),l.join(`
`)}buildEvidencePrompt(i,e){return["Use the `evidence-qa` behavior with strict citations.",'If the provided context is insufficient, explicitly state "Low Confidence" and explain why.',"Do not hallucinate sources or facts not present in the context.","","## User Question",i.trim()||"Please run a full evidence audit for the current draft.","",e,"","## Required Output","```markdown","## Conclusion","- ...","","## Evidence","- Claim:","  - Evidence:","  - Why it supports:","","## Sources","- [[path/to/note]]","","## Confidence","- Level: high | medium | low","- Gaps:","```"].join(`
`)}buildKbAuditPrompt(i,e,t,s){let n=e.trim()||"(no additional constraints)",o=["Use the `kb-health-audit` behavior and return concise actionable findings.","","## Audit Scope",`- ${i}`,"","## User Constraints",n,"",t];return s&&(o.push(""),o.push("## Automated Audit Report (System Generated)"),o.push("The following report was generated by scanning the vault metadata. Use this as your primary source of truth."),o.push(s),o.push(""),o.push("## Task"),o.push("Analyze the above report and provide a prioritized action plan. Do not halllucinate new issues.")),o.push(""),o.push("## Required Output"),o.push("```markdown"),o.push("## Summary"),o.push("- Scope:"),o.push("- Total findings:"),o.push("- High priority:"),o.push(""),o.push("## Findings"),o.push("### Broken Links"),o.push("- ..."),o.push("### Orphan Notes"),o.push("- ..."),o.push("### Potential Duplicates"),o.push("- ..."),o.push("### Stale Notes"),o.push("- ..."),o.push(""),o.push("## Priority Actions"),o.push("1. [high] ..."),o.push("2. [medium] ..."),o.push("3. [low] ..."),o.push("```"),o.join(`
`)}buildWorkflowHelp(){return["## Writing + KB Workflow Commands","- `/write start <topic>`: create/reset a writing task and run discovery.","- `/write outline [extra requirements]`: generate evidence-aware outline.","- `/write draft [extra requirements]`: generate full draft with sources.","- `/write evidence [question]`: run evidence QA for current draft/question.","- `/write polish [style hints]`: improve writing quality while preserving claims.","- `/write publish [release notes]`: package publish-ready version and checklist.","- `/kb audit [full|broken|orphan|duplicate|stale] [constraints]`: run knowledge health audit.","- `/qa <question>`: ask an evidence-backed QA question.","","Use `@file` mentions to pin specific notes into the context bundle."].join(`
`)}toTaskTitle(i){return i?i.length<=48?i:`${i.slice(0,45)}...`:"Untitled Writing Task"}stageLabel(i){return ue[i].label}getTaskBaseline(i){return i.currentDraftVersionId&&i.draftVersions.find(e=>e.id===i.currentDraftVersionId)||null}trimBaselineContent(i){return i.length<=6e3?i:`${i.slice(0,6e3)}
...[baseline truncated]`}};var f=require("obsidian");var M={default:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  font-size: 16px;
  color: #3f3f3f;
  line-height: 1.8;
  background-color: #ffffff;
  text-align: justify;
}
.wechat-article h1, .wechat-article h2, .wechat-article h3 {
  font-weight: 700;
  color: #1a1a1a;
  margin-top: 24px;
  margin-bottom: 12px;
}
.wechat-article h1 { font-size: 22px; }
.wechat-article h2 {
  font-size: 18px;
  border-left: 3px solid #3370ff;
  padding-left: 12px;
}
.wechat-article h3 { font-size: 16px; }
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #1a1a1a; font-weight: 600; }
.wechat-article a { color: #3370ff; text-decoration: none; }
.wechat-article code:not(pre code) {
  font-family: Menlo, Monaco, Consolas, monospace;
  font-size: 14px;
  color: #d63384;
  background-color: #f3f3f3;
  padding: 2px 6px;
  border-radius: 3px;
}
.wechat-article pre {
  background-color: #1e1e1e;
  border-radius: 6px;
  padding: 16px;
  margin: 16px 0;
  overflow-x: auto;
}
.wechat-article pre code {
  font-family: Menlo, Monaco, Consolas, monospace;
  font-size: 14px;
  line-height: 1.6;
  color: #d4d4d4;
  display: block;
}
.wechat-article blockquote {
  margin: 16px 0;
  padding: 16px 20px;
  background-color: #f7f7f7;
  border-left: 3px solid #3370ff;
  border-radius: 0 4px 4px 0;
  color: #888888;
}
.wechat-article ul, .wechat-article ol { margin: 16px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 8px; }
.wechat-article ul li::before {
  content: "\u2022";
  position: absolute;
  left: -16px;
  color: #3370ff;
  font-weight: bold;
}
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 14px;
}
.wechat-article th, .wechat-article td {
  border: 1px solid #e0e0e0;
  padding: 12px;
  text-align: left;
}
.wechat-article th {
  background-color: #f7f7f7;
  font-weight: 600;
}
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; border-top: 1px solid #e0e0e0; margin: 24px 0; }
    `,tech:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 15px;
  color: #3f3f3f;
  line-height: 1.8;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 22px;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 24px;
  padding-bottom: 12px;
  border-bottom: 2px solid #00d4aa;
}
.wechat-article h2 {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 18px;
  font-weight: 600;
  color: #1a1a1a;
  margin-top: 36px;
  margin-bottom: 16px;
}
.wechat-article h3 {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 16px;
  font-weight: 600;
  color: #1a1a1a;
  margin-top: 24px;
  margin-bottom: 12px;
}
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #1a1a1a; font-weight: 600; }
.wechat-article em { color: #00d4aa; font-style: normal; }
.wechat-article blockquote {
  margin: 20px 0;
  padding: 16px 20px;
  background-color: #f0f4f8;
  border-left: 4px solid #00d4aa;
  border-radius: 0 4px 4px 0;
  color: #666666;
}
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  color: #00d4aa;
  background-color: #e8ecf0;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid #d0d7de;
}
.wechat-article pre {
  background-color: #0d1117;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  overflow-x: auto;
  border: 1px solid #d0d7de;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.6;
  color: #e6edf3;
  display: block;
  margin-top: 16px;
}
.wechat-article ul, .wechat-article ol { margin: 16px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 8px; }
.wechat-article a { color: #00d4aa; text-decoration: none; border-bottom: 1px dashed #00a883; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
}
.wechat-article th, .wechat-article td {
  border: 1px solid #d0d7de;
  padding: 10px 14px;
  text-align: left;
}
.wechat-article th {
  background-color: #f0f4f8;
  color: #00d4aa;
  font-weight: 600;
}
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 1px; background: linear-gradient(90deg, transparent, #00d4aa, transparent); margin: 32px 0; }
    `,elegant:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #4a4a4a;
  line-height: 2;
  background-color: #fffbf5;
  text-align: justify;
}
.wechat-article h1, .wechat-article h2, .wechat-article h3 {
  font-family: Georgia, "Noto Serif SC", "Source Han Serif SC", serif;
  font-weight: 600;
  color: #2c1810;
}
.wechat-article h1 {
  font-size: 24px;
  text-align: center;
  margin-bottom: 32px;
  letter-spacing: 2px;
}
.wechat-article h2 {
  font-size: 20px;
  margin-top: 40px;
  margin-bottom: 20px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e8ddd0;
}
.wechat-article h3 { font-size: 17px; margin-top: 28px; margin-bottom: 12px; }
.wechat-article p { margin-bottom: 20px; text-indent: 2em; }
.wechat-article strong { color: #2c1810; font-weight: 600; }
.wechat-article em { font-style: italic; color: #8b4513; }
.wechat-article blockquote {
  margin: 24px 0;
  padding: 20px 24px;
  background-color: #faf6f0;
  border-left: 3px solid #d4a574;
  border-radius: 0 8px 8px 0;
  font-style: italic;
  color: #8c8c8c;
}
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", Menlo, Monaco, monospace;
  font-size: 14px;
  color: #9c5030;
  background-color: #f5f0e8;
  padding: 2px 8px;
  border-radius: 4px;
}
.wechat-article pre {
  background-color: #2d2a24;
  border-radius: 8px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.7;
  color: #e8ddd0;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 28px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article a { color: #8b4513; text-decoration: underline; text-decoration-style: dotted; }
.wechat-article table { width: 100%; border-collapse: collapse; margin: 20px 0; }
.wechat-article th, .wechat-article td {
  border: 1px solid #e8ddd0;
  padding: 12px 16px;
  text-align: left;
}
.wechat-article th {
  background-color: #faf6f0;
  font-family: Georgia, "Noto Serif SC", serif;
  font-weight: 600;
}
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; text-align: center; margin: 32px 0; }
.wechat-article hr::before { content: "\u2726 \u2726 \u2726"; color: #d4a574; font-size: 12px; letter-spacing: 16px; }
    `,minimal:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  font-size: 17px;
  color: #1a1a1a;
  line-height: 2;
  background-color: #ffffff;
  letter-spacing: 0.02em;
}
.wechat-article h1 {
  font-size: 28px;
  font-weight: 700;
  color: #000000;
  text-align: center;
  margin-bottom: 48px;
  letter-spacing: 0.05em;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #000000;
  margin-top: 56px;
  margin-bottom: 24px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e5e5e5;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #000000; margin-top: 40px; margin-bottom: 16px; }
.wechat-article p { margin-bottom: 24px; }
.wechat-article strong { font-weight: 600; color: #000000; }
.wechat-article em { font-style: italic; }
.wechat-article blockquote {
  margin: 32px 0;
  padding: 24px 32px;
  background-color: #fafafa;
  border: none;
  border-radius: 0;
}
.wechat-article blockquote p { margin: 0; color: #666666; font-size: 16px; }
.wechat-article code:not(pre code) {
  font-family: "SF Mono", Menlo, Monaco, monospace;
  font-size: 15px;
  color: #1a1a1a;
  background-color: #f5f5f5;
  padding: 2px 6px;
  border-radius: 3px;
}
.wechat-article pre {
  background-color: #f5f5f5;
  border: 1px solid #f0f0f0;
  border-radius: 0;
  padding: 24px;
  margin: 32px 0;
  overflow-x: auto;
}
.wechat-article pre code {
  font-family: "SF Mono", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.7;
  color: #1a1a1a;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 24px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 12px; }
.wechat-article hr { border: none; height: 1px; background-color: #e5e5e5; margin: 48px 0; }
.wechat-article a { color: #1a1a1a; text-decoration: underline; text-underline-offset: 3px; }
.wechat-article table { width: 100%; border-collapse: collapse; margin: 32px 0; font-size: 15px; }
.wechat-article th, .wechat-article td { border: 1px solid #e5e5e5; padding: 14px 18px; text-align: left; }
.wechat-article th { background-color: #fafafa; font-weight: 600; }
.wechat-article img { max-width: 100%; height: auto; }
    `,vibrant:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #374151;
  line-height: 1.8;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  margin-bottom: 28px;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #1f2937;
  margin-top: 36px;
  margin-bottom: 16px;
  padding: 8px 16px;
  background: linear-gradient(135deg, #f0f9ff 0%, #fdf4ff 100%);
  border-radius: 8px;
  border-left: 4px solid #6366f1;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #6366f1; margin-top: 24px; margin-bottom: 12px; }
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #1f2937; font-weight: 600; }
.wechat-article em { color: #ec4899; font-style: normal; font-weight: 500; }
.wechat-article blockquote {
  margin: 24px 0;
  padding: 20px 24px;
  background: linear-gradient(135deg, #faf5ff 0%, #fdf4ff 100%);
  border-radius: 12px;
  border: none;
}
.wechat-article blockquote p { margin: 0; color: #6b7280; }
.wechat-article code:not(pre code) {
  font-family: "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  color: #7c3aed;
  background-color: #f3f4f6;
  padding: 3px 8px;
  border-radius: 6px;
}
.wechat-article pre {
  background-color: #1e1e2e;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  overflow-x: auto;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.wechat-article pre code {
  font-family: "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.6;
  color: #cdd6f4;
  display: block;
}
.wechat-article ul { margin: 16px 0; padding-left: 8px; list-style: none; }
.wechat-article ul li { margin-bottom: 12px; padding-left: 28px; position: relative; }
.wechat-article ul li::before { content: "\u2726"; position: absolute; left: 0; color: #6366f1; }
.wechat-article a { color: #6366f1; text-decoration: none; font-weight: 500; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
.wechat-article th {
  background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
.wechat-article tr:nth-child(even) { background-color: #f9fafb; }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 4px; background: linear-gradient(90deg, #6366f1, #ec4899); border-radius: 2px; margin: 32px 0; opacity: 0.3; }
    `,aiBlue:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #2c3e50;
  line-height: 1.9;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-size: 26px;
  font-weight: 700;
  color: #1a1a2e;
  text-align: center;
  margin-bottom: 32px;
  padding-bottom: 20px;
  position: relative;
}
.wechat-article h1::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: linear-gradient(90deg, #0066ff, #00ccff);
  border-radius: 2px;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #1a1a2e;
  margin-top: 40px;
  margin-bottom: 20px;
  padding: 12px 20px;
  background: linear-gradient(135deg, #f8fbff 0%, #ffffff 100%);
  border-radius: 8px;
  border-left: 4px solid #0066ff;
  box-shadow: 0 2px 8px rgba(0, 102, 255, 0.1);
}
.wechat-article h3 {
  font-size: 17px;
  font-weight: 600;
  color: #0066ff;
  margin-top: 28px;
  margin-bottom: 14px;
  padding-left: 12px;
  border-left: 3px solid #00ccff;
}
.wechat-article p { margin-bottom: 18px; text-align: justify; }
.wechat-article strong { color: #1a1a2e; font-weight: 600; }
.wechat-article em { color: #0066ff; font-style: italic; }
.wechat-article blockquote {
  margin: 28px 0;
  padding: 20px 24px;
  background: linear-gradient(135deg, #e8f4ff 0%, #ffffff 100%);
  border-left: 4px solid #0066ff;
  border-radius: 0 8px 8px 0;
  box-shadow: 0 2px 8px rgba(0, 102, 255, 0.1);
}
.wechat-article blockquote p { margin: 0; color: #5a6c7d; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 14px;
  color: #0066ff;
  background-color: #eef4ff;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid rgba(0, 102, 255, 0.15);
}
.wechat-article pre {
  background-color: #0d1117;
  border-radius: 10px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
  border: 1px solid #30363d;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #e6edf3;
  display: block;
  margin-top: 8px;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article ul li::before { content: "\u25CF"; position: absolute; left: -18px; color: #0066ff; font-size: 12px; }
.wechat-article a { color: #0066ff; text-decoration: none; border-bottom: 1px solid #3385ff; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 24px 0;
  font-size: 14px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}
.wechat-article th {
  background: linear-gradient(135deg, #0066ff, #0040cc);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #d0e1f5; }
.wechat-article tr:nth-child(even) { background-color: #f8fbff; }
.wechat-article tr:hover { background-color: #e8f4ff; }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 2px; background: linear-gradient(90deg, transparent, #0066ff, #00ccff, #0066ff, transparent); margin: 40px 0; }
    `,matrixGreen:`
.wechat-article {
  font-family: "Courier New", Courier, monospace;
  font-size: 15px;
  color: #1a1a1a;
  line-height: 1.8;
  background-color: #fafafa;
}
.wechat-article h1 {
  font-size: 24px;
  font-weight: 700;
  color: #006622;
  text-align: center;
  margin-bottom: 32px;
  padding: 16px;
  border: 2px solid #00aa33;
  border-radius: 8px;
  letter-spacing: 4px;
}
.wechat-article h2 {
  font-size: 18px;
  font-weight: 600;
  color: #008822;
  margin-top: 36px;
  margin-bottom: 18px;
  padding-left: 16px;
  border-left: 3px solid #00aa33;
}
.wechat-article h3 { font-size: 16px; font-weight: 600; color: #009933; margin-top: 28px; margin-bottom: 14px; }
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #008822; font-weight: 600; }
.wechat-article em { color: #00aa33; font-style: italic; }
.wechat-article blockquote {
  margin: 24px 0;
  padding: 16px 20px;
  background-color: #e8f0e8;
  border-left: 3px solid #00aa33;
  border-radius: 0 4px 4px 0;
  color: #557755;
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
}
.wechat-article blockquote p { margin: 0; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  color: #008822;
  background-color: #e0e8e0;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid #aaccbb;
}
.wechat-article pre {
  background-color: #000000;
  border-radius: 8px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
  border: 1px solid #00aa33;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #00ff41;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 16px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 8px; }
.wechat-article ul li::before { content: ">"; position: absolute; left: -16px; color: #00aa33; font-weight: bold; }
.wechat-article a { color: #009933; text-decoration: none; border-bottom: 1px dashed #00aa33; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  border: 1px solid #aaccbb;
}
.wechat-article th, .wechat-article td {
  border: 1px solid #cccccc;
  padding: 10px 14px;
  text-align: left;
}
.wechat-article th {
  background-color: #e8f0e8;
  color: #008822;
  font-weight: 600;
}
.wechat-article tr:nth-child(even) { background-color: rgba(0, 170, 51, 0.05); }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 1px; background: linear-gradient(90deg, transparent, #00aa33, transparent); margin: 32px 0; }
    `,cyberPurple:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #2a2a3e;
  line-height: 1.8;
  background-color: #faf8ff;
}
.wechat-article h1 {
  font-size: 26px;
  font-weight: 700;
  color: #bc13fe;
  text-align: center;
  margin-bottom: 36px;
  padding: 20px;
  background: linear-gradient(135deg, #bc13fe, #f10056);
  border-radius: 12px;
  letter-spacing: 2px;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #0ff0fc;
  margin-top: 40px;
  margin-bottom: 20px;
  padding: 12px 20px;
  background: linear-gradient(90deg, #f0e8ff, transparent);
  border-left: 4px solid #0ff0fc;
  border-radius: 0 8px 8px 0;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #bc13fe; margin-top: 32px; margin-bottom: 16px; }
.wechat-article p { margin-bottom: 18px; }
.wechat-article strong { color: #0ff0fc; font-weight: 600; }
.wechat-article em { color: #f10056; font-style: italic; }
.wechat-article blockquote {
  margin: 28px 0;
  padding: 20px 24px;
  background: linear-gradient(135deg, #f5e8ff, #f0e8ff);
  border-left: 4px solid #f10056;
  border-radius: 0 8px 8px 0;
  color: #665577;
}
.wechat-article blockquote p { margin: 0; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 14px;
  color: #8b00d4;
  background-color: #f0e0ff;
  padding: 4px 10px;
  border-radius: 6px;
  border: 1px solid #8b00d4;
}
.wechat-article pre {
  background-color: #000000;
  border-radius: 12px;
  padding: 24px;
  margin: 28px 0;
  overflow-x: auto;
  border: 1px solid #bc13fe;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #ffffff;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article ul li::before { content: "\u25B8"; position: absolute; left: -18px; color: #bc13fe; }
.wechat-article a { color: #0ff0fc; text-decoration: none; border-bottom: 1px solid #0ff0fc; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 24px 0;
  font-size: 14px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #bc13fe;
}
.wechat-article th {
  background: linear-gradient(135deg, #bc13fe, #8b00d4);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #d0b0e0; }
.wechat-article tr:nth-child(even) { background-color: rgba(188, 19, 254, 0.1); }
.wechat-article tr:hover { background-color: rgba(15, 240, 252, 0.1); }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 2px; background: linear-gradient(90deg, transparent, #bc13fe, #f10056, #0ff0fc, transparent); margin: 40px 0; box-shadow: 0 0 15px rgba(188, 19, 254, 0.3); }
    `,oceanTeal:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #334155;
  line-height: 1.9;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-size: 26px;
  font-weight: 700;
  color: #0f172a;
  text-align: center;
  margin-bottom: 36px;
  padding-bottom: 16px;
  border-bottom: 3px solid #0891b2;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #0f172a;
  margin-top: 40px;
  margin-bottom: 20px;
  padding: 12px 20px;
  background-color: #f0f9ff;
  border-radius: 8px;
  border-left: 4px solid #14b8a6;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #0891b2; margin-top: 28px; margin-bottom: 14px; }
.wechat-article p { margin-bottom: 18px; text-align: justify; }
.wechat-article strong { color: #0f172a; font-weight: 600; }
.wechat-article em { color: #14b8a6; font-style: italic; }
.wechat-article blockquote {
  margin: 28px 0;
  padding: 20px 24px;
  background-color: #ecfeff;
  border-left: 4px solid #14b8a6;
  border-radius: 0 8px 8px 0;
  color: #64748b;
}
.wechat-article blockquote p { margin: 0; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 14px;
  color: #0891b2;
  background-color: #ecfeff;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid #bae6fd;
}
.wechat-article pre {
  background-color: #1e293b;
  border-radius: 10px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
  border: 1px solid #334155;
  box-shadow: 0 4px 12px rgba(8, 145, 178, 0.15);
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #e2e8f0;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article ul li::before { content: "\u2022"; position: absolute; left: -16px; color: #0891b2; font-weight: bold; }
.wechat-article a { color: #0891b2; text-decoration: none; border-bottom: 1px solid #22d3ee; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 24px 0;
  font-size: 14px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(8, 145, 178, 0.1);
}
.wechat-article th {
  background: linear-gradient(135deg, #0891b2, #14b8a6);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #bae6fd; }
.wechat-article tr:nth-child(even) { background-color: #f0f9ff; }
.wechat-article tr:hover { background-color: #ecfeff; }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 2px; background: linear-gradient(90deg, #f0f9ff, #22d3ee, #f0f9ff); margin: 40px 0; }
    `};var D=class{constructor(i){this.app=i}async imageToBase64(i,e){try{let t=i,s=i.split("?")[0].split("#")[0];if(s.startsWith("file://"))t=decodeURIComponent(s.replace("file://","")),t.startsWith("/")&&!t.match(/^\/[A-Z]:/)&&(t=t.substring(1));else if(s.startsWith("app://local/"))t=decodeURIComponent(s.replace("app://local/",""));else if(s.startsWith("obsidian://"))try{let o=new URL(s);t=o.pathname||o.searchParams.get("file")||o.href}catch(o){t=s}else if(s.includes("obsidian.md")){let o=s.match(/obsidian\.md\/(.+)/);o&&(t=decodeURIComponent(o[1]))}else t=s;if(t.startsWith("/")&&(t=t.substring(1)),e&&!t.startsWith("/")&&!t.match(/^[a-zA-Z]+:/)&&!t.match(/^[?#]/)){let o=e.substring(0,e.lastIndexOf("/"));o&&(t=o?`${o}/${t}`:t)}t=this.normalizePath(t),console.log("[WeChatExporter] Image path resolution:",{src:i,sourcePath:e,resolved:t});let n=this.app.vault.getAbstractFileByPath(t);if(console.log("[WeChatExporter] Vault file lookup:",{imagePath:t,found:n instanceof f.TFile}),n instanceof f.TFile){let o=await this.app.vault.readBinary(n),a=this.arrayBufferToBase64(o),r=n.extension.toLowerCase(),l={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",avif:"image/avif",heic:"image/heic",heif:"image/heif"}[r]||"image/png",d=`data:${l};base64,${a}`;return console.log("[WeChatExporter] Successfully converted image to base64:",{imagePath:t,mimeType:l,length:d.length}),d}if(i.startsWith("http://")||i.startsWith("https://"))try{let o=await fetch(i,{mode:"cors"});if(o.ok){let a=await o.blob(),r=await a.arrayBuffer(),c=this.arrayBufferToBase64(r),l=a.type||"image/png",d=`data:${l};base64,${c}`;return console.log("[WeChatExporter] Successfully fetched external image:",{src:i,contentType:l}),d}}catch(o){console.warn("CORS fetch failed for image:",i,o)}}catch(t){console.error("Failed to convert image to base64:",t)}return console.log("[WeChatExporter] Failed to convert image, returning original src:",i),i}normalizePath(i){let e=i.split("/"),t=[];for(let s of e)s===""||s==="."||(s===".."?t.pop():t.push(s));return t.join("/")}arrayBufferToBase64(i){let e=new Uint8Array(i),t="";for(let s=0;s<e.byteLength;s++)t+=String.fromCharCode(e[s]);return window.btoa(t)}async processImages(i,e){let t=i.querySelectorAll("img");console.log("[WeChatExporter] Found <img> elements:",t.length,"sourcePath:",e);for(let n of Array.from(t)){let o=n.getAttribute("src");if(console.log("[WeChatExporter] Processing <img>:",o),o){let a=await this.imageToBase64(o,e);n.setAttribute("src",a),n.style.maxWidth="100%",n.style.height="auto",n.style.display="block",n.style.margin="16px auto"}}let s=i.querySelectorAll("span.internal-embed, img.internal-embed");console.log("[WeChatExporter] Found internal-embed elements:",s.length);for(let n of Array.from(s)){let o=n.getAttribute("src")||n.getAttribute("alt");if(console.log("[WeChatExporter] Processing internal-embed:",o),o){let a=await this.imageToBase64(o,e),r=document.createElement("img");r.setAttribute("src",a),r.setAttribute("alt",n.getAttribute("alt")||""),r.style.maxWidth="100%",r.style.height="auto",r.style.display="block",r.style.margin="16px auto",n.replaceWith(r),console.log("[WeChatExporter] Replaced embed with <img>:",o)}}}async generateStyledHtml(i,e="default",t=""){let s=this.cleanMarkdown(i),n=document.createElement("div");n.addClass("wechat-article");let o=new f.Component;await f.MarkdownRenderer.renderMarkdown(s,n,t,o),o.unload(),await this.processImages(n,t);let a=M[e]||M.default;return this.inlineStyles(n,a),n.innerHTML}async generateFullHtml(i,e="default",t="",s){let n=this.cleanMarkdown(i),o=document.createElement("div");o.addClass("wechat-article");let a=new f.Component;await f.MarkdownRenderer.renderMarkdown(n,o,s||"",a),a.unload(),await this.processImages(o,s);let r=M[e]||M.default;return this.inlineStyles(o,r),o.innerHTML}async exportToHtml(i,e="default",t,s){try{let n=this.cleanMarkdown(i),o=document.createElement("div");o.addClass("wechat-article");let a=new f.Component;await f.MarkdownRenderer.renderMarkdown(n,o,s||"",a),a.unload(),await this.processImages(o,s);let r=M[e]||M.default;this.inlineStyles(o,r);let c=`<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${t}</title>
    <style>
        ${r}
        body { margin: 0; padding: 20px; background-color: #f5f5f5; }
        .wechat-article-container { 
            max-width: 677px; 
            margin: 0 auto; 
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="wechat-article-container">
        ${o.outerHTML}
    </div>
</body>
</html>`,l=this.app.vault,d=`${t}.html`,h=l.getAbstractFileByPath(d);return h instanceof f.TFile?(await l.modify(h,c),new f.Notice(`Updated existing file: ${d}`)):(h=await l.create(d,c),new f.Notice(`Exported WeChat HTML: ${d}`)),h instanceof f.TFile?h:null}catch(n){return console.error("Failed to export WeChat HTML:",n),new f.Notice("Export failed. Check console for details."),null}}cleanMarkdown(i){let e=i.replace(/<stage_completed>.*?<\/stage_completed>/g,""),t=e.match(/<final_article>([\s\S]*?)<\/final_article>/i);if(t&&t[1].trim().length>0)return t[1].trim();let s=/^```(?:markdown)?\s*([\s\S]*?)\s*```$/i,n=e.trim(),o=n.match(s);if(o&&!(n.replace(/```[\s\S]*?```/g,"").trim().length>10)&&o[1].length>50)return o[1].trim();if(e.startsWith("---")){let a=e.indexOf("---",3);a!==-1&&(e=e.substring(a+3))}return e.trim()}inlineStyles(i,e){let t={},s=e.match(/:root\s*{([^}]+)}/);s&&s[1].split(";").forEach(r=>{let[c,l]=r.split(":").map(d=>d.trim());c&&l&&c.startsWith("--")&&(t[c]=l)});let n=/\.wechat-article\s+([^{]+)\s*{([^}]+)}/g,o;for(;(o=n.exec(e))!==null;){let a=o[1].trim(),c=o[2].trim().split(";").map(d=>{let[h,u]=d.split(":").map(x=>x.trim());return!h||!u?null:(u=u.replace(/var\((--[^)]+)\)/g,(x,T)=>t[T]||T),`${h}: ${u}`)}).filter(Boolean).join("; ");a.split(",").map(d=>d.trim()).forEach(d=>{if(!(d.includes("::")||!d.split(":")[0].trim()))try{i.querySelectorAll(d).forEach(x=>{let T=x.getAttribute("style")||"";x.setAttribute("style",`${T}${T?"; ":""}${c}`)})}catch(u){}})}}};var V=class{constructor(i,e,t,s){this.app=e;this.stopButtonEl=null;this.statusDotEl=null;this.commandHistory=[];this.historyIndex=-1;this.tempInput="";this.mentionCandidates=[];this.mentionSelectedIndex=0;this.mentionStartIndex=-1;this.mentionEndIndex=-1;this.maxMentionResults=8;this.containerEl=i,this.onSubmit=t,this.onStop=s,this.render()}render(){let i=this.containerEl.createEl("div",{cls:"claude-chat-input-container"});this.inputWrapperEl=i.createEl("div",{cls:"claude-chat-input-wrapper"}),this.statusDotEl=this.inputWrapperEl.createEl("div",{cls:"claude-status-dot claude-status-dot-connecting",attr:{"aria-label":"Connecting to OpenCode...",title:"Connecting to OpenCode..."}}),this.inputEl=this.inputWrapperEl.createEl("textarea",{cls:"claude-chat-input",attr:{placeholder:"Ask OpenCode, or use /write /kb /qa workflows... (type @ to reference files)",rows:"1"}}),this.inputEl.addEventListener("input",()=>{this.autoResize(),this.updateMentionSuggestions()}),this.inputEl.addEventListener("click",()=>{this.updateMentionSuggestions()}),this.inputEl.addEventListener("keyup",e=>{(e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Home"||e.key==="End")&&this.updateMentionSuggestions()}),this.inputEl.addEventListener("blur",()=>{window.setTimeout(()=>{document.activeElement!==this.inputEl&&this.closeMentionMenu()},100)}),this.sendButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-send-button"}),this.sendButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            <span>Send</span>
        `,this.sendButtonEl.addEventListener("click",()=>{this.handleSubmit()}),this.inputEl.addEventListener("keydown",e=>{this.handleMentionKeydown(e)||(e.key==="Enter"&&!e.shiftKey&&!e.isComposing?(e.preventDefault(),this.handleSubmit()):e.key==="ArrowUp"?(e.preventDefault(),this.navigateHistory(-1)):e.key==="ArrowDown"&&(e.preventDefault(),this.navigateHistory(1)))}),this.mentionMenuEl=i.createEl("div",{cls:"claude-chat-mention-menu"}),this.mentionMenuEl.style.display="none",i.addEventListener("click",e=>{(e.target===i||e.target===this.inputWrapperEl)&&this.inputEl.focus()})}createStopButton(){this.stopButtonEl||(this.stopButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-stop-button"}),this.stopButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            <span>Stop</span>
        `,this.stopButtonEl.addEventListener("click",()=>{this.onStop()}))}removeStopButton(){this.stopButtonEl&&(this.stopButtonEl.remove(),this.stopButtonEl=null)}async handleSubmit(){let i=this.inputEl.value.trim();i&&!this.sendButtonEl.disabled&&(this.commandHistory[this.commandHistory.length-1]!==i&&(this.commandHistory.push(i),this.commandHistory.length>100&&this.commandHistory.shift()),this.inputEl.value="",this.autoResize(),this.historyIndex=-1,this.tempInput="",this.closeMentionMenu(),await this.onSubmit(i))}navigateHistory(i){if(this.commandHistory.length===0)return;if(this.historyIndex===-1&&(this.tempInput=this.inputEl.value),this.historyIndex+=i,this.historyIndex<0)this.historyIndex=0;else if(this.historyIndex>=this.commandHistory.length){this.historyIndex=-1,this.setValue(this.tempInput);return}let e=this.commandHistory[this.commandHistory.length-1-this.historyIndex];this.setValue(e),this.inputEl.setSelectionRange(0,e.length)}autoResize(){this.inputEl.style.height="auto";let i=Math.min(Math.max(this.inputEl.scrollHeight,44),140);this.inputEl.style.height=`${i}px`}focus(){this.inputEl.focus()}setDisabled(i){this.inputEl.disabled=i,this.sendButtonEl.disabled=i,i&&this.closeMentionMenu()}setProcessing(i){i?(this.sendButtonEl.classList.add("claude-hidden"),this.createStopButton(),this.inputEl.disabled=!0,this.closeMentionMenu()):(this.sendButtonEl.classList.remove("claude-hidden"),this.removeStopButton(),this.inputEl.disabled=!1)}getValue(){return this.inputEl.value}setValue(i){this.inputEl.value=i,this.autoResize(),this.updateMentionSuggestions()}handleMentionKeydown(i){return this.isMentionMenuOpen()?i.key==="ArrowDown"?(i.preventDefault(),this.moveMentionSelection(1),!0):i.key==="ArrowUp"?(i.preventDefault(),this.moveMentionSelection(-1),!0):i.key==="Enter"||i.key==="Tab"?(i.preventDefault(),this.selectMention(this.mentionSelectedIndex),!0):i.key==="Escape"?(i.preventDefault(),this.closeMentionMenu(),!0):!1:!1}updateMentionSuggestions(){let i=this.getMentionContext();if(!i){this.closeMentionMenu();return}let e=this.getMentionCandidates(i.query);if(e.length===0){this.closeMentionMenu();return}this.mentionStartIndex=i.start,this.mentionEndIndex=i.end,this.mentionCandidates=e,this.mentionSelectedIndex=0,this.renderMentionMenu()}getMentionContext(){var o;if(this.inputEl.selectionStart!==this.inputEl.selectionEnd)return null;let i=(o=this.inputEl.selectionStart)!=null?o:this.inputEl.value.length,t=this.inputEl.value.slice(0,i).match(/(^|\s)@([^\s@]*)$/);if(!t)return null;let s=t[2]||"",n=i-s.length-1;return n<0?null:{start:n,end:i,query:s}}getMentionCandidates(i){let e=i.replace(/^"+/,"").replace(/"/g,"").toLowerCase(),t=this.app.vault.getFiles();return e.length===0?t.slice().sort((n,o)=>o.stat.mtime-n.stat.mtime).slice(0,this.maxMentionResults).map(n=>n.path):t.map(n=>{let o=n.path,a=o.toLowerCase(),r=n.basename.toLowerCase(),c=-1;return r===e?c=0:r.startsWith(e)?c=1:a.startsWith(e)?c=2:r.includes(e)?c=3:a.includes(e)&&(c=4),{path:o,score:c}}).filter(n=>n.score>=0).sort((n,o)=>n.score!==o.score?n.score-o.score:n.path.length!==o.path.length?n.path.length-o.path.length:n.path.localeCompare(o.path)).slice(0,this.maxMentionResults).map(n=>n.path)}renderMentionMenu(){this.mentionMenuEl.empty(),this.mentionCandidates.forEach((i,e)=>{var o;let t=(i||"").trim()||"(unknown file)",s=((o=t.split("/").pop())==null?void 0:o.trim())||t,n=this.mentionMenuEl.createEl("div",{cls:"claude-chat-mention-item"});n.setAttribute("role","option"),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label",t),n.setAttribute("title",t),n.setAttribute("data-name",s),n.setAttribute("data-path",t),e===this.mentionSelectedIndex&&n.addClass("is-selected"),n.addEventListener("mouseenter",()=>{this.mentionSelectedIndex=e,this.updateMentionSelectionClasses()}),n.addEventListener("mousedown",a=>{a.preventDefault(),this.selectMention(e)})}),this.mentionMenuEl.style.display="block"}updateMentionSelectionClasses(){let i=this.mentionMenuEl.querySelectorAll(".claude-chat-mention-item");i.forEach((t,s)=>{t.classList.toggle("is-selected",s===this.mentionSelectedIndex)});let e=i[this.mentionSelectedIndex];e==null||e.scrollIntoView({block:"nearest"})}moveMentionSelection(i){if(this.mentionCandidates.length===0)return;let e=this.mentionCandidates.length;this.mentionSelectedIndex=(this.mentionSelectedIndex+i+e)%e,this.updateMentionSelectionClasses()}selectMention(i){let e=this.mentionCandidates[i];if(!e||this.mentionStartIndex<0||this.mentionEndIndex<0)return;let t=this.inputEl.value.slice(0,this.mentionStartIndex),s=this.inputEl.value.slice(this.mentionEndIndex),n=this.formatMentionText(e),o=s.length>0&&!/^\s/.test(s)?" ":"",a=`${t}${n}${o}${s}`,r=t.length+n.length+o.length;this.inputEl.value=a,this.autoResize(),this.inputEl.focus(),this.inputEl.setSelectionRange(r,r),this.closeMentionMenu()}formatMentionText(i){return/\s/.test(i)?`@"${i}"`:`@${i}`}closeMentionMenu(){this.mentionCandidates=[],this.mentionSelectedIndex=0,this.mentionStartIndex=-1,this.mentionEndIndex=-1,this.mentionMenuEl.empty(),this.mentionMenuEl.style.display="none"}isMentionMenuOpen(){return this.mentionMenuEl.style.display!=="none"&&this.mentionCandidates.length>0}setStatus(i,e){if(!this.statusDotEl)return;this.statusDotEl.classList.remove("claude-status-dot-connecting","claude-status-dot-connected","claude-status-dot-disconnected");let t;switch(i){case"connected":this.statusDotEl.classList.add("claude-status-dot-connected"),t=e||"Connected to OpenCode";break;case"disconnected":this.statusDotEl.classList.add("claude-status-dot-disconnected"),t=e||"Disconnected from OpenCode";break;case"connecting":default:this.statusDotEl.classList.add("claude-status-dot-connecting"),t=e||"Connecting to OpenCode...";break}this.statusDotEl.setAttribute("aria-label",t),this.statusDotEl.setAttribute("title",t)}};var m=require("obsidian");var _=class{constructor(i,e){this.timerInterval=null;this.isCollapsed=!0;this.part=e,this.containerEl=i.createEl("div",{cls:"claude-tool-call"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-tool-call-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.statusIconEl=this.headerEl.createEl("span",{cls:"claude-tool-call-icon"}),this.nameEl=this.headerEl.createEl("span",{cls:"claude-tool-call-name"}),this.titleEl=this.headerEl.createEl("span",{cls:"claude-tool-call-title"}),this.timerEl=this.headerEl.createEl("span",{cls:"claude-tool-call-timer"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-tool-call-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-tool-call-body"}),this.bodyEl.style.display="none";let t=this.bodyEl.createEl("div",{cls:"claude-tool-call-input"});t.createEl("div",{cls:"claude-tool-call-section-label",text:"Input"}),this.inputEl=t.createEl("pre",{cls:"claude-tool-call-code"});let s=this.bodyEl.createEl("div",{cls:"claude-tool-call-output"});s.createEl("div",{cls:"claude-tool-call-section-label",text:"Output"}),this.outputEl=s.createEl("pre",{cls:"claude-tool-call-code"}),s.style.display="none",this.update(e)}update(i){let e=this.part.state.status;this.part=i;let t=i.state;this.containerEl.classList.remove("claude-tool-call-pending","claude-tool-call-running","claude-tool-call-completed","claude-tool-call-error"),this.containerEl.classList.add(`claude-tool-call-${t.status}`),this.nameEl.setText(i.tool);let s="\u23F3",n="";t.status==="pending"?s="\u23F3":t.status==="running"?(s="\u2699\uFE0F",n=t.title||""):t.status==="completed"?(s="\u2705",n=t.title||"Completed"):t.status==="error"&&(s="\u274C",n="Error"),this.statusIconEl.setText(s),this.titleEl.setText(n),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC"),this.inputEl.setText(JSON.stringify(t.input,null,2));let o=this.outputEl.parentElement;t.status==="completed"?(o&&(o.style.display="block"),this.outputEl.setText(t.output||"")):t.status==="error"?(o&&(o.style.display="block"),this.outputEl.setText(t.error||"")):o&&(o.style.display="none"),this.handleTimer(t)}handleTimer(i){if(i.status==="running")this.timerInterval||(this.timerInterval=setInterval(()=>{let e=(Date.now()-i.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)},100));else if(i.status==="completed"||i.status==="error"){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null);let e=(i.time.end-i.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)}else this.timerEl.setText(""),this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.containerEl.remove()}};var A=class{constructor(i,e){this.isCollapsed=!0;this.containerEl=i.createEl("div",{cls:"claude-file-diff"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-file-diff-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.iconEl=this.headerEl.createEl("span",{cls:"claude-file-diff-icon",text:"\u0394"}),this.pathEl=this.headerEl.createEl("span",{cls:"claude-file-diff-path"}),this.statsEl=this.headerEl.createEl("span",{cls:"claude-file-diff-stats"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-file-diff-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-file-diff-body"}),this.bodyEl.style.display="none";let t=this.bodyEl.createEl("div",{cls:"claude-file-diff-table-header"});t.createEl("span",{cls:"claude-file-diff-table-title",text:"Before"}),t.createEl("span",{cls:"claude-file-diff-table-title",text:"After"}),this.tableEl=this.bodyEl.createEl("div",{cls:"claude-file-diff-table"}),this.update(e)}update(i){this.pathEl.setText(i.file),this.renderStats(i),this.renderRows(i),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.containerEl.remove()}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}renderStats(i){this.statsEl.empty(),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-additions",text:`+${i.additions}`}),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-deletions",text:`-${i.deletions}`})}renderRows(i){this.tableEl.empty();let e=this.buildDisplayRows(i.before,i.after),t=e.slice(0,800);for(let s of t)this.renderRow(s);if(e.length>800){let s=e.length-800;this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:`... omitted ${s} additional rows ...`})}e.length===0&&this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:"No textual changes."})}renderRow(i){var t;let e=this.tableEl.createEl("div",{cls:`claude-file-diff-row claude-file-diff-row-${i.type}`});if(i.type==="context"){e.createEl("div",{cls:"claude-file-diff-context",text:`... ${(t=i.hiddenCount)!=null?t:0} unchanged lines ...`});return}e.createEl("div",{cls:"claude-file-diff-line-number",text:i.beforeLineNumber!==null?String(i.beforeLineNumber):""}),e.createEl("div",{cls:"claude-file-diff-line-content",text:i.beforeText}),e.createEl("div",{cls:"claude-file-diff-line-number",text:i.afterLineNumber!==null?String(i.afterLineNumber):""}),e.createEl("div",{cls:"claude-file-diff-line-content",text:i.afterText})}buildDisplayRows(i,e){let t=this.toLines(i),s=this.toLines(e),n=this.alignLines(t,s);return this.collapseUnchanged(n)}toLines(i){if(!i)return[];let t=i.replace(/\r\n/g,`
`).split(`
`);return t.length>0&&t[t.length-1]===""&&t.pop(),t}alignLines(i,e){let s=i.length*e.length<=25e4?this.computeLcsOperations(i,e):this.computeHeuristicOperations(i,e);return this.operationsToRows(s)}computeLcsOperations(i,e){let t=i.length,s=e.length,n=s+1,o=new Uint32Array((t+1)*(s+1));for(let l=1;l<=t;l+=1)for(let d=1;d<=s;d+=1){let h=l*n+d;if(i[l-1]===e[d-1]){o[h]=o[(l-1)*n+(d-1)]+1;continue}let u=o[(l-1)*n+d],x=o[l*n+(d-1)];o[h]=u>=x?u:x}let a=[],r=t,c=s;for(;r>0&&c>0;){let l=i[r-1],d=e[c-1];if(l===d){a.push({type:"unchanged",text:l}),r-=1,c-=1;continue}let h=o[(r-1)*n+c];o[r*n+(c-1)]>h?(a.push({type:"added",text:d}),c-=1):(a.push({type:"removed",text:l}),r-=1)}for(;r>0;)a.push({type:"removed",text:i[r-1]}),r-=1;for(;c>0;)a.push({type:"added",text:e[c-1]}),c-=1;return a.reverse(),a}computeHeuristicOperations(i,e){let t=[],s=0,n=0;for(;s<i.length&&n<e.length;){let o=i[s],a=e[n];if(o===a){t.push({type:"unchanged",text:o}),s+=1,n+=1;continue}if(s+1<i.length&&i[s+1]===a){t.push({type:"removed",text:o}),s+=1;continue}if(n+1<e.length&&o===e[n+1]){t.push({type:"added",text:a}),n+=1;continue}t.push({type:"removed",text:o}),t.push({type:"added",text:a}),s+=1,n+=1}for(;s<i.length;)t.push({type:"removed",text:i[s]}),s+=1;for(;n<e.length;)t.push({type:"added",text:e[n]}),n+=1;return t}operationsToRows(i){let e=[],t=1,s=1,n=[],o=[],a=()=>{if(n.length===0&&o.length===0)return;let r=Math.min(n.length,o.length);for(let c=0;c<r;c+=1)e.push({type:"modified",beforeLineNumber:t,afterLineNumber:s,beforeText:n[c],afterText:o[c]}),t+=1,s+=1;for(let c=r;c<n.length;c+=1)e.push({type:"removed",beforeLineNumber:t,afterLineNumber:null,beforeText:n[c],afterText:""}),t+=1;for(let c=r;c<o.length;c+=1)e.push({type:"added",beforeLineNumber:null,afterLineNumber:s,beforeText:"",afterText:o[c]}),s+=1;n=[],o=[]};for(let r of i){if(r.type==="unchanged"){a(),e.push({type:"unchanged",beforeLineNumber:t,afterLineNumber:s,beforeText:r.text,afterText:r.text}),t+=1,s+=1;continue}r.type==="removed"?n.push(r.text):o.push(r.text)}return a(),e}collapseUnchanged(i){let e=[],t=-1,s=n=>{if(t<0)return;let o=i.slice(t,n);if(o.length<8)e.push(...o);else{e.push(...o.slice(0,3));let a=o.length-3*2;a>0&&e.push({type:"context",beforeLineNumber:null,afterLineNumber:null,beforeText:"",afterText:"",hiddenCount:a}),e.push(...o.slice(-3))}t=-1};return i.forEach((n,o)=>{if(n.type==="unchanged"){t<0&&(t=o);return}s(o),e.push(n)}),s(i.length),e}};var z=class{constructor(i,e,t){this.request=e;this.callbacks=t;this.buttons=[];this.resolved=!1;this.diffViews=[];this.diffs=[];this.containerEl=i.createEl("div",{cls:"claude-permission-dialog"});let s=this.containerEl.createEl("div",{cls:"claude-permission-header"});s.createEl("span",{cls:"claude-permission-icon",text:"\u{1F510}"}),s.createEl("span",{cls:"claude-permission-title",text:"Permission Required"});let n=this.containerEl.createEl("div",{cls:"claude-permission-body"});n.createEl("div",{cls:"claude-permission-type",text:`${this.request.permission}: ${this.request.patterns.join(", ")}`});let o=n.createEl("div",{cls:"claude-permission-metadata"});for(let[r,c]of Object.entries(this.request.metadata)){if(this.isDiffData(r,c))continue;let l=o.createEl("div",{cls:"claude-permission-meta-item"});l.createEl("strong",{text:`${r}: `});let d;typeof c=="object"&&c!==null?d=JSON.stringify(c):d=String(c),l.createEl("span",{text:d})}this.extractDiffs(),this.renderDiffs(n);let a=this.containerEl.createEl("div",{cls:"claude-permission-actions"});this.diffs.length>0&&t.onShowInEditor&&this.createButton(a,"\u{1F4DD} Show in Editor","claude-permission-btn-editor",()=>{var r;for(let c of this.diffs)(r=t.onShowInEditor)==null||r.call(t,c)}),this.createButton(a,"Allow Once","claude-permission-btn-allow",()=>{this.handleReply("once","Allowed \u2713")}),this.createButton(a,"Allow Always","claude-permission-btn-always",()=>{this.handleReply("always","Allowed Always \u2713")}),this.createButton(a,"Reject","claude-permission-btn-reject",()=>{this.handleReply("reject","Rejected \u2717")})}isDiffData(i,e){return!!(i==="before"||i==="after"||i==="file"||i==="path"||i==="diff"&&Array.isArray(e))}extractDiffs(){let{metadata:i}=this.request;if(i.diff&&Array.isArray(i.diff)){this.diffs=i.diff;return}if(i.file&&typeof i.before=="string"&&typeof i.after=="string"){let e={file:String(i.file),before:String(i.before),after:String(i.after),additions:0,deletions:0},t=e.before.split(`
`),s=e.after.split(`
`);i.before_line_count!==void 0?e.deletions=Number(i.before_line_count)||0:e.deletions=t.length,i.after_line_count!==void 0?e.additions=Number(i.after_line_count)||0:e.additions=s.length,this.diffs=[e]}}renderDiffs(i){for(let e of this.diffs){let t=new A(i,e);this.diffViews.push(t)}}createButton(i,e,t,s){let n=i.createEl("button",{cls:`claude-permission-btn ${t}`,text:e});n.addEventListener("click",s),this.buttons.push(n)}handleReply(i,e){this.resolved||(this.resolve(),this.callbacks.onReply(i))}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-permission-resolved"),this.buttons.forEach(i=>{i.disabled=!0})}destroy(){this.diffViews.forEach(i=>i.destroy()),this.diffViews=[],this.containerEl.remove()}};var U=class{constructor(i,e,t,s){this.request=e;this.onReply=t;this.onReject=s;this.resolved=!1;this.inputs=[];this.customInputs=[];this.containerEl=i.createEl("div",{cls:"claude-question-dialog"});let n=this.containerEl.createEl("div",{cls:"claude-question-header"});n.createEl("span",{cls:"claude-question-icon",text:"\u2753"}),n.createEl("span",{cls:"claude-question-title",text:"Question"}),this.request.questions.forEach((c,l)=>{this.renderQuestion(c,l)});let o=this.containerEl.createEl("div",{cls:"claude-question-actions"});o.createEl("button",{cls:"claude-question-btn claude-question-btn-submit",text:"Submit"}).addEventListener("click",()=>this.handleSubmit()),o.createEl("button",{cls:"claude-question-btn claude-question-btn-reject",text:"Skip"}).addEventListener("click",()=>{this.resolved||(this.resolve(),this.onReject())})}renderQuestion(i,e){let t=this.containerEl.createEl("div",{cls:"claude-question-item"});t.createEl("div",{cls:"claude-question-text",text:`${i.header}: ${i.question}`});let s=t.createEl("div",{cls:"claude-question-options"});if(i.options.forEach(n=>{let o=s.createEl("label",{cls:"claude-question-option"}),a=o.createEl("input",{type:i.multiple?"checkbox":"radio",attr:{name:`q-${this.request.id}-${e}`,value:n.label}});this.inputs.push(a),o.createEl("span",{cls:"claude-question-option-label",text:n.label}),n.description&&o.createEl("span",{cls:"claude-question-option-desc",text:n.description})}),i.custom){let o=t.createEl("div",{cls:"claude-question-custom"}).createEl("input",{type:"text",cls:"claude-question-custom-input",attr:{placeholder:"Type your answer...","data-q-index":String(e)}});this.customInputs.push(o)}}handleSubmit(){if(this.resolved)return;let i=[];for(let e=0;e<this.request.questions.length;e++){let t=[];this.inputs.filter(o=>o.name===`q-${this.request.id}-${e}`&&o.checked).forEach(o=>t.push(o.value));let n=this.customInputs.find(o=>o.getAttribute("data-q-index")===String(e));n&&n.value.trim()&&t.push(n.value.trim()),i.push(t)}this.resolve(),this.onReply(i)}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-question-resolved"),this.inputs.forEach(e=>e.disabled=!0),this.customInputs.forEach(e=>e.disabled=!0),this.containerEl.querySelectorAll("button").forEach(e=>e.disabled=!0)}destroy(){this.containerEl.remove()}};var j=class{constructor(i,e){this.app=e;this.currentMessageTextEl=null;this.currentMessageBuffer="";this.currentCursorEl=null;this.currentMessageEl=null;this.currentFlowEl=null;this.sealedTextSegments=[];this.scrollLocked=!1;this.scrollBottomButton=null;this.messages=[];this.messageElements=new Map;this.toolCallViews=new Map;this.fileDiffViews=new Map;this.activeDiffHostEl=null;this.permissionDialogs=new Map;this.questionDialogs=new Map;this.lastRenderTime=0;this.containerEl=i,this.messagesEl=this.containerEl.createEl("div",{cls:"claude-chat-messages"}),this.setupLinkClickHandler(),this.setupScrollLock(),this.setupEditHandler()}setOnEditMessage(i){this.onEditMessage=i}setupScrollLock(){this.messagesEl.addEventListener("scroll",()=>{let i=this.messagesEl.scrollHeight-this.messagesEl.scrollTop<=this.messagesEl.clientHeight+50;!i&&!this.scrollLocked?(this.scrollLocked=!0,this.showScrollBottomButton()):i&&this.scrollLocked&&(this.scrollLocked=!1,this.hideScrollBottomButton())})}showScrollBottomButton(){this.scrollBottomButton||(this.scrollBottomButton=this.containerEl.createEl("button",{cls:"claude-scroll-bottom-button"}),this.scrollBottomButton.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>New messages</span>
        `,this.scrollBottomButton.addEventListener("click",()=>{this.scrollToBottomNow()}))}hideScrollBottomButton(){this.scrollBottomButton&&(this.scrollBottomButton.remove(),this.scrollBottomButton=null)}setupLinkClickHandler(){this.messagesEl.addEventListener("click",i=>{let e=i.target,t=e.closest("a");if(t){i.preventDefault(),this.handleLinkClick(t,i);return}let s=e.closest(".internal-link");if(s){i.preventDefault(),this.handleInternalLinkClick(s,i);return}let n=e.closest("code.claude-inline-reference");n&&(i.preventDefault(),this.handleInlineReferenceClick(n,i))})}handleLinkClick(i,e){let t=i.getAttribute("href");if(!(!t||t.startsWith("#"))){if(this.isExternalHref(t)){window.open(t,"_blank");return}if(this.isModifierClick(e)){this.showFilePreview(t,e,i);return}this.tryOpenFile(t)}}handleInternalLinkClick(i,e){let t=i.getAttribute("data-href")||i.textContent;if(t){if(this.isModifierClick(e)){this.showFilePreview(t,e,i);return}this.tryOpenFile(t)}}isModifierClick(i){return i.metaKey||i.ctrlKey}isExternalHref(i){return/^(https?:\/\/|mailto:|obsidian:\/\/)/i.test(i)}showFilePreview(i,e,t){let s=this.resolveFileLink(i);if(!s){let o=this.normalizeFileLink(i);o&&new m.Notice(`File not found: ${o}`);return}let n=this.app.workspace.getActiveFile();this.app.workspace.trigger("hover-link",{event:e,source:"opencode-chat",hoverParent:this.messagesEl,targetEl:t,linktext:s.path,sourcePath:(n==null?void 0:n.path)||""})}tryOpenFile(i){let e=this.resolveFileLink(i);if(e instanceof m.TFile){this.openFileInMainPane(e);return}let t=this.normalizeFileLink(i);new m.Notice(`File not found: ${t||i}`)}resolveFileLink(i){let e=this.normalizeFileLink(i);if(!e)return null;let t=this.app.metadataCache,s=this.app.vault,n=t.getFirstLinkpathDest(e,"");return!n&&!e.endsWith(".md")&&(n=t.getFirstLinkpathDest(`${e}.md`,"")),n||(n=s.getMarkdownFiles().find(a=>{let r=a.basename.toLowerCase(),c=e.toLowerCase();return r===c||r.includes(c)})||null),n instanceof m.TFile?n:null}normalizeFileLink(i){return this.safeDecodeURIComponent(i).replace(/^\[\[/,"").replace(/\]\]$/,"").replace(/\|.*$/,"").replace(/#.*/,"").trim()}safeDecodeURIComponent(i){try{return decodeURIComponent(i)}catch(e){return i}}handleInlineReferenceClick(i,e){var n;let t=(n=i.textContent)==null?void 0:n.trim();if(!t||!this.isModifierClick(e))return;let s=this.safeDecodeURIComponent(t);if(this.isExternalHref(s)){window.open(s,"_blank");return}this.showFilePreview(s,e,i)}enhanceInlineReferences(i){i.querySelectorAll("code").forEach(t=>{var o;if(t.closest("pre"))return;let s=((o=t.textContent)==null?void 0:o.trim())||"";if(!s)return;let n=this.safeDecodeURIComponent(s);(this.isExternalHref(n)||this.looksLikeFileReference(n))&&(t.classList.add("claude-inline-reference"),t.setAttribute("title","Cmd/Ctrl + click to preview/open"))})}looksLikeFileReference(i){return!i||i.includes(`
`)||i.length>240||this.isExternalHref(i)||i.startsWith("#")||/^[a-zA-Z0-9_-]+\(\)$/.test(i)?!1:i.startsWith("./")||i.startsWith("../")||i.startsWith("/")||i.includes("/")?!0:/\.[a-zA-Z0-9_-]{1,12}$/.test(i)}openFileInMainPane(i){let e=this.app.workspace,t=e.getLeavesOfType("markdown"),s=t.length>0?t[0]:null;if(s)s.openFile(i);else{let n=e.getLeaf(!1);n&&n.openFile(i)}}addMessage(i){i.role!=="system"&&this.messages.push(i);let e=this.messagesEl.createEl("div",{cls:`claude-chat-message claude-chat-message-${i.role}`});if(i.role!=="system"){this.messageElements.set(e,i);let o=this.messages.length-1;e.dataset.messageIndex=o.toString()}let s=e.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});s.innerHTML=this.formatContent(i.content);let n=e.createEl("div",{cls:"claude-chat-message-timestamp"});return n.textContent=this.formatTime(i.timestamp),this.addMessageCopyButton(e,i.content),i.role==="user"&&this.addEditButton(e),this.scrollToBottom(),s}addMessageCopyButton(i,e){let t=i.createEl("button",{cls:"claude-message-copy-button"});t.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        `,t.addEventListener("click",async s=>{s.stopPropagation(),await navigator.clipboard.writeText(e),t.classList.add("copied"),t.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            `,setTimeout(()=>{t.classList.remove("copied"),t.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                `},2e3)})}setupEditHandler(){this.messagesEl.addEventListener("click",i=>{let t=i.target.closest(".claude-message-edit-button");if(t){i.preventDefault(),i.stopPropagation();let s=t.closest(".claude-chat-message");s&&this.enterEditMode(s)}})}addEditButton(i){let e=i.createEl("button",{cls:"claude-message-edit-button"});e.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        `}enterEditMode(i){let e=i.querySelector(".claude-chat-message-text");if(!e)return;let t=parseInt(i.dataset.messageIndex||"-1");if(t<0)return;let s=this.messages[t];if(!s)return;let n=e.createEl("textarea",{cls:"claude-message-edit-textarea"});n.value=s.content;let o=e.createEl("div",{cls:"claude-message-edit-buttons"}),a=o.createEl("button",{cls:"claude-message-edit-save",text:"Save & Resend"}),r=o.createEl("button",{cls:"claude-message-edit-cancel",text:"Cancel"});e.querySelectorAll(":scope > :not(textarea):not(.claude-message-edit-buttons)").forEach(h=>h.style.display="none"),n.focus(),n.setSelectionRange(n.value.length,n.value.length);let l=()=>{let h=n.value.trim();h&&h!==s.content?(s.content=h,e.innerHTML=this.formatContent(h),this.onEditMessage&&this.onEditMessage(t,h)):this.exitEditMode(i,e)},d=()=>{this.exitEditMode(i,e)};a.addEventListener("click",l),r.addEventListener("click",d),n.addEventListener("keydown",h=>{h.key==="Enter"&&!h.shiftKey?(h.preventDefault(),l()):h.key==="Escape"&&(h.preventDefault(),d())})}exitEditMode(i,e){let t=e.querySelector(".claude-message-edit-textarea"),s=e.querySelector(".claude-message-edit-buttons");t&&t.remove(),s&&s.remove(),e.querySelectorAll(":scope > *").forEach(o=>o.style.display="")}addUserMessage(i){return this.addMessage({role:"user",content:i,timestamp:new Date})}createAssistantMessage(){let i=this.messagesEl.createEl("div",{cls:"claude-chat-message claude-chat-message-assistant"});this.currentMessageEl=i,this.fileDiffViews.clear(),this.activeDiffHostEl=null,this.sealedTextSegments=[];let e=i.createEl("div",{cls:"claude-chat-message-flow"});this.currentFlowEl=e;let t=this.createTextSegmentEl(e);this.addThinkingIndicator(t);let s=i.createEl("div",{cls:"claude-chat-message-timestamp"});return s.textContent=this.formatTime(new Date),this.currentMessageTextEl=t,this.currentMessageBuffer="",this.scrollToBottom(),t}createTextSegmentEl(i){return i.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"})}sealCurrentTextSegment(){if(!this.currentMessageTextEl||!this.currentMessageBuffer)return;this.removeTypingCursor();let i=this.app.workspace.getActiveFile(),e=(i==null?void 0:i.path)||"";this.currentMessageTextEl.empty(),m.MarkdownRenderer.renderMarkdown(this.currentMessageBuffer,this.currentMessageTextEl,e,new m.Component),this.enhanceInlineReferences(this.currentMessageTextEl),this.addCopyButtonsToCodeBlocks(this.currentMessageTextEl),this.sealedTextSegments.push({el:this.currentMessageTextEl,buffer:this.currentMessageBuffer,rendered:!0}),this.currentMessageTextEl=null,this.currentMessageBuffer=""}ensureCurrentTextSegment(){if(this.currentMessageTextEl||!this.currentFlowEl)return;let i=this.createTextSegmentEl(this.currentFlowEl);this.currentMessageTextEl=i,this.currentMessageBuffer=""}getFlowTargetEl(){return this.currentFlowEl||this.currentMessageEl||this.messagesEl}appendToAssistantMessage(i){if(this.ensureCurrentTextSegment(),this.currentMessageTextEl){this.removeThinkingIndicator(),this.currentMessageBuffer+=i;let e=Date.now();if(e-this.lastRenderTime>50){let t=this.app.workspace.getActiveFile(),s=(t==null?void 0:t.path)||"";this.currentMessageTextEl.empty(),m.MarkdownRenderer.renderMarkdown(this.currentMessageBuffer,this.currentMessageTextEl,s,new m.Component),this.addTypingCursor(),this.lastRenderTime=e}this.scrollToBottom()}}finalizeAssistantMessage(){var n;this.removeTypingCursor();let i=[...this.sealedTextSegments];this.currentMessageTextEl&&this.currentMessageBuffer&&i.push({el:this.currentMessageTextEl,buffer:this.currentMessageBuffer,rendered:!1});let e="",t=this.app.workspace.getActiveFile(),s=(t==null?void 0:t.path)||"";for(let o of i){let a=o.buffer;if(e+=a,!o.rendered&&!a.trim()){(n=o.el.closest(".claude-chat-message-content"))==null||n.remove();continue}o.rendered||(a.endsWith(`
`)||(a+=`
`),o.el.empty(),m.MarkdownRenderer.renderMarkdown(a,o.el,s,new m.Component),this.enhanceInlineReferences(o.el),this.addCopyButtonsToCodeBlocks(o.el))}e&&this.messages.push({role:"assistant",content:e,timestamp:new Date}),this.currentMessageEl&&this.addMessageCopyButton(this.currentMessageEl,e),this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentMessageEl=null,this.currentFlowEl=null,this.sealedTextSegments=[]}addCopyButtonsToCodeBlocks(i){i.querySelectorAll("pre").forEach(t=>{if(t.querySelector(".claude-code-copy-button"))return;let s=t.createEl("button",{cls:"claude-code-copy-button"});s.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span>Copy</span>
            `,s.addEventListener("click",async()=>{let n=t.querySelector("code");if(n){let o=n.textContent||"";await navigator.clipboard.writeText(o),s.classList.add("copied"),s.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>Copied!</span>
                    `,setTimeout(()=>{s.classList.remove("copied"),s.innerHTML=`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copy</span>
                        `},2e3)}})})}showThinking(){this.currentMessageTextEl&&!this.currentMessageBuffer&&this.addThinkingIndicator(this.currentMessageTextEl)}hideThinking(){this.removeThinkingIndicator()}addThinkingIndicator(i){if(i.querySelector(".claude-chat-message-thinking"))return;let t=i.createEl("div",{cls:"claude-chat-message-thinking"}),s=t.createEl("div",{cls:"claude-thinking-dots"});for(let o=0;o<3;o++)s.createEl("span",{cls:"claude-thinking-dot"});let n=t.createEl("span",{cls:"claude-thinking-text",text:"Thinking"})}removeThinkingIndicator(){if(this.currentMessageTextEl){let i=this.currentMessageTextEl.querySelector(".claude-chat-message-thinking");i&&i.remove()}}addTypingCursor(){this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentCursorEl=this.currentMessageTextEl.createEl("span",{cls:"claude-typing-cursor"}))}removeTypingCursor(){this.currentCursorEl&&(this.currentCursorEl.remove(),this.currentCursorEl=null)}formatContent(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}formatTime(i){return i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}scrollToBottom(){this.scrollLocked||(this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}scrollToBottomNow(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight,this.scrollLocked=!1,this.hideScrollBottomButton()}addToolCall(i){let e=this.toolCallViews.get(i.id);if(e)return e.update(i),e;this.sealCurrentTextSegment();let t=this.getFlowTargetEl(),s=new _(t,i);return this.toolCallViews.set(i.id,s),this.scrollToBottom(),s}addFileDiffs(i,e){if(e.length===0)return;this.sealCurrentTextSegment();let t=this.getFlowTargetEl();this.activeDiffHostEl!==t&&(this.fileDiffViews.clear(),this.activeDiffHostEl=t);for(let n of e){let o=`${i}:${n.file}`,a=this.fileDiffViews.get(o);if(a){a.update(n);continue}let r=new A(t,n);this.fileDiffViews.set(o,r)}this.scrollToBottom()}addPermissionDialog(i,e){this.sealCurrentTextSegment();let t=this.getFlowTargetEl(),s=new z(t,i,e);return this.permissionDialogs.set(i.id,s),this.scrollToBottom(),s}addQuestionDialog(i,e,t){this.sealCurrentTextSegment();let s=this.getFlowTargetEl(),n=new U(s,i,e,t);return this.questionDialogs.set(i.id,n),this.scrollToBottom(),n}addStepIndicator(i){this.sealCurrentTextSegment();let e=this.getFlowTargetEl();if(i.type==="step-start"){let t=e.createEl("div",{cls:"claude-step-indicator claude-step-start"});t.createEl("span",{cls:"claude-step-icon",text:"\u25B6"}),t.createEl("span",{cls:"claude-step-label",text:i.step||"Step started"})}else{let t=e.createEl("div",{cls:"claude-step-indicator claude-step-finish"});t.createEl("span",{cls:"claude-step-icon",text:"\u25A0"});let s=i.reason||"Step finished";if(i.tokens){let n=i.tokens.input+i.tokens.output;s+=` (${n} tokens)`}i.cost!==void 0&&(s+=` \xB7 $${i.cost.toFixed(4)}`),t.createEl("span",{cls:"claude-step-label",text:s})}this.scrollToBottom()}clear(){for(let i of this.toolCallViews.values())i.destroy();this.toolCallViews.clear();for(let i of this.fileDiffViews.values())i.destroy();this.fileDiffViews.clear(),this.activeDiffHostEl=null;for(let i of this.permissionDialogs.values())i.destroy();this.permissionDialogs.clear();for(let i of this.questionDialogs.values())i.destroy();this.questionDialogs.clear(),this.messagesEl.empty(),this.messages=[],this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentFlowEl=null,this.sealedTextSegments=[],this.scrollLocked=!1,this.hideScrollBottomButton()}getMessages(){return[...this.messages]}removeMessagesAfter(i){this.messages=this.messages.slice(0,i+1),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((s,n)=>{n>i&&s.remove()}),this.messageElements.clear(),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((s,n)=>{n<this.messages.length&&(this.messageElements.set(s,this.messages[n]),s.dataset.messageIndex=n.toString())})}};var oe=["discover","outline","draft","evidence","polish","publish"],fe={discover:"Discover",outline:"Outline",draft:"Draft",evidence:"Evidence",polish:"Polish",publish:"Publish"},K=class{constructor(i,e){this.callbacks=e;this.isDetailsOpen=!1;this.panelEl=i.createEl("div",{cls:"claude-writing-task-panel"}),this.headerEl=this.panelEl.createEl("div",{cls:"claude-writing-task-header"});let t=this.headerEl.createEl("div",{cls:"claude-writing-header-left"});this.titleEl=t.createEl("div",{cls:"claude-writing-task-title",text:"Writing Agent"}),this.statusEl=t.createEl("span",{cls:"claude-writing-task-status"}),this.toggleBtn=this.headerEl.createEl("div",{cls:"claude-writing-task-toggle",attr:{"aria-label":"Toggle details"}}),this.renderToggleIcon(),this.toggleBtn.addEventListener("click",()=>this.toggleDetails()),this.bodyEl=this.panelEl.createEl("div",{cls:"claude-writing-task-body"}),this.stagesEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-stages"}),this.detailsEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-details"}),this.detailsEl.style.display="none",this.objectiveEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-objective"}),this.metadataEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-metadata"}),this.metricsEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-metrics"}),this.versionsEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-versions"}),this.emptyEl=this.panelEl.createEl("div",{cls:"claude-writing-task-empty"});let s=this.emptyEl.createEl("div",{cls:"claude-writing-empty-inner"});s.createEl("span",{text:"No active writing task."}),s.createEl("button",{text:"Start New Task"}).addEventListener("click",()=>this.callbacks.onStartTask())}toggleDetails(){this.isDetailsOpen=!this.isDetailsOpen,this.detailsEl.style.display=this.isDetailsOpen?"block":"none",this.renderToggleIcon()}renderToggleIcon(){this.toggleBtn.empty(),this.isDetailsOpen?this.toggleBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>':this.toggleBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'}update(i,e){if(!i){this.panelEl.classList.add("is-empty"),this.bodyEl.style.display="none",this.emptyEl.style.display="block",this.headerEl.style.display="none";return}this.panelEl.classList.remove("is-empty"),this.bodyEl.style.display="block",this.emptyEl.style.display="none",this.headerEl.style.display="flex",this.titleEl.setText(i.title),this.statusEl.setText(i.status),this.statusEl.className="claude-writing-task-status",this.statusEl.classList.toggle("is-paused",i.status==="paused"),this.statusEl.classList.toggle("is-completed",i.status==="completed"),this.renderWorkflowStepper(i.stage),this.objectiveEl.empty(),this.objectiveEl.createEl("div",{cls:"claude-writing-task-label",text:"Objective"}),this.objectiveEl.createEl("div",{cls:"claude-writing-task-value",text:i.objective}),this.metadataEl.empty(),this.metadataEl.addClass("claude-writing-metadata-row"),this.renderInlineEditField(this.metadataEl,"Audience","audience",i.audience),this.renderInlineEditField(this.metadataEl,"Tone","tone",i.tone),this.renderInlineEditField(this.metadataEl,"Length","targetLength",i.targetLength),this.renderMetrics(e),this.renderDraftVersions(i)}renderWorkflowStepper(i){let e=this.stagesEl;e.empty();let t=e.createEl("div",{cls:"claude-workflow-stepper"}),s=oe.indexOf(i);oe.forEach((n,o)=>{let a=t.createEl("div",{cls:"claude-workflow-node"});o<s?a.addClass("is-completed"):o===s?a.addClass("is-active"):a.addClass("is-pending"),a.addEventListener("click",()=>this.callbacks.onRunStage(n)),a.setAttribute("title",`Run ${fe[n]}`);let r=a.createEl("div",{cls:"claude-workflow-dot"});if(o<s&&(r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'),a.createEl("span",{cls:"claude-workflow-label",text:fe[n]}),o<oe.length-1){let c=t.createEl("div",{cls:"claude-workflow-line"});o<s&&c.addClass("is-completed")}})}destroy(){this.panelEl.remove()}renderInlineEditField(i,e,t,s){let n=i.createEl("div",{cls:"claude-writing-inline-edit"});n.createEl("span",{cls:"claude-writing-inline-edit-label",text:`${e}: `});let o=n.createEl("span",{cls:"claude-writing-inline-edit-value",text:s});o.setAttribute("tabindex","0"),o.setAttribute("role","button"),o.setAttribute("aria-label",`Edit ${e}`);let a=()=>{let r=n.createEl("input",{cls:"claude-writing-inline-edit-input",type:"text",value:s});o.style.display="none",r.focus(),r.select();let c=()=>{var d,h;let l=r.value.trim();l&&l!==s&&((h=(d=this.callbacks).onUpdateTaskProperty)==null||h.call(d,t,l)),r.remove(),o.style.display=""};r.addEventListener("blur",c),r.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),r.blur()):l.key==="Escape"&&(r.removeEventListener("blur",c),r.remove(),o.style.display="")})};o.addEventListener("click",a),o.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),a())})}renderMetrics(i){if(this.metricsEl.empty(),this.metricsEl.createEl("div",{cls:"claude-writing-task-label",text:"Citation Coverage"}),!i||i.totalClaims===0){this.metricsEl.createEl("div",{cls:"claude-writing-task-value",text:"No citation report yet. Run `/write draft` or `/write evidence`."});return}let e=Math.round(i.coverage*100),t=`${e}% (${i.citedClaims}/${i.totalClaims})`;this.metricsEl.createEl("div",{cls:"claude-writing-task-value",text:`${t} \xB7 Sources: ${i.sourceCount}`});let n=this.metricsEl.createEl("div",{cls:"claude-writing-metrics-bar-container"}).createEl("div",{cls:"claude-writing-metrics-bar"}),o=e>=80?"claude-writing-metrics-severity-low":e>=50?"claude-writing-metrics-severity-medium":"claude-writing-metrics-severity-high";if(n.addClass(o),n.style.width=`${e}%`,i.uncitedClaims.length>0){this.metricsEl.createEl("div",{cls:"claude-writing-task-label claude-writing-metrics-uncited-label",text:`Uncited Claims (${i.uncitedClaims.length})`}).addClass(o);let r=this.metricsEl.createEl("ul",{cls:"claude-writing-task-uncited-list"});for(let c of i.uncitedClaims.slice(0,3))r.createEl("li",{text:c})}}renderDraftVersions(i){if(this.versionsEl.empty(),this.versionsEl.createEl("div",{cls:"claude-writing-task-label",text:"Draft Versions"}),i.draftVersions.length===0){this.versionsEl.createEl("div",{cls:"claude-writing-task-value",text:"No versions yet. Run `/write draft` to capture first snapshot."});return}let e=this.versionsEl.createEl("div",{cls:"claude-writing-version-list"}),t=i.draftVersions.slice(-5).reverse();for(let s of t)this.renderVersionRow(e,s,i.currentDraftVersionId===s.id)}renderVersionRow(i,e,t){let s=i.createEl("div",{cls:"claude-writing-version-row"});t&&s.addClass("is-current");let n=s.createEl("div",{cls:"claude-writing-version-meta"}),o=n.createEl("div",{cls:"claude-writing-version-label",text:e.label});t&&o.createEl("span",{cls:"claude-writing-version-current",text:"Current"});let a=[e.stage,this.formatTime(e.createdAt)];typeof e.citationCoverage=="number"&&a.push(`cite ${Math.round(e.citationCoverage*100)}%`),n.createEl("div",{cls:"claude-writing-version-detail",text:a.join(" \xB7 ")});let r=s.createEl("div",{cls:"claude-writing-version-actions"}),c=r.createEl("button",{cls:"claude-writing-version-compare",text:"Compare"});c.disabled=t,c.addEventListener("click",()=>this.callbacks.onCompareDraftVersion(e.id));let l=r.createEl("button",{cls:"claude-writing-version-rollback",text:"Rollback"});l.disabled=t,l.addEventListener("click",()=>this.callbacks.onRollbackDraftVersion(e.id))}formatTime(i){return i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}};var ge=require("obsidian"),Q=class extends ge.SuggestModal{constructor(e,t){super(e);this.onChoose=t;this.setPlaceholder("Select a style for WeChat export...")}getSuggestions(e){return[{label:"Default (\u9ED8\u8BA4)",value:"default",description:"Blue accent, clear structure. Good for tech/general."},{label:"Elegant (\u6587\u827A)",value:"elegant",description:"Brown tone, serif fonts. Good for essays/reviews."},{label:"Tech (\u6781\u5BA2)",value:"tech",description:"Dark theme, terminal style. Good for coding tutorials."},{label:"Vibrant (\u6D3B\u6CFC)",value:"vibrant",description:"Gradients, lively colors. Good for lifestyle/products."},{label:"Minimal (\u6781\u7B80)",value:"minimal",description:"Black & white, spacious. Good for serious reading."}].filter(s=>s.label.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e.label,cls:"suggestion-content"}),t.createEl("small",{text:e.description,cls:"suggestion-note"})}onChooseSuggestion(e){this.onChoose(e.value)}};var v="claude-chat-view",S="wechat-export-preview-view";function $e(p,i){let e=p.length,t=i.length,s=Array.from({length:e+1},()=>new Array(t+1).fill(0));for(let n=1;n<=e;n++)for(let o=1;o<=t;o++)p[n-1]===i[o-1]?s[n][o]=s[n-1][o-1]+1:s[n][o]=Math.max(s[n-1][o],s[n][o-1]);return s}function G(p,i,e,t,s,n){t>0&&s>0&&i[t-1]===e[s-1]?(G(p,i,e,t-1,s-1,n),n.push({type:"equal",line:i[t-1],oldIdx:t,newIdx:s})):s>0&&(t===0||p[t][s-1]>=p[t-1][s])?(G(p,i,e,t,s-1,n),n.push({type:"insert",line:e[s-1],oldIdx:t,newIdx:s})):t>0&&(G(p,i,e,t-1,s,n),n.push({type:"delete",line:i[t-1],oldIdx:t,newIdx:s}))}function qe(p,i){let e=[];for(let o=0;o<p.length;o++)p[o].type!=="equal"&&e.push(o);if(e.length===0)return[];let t=[],s=Math.max(0,e[0]-i),n=Math.min(p.length-1,e[0]+i);for(let o=1;o<e.length;o++){let a=Math.max(0,e[o]-i);a<=n+1||(t.push(me(p,s,n)),s=a),n=Math.min(p.length-1,e[o]+i)}return t.push(me(p,s,n)),t}function me(p,i,e){let t=[],s=0,n=0,o=0,a=0,r=!0,c=!0;for(let l=i;l<=e;l++){let d=p[l];switch(d.type){case"equal":t.push(` ${d.line}`),r&&(s=d.oldIdx,r=!1),c&&(o=d.newIdx,c=!1),n++,a++;break;case"delete":t.push(`-${d.line}`),r&&(s=d.oldIdx,r=!1),n++;break;case"insert":t.push(`+${d.line}`),c&&(o=d.newIdx,c=!1),a++;break}}return{oldStart:s,oldCount:n,newStart:o,newCount:a,lines:t}}function ve(p,i,e,t,s=3){let n=p.split(`
`),o=i.split(`
`),a=$e(n,o),r=[];G(a,n,o,n.length,o.length,r);let c=qe(r,s);if(c.length===0)return null;let l=[`--- ${e}`,`+++ ${t}`];for(let d of c)l.push(`@@ -${d.oldStart},${d.oldCount} +${d.newStart},${d.newCount} @@`),l.push(...d.lines);return l.join(`
`)}var we=[{permission:"bash",pattern:"*",action:"ask"},{permission:"write",pattern:"*",action:"ask"},{permission:"edit",pattern:"*",action:"ask"}],Ne={start:"discover",discover:"discover",outline:"outline",draft:"draft",evidence:"evidence",polish:"polish",publish:"publish"},J=["discover","outline","draft","evidence","polish","publish"],Ve=["full","broken","orphan","duplicate","stale"],X=class extends k.ItemView{constructor(e,t){super(e);this.writingTaskPanel=null;this.isProcessing=!1;this.pendingMetaByServerSessionId=new Map;this.citationReportBySessionId=new Map;this.plugin=t,this.sessionManager=t.sessionManager,this.contextResolver=new F(t.app),this.writingWorkflow=new N,this.citationQualityService=new O,this.publishAssistant=new $(t.app),this.knowledgeBaseService=new q(t.app),this.weChatExporter=new D(t.app),this.diffHighlighter=new W(t.app),this.boundHandlers={onTextDelta:this.handleTextDelta.bind(this),onSessionIdle:this.handleSessionIdle.bind(this),onSessionStatus:this.handleSessionStatus.bind(this),onSessionError:this.handleSessionError.bind(this),onToolUpdated:this.handleToolUpdated.bind(this),onDiffUpdated:this.handleDiffUpdated.bind(this),onPermissionAsked:this.handlePermissionAsked.bind(this),onQuestionAsked:this.handleQuestionAsked.bind(this),onStepStart:this.handleStepStart.bind(this),onStepFinish:this.handleStepFinish.bind(this),onConnected:this.handleConnected.bind(this),onDisconnected:this.handleDisconnected.bind(this),onError:this.handleError.bind(this)}}getViewType(){return v}getDisplayText(){return"OpenCode Chat"}getIcon(){return"message-square"}get server(){return this.plugin.server}get currentServerSessionId(){return this.sessionManager.getCurrentServerSessionId()}isCurrentSession(e){return this.currentServerSessionId===e}async onOpen(){var c;let e=this.containerEl.children[1];e.empty(),e.addClass("claude-chat-container");let s=e.createEl("div",{cls:"claude-chat-main-layout"}).createEl("div",{cls:"claude-chat-content"}),o=s.createEl("div",{cls:"claude-session-tabs-wrapper"}).createEl("button",{cls:"claude-clear-context-btn",attr:{"aria-label":"Clear Context and Start New Task"}});o.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            <span>Clear Context</span>
        `,o.addEventListener("click",()=>{this.handleClearContext()}),this.writingTaskPanel=new K(s,{onStartTask:()=>this.queueCommandTemplate("/write start "),onRunStage:l=>this.queueCommandTemplate(`/write ${l} `),onPauseTask:()=>this.updateCurrentWritingTaskStatus("paused"),onResumeTask:()=>this.updateCurrentWritingTaskStatus("active"),onCompleteTask:()=>this.updateCurrentWritingTaskStatus("completed"),onRollbackDraftVersion:l=>this.rollbackToDraftVersion(l),onCompareDraftVersion:l=>this.compareDraftVersion(l),onUpdateTaskProperty:(l,d)=>{let h=this.sessionManager.getCurrentWritingTask();h&&(l==="audience"||l==="tone"||l==="targetLength")&&(h[l]=d,this.sessionManager.setCurrentWritingTask(h),this.refreshWritingTaskPanel())}}),this.syncWorkflowTaskFromSession(),this.refreshWritingTaskPanel(),this.messageContainer=new j(s,this.app),this.messageContainer.setOnEditMessage(async(l,d)=>{await this.handleEditMessage(l,d)}),this.loadCurrentSessionMessages();let r=s.createEl("div",{cls:"claude-chat-input-actions"}).createEl("button",{cls:"claude-chat-action-button claude-workflow-menu-btn",attr:{"aria-label":"Open workflow actions"}});r.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
            <span>Writing Workflows</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
        `,r.addEventListener("click",l=>{let d=new k.Menu;d.addItem(h=>h.setTitle("Start Writing Task").setIcon("pen-tool").onClick(()=>this.queueCommandTemplate("/write start "))),d.addItem(h=>h.setTitle("Generate Outline").setIcon("list").onClick(()=>this.queueCommandTemplate("/write outline "))),d.addItem(h=>h.setTitle("Draft Content").setIcon("file-text").onClick(()=>this.queueCommandTemplate("/write draft "))),d.addItem(h=>h.setTitle("Evidence Review").setIcon("check-circle").onClick(()=>this.queueCommandTemplate("/write evidence "))),d.addSeparator(),d.addItem(h=>h.setTitle("Export to WeChat HTML").setIcon("share").onClick(()=>this.handleExportWeChat())),d.addSeparator(),d.addItem(h=>h.setTitle("Knowledge Base Audit").setIcon("database").onClick(()=>this.queueCommandTemplate("/kb audit full "))),d.addItem(h=>h.setTitle("Ask QA").setIcon("help-circle").onClick(()=>this.queueCommandTemplate("/qa "))),d.showAtMouseEvent(l)}),this.chatInput=new V(s,this.app,async l=>{await this.handleCommand(l)},()=>{this.handleStop()}),this.subscribeToServer(),(c=this.server)!=null&&c.connected&&this.updateStatusBadge(!0)}createActionButton(e,t,s,n){let o=e.createEl("button",{cls:"claude-chat-action-button"});o.textContent=t,o.setAttribute("aria-label",s),o.setAttribute("title",s),o.addEventListener("click",n)}queueCommandTemplate(e){!this.chatInput||this.isProcessing||(this.chatInput.setValue(e),this.chatInput.focus())}subscribeToServer(){let e=this.server;e&&(e.on("text.delta",this.boundHandlers.onTextDelta),e.on("session.idle",this.boundHandlers.onSessionIdle),e.on("session.status",this.boundHandlers.onSessionStatus),e.on("session.error",this.boundHandlers.onSessionError),e.on("tool.updated",this.boundHandlers.onToolUpdated),e.on("diff.updated",this.boundHandlers.onDiffUpdated),e.on("permission.asked",this.boundHandlers.onPermissionAsked),e.on("question.asked",this.boundHandlers.onQuestionAsked),e.on("step.start",this.boundHandlers.onStepStart),e.on("step.finish",this.boundHandlers.onStepFinish),e.on("connected",this.boundHandlers.onConnected),e.on("disconnected",this.boundHandlers.onDisconnected),e.on("error",this.boundHandlers.onError))}unsubscribeFromServer(){let e=this.server;e&&(e.off("text.delta",this.boundHandlers.onTextDelta),e.off("session.idle",this.boundHandlers.onSessionIdle),e.off("session.status",this.boundHandlers.onSessionStatus),e.off("session.error",this.boundHandlers.onSessionError),e.off("tool.updated",this.boundHandlers.onToolUpdated),e.off("diff.updated",this.boundHandlers.onDiffUpdated),e.off("permission.asked",this.boundHandlers.onPermissionAsked),e.off("question.asked",this.boundHandlers.onQuestionAsked),e.off("step.start",this.boundHandlers.onStepStart),e.off("step.finish",this.boundHandlers.onStepFinish),e.off("connected",this.boundHandlers.onConnected),e.off("disconnected",this.boundHandlers.onDisconnected),e.off("error",this.boundHandlers.onError))}handleTextDelta(e,t,s,n){this.isCurrentSession(e)&&this.messageContainer.appendToAssistantMessage(s)}handleSessionIdle(e){let t=this.pendingMetaByServerSessionId.get(e);if(this.pendingMetaByServerSessionId.delete(e),!this.isCurrentSession(e))return;this.messageContainer.finalizeAssistantMessage();let s=this.messageContainer.getMessages(),n=s[s.length-1];if(n&&n.role==="assistant"){this.sessionManager.addMessage(n);let o=n.content.match(/<stage_completed>([\w-]+)<\/stage_completed>/);if(o){let r=o[1],c=this.getCurrentWritingTask();if(c&&c.stage===r){let l=J.indexOf(r);if(l>=0&&l<J.length-1){let d=J[l+1],h=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(h,c),this.writingWorkflow.updateStage(h,d),this.sessionManager.setCurrentWritingTask(c),this.refreshWritingTaskPanel(),this.addSystemNotice(`Stage **${r}** completed. Advancing to **${d}**.`)}else l===J.length-1&&this.updateCurrentWritingTaskStatus("completed")}}let a=null;t!=null&&t.requiresCitationCheck&&(a=this.citationQualityService.evaluate(n.content),this.citationReportBySessionId.set(e,a),this.addSystemNotice(this.buildCitationCoverageNotice(a))),t!=null&&t.shouldCaptureDraftVersion&&t.stage&&this.captureDraftVersionFromAssistant(t.stage,n.content,a)}this.updateSessionList(),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}handleSessionStatus(e,t){this.isCurrentSession(e)&&(t.type==="busy"?(this.isProcessing=!0,this.chatInput.setProcessing(!0)):t.type==="idle"?(this.isProcessing=!1,this.chatInput.setProcessing(!1),this.messageContainer.hideThinking()):t.type==="retry"&&(this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

_Retrying (${t.attempt}): ${t.message}_`)))}handleSessionError(e,t){if(e&&this.pendingMetaByServerSessionId.delete(e),e&&!this.isCurrentSession(e))return;let s=(t==null?void 0:t.message)||"Unknown error";console.error("OpenCodeChatView: Session error:",s),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${s}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),o=n[n.length-1];o&&o.role==="assistant"&&this.sessionManager.addMessage(o),this.isProcessing=!1,this.chatInput.setProcessing(!1)}handleToolUpdated(e,t){this.isCurrentSession(e)&&this.messageContainer.addToolCall(t)}handleDiffUpdated(e,t){this.isCurrentSession(e)&&this.messageContainer.addFileDiffs(e,t)}handlePermissionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let t=this.server;t&&this.messageContainer.addPermissionDialog(e,{onReply:s=>{t.approvePermission(e.sessionID,e.id,s).catch(n=>{console.error("OpenCodeChatView: Failed to reply to permission:",n)})},onShowInEditor:s=>{this.diffHighlighter.showDiffInEditor(s)}})}handleQuestionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let t=this.server;t&&this.messageContainer.addQuestionDialog(e,s=>{t.replyToQuestion(e.sessionID,e.id,s).catch(n=>{console.error("OpenCodeChatView: Failed to reply to question:",n)})},()=>{t.rejectQuestion(e.id).catch(s=>{console.error("OpenCodeChatView: Failed to reject question:",s)})})}handleStepStart(e,t){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(t)}handleStepFinish(e,t){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(t)}handleConnected(){this.updateStatusBadge(!0)}handleDisconnected(){this.updateStatusBadge(!1)}handleError(e){console.error("OpenCodeChatView: Server error:",e)}updateStatusBadge(e){this.chatInput&&(e?this.chatInput.setStatus("connected"):this.chatInput.setStatus("disconnected"))}loadCurrentSessionMessages(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - Enter commands to interact with OpenCode\n\n**Keyboard Shortcuts:**\n\u2022 `Ctrl+Shift+N` - New session\n\u2022 `Ctrl+Shift+E` - Export conversation\n\u2022 `Ctrl+K` - Clear history\n\u2022 `Ctrl+L` - Focus input\n\u2022 `\u2191/\u2193` - Browse command history\n\u2022 `Shift+Enter` - New line\n\u2022 `Escape` - Stop generation\n\n**Workflow Commands:**\n\u2022 `/write start <topic>` - Start a writing task discovery\n\u2022 `/write outline [requirements]` - Create source-aware outline\n\u2022 `/write draft [requirements]` - Produce full draft with citations\n\u2022 `/write evidence [question]` - Run evidence QA audit\n\u2022 `/kb audit [full|broken|orphan|duplicate|stale]` - Run KB health audit\n\u2022 `/qa <question>` - Ask source-backed QA in current context\n\n**Tips:**\n\u2022 Click on user messages to edit and resend\n\u2022 Hover over messages to copy content\n\u2022 Type `@` in input to reference vault files\n\u2022 Use the toolbar buttons for quick actions\n\u2022 Tool calls and permissions will appear inline",timestamp:new Date});else for(let t of e)this.messageContainer.addMessage(t)}updateSessionList(){this.refreshWritingTaskPanel()}addSystemNotice(e){this.messageContainer.addMessage({role:"system",content:e,timestamp:new Date})}getCurrentSessionKey(){var e;return((e=this.sessionManager.getCurrentSession())==null?void 0:e.id)||"default-session"}getCurrentWritingTask(){return this.sessionManager.getCurrentWritingTask()}syncWorkflowTaskFromSession(){let e=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(e,this.getCurrentWritingTask())}refreshWritingTaskPanel(){if(!this.writingTaskPanel)return;let e=this.currentServerSessionId||"",t=e&&this.citationReportBySessionId.get(e)||null;this.writingTaskPanel.update(this.getCurrentWritingTask(),t)}updateCurrentWritingTaskStatus(e){let t=this.getCurrentWritingTask();if(!t){this.addSystemNotice("No active writing task. Use `/write start <topic>` first."),this.queueCommandTemplate("/write start ");return}let s={...t,status:e,updatedAt:new Date},n=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(n,s),this.sessionManager.setCurrentWritingTask(s),this.refreshWritingTaskPanel(),this.addSystemNotice(`Writing task status updated to **${e}**.`)}rollbackToDraftVersion(e){let t=this.getCurrentSessionKey();this.syncWorkflowTaskFromSession();let s=this.writingWorkflow.rollbackToDraftVersion(t,e);if(!s){this.addSystemNotice("Rollback failed: draft version not found.");return}this.sessionManager.setCurrentWritingTask(s.task),this.refreshWritingTaskPanel(),this.addSystemNotice(`Rolled back to **${s.version.label}**. Use \`/write ${s.version.stage}\` to continue from this baseline.`)}compareDraftVersion(e){let t=this.getCurrentWritingTask();if(!t){this.addSystemNotice("No active writing task.");return}let s=t.draftVersions.find(r=>r.id===e);if(!s){this.addSystemNotice("Draft version not found.");return}let n=t.draftVersions.find(r=>r.id===t.currentDraftVersionId);if(!n){this.addSystemNotice("No current draft version to compare against.");return}let o=ve(s.content,n.content,s.label,n.label);if(!o){this.addSystemNotice(`**${s.label}** and **${n.label}** are identical.`);return}let a=["## Draft Comparison",`Comparing **${s.label}** \u2192 **${n.label}**`,"","```diff",o,"```"].join(`
`);this.addSystemNotice(a)}captureDraftVersionFromAssistant(e,t,s){let n=this.getCurrentSessionKey();this.syncWorkflowTaskFromSession();let o=this.writingWorkflow.addDraftVersion(n,e,t,{citationCoverage:s==null?void 0:s.coverage,sourceCount:s==null?void 0:s.sourceCount});o&&(this.sessionManager.setCurrentWritingTask(o.task),this.refreshWritingTaskPanel(),o.created&&this.addSystemNotice(`Saved draft version: **${o.version.label}**`))}buildCitationCoverageNotice(e){let t=["## Citation Coverage Report",`- Coverage: ${Math.round(e.coverage*100)}% (${e.citedClaims}/${e.totalClaims})`,`- Sources listed: ${e.sourceCount}`];if(e.totalClaims===0)return t.push("- No claim lines detected for citation scoring."),t.join(`
`);if(e.uncitedClaims.length===0)return t.push("- Uncited claims: none"),t.join(`
`);t.push("### Uncited Claims");for(let s of e.uncitedClaims.slice(0,3))t.push(`- ${s}`);return t.push("- Action: add `[[source-note]]` links for uncited claims."),t.join(`
`)}async prepareWorkflowCommand(e){let t=e.trim();return/^\/help(?:\s+workflow)?$/i.test(t)?{displayCommand:t,promptToSend:null,localNotice:this.writingWorkflow.buildWorkflowHelp(),meta:{source:"plain",requiresCitationCheck:!1}}:/^\/write\b/i.test(t)?this.prepareWriteWorkflowCommand(t):/^\/kb\s+audit\b/i.test(t)?await this.prepareKbAuditCommand(t):/^\/qa\b/i.test(t)?this.prepareEvidenceQaCommand(t):{displayCommand:t,promptToSend:t,meta:{source:"plain",requiresCitationCheck:!1}}}prepareWriteWorkflowCommand(e){let t=e.match(/^\/write\s+([^\s]+)(?:\s+([\s\S]+))?$/i);if(!t)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/write start <topic>` or `/write outline|draft|evidence|polish|publish [requirements]`",meta:{source:"write",requiresCitationCheck:!1}};let s=t[1].toLowerCase(),n=(t[2]||"").trim(),o=Ne[s];if(!o)return{displayCommand:e,promptToSend:null,localNotice:`Unknown /write action: ${s}. Use \`/help workflow\` for available commands.`,meta:{source:"write",requiresCitationCheck:!1}};let a=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(a,this.getCurrentWritingTask());let r=this.contextResolver.resolveSnapshot(e),c=this.contextResolver.buildContextBlock(r),l=this.writingWorkflow.getTask(a);if(o==="discover"){if(!n&&!l)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/write start <topic>` (or create one task first, then use `/write discover`)",meta:{source:"write",stage:o,requiresCitationCheck:!1}};let L={...n?this.writingWorkflow.createTask(a,n):this.writingWorkflow.ensureTask(a,(l==null?void 0:l.objective)||"Untitled writing objective"),stage:"discover",status:"active",updatedAt:new Date};this.writingWorkflow.hydrateTask(a,L),this.sessionManager.setCurrentWritingTask(L),n&&this.currentServerSessionId&&this.citationReportBySessionId.delete(this.currentServerSessionId);let Ce=n||`Re-run discovery for writing task "${L.title}".`,Se=this.writingWorkflow.buildStagePrompt("discover",Ce,r,L,c);return{displayCommand:e,promptToSend:Se,localNotice:n?`Writing task created: **${L.title}**`:`Workflow stage: **discover** \xB7 Task: **${L.title}**`,meta:{source:"write",stage:o,requiresCitationCheck:!1}}}let d=this.writingWorkflow.ensureTask(a,n||"Untitled writing objective");this.writingWorkflow.updateStage(a,o);let h={...d,stage:o,status:"active",updatedAt:new Date};if(this.writingWorkflow.hydrateTask(a,h),this.sessionManager.setCurrentWritingTask(h),o==="evidence"){let ce=n||`Audit factual grounding for writing task "${h.title}".`;return{displayCommand:e,promptToSend:this.writingWorkflow.buildEvidencePrompt(ce,c),localNotice:`Workflow stage: **evidence** \xB7 Task: **${h.title}**`,meta:{source:"write",stage:o,requiresCitationCheck:!0}}}let u=n||`Continue task "${h.title}" in ${o} stage.`,x=o==="publish"?this.publishAssistant.buildPublishContextBlock(this.publishAssistant.gatherVaultContext()):void 0,T=this.writingWorkflow.buildStagePrompt(o,u,r,h,c,x),Ee=o==="draft"||o==="polish"||o==="publish";return{displayCommand:e,promptToSend:T,localNotice:`Workflow stage: **${o}** \xB7 Task: **${h.title}**`,meta:{source:"write",stage:o,requiresCitationCheck:!0,shouldCaptureDraftVersion:Ee}}}async prepareKbAuditCommand(e){let t=e.match(/^\/kb\s+audit(?:\s+([^\s]+))?(?:\s+([\s\S]+))?$/i);if(!t)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/kb audit [full|broken|orphan|duplicate|stale] [extra requirements]`",meta:{source:"kb",requiresCitationCheck:!1}};let s=(t[1]||"").toLowerCase(),n=(t[2]||"").trim(),o="full",a="";Ve.includes(s)?(o=s,a=n):a=[s,n].filter(u=>u.length>0).join(" ").trim();let r=await this.knowledgeBaseService.runAudit(),c=this.knowledgeBaseService.formatReport(r),l=this.contextResolver.resolveSnapshot(e),d=this.contextResolver.buildContextBlock(l),h=this.writingWorkflow.buildKbAuditPrompt(o,a,d,c);return{displayCommand:e,promptToSend:h,localNotice:`Knowledge base audit scope: **${o}** (Found ${r.issues.length} issues)`,meta:{source:"kb",requiresCitationCheck:!1}}}prepareEvidenceQaCommand(e){let t=e.match(/^\/qa(?:\s+([\s\S]+))?$/i),s=((t==null?void 0:t[1])||"").trim();if(!s)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/qa <question>`",meta:{source:"qa",requiresCitationCheck:!1}};let n=this.contextResolver.resolveSnapshot(e,s),o=this.contextResolver.buildContextBlock(n),a=this.writingWorkflow.buildEvidencePrompt(s,o);return{displayCommand:e,promptToSend:a,localNotice:"Running evidence QA workflow with strict citation checks.",meta:{source:"qa",requiresCitationCheck:!0}}}async handleCommand(e){if(this.isProcessing)return;let t=await this.prepareWorkflowCommand(e);if(!t.promptToSend){t.localNotice&&this.addSystemNotice(t.localNotice),this.refreshWritingTaskPanel();return}if(this.refreshWritingTaskPanel(),!this.server){console.error("OpenCodeChatView: Server not available");return}this.isProcessing=!0,this.chatInput.setProcessing(!0),this.messageContainer.addUserMessage(t.displayCommand),this.sessionManager.addMessage({role:"user",content:t.displayCommand,timestamp:new Date}),t.localNotice&&this.addSystemNotice(t.localNotice),this.messageContainer.createAssistantMessage();try{let s=this.currentServerSessionId;s||(s=(await this.server.createSession(we)).id,this.sessionManager.updateServerSessionId(s)),await this.server.sendMessage(s,t.promptToSend),this.pendingMetaByServerSessionId.set(s,t.meta||{source:"plain",requiresCitationCheck:!1})}catch(s){console.error("OpenCodeChatView: Command error:",s),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${s.message}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),o=n[n.length-1];o&&o.role==="assistant"&&this.sessionManager.addMessage(o),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}}handleStop(){if(!this.isProcessing)return;let e=this.currentServerSessionId;e&&this.pendingMetaByServerSessionId.delete(e),e&&this.server&&this.server.abortSession(e).catch(t=>{console.error("OpenCodeChatView: Failed to abort session:",t)}),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

_Stopped by user_`),this.messageContainer.finalizeAssistantMessage(),this.isProcessing=!1,this.chatInput.setProcessing(!1)}clearHistory(){let e=this.getCurrentSessionKey();this.sessionManager.clearCurrentSession(),this.sessionManager.setCurrentWritingTask(null),this.writingWorkflow.hydrateTask(e,null);let t=this.currentServerSessionId;t&&(this.citationReportBySessionId.delete(t),this.pendingMetaByServerSessionId.delete(t)),this.messageContainer.clear(),this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - History cleared",timestamp:new Date}),this.updateSessionList()}focusInput(){this.chatInput.focus()}clearDiffHighlights(){this.diffHighlighter.clearAllDiffs()}async handleClearContext(){if(this.isProcessing&&this.handleStop(),!confirm("Clear all context and start a new task? This will reset the conversation history."))return;let e=this.server;if(e!=null&&e.connected){let t=await e.createSession(we);this.sessionManager.updateServerSessionId(t.id)}this.sessionManager.clearCurrentSession(),this.writingWorkflow.hydrateTask(this.getCurrentSessionKey(),null),this.sessionManager.setCurrentWritingTask(null),this.messageContainer.clear(),this.refreshWritingTaskPanel(),this.chatInput.focus(),new k.Notice("Context cleared. Starting fresh conversation.")}loadSession(e){if(this.isProcessing&&this.handleStop(),!this.sessionManager.switchSession(e)){console.error("OpenCodeChatView: Failed to switch to session:",e);return}this.syncWorkflowTaskFromSession(),this.messageContainer.clear(),this.loadCurrentSessionMessages(),this.updateSessionList(),this.chatInput.focus()}createNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length}`);this.loadSession(e.id)}deleteSession(e){if(this.writingWorkflow.hydrateTask(e,null),!this.sessionManager.deleteSession(e)){console.error("OpenCodeChatView: Failed to delete session:",e);return}let s=this.sessionManager.getCurrentSession();s?this.loadSession(s.id):this.createNewSession()}renameSession(e,t){this.sessionManager.updateSessionName(e,t)&&this.updateSessionList()}async exportConversation(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)return;let t=this.sessionManager.getCurrentSession(),s=(t==null?void 0:t.name)||"Conversation",n=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),a=`opencode-chat-${s.replace(/[^a-zA-Z0-9]/g,"-")}-${n}.md`,r=`# OpenCode Chat Conversation

`;r+=`**Session:** ${s}

`,r+=`*Exported: ${new Date().toLocaleString()}*

`,r+=`*Server Session ID: ${(t==null?void 0:t.serverSessionId)||"N/A"}*

`,r+=`---

`;for(let d of e){if(d.role==="system")continue;let h=d.role==="user"?"\u{1F464} User":"\u{1F916} Assistant",u=d.timestamp.toLocaleTimeString();r+=`## ${h}

`,r+=`*${u}*

`,r+=`${d.content}

`,r+=`---

`}let c=this.app.vault;await c.create(a,r),c.getAbstractFileByPath(a)&&await this.app.workspace.openLinkText(a,"",!0)}async handleEditMessage(e,t){this.messageContainer.removeMessagesAfter(e),await this.handleCommand(t)}async regenerateLast(){let e=this.messageContainer.getMessages(),t=-1;for(let s=e.length-1;s>=0;s--)if(e[s].role==="user"){t=s;break}t>=0&&(this.messageContainer.removeMessagesAfter(t-1),await this.handleCommand(e[t].content))}async onClose(){this.writingTaskPanel&&(this.writingTaskPanel.destroy(),this.writingTaskPanel=null),this.unsubscribeFromServer()}handleExportWeChat(){let e=this.sessionManager.getCurrentWritingTask();if(!e||!e.currentDraftVersionId){new k.Notice("No active draft to export.");return}let t=e.draftVersions.find(n=>n.id===e.currentDraftVersionId);if(!t){new k.Notice("Draft version content not found.");return}new Q(this.app,n=>{let a=`${e.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5-_]/g,"").slice(0,50)} - WeChat ${n}`;this.weChatExporter.exportToHtml(t.content,n,a,"")}).open()}};var g=require("obsidian");var _e=[{label:"Default (\u9ED8\u8BA4)",value:"default",description:"Blue accent, clear structure. Good for tech/general."},{label:"Elegant (\u6587\u827A)",value:"elegant",description:"Brown tone, serif fonts. Good for essays/reviews."},{label:"Tech (\u6781\u5BA2)",value:"tech",description:"Dark theme, terminal style. Good for coding tutorials."},{label:"Vibrant (\u6D3B\u6CFC)",value:"vibrant",description:"Gradients, lively colors. Good for lifestyle/products."},{label:"Minimal (\u6781\u7B80)",value:"minimal",description:"Black & white, spacious. Good for serious reading."},{label:"AI Blue (AI \u84DD)",value:"aiBlue",description:"Deep sea tech feel. Perfect for AI/deep learning topics."},{label:"Matrix Green (\u9ED1\u5BA2\u7EFF)",value:"matrixGreen",description:"Hacker style. Great for programming/security."},{label:"Cyber Purple (\u8D5B\u535A\u7D2B)",value:"cyberPurple",description:"Cyberpunk style. For cutting-edge tech/AI."},{label:"Ocean Teal (\u6D77\u6D0B\u9752)",value:"oceanTeal",description:"Fresh & professional. Clean tech style."}],Y=class p extends g.ItemView{constructor(e){super(e);this.currentFile=null;this.currentStyle="default";this.previewContainer=null;this.styleSelector=null;this.weChatExporter=new D(this.app)}getViewType(){return S}getDisplayText(){return this.currentFile?`Export Preview: ${this.currentFile.name}`:"Export Preview"}getIcon(){return"file-output"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("wechat-preview-container");let e=this.containerEl.createEl("div",{cls:"wechat-preview-header"}),t=e.createEl("h3",{cls:"wechat-preview-title",text:"WeChat Export Preview"}),s=e.createEl("div",{cls:"wechat-preview-style-selector"});s.createEl("label",{text:"Style: ",cls:"wechat-preview-style-label"}),this.styleSelector=s.createEl("select",{cls:"wechat-preview-style-dropdown"}),_e.forEach(l=>{this.styleSelector.createEl("option",{value:l.value,text:l.label}).setAttribute("data-description",l.description)}),this.styleSelector.value=this.currentStyle,this.styleSelector.addEventListener("change",()=>{this.currentStyle=this.styleSelector.value,this.updatePreview()});let n=e.createEl("div",{cls:"wechat-preview-actions"});n.createEl("button",{cls:"wechat-preview-action-btn",text:"Copy for WeChat"}).addEventListener("click",()=>this.copyForWeChat()),n.createEl("button",{cls:"wechat-preview-action-btn mod-cta",text:"Export HTML"}).addEventListener("click",()=>this.exportToFile());let r=this.containerEl.createEl("div",{cls:"wechat-preview-area"});this.previewContainer=r.createEl("div",{cls:"wechat-preview-content"}),this.registerEvent(this.app.workspace.on("active-leaf-change",l=>{var h;if((l==null?void 0:l.view)instanceof p)return;let d=(h=l==null?void 0:l.view)==null?void 0:h.file;d&&d instanceof g.TFile&&this.setFile(d)}));let c=this.app.workspace.getActiveFile();c&&this.setFile(c)}async setFile(e){this.currentFile=e,this.updateDisplayText(),await this.updatePreview()}async updatePreview(){var e,t;if(!this.currentFile||!this.previewContainer){(e=this.previewContainer)==null||e.empty(),(t=this.previewContainer)==null||t.createEl("div",{cls:"wechat-preview-empty",text:"No file selected"});return}this.previewContainer.empty(),this.previewContainer.createEl("div",{cls:"wechat-preview-loading",text:"Loading preview..."});try{let s=await this.app.vault.cachedRead(this.currentFile),n=this.currentStyle,o=await this.weChatExporter.generateStyledHtml(s,n,this.currentFile.path);this.previewContainer.empty();let a=this.previewContainer.createEl("div",{cls:"wechat-article"});a.innerHTML=o}catch(s){this.previewContainer.empty(),this.previewContainer.createEl("div",{cls:"wechat-preview-error",text:`Failed to load preview: ${s}`}),new g.Notice("Failed to load preview")}}async exportToFile(){if(!this.currentFile){new g.Notice("No file to export");return}try{let e=await this.app.vault.read(this.currentFile),t=this.currentFile.basename,s=new D(this.app);new g.Notice("Exporting to HTML...");let n=await s.exportToHtml(e,this.currentStyle,t,this.currentFile.path);n&&(new g.Notice(`Exported: ${n.name}`),await this.app.workspace.getLeaf(!1).openFile(n))}catch(e){console.error("Export failed:",e),new g.Notice("Export failed. Check console for details.")}}async copyForWeChat(){var e;if(!this.currentFile){new g.Notice("No file to copy");return}if(!this.previewContainer){new g.Notice("Preview not ready");return}try{new g.Notice("Preparing content for copy...");let t=await this.app.vault.read(this.currentFile),s=await this.weChatExporter.generateFullHtml(t,this.currentStyle,this.currentFile.basename,this.currentFile.path),n=document.createElement("iframe");n.style.position="fixed",n.style.left="-9999px",n.style.top="0",n.style.width="1px",n.style.height="1px",n.style.border="none",document.body.appendChild(n);let o=n.contentDocument;if(o){o.open(),o.write('<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>'+s+"</body></html>"),o.close();let a=o.createRange();a.selectNodeContents(o.body);let r=(e=o.defaultView)==null?void 0:e.getSelection();r==null||r.removeAllRanges(),r==null||r.addRange(a);try{if(o.execCommand("copy"))new g.Notice("Copied! Now paste into WeChat Official Account editor.");else throw new Error("execCommand failed")}catch(c){await navigator.clipboard.writeText(s),new g.Notice("Copied (HTML)! Now paste into WeChat Official Account editor.")}}document.body.removeChild(n)}catch(t){console.error("Copy failed:",t),new g.Notice("Copy failed. Check console for details.")}}updateDisplayText(){let e=this.containerEl.querySelector(".view-header-title");e&&(e.textContent=this.currentFile?`Export: ${this.currentFile.name}`:"Export Preview")}};var Z=class{constructor(){this.sessions=[];this.currentSessionId=null;this.onChangeCallbacks=[];this.loadSessions()}loadSessions(i=[],e=null){this.sessions=i.map(t=>({...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),writingTask:t.writingTask?{...t.writingTask,draftVersions:(t.writingTask.draftVersions||[]).map(s=>({...s,createdAt:new Date(s.createdAt)})),stageHistory:(t.writingTask.stageHistory||[]).map(s=>({...s,timestamp:new Date(s.timestamp)})),currentDraftVersionId:t.writingTask.currentDraftVersionId||null,createdAt:new Date(t.writingTask.createdAt),updatedAt:new Date(t.writingTask.updatedAt)}:null,messages:t.messages.map(s=>({...s,timestamp:new Date(s.timestamp)}))})),this.currentSessionId=e,this.sessions.length===0?this.createSession("Default Session"):this.currentSessionId||(this.currentSessionId=this.sessions[0].id)}getSessions(){return[...this.sessions]}getCurrentSession(){return this.currentSessionId&&this.sessions.find(i=>i.id===this.currentSessionId)||null}getSession(i){return this.sessions.find(e=>e.id===i)||null}createSession(i){let e={id:this.generateId(),name:i,sessionId:null,serverSessionId:null,writingTask:null,createdAt:new Date,updatedAt:new Date,messages:[]};return this.sessions.push(e),this.currentSessionId=e.id,this.notifyChange(),e}updateSessionName(i,e){let t=this.getSession(i);return t?(t.name=e,t.updatedAt=new Date,this.notifyChange(),!0):!1}deleteSession(i){let e=this.sessions.findIndex(t=>t.id===i);return e!==-1?(this.sessions.splice(e,1),this.currentSessionId===i&&(this.currentSessionId=this.sessions.length>0?this.sessions[0].id:null,this.sessions.length===0&&this.createSession("Default Session")),this.notifyChange(),!0):!1}switchSession(i){return this.getSession(i)?(this.currentSessionId=i,this.notifyChange(),!0):!1}addMessage(i){let e=this.getCurrentSession();e&&(e.messages.push(i),e.updatedAt=new Date,this.notifyChange())}updateCliSessionId(i){let e=this.getCurrentSession();e&&(e.sessionId=i,e.updatedAt=new Date,this.notifyChange())}updateServerSessionId(i){let e=this.getCurrentSession();e&&(e.serverSessionId=i,e.updatedAt=new Date,this.notifyChange())}getCurrentServerSessionId(){let i=this.getCurrentSession();return i?i.serverSessionId:null}getCurrentWritingTask(){let i=this.getCurrentSession();return(i==null?void 0:i.writingTask)||null}setCurrentWritingTask(i){let e=this.getCurrentSession();if(e){if(!i){e.writingTask=null,e.updatedAt=new Date,this.notifyChange();return}e.writingTask={...i,draftVersions:(i.draftVersions||[]).map(t=>({...t,createdAt:new Date(t.createdAt)})),stageHistory:(i.stageHistory||[]).map(t=>({...t,timestamp:new Date(t.timestamp)})),currentDraftVersionId:i.currentDraftVersionId||null,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)},e.updatedAt=new Date,this.notifyChange()}}clearCurrentSession(){let i=this.getCurrentSession();i&&(i.messages=[],i.updatedAt=new Date,this.notifyChange())}getCurrentMessages(){let i=this.getCurrentSession();return i?i.messages:[]}getCurrentCliSessionId(){let i=this.getCurrentSession();return i?i.sessionId:null}onChange(i){this.onChangeCallbacks.push(i)}exportForSave(){return{sessions:this.sessions,currentSessionId:this.currentSessionId}}notifyChange(){for(let i of this.onChangeCallbacks)i()}generateId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}};var re=require("child_process"),P=he(require("fs")),ae=he(require("path")),xe=require("http"),be=require("obsidian"),le=class{constructor(){this.listeners={}}on(i,e){let t=this.listeners[i];if(t){t.add(e);return}this.listeners[i]=new Set([e])}off(i,e){let t=this.listeners[i];t&&(t.delete(e),t.size===0&&delete this.listeners[i])}emit(i,...e){let t=this.listeners[i];if(t)for(let s of t)s(...e)}removeAllListeners(){this.listeners={}}},I=class I extends le{constructor(e){super();this.serverProcess=null;this.sseRequest=null;this.port=0;this.baseUrl="";this.isConnected=!1;this.reconnectTimer=null;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.sseBuffer="";this.textAccumulator=new Map;this.messageRoles=new Map;this.stopping=!1;this.opencodeModel="";this.ohMyOpencodeModel="";this.enableOhMyOpencode=!0;this.vaultPath=e}static getInstance(e){return I.instance||(I.instance=new I(e)),I.instance}setModels(e,t,s){this.opencodeModel=e,this.ohMyOpencodeModel=t,this.enableOhMyOpencode=s}async listModels(){return new Promise((e,t)=>{var a,r;let s=(0,re.spawn)("opencode",["models"],{env:{...process.env,PATH:this.buildAugmentedPath()},windowsHide:!0}),n="",o="";(a=s.stdout)==null||a.on("data",c=>{n+=c.toString()}),(r=s.stderr)==null||r.on("data",c=>{o+=c.toString()}),s.on("close",c=>{if(c===0){let l=n.split(`
`).map(d=>d.trim()).filter(d=>d.length>0);e(l)}else t(new Error(`Failed to list models: ${o||"Unknown error"}`))}),s.on("error",c=>{t(c)})})}get connected(){return this.isConnected}get serverPort(){return this.port}async start(){if(this.serverProcess)return;this.stopping=!1;let e=null,t=5;for(let s=0;s<t;s+=1){let n=14e3+s;try{await this.startServerOnPort(n);return}catch(o){let a=o instanceof Error?o:new Error("Failed to start OpenCode server");if(e=a,console.error(`OpenCodeServer: Port ${n} failed:`,a.message),a.message.includes("ENOENT"))throw new Error("OpenCode CLI not found. Please install it: curl -fsSL https://opencode.ai/install | bash")}}throw e||new Error("Failed to start OpenCode server")}async restart(){if(console.log("OpenCodeServer: Restarting service..."),this.stopping=!0,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.sseRequest&&(this.sseRequest.destroy(),this.sseRequest=null),this.sseBuffer="",this.textAccumulator.clear(),this.messageRoles.clear(),this.isConnected=!1,this.serverProcess){try{this.serverProcess.kill("SIGTERM")}catch(e){}await new Promise(e=>setTimeout(e,500));try{this.serverProcess.kill("SIGKILL")}catch(e){}this.serverProcess=null}this.port=0,this.baseUrl="",this.reconnectAttempts=0,this.stopping=!1,console.log("OpenCodeServer: Waiting for port release (3s)..."),await new Promise(e=>setTimeout(e,3e3)),await this.start()}async stop(){this.stopping=!0,this.disconnectSSE(),this.textAccumulator.clear(),this.messageRoles.clear(),this.isConnected=!1,await this.killServerProcess(),this.port=0,this.baseUrl="",this.reconnectAttempts=0,this.stopping=!1}async startServerOnPort(e){var o,a,r,c;this.port=e,this.baseUrl=`http://127.0.0.1:${e}`,console.log(`OpenCodeServer: Starting on port ${e}, cwd: ${this.vaultPath}`);let t={...process.env,PATH:this.buildAugmentedPath()};this.opencodeModel&&(t.OPENCODE_MODEL=this.opencodeModel),this.enableOhMyOpencode&&this.ohMyOpencodeModel&&(t.OH_MY_OPENCODE_MODEL=this.ohMyOpencodeModel),await this.writeLocalConfig();let s=(0,re.spawn)("opencode",["serve","--port",String(e)],{cwd:this.vaultPath,env:t,stdio:["ignore","pipe","pipe"],windowsHide:!0});this.serverProcess=s,(o=s.stdout)==null||o.setEncoding("utf8"),(a=s.stderr)==null||a.setEncoding("utf8"),(r=s.stdout)==null||r.on("data",()=>{});let n="";(c=s.stderr)==null||c.on("data",l=>{let d=l.toString().trim();d&&(console.error("OpenCodeServer: stderr:",d),n+=d+`
`)}),s.on("exit",(l,d)=>{console.error(`OpenCodeServer: Process exited (code: ${l}, signal: ${d})`)});try{await this.waitForServerReady(s,()=>n)}catch(l){throw await this.stop(),l}console.log(`OpenCodeServer: Server ready on port ${e}`),await this.connectSSE()}async writeLocalConfig(){let e=ae.join(this.vaultPath,".opencode"),t=ae.join(e,"opencode.json");try{P.existsSync(e)||P.mkdirSync(e,{recursive:!0});let s={};this.enableOhMyOpencode||(s.plugin=[]),P.writeFileSync(t,JSON.stringify(s,null,2))}catch(s){console.error("OpenCodeServer: Failed to write local config:",s)}}buildAugmentedPath(){let e=process.env.HOME||process.env.USERPROFILE||"",t=e?`${e}/.opencode/bin`:"",s=process.env.PATH||"";return t&&!s.includes(t)?`${t}:${s}`:s}async waitForServerReady(e,t){let s=Date.now(),n=1e4,o=null,a=(c,l)=>{let d=t?t():"",h=d?` (stderr: ${d})`:"";o=new Error(`OpenCode server exited before ready (code: ${c!=null?c:"unknown"}, signal: ${l!=null?l:"none"})${h}`)},r=c=>{o=c};e.once("exit",a),e.once("error",r);try{for(;Date.now()-s<n;){if(o)throw o;try{await this.httpRequest("GET","/session");return}catch(c){await this.delay(500)}}}finally{e.off("exit",a),e.off("error",r)}throw o||new Error("OpenCode server did not become ready in time")}delay(e){return new Promise(t=>setTimeout(t,e))}async connectSSE(){this.disconnectSSE(),this.sseBuffer="";let e=new Promise((s,n)=>{let o=(0,xe.request)(`${this.baseUrl}/event`,{method:"GET",headers:{Accept:"text/event-stream"}},a=>{var d;let r=(d=a.statusCode)!=null?d:0;if(r>=400){let h=new Error(`SSE connection failed with status ${r}`);this.handleSseDisconnect(h),n(h);return}let c=!1,l=h=>{c||(c=!0,this.handleSseDisconnect(h))};console.log("OpenCodeServer: SSE connected"),this.reconnectAttempts=0,this.markConnected(),a.setEncoding("utf8"),a.on("data",h=>{this.handleSseData(h.toString())}),a.once("end",()=>{l(new Error("SSE connection ended"))}),a.once("close",()=>{l(new Error("SSE connection closed"))}),a.once("error",h=>{l(h)}),s()});this.sseRequest=o,o.on("error",a=>{this.handleSseDisconnect(a),n(a)}),o.end()}),t=new Promise((s,n)=>{setTimeout(()=>n(new Error("SSE connection timeout")),5e3)});return Promise.race([e,t])}disconnectSSE(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.sseRequest&&(this.sseRequest.destroy(),this.sseRequest=null),this.sseBuffer="",this.isConnected&&(this.isConnected=!1,this.emit("disconnected"))}markConnected(){this.isConnected||(this.isConnected=!0,this.emit("connected"))}handleSseDisconnect(e){this.disconnectSSE(),!this.stopping&&(e?(console.error("OpenCodeServer: SSE disconnected",e),this.emit("error",e)):console.log("OpenCodeServer: SSE disconnected"),this.scheduleReconnect())}scheduleReconnect(){this.stopping||!this.serverProcess||this.reconnectAttempts>=this.maxReconnectAttempts||this.reconnectTimer||(this.reconnectAttempts+=1,this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connectSSE().catch(e=>{let t=e instanceof Error?e:new Error("Failed to reconnect SSE");this.handleSseDisconnect(t)})},2e3))}handleSseData(e){var s;if(this.stopping)return;this.sseBuffer+=e;let t=this.sseBuffer.split(/\r?\n\r?\n/);this.sseBuffer=(s=t.pop())!=null?s:"";for(let n of t){let o=n.split(/\r?\n/).filter(r=>r.startsWith("data:")).map(r=>r.replace(/^data:\s?/,""));if(o.length===0)continue;let a=o.join(`
`);this.handleSsePayload(a)}}handleSsePayload(e){if(!this.stopping)try{let t=JSON.parse(e);this.handleEvent(t)}catch(t){let s=t instanceof Error?t:new Error("Failed to parse SSE payload");this.emit("error",s)}}handleEvent(e){switch(e.type){case"session.status":{let{sessionID:t,status:s}=e.properties;this.emit("session.status",t,s);break}case"session.idle":{this.emit("session.idle",e.properties.sessionID);break}case"session.error":{this.emit("session.error",e.properties.sessionID,e.properties.error);break}case"session.diff":{let{sessionID:t,diff:s}=e.properties;this.emit("diff.updated",t,s);break}case"message.updated":{let t=e.properties.info;t.role&&this.messageRoles.set(t.id,t.role),this.emit("message.updated",t);break}case"message.part.updated":{this.handlePartUpdated(e.properties.part,e.properties.delta);break}case"permission.asked":{this.emit("permission.asked",e.properties);break}case"question.asked":{this.emit("question.asked",e.properties);break}case"todo.updated":{let{sessionID:t,todos:s}=e.properties;this.emit("todo.updated",t,s);break}case"server.connected":{this.markConnected();break}default:break}}handlePartUpdated(e,t){var s,n;if(e.type==="text"){if(this.messageRoles.get(e.messageID)==="user")return;let a=e.id,r=(s=this.textAccumulator.get(a))!=null?s:"",c=r,l="";typeof t=="string"?(l=t,c=r+t):typeof e.text=="string"&&(c=e.text,e.text.startsWith(r)?l=e.text.slice(r.length):l=e.text),this.textAccumulator.set(a,c),this.emit("text.delta",e.sessionID,a,l,c),((n=e.time)==null?void 0:n.end)!==void 0&&this.emit("text.done",e.sessionID,a,c);return}if(e.type==="tool"){this.emit("tool.updated",e.sessionID,e);return}if(e.type==="step-start"){this.emit("step.start",e.sessionID,e);return}e.type==="step-finish"&&this.emit("step.finish",e.sessionID,e)}async httpRequest(e,t,s){if(!this.baseUrl)throw new Error("OpenCode server is not started");let n=`${this.baseUrl}${t}`,o={"Content-Type":"application/json"},a=s!==void 0?JSON.stringify(s):void 0,r=await(0,be.requestUrl)({url:n,method:e,headers:o,body:a,throw:!1});if(r.status>=400)throw new Error(`HTTP ${r.status}: ${r.text||"Request failed"}`);if(!(r.status===204||r.text.trim()===""))try{return JSON.parse(r.text)}catch(c){throw c instanceof Error?c:new Error("Failed to parse JSON response")}}async createSession(e){let t=e?{permission:e}:{};return this.httpRequest("POST","/session",t)}async listSessions(){return this.httpRequest("GET","/session")}async sendMessage(e,t){let s={parts:[{type:"text",text:t}]};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/prompt_async`,s)}async getMessages(e){return this.httpRequest("GET",`/session/${encodeURIComponent(e)}/message`)}async abortSession(e){await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/abort`)}async approvePermission(e,t,s){let n={response:s};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/permissions/${encodeURIComponent(t)}`,n)}async replyToQuestion(e,t,s){let{requestId:n,answers:o}=this.normalizeQuestionReplyArgs(e,t,s),a={answers:o};await this.httpRequest("POST",`/question/${encodeURIComponent(n)}/reply`,a)}async rejectQuestion(e){await this.httpRequest("POST",`/question/${encodeURIComponent(e)}/reject`)}normalizeQuestionReplyArgs(e,t,s){if(Array.isArray(t))return{requestId:e,answers:t};if(!s)throw new Error("Question reply requires answers");return{requestId:t,answers:s}}async killServerProcess(){let e=this.serverProcess;e&&(this.serverProcess=null,await new Promise(t=>{let s=!1,n=()=>{s||(s=!0,clearTimeout(o),t())},o=setTimeout(()=>{if(!s)try{e.kill("SIGKILL")}catch(a){n()}},3e3);e.once("exit",n),e.once("close",n);try{e.kill("SIGTERM")}catch(a){n()}}))}};I.instance=null;var ee=I;var b=require("obsidian"),te=class extends b.PluginSettingTab{constructor(e,t){super(e,t);this.ohMyOpencodeModelSetting=null;this.tempSettings=null;this.opencodeModelDropdown=null;this.ohMyOpencodeToggle=null;this.ohMyOpencodeModelDropdown=null;this.applyBtn=null;this.cancelBtn=null;this.isApplying=!1;this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"OpenCode Chat Settings"}),this.tempSettings={...this.plugin.settings};let t=e.createEl("div",{text:"Loading available models...",cls:"setting-item-description"});this.plugin.server?this.plugin.server.listModels().then(s=>{t.remove(),this.renderModelSettings(e,s),this.renderButtons(e)}).catch(s=>{t.setText(`Error loading models: ${s.message}`)}):t.setText("OpenCode server not initialized.")}renderModelSettings(e,t){new b.Setting(e).setName("OpenCode Model").setDesc("The model ID to use for the OpenCode server (e.g. opencode/gpt-4o).").addDropdown(s=>{s.addOption("","Default (System)"),t.forEach(o=>s.addOption(o,o));let n=this.tempSettings.opencodeModel;n&&!t.includes(n)&&s.addOption(n,n),s.setValue(n).onChange(o=>{this.tempSettings.opencodeModel=o}),this.opencodeModelDropdown=s}),new b.Setting(e).setName("Enable Oh-My-OpenCode").setDesc("Enable or disable the Oh-My-OpenCode plugin integration.").addToggle(s=>{s.setValue(this.tempSettings.enableOhMyOpencode).onChange(n=>{this.tempSettings.enableOhMyOpencode=n,this.updateOhMyOpencodeModelState()}),this.ohMyOpencodeToggle=s}),this.ohMyOpencodeModelSetting=new b.Setting(e).setName("Oh-My-OpenCode Model").setDesc("The model ID to use for Oh-My-OpenCode agents.").addDropdown(s=>{s.addOption("","Default (System)"),t.forEach(o=>s.addOption(o,o));let n=this.tempSettings.ohMyOpencodeModel;n&&!t.includes(n)&&s.addOption(n,n),s.setValue(n).onChange(o=>{this.tempSettings.ohMyOpencodeModel=o}),this.ohMyOpencodeModelDropdown=s}),this.updateOhMyOpencodeModelState()}renderButtons(e){new b.Setting(e).addButton(t=>{this.applyBtn=t,t.setButtonText("Apply").setCta().onClick(()=>{this.handleApply()})}).addButton(t=>{this.cancelBtn=t,t.setButtonText("Cancel").onClick(()=>{this.handleCancel()})})}async handleApply(){if(!this.isApplying){this.isApplying=!0,this.applyBtn.setDisabled(!0).setButtonText("Applying..."),this.cancelBtn.setDisabled(!0),this.plugin.settings={...this.tempSettings},await this.plugin.saveSettings();try{await this.plugin.reloadServer(),new b.Notice("Settings applied successfully.")}catch(e){let t=e instanceof Error?e.message:String(e);new b.Notice(`Restart failed: ${t}. Please restart Obsidian manually.`)}finally{this.isApplying=!1,this.applyBtn.setDisabled(!1).setButtonText("Apply"),this.cancelBtn.setDisabled(!1)}}}handleCancel(){this.isApplying||(this.tempSettings={...this.plugin.settings},this.resetControlsToTemp())}updateOhMyOpencodeModelState(){if(this.ohMyOpencodeModelSetting){let e=this.tempSettings.enableOhMyOpencode;this.ohMyOpencodeModelSetting.setDisabled(!e),e?this.ohMyOpencodeModelSetting.settingEl.style.opacity="1":this.ohMyOpencodeModelSetting.settingEl.style.opacity="0.5"}}resetControlsToTemp(){this.opencodeModelDropdown&&this.opencodeModelDropdown.setValue(this.tempSettings.opencodeModel),this.ohMyOpencodeToggle&&this.ohMyOpencodeToggle.setValue(this.tempSettings.enableOhMyOpencode),this.ohMyOpencodeModelDropdown&&this.ohMyOpencodeModelDropdown.setValue(this.tempSettings.ohMyOpencodeModel),this.updateOhMyOpencodeModelState()}};var ye={opencodeModel:"",ohMyOpencodeModel:"",enableOhMyOpencode:!0},ie=class extends se.Plugin{constructor(){super(...arguments);this.data={sessionId:null,version:"1.0.0",sessions:[],currentSessionId:null};this.settings=ye;this.sessionManager=new Z;this.server=null}async onload(){await this.loadPluginData(),await this.loadSettings(),this.syncBundledSkillsToVault();let e=this.getVaultPath();this.server=ee.getInstance(e),this.server.setModels(this.settings.opencodeModel,this.settings.ohMyOpencodeModel,this.settings.enableOhMyOpencode),this.server.start().then(()=>{var t;console.log("OpenCodeChat: Server started on port",(t=this.server)==null?void 0:t.serverPort)}).catch(t=>{console.error("OpenCodeChat: Failed to start OpenCode server:",t)}),this.addSettingTab(new te(this.app,this)),this.registerView(v,t=>new X(t,this)),this.registerView(S,t=>new Y(t)),this.addRibbonIcon("message-square","Open OpenCode Chat",()=>{this.activateView()}),this.addRibbonIcon("file-output","Open WeChat Export Preview",()=>{this.activateWeChatPreview()}),this.addCommand({id:"open-claude-chat",name:"Open OpenCode Chat",callback:()=>this.activateView()}),this.addCommand({id:"claude-chat-clear-history",name:"Clear chat history",hotkeys:[{modifiers:["Mod"],key:"k"}],callback:()=>this.clearChatHistory()}),this.addCommand({id:"claude-chat-focus-input",name:"Focus chat input",hotkeys:[{modifiers:["Mod"],key:"l"}],callback:()=>this.focusInput()}),this.addCommand({id:"claude-chat-stop",name:"Stop generation",hotkeys:[{modifiers:[],key:"Escape"}],callback:()=>this.stopGeneration()}),this.addCommand({id:"claude-chat-new-session",name:"Start new session",hotkeys:[{modifiers:["Mod","Shift"],key:"n"}],callback:()=>this.startNewSession()}),this.addCommand({id:"claude-chat-export",name:"Export conversation to Markdown",hotkeys:[{modifiers:["Mod","Shift"],key:"e"}],callback:()=>this.exportConversation()}),this.addCommand({id:"wechat-export-preview",name:"Open WeChat Export Preview",callback:()=>this.activateWeChatPreview()}),this.addCommand({id:"clear-diff-highlights",name:"Clear all diff highlights in editor",callback:()=>{let t=this.app.workspace.getLeavesOfType(v)[0];if(t){let s=t.view;s.clearDiffHighlights&&s.clearDiffHighlights()}}}),this.registerEvent(this.app.workspace.on("file-menu",(t,s)=>{s.extension==="md"&&t.addItem(n=>{n.setTitle("WeChat Export Preview").setIcon("file-output").onClick(()=>this.openWeChatPreviewForFile(s))})}))}async loadSettings(){this.settings=Object.assign({},ye,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async reloadServer(){this.server&&(this.server.setModels(this.settings.opencodeModel,this.settings.ohMyOpencodeModel,this.settings.enableOhMyOpencode),await this.server.restart())}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t)e.revealLeaf(t);else{let s=e.getRightLeaf(!1);s&&await s.setViewState({type:v,active:!0})}}async activateWeChatPreview(){let{workspace:e}=this.app,t=e.getActiveFile();if(!t){new se.Notice("No active file to preview");return}let s=e.getLeavesOfType(S)[0];if(s)e.revealLeaf(s),await s.view.setFile(t);else{let n=e.getRightLeaf(!1);n&&(await n.setViewState({type:S,active:!0}),await n.view.setFile(t))}}async openWeChatPreviewForFile(e){let{workspace:t}=this.app,s=t.getLeavesOfType(S)[0];if(s)t.revealLeaf(s),await s.view.setFile(e);else{let n=t.getRightLeaf(!1);n&&(await n.setViewState({type:S,active:!0}),await n.view.setFile(e))}}onunload(){this.server&&(this.server.stop(),this.server=null)}async loadPluginData(){let e=await this.loadData();if(e){if(this.data=e,!this.data.sessions||this.data.sessions.length===0){let t={id:"session-migrated",name:"Migrated Session",sessionId:this.data.sessionId,serverSessionId:null,writingTask:null,createdAt:new Date,updatedAt:new Date,messages:[]};this.data.sessions=[t],this.data.currentSessionId=t.id}this.sessionManager.loadSessions(this.data.sessions,this.data.currentSessionId),this.sessionManager.onChange(()=>{this.saveSessions()}),console.log("OpenCodeChat: Loaded data, sessions:",this.data.sessions.length)}else console.log("OpenCodeChat: No saved data found, starting fresh"),this.sessionManager.onChange(()=>{this.saveSessions()})}async saveSessions(){let e=this.sessionManager.exportForSave();this.data.sessions=e.sessions,this.data.currentSessionId=e.currentSessionId,await this.saveData(this.data)}async updateSessionId(e){this.sessionManager.updateCliSessionId(e)}getSessionId(){return this.sessionManager.getCurrentCliSessionId()}clearChatHistory(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let s=t.view;s.clearHistory&&s.clearHistory()}}focusInput(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let s=t.view;s.focusInput&&s.focusInput()}}stopGeneration(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let s=t.view;s.handleStop&&s.handleStop()}}startNewSession(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let s=t.view;s.handleClearContext&&s.handleClearContext()}}async exportConversation(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let s=t.view;s.exportConversation&&await s.exportConversation()}}getVaultPath(){return this.app.vault.adapter.basePath||""}syncBundledSkillsToVault(){let e=this.getVaultPath();if(!e)return;let t=(0,E.join)(e,".obsidian","plugins",this.manifest.id),s=(0,E.join)(t,"opencode-skills");if(!(0,w.existsSync)(s))return;let n=(0,E.join)(e,".opencode","skills");(0,w.mkdirSync)(n,{recursive:!0});let o=(0,w.readdirSync)(s,{withFileTypes:!0});for(let a of o){if(!a.isDirectory())continue;let r=(0,E.join)(s,a.name),c=(0,E.join)(r,"SKILL.md");if(!(0,w.existsSync)(c))continue;let l=(0,E.join)(n,a.name);this.copyDirectoryRecursive(r,l)}}copyDirectoryRecursive(e,t){(0,w.mkdirSync)(t,{recursive:!0});let s=(0,w.readdirSync)(e,{withFileTypes:!0});for(let n of s){let o=(0,E.join)(e,n.name),a=(0,E.join)(t,n.name);if(n.isDirectory()){this.copyDirectoryRecursive(o,a);continue}n.isFile()&&(0,w.copyFileSync)(o,a)}}};
