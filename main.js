/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
var be=Object.create;var D=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames;var Ce=Object.getPrototypeOf,Se=Object.prototype.hasOwnProperty;var ke=(p,s)=>{for(var e in s)D(p,e,{get:s[e],enumerable:!0})},re=(p,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of ye(s))!Se.call(p,i)&&i!==e&&D(p,i,{get:()=>s[i],enumerable:!(t=Ee(s,i))||t.enumerable});return p};var ae=(p,s,e)=>(e=p!=null?be(Ce(p)):{},re(s||!p||!p.__esModule?D(e,"default",{value:p,enumerable:!0}):e,p)),Te=p=>re(D({},"__esModule",{value:!0}),p);var qe={};ke(qe,{default:()=>Z});module.exports=Te(qe);var ee=require("obsidian"),w=require("fs"),E=require("path");var T=require("obsidian");var Me=/\[\[[^\]]+\]\]/,Le=/\[[^\]]+\]\([^)]+\)/,P=class{evaluate(s){let e=s.split(/\r?\n/),t=!1,i=!1,n=0,o=0,a=0,r=[];for(let c of e){let d=c.trim();if(!d)continue;if(d.startsWith("```")){t=!t;continue}if(t)continue;if(/^#{1,6}\s+/u.test(d)){i=/source/iu.test(d);continue}if(i){this.hasCitation(d)&&(n+=1);continue}let h=this.normalizeClaimLine(d);if(h){if(o+=1,this.hasCitation(h)){a+=1;continue}r.length<5&&r.push(this.shortenClaim(h))}}let l=o>0?a/o:n>0?1:0;return{totalClaims:o,citedClaims:a,uncitedClaims:r,sourceCount:n,coverage:l}}normalizeClaimLine(s){return/^(confidence|level|gaps|scope|total findings|high priority)\s*:/iu.test(s)?"":/^[-*+]\s+/u.test(s)?s.replace(/^[-*+]\s+/u,"").trim():/^\d+\.\s+/u.test(s)?s.replace(/^\d+\.\s+/u,"").trim():s}hasCitation(s){return Me.test(s)||Le.test(s)}shortenClaim(s){return s.length<=120?s:`${s.slice(0,117)}...`}};var R=require("obsidian"),Ie=5,De=1200,A=class{constructor(s){this.app=s}resolveSnapshot(s,e){let t=this.app.workspace.getActiveFile(),i=this.parseMentionPaths(s),n=this.resolveMentionPaths(i),o=this.collectContextFiles(t,n.existing),a=this.getRecentMarkdownFiles(o.map(d=>d.path)),r=e?this.retrieveRelatedFiles(e):[],l=this.getEditorSelection(),c=this.extractFrontmatterTags(t);return{activeFilePath:(t==null?void 0:t.path)||null,activeFileTags:c,selection:l,mentionPaths:i,missingMentionPaths:n.missing,contextFiles:o,recentFiles:a,relatedFiles:r}}buildContextBlock(s){let e=["## Workspace Context"];if(s.activeFilePath?e.push(`- Active note: [[${s.activeFilePath}]]`):e.push("- Active note: (none)"),s.activeFileTags.length>0&&e.push(`- Active note tags: ${s.activeFileTags.map(t=>`#${t}`).join(", ")}`),s.selection&&(e.push("- Selected excerpt:"),e.push("```text"),e.push(s.selection),e.push("```")),s.contextFiles.length>0){e.push("- Priority context files:");for(let t of s.contextFiles)e.push(`  - [[${t.path}]] (${t.source})`)}if(s.relatedFiles.length>0){e.push("- Related notes (search results):");for(let t of s.relatedFiles)e.push(`  - [[${t.path}]]`)}if(s.recentFiles.length>0){e.push("- Recently updated notes:");for(let t of s.recentFiles)e.push(`  - [[${t}]]`)}if(s.missingMentionPaths.length>0){e.push("- Missing @ references (not found in vault):");for(let t of s.missingMentionPaths)e.push(`  - ${t}`)}return e.push("- Citation policy: use `[[path/to/note]]` for every key claim."),e.join(`
`)}retrieveRelatedFiles(s){let e=s.toLowerCase().split(/\s+/).filter(i=>i.length>2);return e.length===0?[]:this.app.vault.getMarkdownFiles().map(i=>{let n=0,o=i.basename.toLowerCase();return e.forEach(a=>{o===a?n+=10:o.includes(a)&&(n+=3)}),{file:i,score:n}}).filter(i=>i.score>0).sort((i,n)=>n.score-i.score||n.file.stat.mtime-i.file.stat.mtime).slice(0,5).map(i=>({path:i.file.path,source:"search"}))}parseMentionPaths(s){let e=[],t=/@(?:"([^"]+)"|([^\s@]+))/g,i=t.exec(s);for(;i;){let n=(i[1]||i[2]||"").trim();n.length>0&&e.push(n),i=t.exec(s)}return[...new Set(e)]}resolveMentionPaths(s){let e=[],t=[];for(let i of s){let n=i.replace(/^"+|"+$/g,""),o=this.app.vault.getAbstractFileByPath(n);o instanceof R.TFile?e.push(o.path):t.push(n)}return{existing:e,missing:t}}collectContextFiles(s,e){let t=[],i=new Set;s&&(t.push({path:s.path,source:"active"}),i.add(s.path));for(let n of e)i.has(n)||(t.push({path:n,source:"mention"}),i.add(n));return t}getRecentMarkdownFiles(s){let e=new Set(s);return this.app.vault.getMarkdownFiles().filter(t=>!e.has(t.path)).sort((t,i)=>i.stat.mtime-t.stat.mtime).slice(0,Ie).map(t=>t.path)}getEditorSelection(){var t;let s=this.app.workspace.getActiveViewOfType(R.MarkdownView),e=((t=s==null?void 0:s.editor)==null?void 0:t.getSelection())||"";return this.truncateText(e.trim(),De)}extractFrontmatterTags(s){var n;if(!s)return[];let e=this.app.metadataCache.getFileCache(s),t=(n=e==null?void 0:e.frontmatter)==null?void 0:n.tags;return t?(Array.isArray(t)?t:[t]).map(o=>String(o).trim()).filter(o=>o.length>0).map(o=>o.startsWith("#")?o.slice(1):o):[]}truncateText(s,e){return s.length<=e?s:`${s.slice(0,e)}
...[truncated]`}};var le=require("obsidian"),Pe=40,Ae=50,Re=10,B=class{constructor(s){this.app=s}gatherVaultContext(){return{folderTree:this.collectFolderTree(),tagTaxonomy:this.collectTagTaxonomy(),recentNotePaths:this.collectRecentNotePaths()}}buildPublishContextBlock(s){let e=["## Vault Metadata (for publish suggestions)"];if(s.folderTree.length>0){e.push("### Folder Structure"),e.push("Use these existing folders when suggesting an output path:");for(let t of s.folderTree)e.push(`- ${t}/`)}else e.push("### Folder Structure"),e.push("- (root only \u2014 no subdirectories)");if(s.tagTaxonomy.length>0&&(e.push("### Existing Tag Taxonomy"),e.push("Prefer reusing existing tags. Only suggest new tags when no existing tag fits:"),e.push(s.tagTaxonomy.map(t=>`#${t}`).join(", "))),s.recentNotePaths.length>0){e.push("### Recent Note Paths (naming pattern reference)");for(let t of s.recentNotePaths)e.push(`- ${t}`)}return e.join(`
`)}collectFolderTree(){let s=this.app.vault.getRoot(),e=[];return this.walkFolders(s,0,e),e.slice(0,Pe)}walkFolders(s,e,t){if(!(e>2)){for(let i of s.children)if(i instanceof le.TFolder){let n=i.name;if(n.startsWith(".")||n==="node_modules")continue;t.push(i.path),this.walkFolders(i,e+1,t)}}}collectTagTaxonomy(){var t;let s=new Map,e=this.app.vault.getMarkdownFiles();for(let i of e){let n=this.app.metadataCache.getFileCache(i);if(!n)continue;let o=(t=n.frontmatter)==null?void 0:t.tags;if(o){let a=Array.isArray(o)?o:[o];for(let r of a){let l=this.normalizeTag(String(r));l&&s.set(l,(s.get(l)||0)+1)}}if(n.tags)for(let a of n.tags){let r=this.normalizeTag(a.tag);r&&s.set(r,(s.get(r)||0)+1)}}return Array.from(s.entries()).sort((i,n)=>n[1]-i[1]).slice(0,Ae).map(([i])=>i)}normalizeTag(s){let e=s.trim();return e?e.startsWith("#")?e.slice(1):e:""}collectRecentNotePaths(){return this.app.vault.getMarkdownFiles().sort((s,e)=>e.stat.mtime-s.stat.mtime).slice(0,Re).map(s=>s.path)}};var O=class{constructor(s){this.app=s}async runAudit(){let s=this.app.vault.getMarkdownFiles(),e=[],t={},i=new Set(s.map(r=>r.path)),n={};for(let r of s){n[r.basename]||(n[r.basename]=[]),n[r.basename].push(r),t[r.path]===void 0&&(t[r.path]=0);let l=this.app.metadataCache.getFileCache(r);if(l!=null&&l.links)for(let c of l.links){let d=this.app.metadataCache.getFirstLinkpathDest(c.link,r.path);d?t[d.path]=(t[d.path]||0)+1:e.push({type:"broken-link",file:r,detail:`Link to "${c.link}" not found`,severity:"high"})}if(l!=null&&l.embeds)for(let c of l.embeds){let d=this.app.metadataCache.getFirstLinkpathDest(c.link,r.path);d?t[d.path]=(t[d.path]||0)+1:e.push({type:"broken-link",file:r,detail:`Embed "${c.link}" not found`,severity:"high"})}}for(let r of s)!t[r.path]&&r.stat.size>0&&e.push({type:"orphan",file:r,detail:"No incoming links from other notes",severity:"low"});for(let r in n)if(n[r].length>1)for(let l of n[r])e.push({type:"duplicate-title",file:l,detail:`Title clash with ${n[r].length-1} other file(s)`,severity:"medium"});let o=365*24*60*60*1e3,a=Date.now();for(let r of s)a-r.stat.mtime>o&&e.push({type:"stale",file:r,detail:`Last modified ${new Date(r.stat.mtime).toLocaleDateString()}`,severity:"low"});return{timestamp:Date.now(),totalFiles:s.length,issues:e,summary:{brokenLinks:e.filter(r=>r.type==="broken-link").length,orphans:e.filter(r=>r.type==="orphan").length,duplicates:e.filter(r=>r.type==="duplicate-title").length,stale:e.filter(r=>r.type==="stale").length}}}formatReport(s){let e=`# Knowledge Base Health Report
`;if(e+=`**Date:** ${new Date(s.timestamp).toLocaleString()}
`,e+=`**Total Files:** ${s.totalFiles}

`,e+=`## Summary
`,e+=`- \u{1F534} Broken Links: **${s.summary.brokenLinks}**
`,e+=`- \u{1F7E0} Duplicate Titles: **${s.summary.duplicates}**
`,e+=`- \u{1F7E1} Orphan Notes: **${s.summary.orphans}**
`,e+=`- \u26AA Stale Notes (>1yr): **${s.summary.stale}**

`,s.issues.length===0)return e+=`\u{1F389} **Excellent! No issues found.**
`,e;e+=`## Issues Detail
`;let t=s.issues.filter(o=>o.type==="broken-link");if(t.length>0){e+=`### \u{1F534} Broken Links (${t.length})
`,e+=`> Links pointing to non-existent files.

`;for(let o of t.slice(0,50))e+=`- [[${o.file.path}]] : ${o.detail}
`;t.length>50&&(e+=`- ... and ${t.length-50} more
`),e+=`
`}let i=s.issues.filter(o=>o.type==="duplicate-title");if(i.length>0){e+=`### \u{1F7E0} Duplicate Titles (${i.length})
`,e+=`> Files with same basename but different folders.

`;for(let o of i.slice(0,20))e+=`- [[${o.file.path}]]
`;i.length>20&&(e+=`- ... and ${i.length-20} more
`),e+=`
`}let n=s.issues.filter(o=>o.type==="orphan");if(n.length>0){e+=`### \u{1F7E1} Orphan Notes (${n.length})
`,e+=`> Notes not linked from anywhere else.

`;for(let o of n.slice(0,20))e+=`- [[${o.file.path}]]
`;n.length>20&&(e+=`- ... and ${n.length-20} more
`),e+=`
`}return e}};var ce={discover:{label:"Discovery",goal:"Clarify scope, audience, constraints, and missing evidence before writing.",outputContract:["## Task Brief","- Objective:","- Audience:","- Key questions:","","## Information Gaps","- Gap:","- Why it matters:","- Suggested retrieval action:","","## Execution Plan","1. ...","2. ..."].join(`
`)},outline:{label:"Outline",goal:"Build a structured outline tied to evidence and intended reader flow.",outputContract:["## Proposed Title","- ...","","## Outline","1. Section","   - Key point","   - Evidence link: [[path/to/note]]","","## Source Map","- Claim -> [[path/to/note]]"].join(`
`)},draft:{label:"Draft",goal:"Write a complete draft grounded in available notes and explicit citations.",outputContract:["## Draft","<full article or document>","","## Sources","- [[path/to/note-a]]","- [[path/to/note-b]]","","## Citation Coverage","- Claims without direct evidence: <count and list>"].join(`
`)},evidence:{label:"Evidence Review",goal:"Audit each key claim for source coverage and confidence level.",outputContract:["## Claim Audit","- Claim:","  - Source:","  - Confidence: high | medium | low","  - Gap:","","## Risky Claims","- ...","","## Remediation Actions","1. ...","2. ..."].join(`
`)},polish:{label:"Polish",goal:"Improve readability, coherence, and style while preserving factual grounding.",outputContract:["## Polished Version","<improved content>","","## Major Edits","- Edit:","- Reason:","","## Source Integrity Check","- Any citation removed/changed and why"].join(`
`)},publish:{label:"Publish",goal:"Package final output for vault publishing with complete YAML frontmatter, metadata, and action checklist. Use the vault metadata section (if present) to suggest tags from existing taxonomy and a file path matching the vault folder structure.",outputContract:["## Final Title","- ...","","## YAML Frontmatter","```yaml","---","title: <final title>","date: <YYYY-MM-DD>","tags:","  - <prefer existing tags from vault taxonomy>","  - <only add new tags when no existing tag fits>","summary: <1-2 sentence summary>","author: <author or leave blank>","---","```","","## Final Content","<ready-to-publish markdown content>","","## Metadata","- Tags: <list, preferring existing vault tags>","- Summary: <1-2 sentences>","- Suggested file path: <match vault folder structure>","","## Publish Checklist","- [ ] Citation validation","- [ ] Link validation","- [ ] Style review","- [ ] Frontmatter completeness"].join(`
`)}},F=class{constructor(){this.tasksBySession=new Map}hydrateTask(s,e){var n;if(!e){this.tasksBySession.delete(s);return}let t=(e.draftVersions||[]).map(o=>({...o,createdAt:new Date(o.createdAt)})),i=(e.stageHistory||[]).map(o=>({...o,timestamp:new Date(o.timestamp)}));this.tasksBySession.set(s,{...e,draftVersions:t,stageHistory:i,currentDraftVersionId:e.currentDraftVersionId||((n=t[t.length-1])==null?void 0:n.id)||null,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)})}createTask(s,e){let t=new Date,i=e.trim(),n={id:`task-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,title:this.toTaskTitle(i),objective:i,audience:"General knowledge workers",tone:"Clear, concise, evidence-driven",targetLength:"1200-1800 words",stage:"discover",status:"active",draftVersions:[],currentDraftVersionId:null,stageHistory:[],createdAt:t,updatedAt:t};return this.tasksBySession.set(s,n),n}ensureTask(s,e){let t=this.tasksBySession.get(s);return t||this.createTask(s,e)}getTask(s){return this.tasksBySession.get(s)||null}getCurrentDraftVersion(s){let e=this.tasksBySession.get(s);return!e||!e.currentDraftVersionId?null:e.draftVersions.find(t=>t.id===e.currentDraftVersionId)||null}updateStage(s,e){let t=this.tasksBySession.get(s);if(!t)return null;let i=t.stage;return i!==e&&t.stageHistory.push({from:i,to:e,timestamp:new Date}),t.stage=e,t.updatedAt=new Date,t}addDraftVersion(s,e,t,i){let n=this.tasksBySession.get(s);if(!n)return null;let o=t.trim();if(!o)return null;let a=this.getCurrentDraftVersion(s);if(a&&a.content.trim()===o)return{task:n,version:a,created:!1};let r=new Date,l=n.draftVersions.length+1,c={id:`draft-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,stage:e,label:`${this.stageLabel(e)} v${l}`,content:o,createdAt:r,citationCoverage:i==null?void 0:i.citationCoverage,sourceCount:i==null?void 0:i.sourceCount};return n.draftVersions.push(c),n.currentDraftVersionId=c.id,n.updatedAt=r,{task:n,version:c,created:!0}}rollbackToDraftVersion(s,e){let t=this.tasksBySession.get(s);if(!t)return null;let i=t.draftVersions.find(o=>o.id===e);if(!i)return null;let n=t.stage;return t.currentDraftVersionId=i.id,t.stage=i.stage,t.status="active",t.updatedAt=new Date,n!==i.stage&&t.stageHistory.push({from:n,to:i.stage,timestamp:new Date}),{task:t,version:i}}buildStagePrompt(s,e,t,i,n,o){let a=ce[s],r=e.trim()||"(no additional request)",l=this.getTaskBaseline(i),c=["You are a writing and knowledge-base management agent for an Obsidian vault.","Work in a rigorous, source-grounded way. Do not invent facts.","","## Core Constraints","1. Every key claim must have a source link in `[[path/to/note]]` form.","2. If evidence is missing, explicitly mark as `[MISSING-EVIDENCE]`.","3. Keep conclusions traceable, concise, and actionable.","","## Current Writing Task",`- Task ID: ${i.id}`,`- Title: ${i.title}`,`- Objective: ${i.objective}`,`- Audience: ${i.audience}`,`- Tone: ${i.tone}`,`- Target Length: ${i.targetLength}`,`- Current Stage: ${a.label}`,"","## Stage Goal",`- ${a.goal}`,"","## User Request",r,"",n,"","## Output Contract",a.outputContract,"","## Stage Completion Protocol","When you have fully satisfied the goal of this stage, you MUST end your response with a specific tag:",`<stage_completed>${s}</stage_completed>`,"Do NOT include this tag if the work is partial or you have follow-up questions.","","## Missing Evidence Policy","- If evidence is insufficient, provide the safest partial answer and list what to retrieve next.",`- Mention unresolved @ references if any: ${t.missingMentionPaths.join(", ")||"(none)"}`];l&&(c.push(""),c.push("## Current Draft Baseline"),c.push(`- Active version: ${l.label}`),c.push("```markdown"),c.push(this.trimBaselineContent(l.content)),c.push("```")),o&&(c.push(""),c.push(o));let d=/wechat|微信|公众号|public account/i.test(r);return s==="publish"&&d&&(c.push(""),c.push("## \u{1F7E2} WECHAT/PUBLIC ACCOUNT MODE ACTIVATED"),c.push("The user wants to publish this to a WeChat Official Account. You MUST override the standard Output Contract with these specific rules:"),c.push(""),c.push("1. **NO YAML Frontmatter**: Do not include `---` metadata headers."),c.push("2. **Link Handling**: WeChat articles cannot have external links in the body."),c.push("   - Convert ALL external links `[text](url)` into inline text with a reference number `text [^1]`."),c.push('   - Add a "References" (\u53C2\u8003\u6587\u732E) section at the very bottom listing the URLs.'),c.push("3. **Formatting & Layout**:"),c.push("   - Use **short paragraphs** (1-3 sentences max) for mobile readability."),c.push("   - Use **bolding** for key insights freely."),c.push("   - Use `---` or visual separators between sections."),c.push("   - Remove `[[WikiLinks]]` and replace with plain text (unless it is a logical emphasis)."),c.push("4. **Tone**: Engaging, conversational, yet professional."),c.push("5. **Structure**:"),c.push("   - **Catchy Title**: Suggest 3 viral/engaging title options at the top."),c.push("   - **Lead-in**: A hook summary at the start."),c.push("   - **Body**: The main content formatted as requested."),c.push('   - **CTA**: A "Call to Action" or conclusion inviting comments/follows.'),c.push(""),c.push("## \u{1F4E6} FINAL OUTPUT FORMAT - CRITICAL"),c.push("You MUST wrap the final article content inside XML tags exactly like this:"),c.push("<final_article>"),c.push("(The full article content goes here)"),c.push("</final_article>"),c.push("Do NOT put the article inside a markdown code block (```). Output raw text inside the tags."),c.push("Do NOT include any conversation text outside the tags.")),c.join(`
`)}buildEvidencePrompt(s,e){return["Use the `evidence-qa` behavior with strict citations.",'If the provided context is insufficient, explicitly state "Low Confidence" and explain why.',"Do not hallucinate sources or facts not present in the context.","","## User Question",s.trim()||"Please run a full evidence audit for the current draft.","",e,"","## Required Output","```markdown","## Conclusion","- ...","","## Evidence","- Claim:","  - Evidence:","  - Why it supports:","","## Sources","- [[path/to/note]]","","## Confidence","- Level: high | medium | low","- Gaps:","```"].join(`
`)}buildKbAuditPrompt(s,e,t,i){let n=e.trim()||"(no additional constraints)",o=["Use the `kb-health-audit` behavior and return concise actionable findings.","","## Audit Scope",`- ${s}`,"","## User Constraints",n,"",t];return i&&(o.push(""),o.push("## Automated Audit Report (System Generated)"),o.push("The following report was generated by scanning the vault metadata. Use this as your primary source of truth."),o.push(i),o.push(""),o.push("## Task"),o.push("Analyze the above report and provide a prioritized action plan. Do not halllucinate new issues.")),o.push(""),o.push("## Required Output"),o.push("```markdown"),o.push("## Summary"),o.push("- Scope:"),o.push("- Total findings:"),o.push("- High priority:"),o.push(""),o.push("## Findings"),o.push("### Broken Links"),o.push("- ..."),o.push("### Orphan Notes"),o.push("- ..."),o.push("### Potential Duplicates"),o.push("- ..."),o.push("### Stale Notes"),o.push("- ..."),o.push(""),o.push("## Priority Actions"),o.push("1. [high] ..."),o.push("2. [medium] ..."),o.push("3. [low] ..."),o.push("```"),o.join(`
`)}buildWorkflowHelp(){return["## Writing + KB Workflow Commands","- `/write start <topic>`: create/reset a writing task and run discovery.","- `/write outline [extra requirements]`: generate evidence-aware outline.","- `/write draft [extra requirements]`: generate full draft with sources.","- `/write evidence [question]`: run evidence QA for current draft/question.","- `/write polish [style hints]`: improve writing quality while preserving claims.","- `/write publish [release notes]`: package publish-ready version and checklist.","- `/kb audit [full|broken|orphan|duplicate|stale] [constraints]`: run knowledge health audit.","- `/qa <question>`: ask an evidence-backed QA question.","","Use `@file` mentions to pin specific notes into the context bundle."].join(`
`)}toTaskTitle(s){return s?s.length<=48?s:`${s.slice(0,45)}...`:"Untitled Writing Task"}stageLabel(s){return ce[s].label}getTaskBaseline(s){return s.currentDraftVersionId&&s.draftVersions.find(e=>e.id===s.currentDraftVersionId)||null}trimBaselineContent(s){return s.length<=6e3?s:`${s.slice(0,6e3)}
...[baseline truncated]`}};var u=require("obsidian");var S={default:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  font-size: 16px;
  color: #3f3f3f;
  line-height: 1.8;
  background-color: #ffffff;
  text-align: justify;
}
.wechat-article h1, .wechat-article h2, .wechat-article h3 {
  font-weight: 700;
  color: #1a1a1a;
  margin-top: 24px;
  margin-bottom: 12px;
}
.wechat-article h1 { font-size: 22px; }
.wechat-article h2 {
  font-size: 18px;
  border-left: 3px solid #3370ff;
  padding-left: 12px;
}
.wechat-article h3 { font-size: 16px; }
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #1a1a1a; font-weight: 600; }
.wechat-article a { color: #3370ff; text-decoration: none; }
.wechat-article code:not(pre code) {
  font-family: Menlo, Monaco, Consolas, monospace;
  font-size: 14px;
  color: #d63384;
  background-color: #f3f3f3;
  padding: 2px 6px;
  border-radius: 3px;
}
.wechat-article pre {
  background-color: #1e1e1e;
  border-radius: 6px;
  padding: 16px;
  margin: 16px 0;
  overflow-x: auto;
}
.wechat-article pre code {
  font-family: Menlo, Monaco, Consolas, monospace;
  font-size: 14px;
  line-height: 1.6;
  color: #d4d4d4;
  display: block;
}
.wechat-article blockquote {
  margin: 16px 0;
  padding: 16px 20px;
  background-color: #f7f7f7;
  border-left: 3px solid #3370ff;
  border-radius: 0 4px 4px 0;
  color: #888888;
}
.wechat-article ul, .wechat-article ol { margin: 16px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 8px; }
.wechat-article ul li::before {
  content: "\u2022";
  position: absolute;
  left: -16px;
  color: #3370ff;
  font-weight: bold;
}
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 14px;
}
.wechat-article th, .wechat-article td {
  border: 1px solid #e0e0e0;
  padding: 12px;
  text-align: left;
}
.wechat-article th {
  background-color: #f7f7f7;
  font-weight: 600;
}
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; border-top: 1px solid #e0e0e0; margin: 24px 0; }
    `,tech:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 15px;
  color: #3f3f3f;
  line-height: 1.8;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 22px;
  font-weight: 700;
  color: #1a1a1a;
  margin-bottom: 24px;
  padding-bottom: 12px;
  border-bottom: 2px solid #00d4aa;
}
.wechat-article h2 {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 18px;
  font-weight: 600;
  color: #1a1a1a;
  margin-top: 36px;
  margin-bottom: 16px;
}
.wechat-article h3 {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 16px;
  font-weight: 600;
  color: #1a1a1a;
  margin-top: 24px;
  margin-bottom: 12px;
}
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #1a1a1a; font-weight: 600; }
.wechat-article em { color: #00d4aa; font-style: normal; }
.wechat-article blockquote {
  margin: 20px 0;
  padding: 16px 20px;
  background-color: #f0f4f8;
  border-left: 4px solid #00d4aa;
  border-radius: 0 4px 4px 0;
  color: #666666;
}
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  color: #00d4aa;
  background-color: #e8ecf0;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid #d0d7de;
}
.wechat-article pre {
  background-color: #0d1117;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  overflow-x: auto;
  border: 1px solid #d0d7de;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.6;
  color: #e6edf3;
  display: block;
  margin-top: 16px;
}
.wechat-article ul, .wechat-article ol { margin: 16px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 8px; }
.wechat-article a { color: #00d4aa; text-decoration: none; border-bottom: 1px dashed #00a883; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-family: "JetBrains Mono", "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
}
.wechat-article th, .wechat-article td {
  border: 1px solid #d0d7de;
  padding: 10px 14px;
  text-align: left;
}
.wechat-article th {
  background-color: #f0f4f8;
  color: #00d4aa;
  font-weight: 600;
}
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 1px; background: linear-gradient(90deg, transparent, #00d4aa, transparent); margin: 32px 0; }
    `,elegant:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #4a4a4a;
  line-height: 2;
  background-color: #fffbf5;
  text-align: justify;
}
.wechat-article h1, .wechat-article h2, .wechat-article h3 {
  font-family: Georgia, "Noto Serif SC", "Source Han Serif SC", serif;
  font-weight: 600;
  color: #2c1810;
}
.wechat-article h1 {
  font-size: 24px;
  text-align: center;
  margin-bottom: 32px;
  letter-spacing: 2px;
}
.wechat-article h2 {
  font-size: 20px;
  margin-top: 40px;
  margin-bottom: 20px;
  padding-bottom: 8px;
  border-bottom: 1px solid #e8ddd0;
}
.wechat-article h3 { font-size: 17px; margin-top: 28px; margin-bottom: 12px; }
.wechat-article p { margin-bottom: 20px; text-indent: 2em; }
.wechat-article strong { color: #2c1810; font-weight: 600; }
.wechat-article em { font-style: italic; color: #8b4513; }
.wechat-article blockquote {
  margin: 24px 0;
  padding: 20px 24px;
  background-color: #faf6f0;
  border-left: 3px solid #d4a574;
  border-radius: 0 8px 8px 0;
  font-style: italic;
  color: #8c8c8c;
}
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", Menlo, Monaco, monospace;
  font-size: 14px;
  color: #9c5030;
  background-color: #f5f0e8;
  padding: 2px 8px;
  border-radius: 4px;
}
.wechat-article pre {
  background-color: #2d2a24;
  border-radius: 8px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.7;
  color: #e8ddd0;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 28px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article a { color: #8b4513; text-decoration: underline; text-decoration-style: dotted; }
.wechat-article table { width: 100%; border-collapse: collapse; margin: 20px 0; }
.wechat-article th, .wechat-article td {
  border: 1px solid #e8ddd0;
  padding: 12px 16px;
  text-align: left;
}
.wechat-article th {
  background-color: #faf6f0;
  font-family: Georgia, "Noto Serif SC", serif;
  font-weight: 600;
}
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; text-align: center; margin: 32px 0; }
.wechat-article hr::before { content: "\u2726 \u2726 \u2726"; color: #d4a574; font-size: 12px; letter-spacing: 16px; }
    `,minimal:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  font-size: 17px;
  color: #1a1a1a;
  line-height: 2;
  background-color: #ffffff;
  letter-spacing: 0.02em;
}
.wechat-article h1 {
  font-size: 28px;
  font-weight: 700;
  color: #000000;
  text-align: center;
  margin-bottom: 48px;
  letter-spacing: 0.05em;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #000000;
  margin-top: 56px;
  margin-bottom: 24px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e5e5e5;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #000000; margin-top: 40px; margin-bottom: 16px; }
.wechat-article p { margin-bottom: 24px; }
.wechat-article strong { font-weight: 600; color: #000000; }
.wechat-article em { font-style: italic; }
.wechat-article blockquote {
  margin: 32px 0;
  padding: 24px 32px;
  background-color: #fafafa;
  border: none;
  border-radius: 0;
}
.wechat-article blockquote p { margin: 0; color: #666666; font-size: 16px; }
.wechat-article code:not(pre code) {
  font-family: "SF Mono", Menlo, Monaco, monospace;
  font-size: 15px;
  color: #1a1a1a;
  background-color: #f5f5f5;
  padding: 2px 6px;
  border-radius: 3px;
}
.wechat-article pre {
  background-color: #f5f5f5;
  border: 1px solid #f0f0f0;
  border-radius: 0;
  padding: 24px;
  margin: 32px 0;
  overflow-x: auto;
}
.wechat-article pre code {
  font-family: "SF Mono", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.7;
  color: #1a1a1a;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 24px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 12px; }
.wechat-article hr { border: none; height: 1px; background-color: #e5e5e5; margin: 48px 0; }
.wechat-article a { color: #1a1a1a; text-decoration: underline; text-underline-offset: 3px; }
.wechat-article table { width: 100%; border-collapse: collapse; margin: 32px 0; font-size: 15px; }
.wechat-article th, .wechat-article td { border: 1px solid #e5e5e5; padding: 14px 18px; text-align: left; }
.wechat-article th { background-color: #fafafa; font-weight: 600; }
.wechat-article img { max-width: 100%; height: auto; }
    `,vibrant:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #374151;
  line-height: 1.8;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  margin-bottom: 28px;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #1f2937;
  margin-top: 36px;
  margin-bottom: 16px;
  padding: 8px 16px;
  background: linear-gradient(135deg, #f0f9ff 0%, #fdf4ff 100%);
  border-radius: 8px;
  border-left: 4px solid #6366f1;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #6366f1; margin-top: 24px; margin-bottom: 12px; }
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #1f2937; font-weight: 600; }
.wechat-article em { color: #ec4899; font-style: normal; font-weight: 500; }
.wechat-article blockquote {
  margin: 24px 0;
  padding: 20px 24px;
  background: linear-gradient(135deg, #faf5ff 0%, #fdf4ff 100%);
  border-radius: 12px;
  border: none;
}
.wechat-article blockquote p { margin: 0; color: #6b7280; }
.wechat-article code:not(pre code) {
  font-family: "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  color: #7c3aed;
  background-color: #f3f4f6;
  padding: 3px 8px;
  border-radius: 6px;
}
.wechat-article pre {
  background-color: #1e1e2e;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  overflow-x: auto;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.wechat-article pre code {
  font-family: "Fira Code", Menlo, Monaco, monospace;
  font-size: 14px;
  line-height: 1.6;
  color: #cdd6f4;
  display: block;
}
.wechat-article ul { margin: 16px 0; padding-left: 8px; list-style: none; }
.wechat-article ul li { margin-bottom: 12px; padding-left: 28px; position: relative; }
.wechat-article ul li::before { content: "\u2726"; position: absolute; left: 0; color: #6366f1; }
.wechat-article a { color: #6366f1; text-decoration: none; font-weight: 500; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
.wechat-article th {
  background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
.wechat-article tr:nth-child(even) { background-color: #f9fafb; }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 4px; background: linear-gradient(90deg, #6366f1, #ec4899); border-radius: 2px; margin: 32px 0; opacity: 0.3; }
    `,aiBlue:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #2c3e50;
  line-height: 1.9;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-size: 26px;
  font-weight: 700;
  color: #1a1a2e;
  text-align: center;
  margin-bottom: 32px;
  padding-bottom: 20px;
  position: relative;
}
.wechat-article h1::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: linear-gradient(90deg, #0066ff, #00ccff);
  border-radius: 2px;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #1a1a2e;
  margin-top: 40px;
  margin-bottom: 20px;
  padding: 12px 20px;
  background: linear-gradient(135deg, #f8fbff 0%, #ffffff 100%);
  border-radius: 8px;
  border-left: 4px solid #0066ff;
  box-shadow: 0 2px 8px rgba(0, 102, 255, 0.1);
}
.wechat-article h3 {
  font-size: 17px;
  font-weight: 600;
  color: #0066ff;
  margin-top: 28px;
  margin-bottom: 14px;
  padding-left: 12px;
  border-left: 3px solid #00ccff;
}
.wechat-article p { margin-bottom: 18px; text-align: justify; }
.wechat-article strong { color: #1a1a2e; font-weight: 600; }
.wechat-article em { color: #0066ff; font-style: italic; }
.wechat-article blockquote {
  margin: 28px 0;
  padding: 20px 24px;
  background: linear-gradient(135deg, #e8f4ff 0%, #ffffff 100%);
  border-left: 4px solid #0066ff;
  border-radius: 0 8px 8px 0;
  box-shadow: 0 2px 8px rgba(0, 102, 255, 0.1);
}
.wechat-article blockquote p { margin: 0; color: #5a6c7d; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 14px;
  color: #0066ff;
  background-color: #eef4ff;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid rgba(0, 102, 255, 0.15);
}
.wechat-article pre {
  background-color: #0d1117;
  border-radius: 10px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
  border: 1px solid #30363d;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #e6edf3;
  display: block;
  margin-top: 8px;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article ul li::before { content: "\u25CF"; position: absolute; left: -18px; color: #0066ff; font-size: 12px; }
.wechat-article a { color: #0066ff; text-decoration: none; border-bottom: 1px solid #3385ff; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 24px 0;
  font-size: 14px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}
.wechat-article th {
  background: linear-gradient(135deg, #0066ff, #0040cc);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #d0e1f5; }
.wechat-article tr:nth-child(even) { background-color: #f8fbff; }
.wechat-article tr:hover { background-color: #e8f4ff; }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 2px; background: linear-gradient(90deg, transparent, #0066ff, #00ccff, #0066ff, transparent); margin: 40px 0; }
    `,matrixGreen:`
.wechat-article {
  font-family: "Courier New", Courier, monospace;
  font-size: 15px;
  color: #1a1a1a;
  line-height: 1.8;
  background-color: #fafafa;
}
.wechat-article h1 {
  font-size: 24px;
  font-weight: 700;
  color: #006622;
  text-align: center;
  margin-bottom: 32px;
  padding: 16px;
  border: 2px solid #00aa33;
  border-radius: 8px;
  letter-spacing: 4px;
}
.wechat-article h2 {
  font-size: 18px;
  font-weight: 600;
  color: #008822;
  margin-top: 36px;
  margin-bottom: 18px;
  padding-left: 16px;
  border-left: 3px solid #00aa33;
}
.wechat-article h3 { font-size: 16px; font-weight: 600; color: #009933; margin-top: 28px; margin-bottom: 14px; }
.wechat-article p { margin-bottom: 16px; }
.wechat-article strong { color: #008822; font-weight: 600; }
.wechat-article em { color: #00aa33; font-style: italic; }
.wechat-article blockquote {
  margin: 24px 0;
  padding: 16px 20px;
  background-color: #e8f0e8;
  border-left: 3px solid #00aa33;
  border-radius: 0 4px 4px 0;
  color: #557755;
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
}
.wechat-article blockquote p { margin: 0; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  color: #008822;
  background-color: #e0e8e0;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid #aaccbb;
}
.wechat-article pre {
  background-color: #000000;
  border-radius: 8px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
  border: 1px solid #00aa33;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #00ff41;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 16px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 8px; }
.wechat-article ul li::before { content: ">"; position: absolute; left: -16px; color: #00aa33; font-weight: bold; }
.wechat-article a { color: #009933; text-decoration: none; border-bottom: 1px dashed #00aa33; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  border: 1px solid #aaccbb;
}
.wechat-article th, .wechat-article td {
  border: 1px solid #cccccc;
  padding: 10px 14px;
  text-align: left;
}
.wechat-article th {
  background-color: #e8f0e8;
  color: #008822;
  font-weight: 600;
}
.wechat-article tr:nth-child(even) { background-color: rgba(0, 170, 51, 0.05); }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 1px; background: linear-gradient(90deg, transparent, #00aa33, transparent); margin: 32px 0; }
    `,cyberPurple:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #2a2a3e;
  line-height: 1.8;
  background-color: #faf8ff;
}
.wechat-article h1 {
  font-size: 26px;
  font-weight: 700;
  color: #bc13fe;
  text-align: center;
  margin-bottom: 36px;
  padding: 20px;
  background: linear-gradient(135deg, #bc13fe, #f10056);
  border-radius: 12px;
  letter-spacing: 2px;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #0ff0fc;
  margin-top: 40px;
  margin-bottom: 20px;
  padding: 12px 20px;
  background: linear-gradient(90deg, #f0e8ff, transparent);
  border-left: 4px solid #0ff0fc;
  border-radius: 0 8px 8px 0;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #bc13fe; margin-top: 32px; margin-bottom: 16px; }
.wechat-article p { margin-bottom: 18px; }
.wechat-article strong { color: #0ff0fc; font-weight: 600; }
.wechat-article em { color: #f10056; font-style: italic; }
.wechat-article blockquote {
  margin: 28px 0;
  padding: 20px 24px;
  background: linear-gradient(135deg, #f5e8ff, #f0e8ff);
  border-left: 4px solid #f10056;
  border-radius: 0 8px 8px 0;
  color: #665577;
}
.wechat-article blockquote p { margin: 0; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 14px;
  color: #8b00d4;
  background-color: #f0e0ff;
  padding: 4px 10px;
  border-radius: 6px;
  border: 1px solid #8b00d4;
}
.wechat-article pre {
  background-color: #000000;
  border-radius: 12px;
  padding: 24px;
  margin: 28px 0;
  overflow-x: auto;
  border: 1px solid #bc13fe;
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #ffffff;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article ul li::before { content: "\u25B8"; position: absolute; left: -18px; color: #bc13fe; }
.wechat-article a { color: #0ff0fc; text-decoration: none; border-bottom: 1px solid #0ff0fc; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 24px 0;
  font-size: 14px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #bc13fe;
}
.wechat-article th {
  background: linear-gradient(135deg, #bc13fe, #8b00d4);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #d0b0e0; }
.wechat-article tr:nth-child(even) { background-color: rgba(188, 19, 254, 0.1); }
.wechat-article tr:hover { background-color: rgba(15, 240, 252, 0.1); }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 2px; background: linear-gradient(90deg, transparent, #bc13fe, #f10056, #0ff0fc, transparent); margin: 40px 0; box-shadow: 0 0 15px rgba(188, 19, 254, 0.3); }
    `,oceanTeal:`
.wechat-article {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  font-size: 16px;
  color: #334155;
  line-height: 1.9;
  background-color: #ffffff;
}
.wechat-article h1 {
  font-size: 26px;
  font-weight: 700;
  color: #0f172a;
  text-align: center;
  margin-bottom: 36px;
  padding-bottom: 16px;
  border-bottom: 3px solid #0891b2;
}
.wechat-article h2 {
  font-size: 20px;
  font-weight: 600;
  color: #0f172a;
  margin-top: 40px;
  margin-bottom: 20px;
  padding: 12px 20px;
  background-color: #f0f9ff;
  border-radius: 8px;
  border-left: 4px solid #14b8a6;
}
.wechat-article h3 { font-size: 17px; font-weight: 600; color: #0891b2; margin-top: 28px; margin-bottom: 14px; }
.wechat-article p { margin-bottom: 18px; text-align: justify; }
.wechat-article strong { color: #0f172a; font-weight: 600; }
.wechat-article em { color: #14b8a6; font-style: italic; }
.wechat-article blockquote {
  margin: 28px 0;
  padding: 20px 24px;
  background-color: #ecfeff;
  border-left: 4px solid #14b8a6;
  border-radius: 0 8px 8px 0;
  color: #64748b;
}
.wechat-article blockquote p { margin: 0; }
.wechat-article code:not(pre code) {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 14px;
  color: #0891b2;
  background-color: #ecfeff;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid #bae6fd;
}
.wechat-article pre {
  background-color: #1e293b;
  border-radius: 10px;
  padding: 20px;
  margin: 24px 0;
  overflow-x: auto;
  border: 1px solid #334155;
  box-shadow: 0 4px 12px rgba(8, 145, 178, 0.15);
}
.wechat-article pre code {
  font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
  font-size: 13px;
  line-height: 1.7;
  color: #e2e8f0;
  display: block;
}
.wechat-article ul, .wechat-article ol { margin: 20px 0; padding-left: 24px; }
.wechat-article li { margin-bottom: 10px; }
.wechat-article ul li::before { content: "\u2022"; position: absolute; left: -16px; color: #0891b2; font-weight: bold; }
.wechat-article a { color: #0891b2; text-decoration: none; border-bottom: 1px solid #22d3ee; }
.wechat-article table {
  width: 100%;
  border-collapse: collapse;
  margin: 24px 0;
  font-size: 14px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(8, 145, 178, 0.1);
}
.wechat-article th {
  background: linear-gradient(135deg, #0891b2, #14b8a6);
  color: white;
  padding: 14px 16px;
  text-align: left;
  font-weight: 600;
}
.wechat-article td { padding: 12px 16px; border-bottom: 1px solid #bae6fd; }
.wechat-article tr:nth-child(even) { background-color: #f0f9ff; }
.wechat-article tr:hover { background-color: #ecfeff; }
.wechat-article img { max-width: 100%; height: auto; }
.wechat-article hr { border: none; height: 2px; background: linear-gradient(90deg, #f0f9ff, #22d3ee, #f0f9ff); margin: 40px 0; }
    `};var k=class{constructor(s){this.app=s}async imageToBase64(s,e){try{let t=s,i=s.split("?")[0].split("#")[0];if(i.startsWith("file://"))t=decodeURIComponent(i.replace("file://","")),t.startsWith("/")&&!t.match(/^\/[A-Z]:/)&&(t=t.substring(1));else if(i.startsWith("app://local/"))t=decodeURIComponent(i.replace("app://local/",""));else if(i.startsWith("obsidian://"))try{let o=new URL(i);t=o.pathname||o.searchParams.get("file")||o.href}catch(o){t=i}else if(i.includes("obsidian.md")){let o=i.match(/obsidian\.md\/(.+)/);o&&(t=decodeURIComponent(o[1]))}else t=i;if(t.startsWith("/")&&(t=t.substring(1)),e&&!t.startsWith("/")&&!t.match(/^[a-zA-Z]+:/)&&!t.match(/^[?#]/)){let o=e.substring(0,e.lastIndexOf("/"));o&&(t=o?`${o}/${t}`:t)}t=this.normalizePath(t),console.log("[WeChatExporter] Image path resolution:",{src:s,sourcePath:e,resolved:t});let n=this.app.vault.getAbstractFileByPath(t);if(console.log("[WeChatExporter] Vault file lookup:",{imagePath:t,found:n instanceof u.TFile}),n instanceof u.TFile){let o=await this.app.vault.readBinary(n),a=this.arrayBufferToBase64(o),r=n.extension.toLowerCase(),c={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",avif:"image/avif",heic:"image/heic",heif:"image/heif"}[r]||"image/png",d=`data:${c};base64,${a}`;return console.log("[WeChatExporter] Successfully converted image to base64:",{imagePath:t,mimeType:c,length:d.length}),d}if(s.startsWith("http://")||s.startsWith("https://"))try{let o=await fetch(s,{mode:"cors"});if(o.ok){let a=await o.blob(),r=await a.arrayBuffer(),l=this.arrayBufferToBase64(r),c=a.type||"image/png",d=`data:${c};base64,${l}`;return console.log("[WeChatExporter] Successfully fetched external image:",{src:s,contentType:c}),d}}catch(o){console.warn("CORS fetch failed for image:",s,o)}}catch(t){console.error("Failed to convert image to base64:",t)}return console.log("[WeChatExporter] Failed to convert image, returning original src:",s),s}normalizePath(s){let e=s.split("/"),t=[];for(let i of e)i===""||i==="."||(i===".."?t.pop():t.push(i));return t.join("/")}arrayBufferToBase64(s){let e=new Uint8Array(s),t="";for(let i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)}async processImages(s,e){let t=s.querySelectorAll("img");console.log("[WeChatExporter] Found <img> elements:",t.length,"sourcePath:",e);for(let n of Array.from(t)){let o=n.getAttribute("src");if(console.log("[WeChatExporter] Processing <img>:",o),o){let a=await this.imageToBase64(o,e);n.setAttribute("src",a),n.style.maxWidth="100%",n.style.height="auto",n.style.display="block",n.style.margin="16px auto"}}let i=s.querySelectorAll("span.internal-embed, img.internal-embed");console.log("[WeChatExporter] Found internal-embed elements:",i.length);for(let n of Array.from(i)){let o=n.getAttribute("src")||n.getAttribute("alt");if(console.log("[WeChatExporter] Processing internal-embed:",o),o){let a=await this.imageToBase64(o,e),r=document.createElement("img");r.setAttribute("src",a),r.setAttribute("alt",n.getAttribute("alt")||""),r.style.maxWidth="100%",r.style.height="auto",r.style.display="block",r.style.margin="16px auto",n.replaceWith(r),console.log("[WeChatExporter] Replaced embed with <img>:",o)}}}async generateStyledHtml(s,e="default",t=""){let i=this.cleanMarkdown(s),n=document.createElement("div");n.addClass("wechat-article");let o=new u.Component;await u.MarkdownRenderer.renderMarkdown(i,n,t,o),o.unload(),await this.processImages(n,t);let a=S[e]||S.default;return this.inlineStyles(n,a),n.innerHTML}async generateFullHtml(s,e="default",t="",i){let n=this.cleanMarkdown(s),o=document.createElement("div");o.addClass("wechat-article");let a=new u.Component;await u.MarkdownRenderer.renderMarkdown(n,o,i||"",a),a.unload(),await this.processImages(o,i);let r=S[e]||S.default;return this.inlineStyles(o,r),o.innerHTML}async exportToHtml(s,e="default",t,i){try{let n=this.cleanMarkdown(s),o=document.createElement("div");o.addClass("wechat-article");let a=new u.Component;await u.MarkdownRenderer.renderMarkdown(n,o,i||"",a),a.unload(),await this.processImages(o,i);let r=S[e]||S.default;this.inlineStyles(o,r);let l=`<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${t}</title>
    <style>
        ${r}
        body { margin: 0; padding: 20px; background-color: #f5f5f5; }
        .wechat-article-container { 
            max-width: 677px; 
            margin: 0 auto; 
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="wechat-article-container">
        ${o.outerHTML}
    </div>
</body>
</html>`,c=this.app.vault,d=`${t}.html`,h=c.getAbstractFileByPath(d);return h instanceof u.TFile?(await c.modify(h,l),new u.Notice(`Updated existing file: ${d}`)):(h=await c.create(d,l),new u.Notice(`Exported WeChat HTML: ${d}`)),h instanceof u.TFile?h:null}catch(n){return console.error("Failed to export WeChat HTML:",n),new u.Notice("Export failed. Check console for details."),null}}cleanMarkdown(s){let e=s.replace(/<stage_completed>.*?<\/stage_completed>/g,""),t=e.match(/<final_article>([\s\S]*?)<\/final_article>/i);if(t&&t[1].trim().length>0)return t[1].trim();let i=/^```(?:markdown)?\s*([\s\S]*?)\s*```$/i,n=e.trim(),o=n.match(i);if(o&&!(n.replace(/```[\s\S]*?```/g,"").trim().length>10)&&o[1].length>50)return o[1].trim();if(e.startsWith("---")){let a=e.indexOf("---",3);a!==-1&&(e=e.substring(a+3))}return e.trim()}inlineStyles(s,e){let t={},i=e.match(/:root\s*{([^}]+)}/);i&&i[1].split(";").forEach(r=>{let[l,c]=r.split(":").map(d=>d.trim());l&&c&&l.startsWith("--")&&(t[l]=c)});let n=/\.wechat-article\s+([^{]+)\s*{([^}]+)}/g,o;for(;(o=n.exec(e))!==null;){let a=o[1].trim(),l=o[2].trim().split(";").map(d=>{let[h,g]=d.split(":").map(x=>x.trim());return!h||!g?null:(g=g.replace(/var\((--[^)]+)\)/g,(x,C)=>t[C]||C),`${h}: ${g}`)}).filter(Boolean).join("; ");a.split(",").map(d=>d.trim()).forEach(d=>{if(!(d.includes("::")||!d.split(":")[0].trim()))try{s.querySelectorAll(d).forEach(x=>{let C=x.getAttribute("style")||"";x.setAttribute("style",`${C}${C?"; ":""}${l}`)})}catch(g){}})}}};var W=class{constructor(s,e,t,i){this.app=e;this.stopButtonEl=null;this.commandHistory=[];this.historyIndex=-1;this.tempInput="";this.mentionCandidates=[];this.mentionSelectedIndex=0;this.mentionStartIndex=-1;this.mentionEndIndex=-1;this.maxMentionResults=8;this.containerEl=s,this.onSubmit=t,this.onStop=i,this.render()}render(){let s=this.containerEl.createEl("div",{cls:"claude-chat-input-container"});this.inputWrapperEl=s.createEl("div",{cls:"claude-chat-input-wrapper"}),this.inputEl=this.inputWrapperEl.createEl("textarea",{cls:"claude-chat-input",attr:{placeholder:"Ask OpenCode, or use /write /kb /qa workflows... (type @ to reference files)",rows:"1"}}),this.inputEl.addEventListener("input",()=>{this.autoResize(),this.updateMentionSuggestions()}),this.inputEl.addEventListener("click",()=>{this.updateMentionSuggestions()}),this.inputEl.addEventListener("keyup",e=>{(e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Home"||e.key==="End")&&this.updateMentionSuggestions()}),this.inputEl.addEventListener("blur",()=>{window.setTimeout(()=>{document.activeElement!==this.inputEl&&this.closeMentionMenu()},100)}),this.sendButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-send-button"}),this.sendButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            <span>Send</span>
        `,this.sendButtonEl.addEventListener("click",()=>{this.handleSubmit()}),this.inputEl.addEventListener("keydown",e=>{this.handleMentionKeydown(e)||(e.key==="Enter"&&!e.shiftKey&&!e.isComposing?(e.preventDefault(),this.handleSubmit()):e.key==="ArrowUp"?(e.preventDefault(),this.navigateHistory(-1)):e.key==="ArrowDown"&&(e.preventDefault(),this.navigateHistory(1)))}),this.mentionMenuEl=s.createEl("div",{cls:"claude-chat-mention-menu"}),this.mentionMenuEl.style.display="none",s.addEventListener("click",e=>{(e.target===s||e.target===this.inputWrapperEl)&&this.inputEl.focus()})}createStopButton(){this.stopButtonEl||(this.stopButtonEl=this.inputWrapperEl.createEl("button",{cls:"claude-chat-stop-button"}),this.stopButtonEl.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
            <span>Stop</span>
        `,this.stopButtonEl.addEventListener("click",()=>{this.onStop()}))}removeStopButton(){this.stopButtonEl&&(this.stopButtonEl.remove(),this.stopButtonEl=null)}async handleSubmit(){let s=this.inputEl.value.trim();s&&!this.sendButtonEl.disabled&&(this.commandHistory[this.commandHistory.length-1]!==s&&(this.commandHistory.push(s),this.commandHistory.length>100&&this.commandHistory.shift()),this.inputEl.value="",this.autoResize(),this.historyIndex=-1,this.tempInput="",this.closeMentionMenu(),await this.onSubmit(s))}navigateHistory(s){if(this.commandHistory.length===0)return;if(this.historyIndex===-1&&(this.tempInput=this.inputEl.value),this.historyIndex+=s,this.historyIndex<0)this.historyIndex=0;else if(this.historyIndex>=this.commandHistory.length){this.historyIndex=-1,this.setValue(this.tempInput);return}let e=this.commandHistory[this.commandHistory.length-1-this.historyIndex];this.setValue(e),this.inputEl.setSelectionRange(0,e.length)}autoResize(){this.inputEl.style.height="auto";let s=Math.min(Math.max(this.inputEl.scrollHeight,44),140);this.inputEl.style.height=`${s}px`}focus(){this.inputEl.focus()}setDisabled(s){this.inputEl.disabled=s,this.sendButtonEl.disabled=s,s&&this.closeMentionMenu()}setProcessing(s){s?(this.sendButtonEl.classList.add("claude-hidden"),this.createStopButton(),this.inputEl.disabled=!0,this.closeMentionMenu()):(this.sendButtonEl.classList.remove("claude-hidden"),this.removeStopButton(),this.inputEl.disabled=!1)}getValue(){return this.inputEl.value}setValue(s){this.inputEl.value=s,this.autoResize(),this.updateMentionSuggestions()}handleMentionKeydown(s){return this.isMentionMenuOpen()?s.key==="ArrowDown"?(s.preventDefault(),this.moveMentionSelection(1),!0):s.key==="ArrowUp"?(s.preventDefault(),this.moveMentionSelection(-1),!0):s.key==="Enter"||s.key==="Tab"?(s.preventDefault(),this.selectMention(this.mentionSelectedIndex),!0):s.key==="Escape"?(s.preventDefault(),this.closeMentionMenu(),!0):!1:!1}updateMentionSuggestions(){let s=this.getMentionContext();if(!s){this.closeMentionMenu();return}let e=this.getMentionCandidates(s.query);if(e.length===0){this.closeMentionMenu();return}this.mentionStartIndex=s.start,this.mentionEndIndex=s.end,this.mentionCandidates=e,this.mentionSelectedIndex=0,this.renderMentionMenu()}getMentionContext(){var o;if(this.inputEl.selectionStart!==this.inputEl.selectionEnd)return null;let s=(o=this.inputEl.selectionStart)!=null?o:this.inputEl.value.length,t=this.inputEl.value.slice(0,s).match(/(^|\s)@([^\s@]*)$/);if(!t)return null;let i=t[2]||"",n=s-i.length-1;return n<0?null:{start:n,end:s,query:i}}getMentionCandidates(s){let e=s.replace(/^"+/,"").replace(/"/g,"").toLowerCase(),t=this.app.vault.getFiles();return e.length===0?t.slice().sort((n,o)=>o.stat.mtime-n.stat.mtime).slice(0,this.maxMentionResults).map(n=>n.path):t.map(n=>{let o=n.path,a=o.toLowerCase(),r=n.basename.toLowerCase(),l=-1;return r===e?l=0:r.startsWith(e)?l=1:a.startsWith(e)?l=2:r.includes(e)?l=3:a.includes(e)&&(l=4),{path:o,score:l}}).filter(n=>n.score>=0).sort((n,o)=>n.score!==o.score?n.score-o.score:n.path.length!==o.path.length?n.path.length-o.path.length:n.path.localeCompare(o.path)).slice(0,this.maxMentionResults).map(n=>n.path)}renderMentionMenu(){this.mentionMenuEl.empty(),this.mentionCandidates.forEach((s,e)=>{var o;let t=(s||"").trim()||"(unknown file)",i=((o=t.split("/").pop())==null?void 0:o.trim())||t,n=this.mentionMenuEl.createEl("div",{cls:"claude-chat-mention-item"});n.setAttribute("role","option"),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label",t),n.setAttribute("title",t),n.setAttribute("data-name",i),n.setAttribute("data-path",t),e===this.mentionSelectedIndex&&n.addClass("is-selected"),n.addEventListener("mouseenter",()=>{this.mentionSelectedIndex=e,this.updateMentionSelectionClasses()}),n.addEventListener("mousedown",a=>{a.preventDefault(),this.selectMention(e)})}),this.mentionMenuEl.style.display="block"}updateMentionSelectionClasses(){let s=this.mentionMenuEl.querySelectorAll(".claude-chat-mention-item");s.forEach((t,i)=>{t.classList.toggle("is-selected",i===this.mentionSelectedIndex)});let e=s[this.mentionSelectedIndex];e==null||e.scrollIntoView({block:"nearest"})}moveMentionSelection(s){if(this.mentionCandidates.length===0)return;let e=this.mentionCandidates.length;this.mentionSelectedIndex=(this.mentionSelectedIndex+s+e)%e,this.updateMentionSelectionClasses()}selectMention(s){let e=this.mentionCandidates[s];if(!e||this.mentionStartIndex<0||this.mentionEndIndex<0)return;let t=this.inputEl.value.slice(0,this.mentionStartIndex),i=this.inputEl.value.slice(this.mentionEndIndex),n=this.formatMentionText(e),o=i.length>0&&!/^\s/.test(i)?" ":"",a=`${t}${n}${o}${i}`,r=t.length+n.length+o.length;this.inputEl.value=a,this.autoResize(),this.inputEl.focus(),this.inputEl.setSelectionRange(r,r),this.closeMentionMenu()}formatMentionText(s){return/\s/.test(s)?`@"${s}"`:`@${s}`}closeMentionMenu(){this.mentionCandidates=[],this.mentionSelectedIndex=0,this.mentionStartIndex=-1,this.mentionEndIndex=-1,this.mentionMenuEl.empty(),this.mentionMenuEl.style.display="none"}isMentionMenuOpen(){return this.mentionMenuEl.style.display!=="none"&&this.mentionCandidates.length>0}};var m=require("obsidian");var H=class{constructor(s,e){this.timerInterval=null;this.isCollapsed=!0;this.part=e,this.containerEl=s.createEl("div",{cls:"claude-tool-call"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-tool-call-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.statusIconEl=this.headerEl.createEl("span",{cls:"claude-tool-call-icon"}),this.nameEl=this.headerEl.createEl("span",{cls:"claude-tool-call-name"}),this.titleEl=this.headerEl.createEl("span",{cls:"claude-tool-call-title"}),this.timerEl=this.headerEl.createEl("span",{cls:"claude-tool-call-timer"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-tool-call-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-tool-call-body"}),this.bodyEl.style.display="none";let t=this.bodyEl.createEl("div",{cls:"claude-tool-call-input"});t.createEl("div",{cls:"claude-tool-call-section-label",text:"Input"}),this.inputEl=t.createEl("pre",{cls:"claude-tool-call-code"});let i=this.bodyEl.createEl("div",{cls:"claude-tool-call-output"});i.createEl("div",{cls:"claude-tool-call-section-label",text:"Output"}),this.outputEl=i.createEl("pre",{cls:"claude-tool-call-code"}),i.style.display="none",this.update(e)}update(s){let e=this.part.state.status;this.part=s;let t=s.state;this.containerEl.classList.remove("claude-tool-call-pending","claude-tool-call-running","claude-tool-call-completed","claude-tool-call-error"),this.containerEl.classList.add(`claude-tool-call-${t.status}`),this.nameEl.setText(s.tool);let i="\u23F3",n="";t.status==="pending"?i="\u23F3":t.status==="running"?(i="\u2699\uFE0F",n=t.title||""):t.status==="completed"?(i="\u2705",n=t.title||"Completed"):t.status==="error"&&(i="\u274C",n="Error"),this.statusIconEl.setText(i),this.titleEl.setText(n),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC"),this.inputEl.setText(JSON.stringify(t.input,null,2));let o=this.outputEl.parentElement;t.status==="completed"?(o&&(o.style.display="block"),this.outputEl.setText(t.output||"")):t.status==="error"?(o&&(o.style.display="block"),this.outputEl.setText(t.error||"")):o&&(o.style.display="none"),this.handleTimer(t)}handleTimer(s){if(s.status==="running")this.timerInterval||(this.timerInterval=setInterval(()=>{let e=(Date.now()-s.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)},100));else if(s.status==="completed"||s.status==="error"){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null);let e=(s.time.end-s.time.start)/1e3;this.timerEl.setText(`${e.toFixed(1)}s`)}else this.timerEl.setText(""),this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.containerEl.remove()}};var $=class{constructor(s,e,t){this.request=e;this.onReply=t;this.buttons=[];this.resolved=!1;this.containerEl=s.createEl("div",{cls:"claude-permission-dialog"});let i=this.containerEl.createEl("div",{cls:"claude-permission-header"});i.createEl("span",{cls:"claude-permission-icon",text:"\u{1F510}"}),i.createEl("span",{cls:"claude-permission-title",text:"Permission Required"});let n=this.containerEl.createEl("div",{cls:"claude-permission-body"});n.createEl("div",{cls:"claude-permission-type",text:`${this.request.permission}: ${this.request.patterns.join(", ")}`});let o=n.createEl("div",{cls:"claude-permission-metadata"});for(let[r,l]of Object.entries(this.request.metadata)){let c=o.createEl("div",{cls:"claude-permission-meta-item"});c.createEl("strong",{text:`${r}: `});let d;typeof l=="object"&&l!==null?d=JSON.stringify(l):d=String(l),c.createEl("span",{text:d})}let a=this.containerEl.createEl("div",{cls:"claude-permission-actions"});this.createButton(a,"Allow Once","claude-permission-btn-allow",()=>{this.handleReply("once","Allowed \u2713")}),this.createButton(a,"Allow Always","claude-permission-btn-always",()=>{this.handleReply("always","Allowed Always \u2713")}),this.createButton(a,"Reject","claude-permission-btn-reject",()=>{this.handleReply("reject","Rejected \u2717")})}createButton(s,e,t,i){let n=s.createEl("button",{cls:`claude-permission-btn ${t}`,text:e});n.addEventListener("click",i),this.buttons.push(n)}handleReply(s,e){this.resolved||(this.resolve(),this.onReply(s))}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-permission-resolved"),this.buttons.forEach(s=>{s.disabled=!0})}destroy(){this.containerEl.remove()}};var q=class{constructor(s,e,t,i){this.request=e;this.onReply=t;this.onReject=i;this.resolved=!1;this.inputs=[];this.customInputs=[];this.containerEl=s.createEl("div",{cls:"claude-question-dialog"});let n=this.containerEl.createEl("div",{cls:"claude-question-header"});n.createEl("span",{cls:"claude-question-icon",text:"\u2753"}),n.createEl("span",{cls:"claude-question-title",text:"Question"}),this.request.questions.forEach((l,c)=>{this.renderQuestion(l,c)});let o=this.containerEl.createEl("div",{cls:"claude-question-actions"});o.createEl("button",{cls:"claude-question-btn claude-question-btn-submit",text:"Submit"}).addEventListener("click",()=>this.handleSubmit()),o.createEl("button",{cls:"claude-question-btn claude-question-btn-reject",text:"Skip"}).addEventListener("click",()=>{this.resolved||(this.resolve(),this.onReject())})}renderQuestion(s,e){let t=this.containerEl.createEl("div",{cls:"claude-question-item"});t.createEl("div",{cls:"claude-question-text",text:`${s.header}: ${s.question}`});let i=t.createEl("div",{cls:"claude-question-options"});if(s.options.forEach(n=>{let o=i.createEl("label",{cls:"claude-question-option"}),a=o.createEl("input",{type:s.multiple?"checkbox":"radio",attr:{name:`q-${this.request.id}-${e}`,value:n.label}});this.inputs.push(a),o.createEl("span",{cls:"claude-question-option-label",text:n.label}),n.description&&o.createEl("span",{cls:"claude-question-option-desc",text:n.description})}),s.custom){let o=t.createEl("div",{cls:"claude-question-custom"}).createEl("input",{type:"text",cls:"claude-question-custom-input",attr:{placeholder:"Type your answer...","data-q-index":String(e)}});this.customInputs.push(o)}}handleSubmit(){if(this.resolved)return;let s=[];for(let e=0;e<this.request.questions.length;e++){let t=[];this.inputs.filter(o=>o.name===`q-${this.request.id}-${e}`&&o.checked).forEach(o=>t.push(o.value));let n=this.customInputs.find(o=>o.getAttribute("data-q-index")===String(e));n&&n.value.trim()&&t.push(n.value.trim()),s.push(t)}this.resolve(),this.onReply(s)}resolve(){this.resolved=!0,this.containerEl.classList.add("claude-question-resolved"),this.inputs.forEach(e=>e.disabled=!0),this.customInputs.forEach(e=>e.disabled=!0),this.containerEl.querySelectorAll("button").forEach(e=>e.disabled=!0)}destroy(){this.containerEl.remove()}};var N=class{constructor(s,e){this.isCollapsed=!0;this.containerEl=s.createEl("div",{cls:"claude-file-diff"}),this.headerEl=this.containerEl.createEl("div",{cls:"claude-file-diff-header"}),this.headerEl.addEventListener("click",()=>this.toggleCollapse()),this.iconEl=this.headerEl.createEl("span",{cls:"claude-file-diff-icon",text:"\u0394"}),this.pathEl=this.headerEl.createEl("span",{cls:"claude-file-diff-path"}),this.statsEl=this.headerEl.createEl("span",{cls:"claude-file-diff-stats"}),this.chevronEl=this.headerEl.createEl("span",{cls:"claude-file-diff-chevron"}),this.bodyEl=this.containerEl.createEl("div",{cls:"claude-file-diff-body"}),this.bodyEl.style.display="none";let t=this.bodyEl.createEl("div",{cls:"claude-file-diff-table-header"});t.createEl("span",{cls:"claude-file-diff-table-title",text:"Before"}),t.createEl("span",{cls:"claude-file-diff-table-title",text:"After"}),this.tableEl=this.bodyEl.createEl("div",{cls:"claude-file-diff-table"}),this.update(e)}update(s){this.pathEl.setText(s.file),this.renderStats(s),this.renderRows(s),this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}destroy(){this.containerEl.remove()}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.bodyEl.style.display=this.isCollapsed?"none":"block",this.chevronEl.setText(this.isCollapsed?"\u25B6":"\u25BC")}renderStats(s){this.statsEl.empty(),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-additions",text:`+${s.additions}`}),this.statsEl.createEl("span",{cls:"claude-file-diff-stat-deletions",text:`-${s.deletions}`})}renderRows(s){this.tableEl.empty();let e=this.buildDisplayRows(s.before,s.after),t=e.slice(0,800);for(let i of t)this.renderRow(i);if(e.length>800){let i=e.length-800;this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:`... omitted ${i} additional rows ...`})}e.length===0&&this.tableEl.createEl("div",{cls:"claude-file-diff-row claude-file-diff-row-context"}).createEl("div",{cls:"claude-file-diff-context",text:"No textual changes."})}renderRow(s){var t;let e=this.tableEl.createEl("div",{cls:`claude-file-diff-row claude-file-diff-row-${s.type}`});if(s.type==="context"){e.createEl("div",{cls:"claude-file-diff-context",text:`... ${(t=s.hiddenCount)!=null?t:0} unchanged lines ...`});return}e.createEl("div",{cls:"claude-file-diff-line-number",text:s.beforeLineNumber!==null?String(s.beforeLineNumber):""}),e.createEl("div",{cls:"claude-file-diff-line-content",text:s.beforeText}),e.createEl("div",{cls:"claude-file-diff-line-number",text:s.afterLineNumber!==null?String(s.afterLineNumber):""}),e.createEl("div",{cls:"claude-file-diff-line-content",text:s.afterText})}buildDisplayRows(s,e){let t=this.toLines(s),i=this.toLines(e),n=this.alignLines(t,i);return this.collapseUnchanged(n)}toLines(s){if(!s)return[];let t=s.replace(/\r\n/g,`
`).split(`
`);return t.length>0&&t[t.length-1]===""&&t.pop(),t}alignLines(s,e){let i=s.length*e.length<=25e4?this.computeLcsOperations(s,e):this.computeHeuristicOperations(s,e);return this.operationsToRows(i)}computeLcsOperations(s,e){let t=s.length,i=e.length,n=i+1,o=new Uint32Array((t+1)*(i+1));for(let c=1;c<=t;c+=1)for(let d=1;d<=i;d+=1){let h=c*n+d;if(s[c-1]===e[d-1]){o[h]=o[(c-1)*n+(d-1)]+1;continue}let g=o[(c-1)*n+d],x=o[c*n+(d-1)];o[h]=g>=x?g:x}let a=[],r=t,l=i;for(;r>0&&l>0;){let c=s[r-1],d=e[l-1];if(c===d){a.push({type:"unchanged",text:c}),r-=1,l-=1;continue}let h=o[(r-1)*n+l];o[r*n+(l-1)]>h?(a.push({type:"added",text:d}),l-=1):(a.push({type:"removed",text:c}),r-=1)}for(;r>0;)a.push({type:"removed",text:s[r-1]}),r-=1;for(;l>0;)a.push({type:"added",text:e[l-1]}),l-=1;return a.reverse(),a}computeHeuristicOperations(s,e){let t=[],i=0,n=0;for(;i<s.length&&n<e.length;){let o=s[i],a=e[n];if(o===a){t.push({type:"unchanged",text:o}),i+=1,n+=1;continue}if(i+1<s.length&&s[i+1]===a){t.push({type:"removed",text:o}),i+=1;continue}if(n+1<e.length&&o===e[n+1]){t.push({type:"added",text:a}),n+=1;continue}t.push({type:"removed",text:o}),t.push({type:"added",text:a}),i+=1,n+=1}for(;i<s.length;)t.push({type:"removed",text:s[i]}),i+=1;for(;n<e.length;)t.push({type:"added",text:e[n]}),n+=1;return t}operationsToRows(s){let e=[],t=1,i=1,n=[],o=[],a=()=>{if(n.length===0&&o.length===0)return;let r=Math.min(n.length,o.length);for(let l=0;l<r;l+=1)e.push({type:"modified",beforeLineNumber:t,afterLineNumber:i,beforeText:n[l],afterText:o[l]}),t+=1,i+=1;for(let l=r;l<n.length;l+=1)e.push({type:"removed",beforeLineNumber:t,afterLineNumber:null,beforeText:n[l],afterText:""}),t+=1;for(let l=r;l<o.length;l+=1)e.push({type:"added",beforeLineNumber:null,afterLineNumber:i,beforeText:"",afterText:o[l]}),i+=1;n=[],o=[]};for(let r of s){if(r.type==="unchanged"){a(),e.push({type:"unchanged",beforeLineNumber:t,afterLineNumber:i,beforeText:r.text,afterText:r.text}),t+=1,i+=1;continue}r.type==="removed"?n.push(r.text):o.push(r.text)}return a(),e}collapseUnchanged(s){let e=[],t=-1,i=n=>{if(t<0)return;let o=s.slice(t,n);if(o.length<8)e.push(...o);else{e.push(...o.slice(0,3));let a=o.length-3*2;a>0&&e.push({type:"context",beforeLineNumber:null,afterLineNumber:null,beforeText:"",afterText:"",hiddenCount:a}),e.push(...o.slice(-3))}t=-1};return s.forEach((n,o)=>{if(n.type==="unchanged"){t<0&&(t=o);return}i(o),e.push(n)}),i(s.length),e}};var V=class{constructor(s,e){this.app=e;this.currentMessageTextEl=null;this.currentMessageBuffer="";this.currentCursorEl=null;this.currentMessageEl=null;this.currentFlowEl=null;this.sealedTextSegments=[];this.scrollLocked=!1;this.scrollBottomButton=null;this.messages=[];this.messageElements=new Map;this.toolCallViews=new Map;this.fileDiffViews=new Map;this.activeDiffHostEl=null;this.permissionDialogs=new Map;this.questionDialogs=new Map;this.lastRenderTime=0;this.containerEl=s,this.messagesEl=this.containerEl.createEl("div",{cls:"claude-chat-messages"}),this.setupLinkClickHandler(),this.setupScrollLock(),this.setupEditHandler()}setOnEditMessage(s){this.onEditMessage=s}setupScrollLock(){this.messagesEl.addEventListener("scroll",()=>{let s=this.messagesEl.scrollHeight-this.messagesEl.scrollTop<=this.messagesEl.clientHeight+50;!s&&!this.scrollLocked?(this.scrollLocked=!0,this.showScrollBottomButton()):s&&this.scrollLocked&&(this.scrollLocked=!1,this.hideScrollBottomButton())})}showScrollBottomButton(){this.scrollBottomButton||(this.scrollBottomButton=this.containerEl.createEl("button",{cls:"claude-scroll-bottom-button"}),this.scrollBottomButton.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span>New messages</span>
        `,this.scrollBottomButton.addEventListener("click",()=>{this.scrollToBottomNow()}))}hideScrollBottomButton(){this.scrollBottomButton&&(this.scrollBottomButton.remove(),this.scrollBottomButton=null)}setupLinkClickHandler(){this.messagesEl.addEventListener("click",s=>{let e=s.target,t=e.closest("a");if(t){s.preventDefault(),this.handleLinkClick(t,s);return}let i=e.closest(".internal-link");if(i){s.preventDefault(),this.handleInternalLinkClick(i,s);return}let n=e.closest("code.claude-inline-reference");n&&(s.preventDefault(),this.handleInlineReferenceClick(n,s))})}handleLinkClick(s,e){let t=s.getAttribute("href");if(!(!t||t.startsWith("#"))){if(this.isExternalHref(t)){window.open(t,"_blank");return}if(this.isModifierClick(e)){this.showFilePreview(t,e,s);return}this.tryOpenFile(t)}}handleInternalLinkClick(s,e){let t=s.getAttribute("data-href")||s.textContent;if(t){if(this.isModifierClick(e)){this.showFilePreview(t,e,s);return}this.tryOpenFile(t)}}isModifierClick(s){return s.metaKey||s.ctrlKey}isExternalHref(s){return/^(https?:\/\/|mailto:|obsidian:\/\/)/i.test(s)}showFilePreview(s,e,t){let i=this.resolveFileLink(s);if(!i){let o=this.normalizeFileLink(s);o&&new m.Notice(`File not found: ${o}`);return}let n=this.app.workspace.getActiveFile();this.app.workspace.trigger("hover-link",{event:e,source:"opencode-chat",hoverParent:this.messagesEl,targetEl:t,linktext:i.path,sourcePath:(n==null?void 0:n.path)||""})}tryOpenFile(s){let e=this.resolveFileLink(s);if(e instanceof m.TFile){this.openFileInMainPane(e);return}let t=this.normalizeFileLink(s);new m.Notice(`File not found: ${t||s}`)}resolveFileLink(s){let e=this.normalizeFileLink(s);if(!e)return null;let t=this.app.metadataCache,i=this.app.vault,n=t.getFirstLinkpathDest(e,"");return!n&&!e.endsWith(".md")&&(n=t.getFirstLinkpathDest(`${e}.md`,"")),n||(n=i.getMarkdownFiles().find(a=>{let r=a.basename.toLowerCase(),l=e.toLowerCase();return r===l||r.includes(l)})||null),n instanceof m.TFile?n:null}normalizeFileLink(s){return this.safeDecodeURIComponent(s).replace(/^\[\[/,"").replace(/\]\]$/,"").replace(/\|.*$/,"").replace(/#.*/,"").trim()}safeDecodeURIComponent(s){try{return decodeURIComponent(s)}catch(e){return s}}handleInlineReferenceClick(s,e){var n;let t=(n=s.textContent)==null?void 0:n.trim();if(!t||!this.isModifierClick(e))return;let i=this.safeDecodeURIComponent(t);if(this.isExternalHref(i)){window.open(i,"_blank");return}this.showFilePreview(i,e,s)}enhanceInlineReferences(s){s.querySelectorAll("code").forEach(t=>{var o;if(t.closest("pre"))return;let i=((o=t.textContent)==null?void 0:o.trim())||"";if(!i)return;let n=this.safeDecodeURIComponent(i);(this.isExternalHref(n)||this.looksLikeFileReference(n))&&(t.classList.add("claude-inline-reference"),t.setAttribute("title","Cmd/Ctrl + click to preview/open"))})}looksLikeFileReference(s){return!s||s.includes(`
`)||s.length>240||this.isExternalHref(s)||s.startsWith("#")||/^[a-zA-Z0-9_-]+\(\)$/.test(s)?!1:s.startsWith("./")||s.startsWith("../")||s.startsWith("/")||s.includes("/")?!0:/\.[a-zA-Z0-9_-]{1,12}$/.test(s)}openFileInMainPane(s){let e=this.app.workspace,t=e.getLeavesOfType("markdown"),i=t.length>0?t[0]:null;if(i)i.openFile(s);else{let n=e.getLeaf(!1);n&&n.openFile(s)}}addMessage(s){s.role!=="system"&&this.messages.push(s);let e=this.messagesEl.createEl("div",{cls:`claude-chat-message claude-chat-message-${s.role}`});if(s.role!=="system"){this.messageElements.set(e,s);let o=this.messages.length-1;e.dataset.messageIndex=o.toString()}let i=e.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"});i.innerHTML=this.formatContent(s.content);let n=e.createEl("div",{cls:"claude-chat-message-timestamp"});return n.textContent=this.formatTime(s.timestamp),this.addMessageCopyButton(e,s.content),s.role==="user"&&this.addEditButton(e),this.scrollToBottom(),i}addMessageCopyButton(s,e){let t=s.createEl("button",{cls:"claude-message-copy-button"});t.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        `,t.addEventListener("click",async i=>{i.stopPropagation(),await navigator.clipboard.writeText(e),t.classList.add("copied"),t.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            `,setTimeout(()=>{t.classList.remove("copied"),t.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                `},2e3)})}setupEditHandler(){this.messagesEl.addEventListener("click",s=>{let t=s.target.closest(".claude-message-edit-button");if(t){s.preventDefault(),s.stopPropagation();let i=t.closest(".claude-chat-message");i&&this.enterEditMode(i)}})}addEditButton(s){let e=s.createEl("button",{cls:"claude-message-edit-button"});e.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        `}enterEditMode(s){let e=s.querySelector(".claude-chat-message-text");if(!e)return;let t=parseInt(s.dataset.messageIndex||"-1");if(t<0)return;let i=this.messages[t];if(!i)return;let n=e.createEl("textarea",{cls:"claude-message-edit-textarea"});n.value=i.content;let o=e.createEl("div",{cls:"claude-message-edit-buttons"}),a=o.createEl("button",{cls:"claude-message-edit-save",text:"Save & Resend"}),r=o.createEl("button",{cls:"claude-message-edit-cancel",text:"Cancel"});e.querySelectorAll(":scope > :not(textarea):not(.claude-message-edit-buttons)").forEach(h=>h.style.display="none"),n.focus(),n.setSelectionRange(n.value.length,n.value.length);let c=()=>{let h=n.value.trim();h&&h!==i.content?(i.content=h,e.innerHTML=this.formatContent(h),this.onEditMessage&&this.onEditMessage(t,h)):this.exitEditMode(s,e)},d=()=>{this.exitEditMode(s,e)};a.addEventListener("click",c),r.addEventListener("click",d),n.addEventListener("keydown",h=>{h.key==="Enter"&&!h.shiftKey?(h.preventDefault(),c()):h.key==="Escape"&&(h.preventDefault(),d())})}exitEditMode(s,e){let t=e.querySelector(".claude-message-edit-textarea"),i=e.querySelector(".claude-message-edit-buttons");t&&t.remove(),i&&i.remove(),e.querySelectorAll(":scope > *").forEach(o=>o.style.display="")}addUserMessage(s){return this.addMessage({role:"user",content:s,timestamp:new Date})}createAssistantMessage(){let s=this.messagesEl.createEl("div",{cls:"claude-chat-message claude-chat-message-assistant"});this.currentMessageEl=s,this.fileDiffViews.clear(),this.activeDiffHostEl=null,this.sealedTextSegments=[];let e=s.createEl("div",{cls:"claude-chat-message-flow"});this.currentFlowEl=e;let t=this.createTextSegmentEl(e);this.addThinkingIndicator(t);let i=s.createEl("div",{cls:"claude-chat-message-timestamp"});return i.textContent=this.formatTime(new Date),this.currentMessageTextEl=t,this.currentMessageBuffer="",this.scrollToBottom(),t}createTextSegmentEl(s){return s.createEl("div",{cls:"claude-chat-message-content"}).createEl("div",{cls:"claude-chat-message-text"})}sealCurrentTextSegment(){if(!this.currentMessageTextEl||!this.currentMessageBuffer)return;this.removeTypingCursor();let s=this.app.workspace.getActiveFile(),e=(s==null?void 0:s.path)||"";this.currentMessageTextEl.empty(),m.MarkdownRenderer.renderMarkdown(this.currentMessageBuffer,this.currentMessageTextEl,e,new m.Component),this.enhanceInlineReferences(this.currentMessageTextEl),this.addCopyButtonsToCodeBlocks(this.currentMessageTextEl),this.sealedTextSegments.push({el:this.currentMessageTextEl,buffer:this.currentMessageBuffer,rendered:!0}),this.currentMessageTextEl=null,this.currentMessageBuffer=""}ensureCurrentTextSegment(){if(this.currentMessageTextEl||!this.currentFlowEl)return;let s=this.createTextSegmentEl(this.currentFlowEl);this.currentMessageTextEl=s,this.currentMessageBuffer=""}getFlowTargetEl(){return this.currentFlowEl||this.currentMessageEl||this.messagesEl}appendToAssistantMessage(s){if(this.ensureCurrentTextSegment(),this.currentMessageTextEl){this.removeThinkingIndicator(),this.currentMessageBuffer+=s;let e=Date.now();if(e-this.lastRenderTime>50){let t=this.app.workspace.getActiveFile(),i=(t==null?void 0:t.path)||"";this.currentMessageTextEl.empty(),m.MarkdownRenderer.renderMarkdown(this.currentMessageBuffer,this.currentMessageTextEl,i,new m.Component),this.addTypingCursor(),this.lastRenderTime=e}this.scrollToBottom()}}finalizeAssistantMessage(){var n;this.removeTypingCursor();let s=[...this.sealedTextSegments];this.currentMessageTextEl&&this.currentMessageBuffer&&s.push({el:this.currentMessageTextEl,buffer:this.currentMessageBuffer,rendered:!1});let e="",t=this.app.workspace.getActiveFile(),i=(t==null?void 0:t.path)||"";for(let o of s){let a=o.buffer;if(e+=a,!o.rendered&&!a.trim()){(n=o.el.closest(".claude-chat-message-content"))==null||n.remove();continue}o.rendered||(a.endsWith(`
`)||(a+=`
`),o.el.empty(),m.MarkdownRenderer.renderMarkdown(a,o.el,i,new m.Component),this.enhanceInlineReferences(o.el),this.addCopyButtonsToCodeBlocks(o.el))}e&&this.messages.push({role:"assistant",content:e,timestamp:new Date}),this.currentMessageEl&&this.addMessageCopyButton(this.currentMessageEl,e),this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentMessageEl=null,this.currentFlowEl=null,this.sealedTextSegments=[]}addCopyButtonsToCodeBlocks(s){s.querySelectorAll("pre").forEach(t=>{if(t.querySelector(".claude-code-copy-button"))return;let i=t.createEl("button",{cls:"claude-code-copy-button"});i.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span>Copy</span>
            `,i.addEventListener("click",async()=>{let n=t.querySelector("code");if(n){let o=n.textContent||"";await navigator.clipboard.writeText(o),i.classList.add("copied"),i.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>Copied!</span>
                    `,setTimeout(()=>{i.classList.remove("copied"),i.innerHTML=`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copy</span>
                        `},2e3)}})})}showThinking(){this.currentMessageTextEl&&!this.currentMessageBuffer&&this.addThinkingIndicator(this.currentMessageTextEl)}hideThinking(){this.removeThinkingIndicator()}addThinkingIndicator(s){if(s.querySelector(".claude-chat-message-thinking"))return;let t=s.createEl("div",{cls:"claude-chat-message-thinking"}),i=t.createEl("div",{cls:"claude-thinking-dots"});for(let o=0;o<3;o++)i.createEl("span",{cls:"claude-thinking-dot"});let n=t.createEl("span",{cls:"claude-thinking-text",text:"Thinking"})}removeThinkingIndicator(){if(this.currentMessageTextEl){let s=this.currentMessageTextEl.querySelector(".claude-chat-message-thinking");s&&s.remove()}}addTypingCursor(){this.currentMessageTextEl&&(this.removeTypingCursor(),this.currentCursorEl=this.currentMessageTextEl.createEl("span",{cls:"claude-typing-cursor"}))}removeTypingCursor(){this.currentCursorEl&&(this.currentCursorEl.remove(),this.currentCursorEl=null)}formatContent(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}formatTime(s){return s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}scrollToBottom(){this.scrollLocked||(this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}scrollToBottomNow(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight,this.scrollLocked=!1,this.hideScrollBottomButton()}addToolCall(s){let e=this.toolCallViews.get(s.id);if(e)return e.update(s),e;this.sealCurrentTextSegment();let t=this.getFlowTargetEl(),i=new H(t,s);return this.toolCallViews.set(s.id,i),this.scrollToBottom(),i}addFileDiffs(s,e){if(e.length===0)return;this.sealCurrentTextSegment();let t=this.getFlowTargetEl();this.activeDiffHostEl!==t&&(this.fileDiffViews.clear(),this.activeDiffHostEl=t);for(let n of e){let o=`${s}:${n.file}`,a=this.fileDiffViews.get(o);if(a){a.update(n);continue}let r=new N(t,n);this.fileDiffViews.set(o,r)}this.scrollToBottom()}addPermissionDialog(s,e){this.sealCurrentTextSegment();let t=this.getFlowTargetEl(),i=new $(t,s,e);return this.permissionDialogs.set(s.id,i),this.scrollToBottom(),i}addQuestionDialog(s,e,t){this.sealCurrentTextSegment();let i=this.getFlowTargetEl(),n=new q(i,s,e,t);return this.questionDialogs.set(s.id,n),this.scrollToBottom(),n}addStepIndicator(s){this.sealCurrentTextSegment();let e=this.getFlowTargetEl();if(s.type==="step-start"){let t=e.createEl("div",{cls:"claude-step-indicator claude-step-start"});t.createEl("span",{cls:"claude-step-icon",text:"\u25B6"}),t.createEl("span",{cls:"claude-step-label",text:s.step||"Step started"})}else{let t=e.createEl("div",{cls:"claude-step-indicator claude-step-finish"});t.createEl("span",{cls:"claude-step-icon",text:"\u25A0"});let i=s.reason||"Step finished";if(s.tokens){let n=s.tokens.input+s.tokens.output;i+=` (${n} tokens)`}s.cost!==void 0&&(i+=` \xB7 $${s.cost.toFixed(4)}`),t.createEl("span",{cls:"claude-step-label",text:i})}this.scrollToBottom()}clear(){for(let s of this.toolCallViews.values())s.destroy();this.toolCallViews.clear();for(let s of this.fileDiffViews.values())s.destroy();this.fileDiffViews.clear(),this.activeDiffHostEl=null;for(let s of this.permissionDialogs.values())s.destroy();this.permissionDialogs.clear();for(let s of this.questionDialogs.values())s.destroy();this.questionDialogs.clear(),this.messagesEl.empty(),this.messages=[],this.currentMessageTextEl=null,this.currentMessageBuffer="",this.currentFlowEl=null,this.sealedTextSegments=[],this.scrollLocked=!1,this.hideScrollBottomButton()}getMessages(){return[...this.messages]}removeMessagesAfter(s){this.messages=this.messages.slice(0,s+1),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((i,n)=>{n>s&&i.remove()}),this.messageElements.clear(),this.messagesEl.querySelectorAll(".claude-chat-message").forEach((i,n)=>{n<this.messages.length&&(this.messageElements.set(i,this.messages[n]),i.dataset.messageIndex=n.toString())})}};var z=class{constructor(s,e){this.sessions=[];this.currentSessionId=null;this.containerEl=s,this.onSessionSelect=e.onSessionSelect,this.onNewSession=e.onNewSession,this.onSessionDelete=e.onSessionDelete,this.onSessionRename=e.onSessionRename,this.render()}updateSessions(s,e){this.sessions=s,this.currentSessionId=e,this.render()}render(){this.containerEl.empty(),this.containerEl.addClass("claude-session-tabs");let s=this.containerEl.createEl("div",{cls:"claude-session-tabs-container"}),t=s.createEl("div",{cls:"claude-session-tabs-scroll"}).createEl("div",{cls:"claude-session-tabs-list"});if(this.sessions.length===0){let n=t.createEl("div",{cls:"claude-session-tabs-empty"});n.textContent="No sessions"}else for(let n of this.sessions){let o=this.createTab(n);t.appendChild(o)}let i=s.createEl("button",{cls:"claude-session-tab-new"});i.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"></path>
            </svg>
        `,i.setAttribute("aria-label","New session"),i.addEventListener("click",()=>{this.onNewSession&&this.onNewSession()})}createTab(s){let e=s.id===this.currentSessionId,t=document.createElement("div");t.className="claude-session-tab",e&&t.classList.add("claude-session-tab-active");let i=t.createEl("div",{cls:"claude-session-tab-content"}),n=i.createEl("span",{cls:"claude-session-tab-name"});if(n.textContent=s.name,this.sessions.length>1){let o=i.createEl("button",{cls:"claude-session-tab-close"});o.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            `,o.setAttribute("aria-label","Close session"),o.addEventListener("click",a=>{a.stopPropagation(),this.confirmClose(s.id)})}return i.addEventListener("click",()=>{this.onSessionSelect&&!e&&this.onSessionSelect(s.id)}),i.addEventListener("dblclick",()=>{this.promptRename(s.id)}),t}promptRename(s){let e=this.sessions.find(i=>i.id===s);if(!e)return;let t=prompt("Enter session name:",e.name);t&&t.trim()&&t!==e.name&&this.onSessionRename&&this.onSessionRename(s,t.trim())}confirmClose(s){let e=this.sessions.find(t=>t.id===s);e&&this.sessions.length!==1&&confirm(`Close session "${e.name}"?`)&&this.onSessionDelete&&this.onSessionDelete(s)}};var te=["discover","outline","draft","evidence","polish","publish"],de={discover:"Discover",outline:"Outline",draft:"Draft",evidence:"Evidence",polish:"Polish",publish:"Publish"},U=class{constructor(s,e){this.callbacks=e;this.isDetailsOpen=!1;this.panelEl=s.createEl("div",{cls:"claude-writing-task-panel"}),this.headerEl=this.panelEl.createEl("div",{cls:"claude-writing-task-header"});let t=this.headerEl.createEl("div",{cls:"claude-writing-header-left"});this.titleEl=t.createEl("div",{cls:"claude-writing-task-title",text:"Writing Agent"}),this.statusEl=t.createEl("span",{cls:"claude-writing-task-status"}),this.toggleBtn=this.headerEl.createEl("div",{cls:"claude-writing-task-toggle",attr:{"aria-label":"Toggle details"}}),this.renderToggleIcon(),this.toggleBtn.addEventListener("click",()=>this.toggleDetails()),this.bodyEl=this.panelEl.createEl("div",{cls:"claude-writing-task-body"}),this.stagesEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-stages"}),this.detailsEl=this.bodyEl.createEl("div",{cls:"claude-writing-task-details"}),this.detailsEl.style.display="none",this.objectiveEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-objective"}),this.metadataEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-metadata"}),this.metricsEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-metrics"}),this.versionsEl=this.detailsEl.createEl("div",{cls:"claude-writing-task-versions"}),this.emptyEl=this.panelEl.createEl("div",{cls:"claude-writing-task-empty"});let i=this.emptyEl.createEl("div",{cls:"claude-writing-empty-inner"});i.createEl("span",{text:"No active writing task."}),i.createEl("button",{text:"Start New Task"}).addEventListener("click",()=>this.callbacks.onStartTask())}toggleDetails(){this.isDetailsOpen=!this.isDetailsOpen,this.detailsEl.style.display=this.isDetailsOpen?"block":"none",this.renderToggleIcon()}renderToggleIcon(){this.toggleBtn.empty(),this.isDetailsOpen?this.toggleBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>':this.toggleBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'}update(s,e){if(!s){this.panelEl.classList.add("is-empty"),this.bodyEl.style.display="none",this.emptyEl.style.display="block",this.headerEl.style.display="none";return}this.panelEl.classList.remove("is-empty"),this.bodyEl.style.display="block",this.emptyEl.style.display="none",this.headerEl.style.display="flex",this.titleEl.setText(s.title),this.statusEl.setText(s.status),this.statusEl.className="claude-writing-task-status",this.statusEl.classList.toggle("is-paused",s.status==="paused"),this.statusEl.classList.toggle("is-completed",s.status==="completed"),this.renderWorkflowStepper(s.stage),this.objectiveEl.empty(),this.objectiveEl.createEl("div",{cls:"claude-writing-task-label",text:"Objective"}),this.objectiveEl.createEl("div",{cls:"claude-writing-task-value",text:s.objective}),this.metadataEl.empty(),this.metadataEl.addClass("claude-writing-metadata-row"),this.renderInlineEditField(this.metadataEl,"Audience","audience",s.audience),this.renderInlineEditField(this.metadataEl,"Tone","tone",s.tone),this.renderInlineEditField(this.metadataEl,"Length","targetLength",s.targetLength),this.renderMetrics(e),this.renderDraftVersions(s)}renderWorkflowStepper(s){let e=this.stagesEl;e.empty();let t=e.createEl("div",{cls:"claude-workflow-stepper"}),i=te.indexOf(s);te.forEach((n,o)=>{let a=t.createEl("div",{cls:"claude-workflow-node"});o<i?a.addClass("is-completed"):o===i?a.addClass("is-active"):a.addClass("is-pending"),a.addEventListener("click",()=>this.callbacks.onRunStage(n)),a.setAttribute("title",`Run ${de[n]}`);let r=a.createEl("div",{cls:"claude-workflow-dot"});if(o<i&&(r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'),a.createEl("span",{cls:"claude-workflow-label",text:de[n]}),o<te.length-1){let l=t.createEl("div",{cls:"claude-workflow-line"});o<i&&l.addClass("is-completed")}})}destroy(){this.panelEl.remove()}renderInlineEditField(s,e,t,i){let n=s.createEl("div",{cls:"claude-writing-inline-edit"});n.createEl("span",{cls:"claude-writing-inline-edit-label",text:`${e}: `});let o=n.createEl("span",{cls:"claude-writing-inline-edit-value",text:i});o.setAttribute("tabindex","0"),o.setAttribute("role","button"),o.setAttribute("aria-label",`Edit ${e}`);let a=()=>{let r=n.createEl("input",{cls:"claude-writing-inline-edit-input",type:"text",value:i});o.style.display="none",r.focus(),r.select();let l=()=>{var d,h;let c=r.value.trim();c&&c!==i&&((h=(d=this.callbacks).onUpdateTaskProperty)==null||h.call(d,t,c)),r.remove(),o.style.display=""};r.addEventListener("blur",l),r.addEventListener("keydown",c=>{c.key==="Enter"?(c.preventDefault(),r.blur()):c.key==="Escape"&&(r.removeEventListener("blur",l),r.remove(),o.style.display="")})};o.addEventListener("click",a),o.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),a())})}renderMetrics(s){if(this.metricsEl.empty(),this.metricsEl.createEl("div",{cls:"claude-writing-task-label",text:"Citation Coverage"}),!s||s.totalClaims===0){this.metricsEl.createEl("div",{cls:"claude-writing-task-value",text:"No citation report yet. Run `/write draft` or `/write evidence`."});return}let e=Math.round(s.coverage*100),t=`${e}% (${s.citedClaims}/${s.totalClaims})`;this.metricsEl.createEl("div",{cls:"claude-writing-task-value",text:`${t} \xB7 Sources: ${s.sourceCount}`});let n=this.metricsEl.createEl("div",{cls:"claude-writing-metrics-bar-container"}).createEl("div",{cls:"claude-writing-metrics-bar"}),o=e>=80?"claude-writing-metrics-severity-low":e>=50?"claude-writing-metrics-severity-medium":"claude-writing-metrics-severity-high";if(n.addClass(o),n.style.width=`${e}%`,s.uncitedClaims.length>0){this.metricsEl.createEl("div",{cls:"claude-writing-task-label claude-writing-metrics-uncited-label",text:`Uncited Claims (${s.uncitedClaims.length})`}).addClass(o);let r=this.metricsEl.createEl("ul",{cls:"claude-writing-task-uncited-list"});for(let l of s.uncitedClaims.slice(0,3))r.createEl("li",{text:l})}}renderDraftVersions(s){if(this.versionsEl.empty(),this.versionsEl.createEl("div",{cls:"claude-writing-task-label",text:"Draft Versions"}),s.draftVersions.length===0){this.versionsEl.createEl("div",{cls:"claude-writing-task-value",text:"No versions yet. Run `/write draft` to capture first snapshot."});return}let e=this.versionsEl.createEl("div",{cls:"claude-writing-version-list"}),t=s.draftVersions.slice(-5).reverse();for(let i of t)this.renderVersionRow(e,i,s.currentDraftVersionId===i.id)}renderVersionRow(s,e,t){let i=s.createEl("div",{cls:"claude-writing-version-row"});t&&i.addClass("is-current");let n=i.createEl("div",{cls:"claude-writing-version-meta"}),o=n.createEl("div",{cls:"claude-writing-version-label",text:e.label});t&&o.createEl("span",{cls:"claude-writing-version-current",text:"Current"});let a=[e.stage,this.formatTime(e.createdAt)];typeof e.citationCoverage=="number"&&a.push(`cite ${Math.round(e.citationCoverage*100)}%`),n.createEl("div",{cls:"claude-writing-version-detail",text:a.join(" \xB7 ")});let r=i.createEl("div",{cls:"claude-writing-version-actions"}),l=r.createEl("button",{cls:"claude-writing-version-compare",text:"Compare"});l.disabled=t,l.addEventListener("click",()=>this.callbacks.onCompareDraftVersion(e.id));let c=r.createEl("button",{cls:"claude-writing-version-rollback",text:"Rollback"});c.disabled=t,c.addEventListener("click",()=>this.callbacks.onRollbackDraftVersion(e.id))}formatTime(s){return s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}};var he=require("obsidian"),_=class extends he.SuggestModal{constructor(e,t){super(e);this.onChoose=t;this.setPlaceholder("Select a style for WeChat export...")}getSuggestions(e){return[{label:"Default (\u9ED8\u8BA4)",value:"default",description:"Blue accent, clear structure. Good for tech/general."},{label:"Elegant (\u6587\u827A)",value:"elegant",description:"Brown tone, serif fonts. Good for essays/reviews."},{label:"Tech (\u6781\u5BA2)",value:"tech",description:"Dark theme, terminal style. Good for coding tutorials."},{label:"Vibrant (\u6D3B\u6CFC)",value:"vibrant",description:"Gradients, lively colors. Good for lifestyle/products."},{label:"Minimal (\u6781\u7B80)",value:"minimal",description:"Black & white, spacious. Good for serious reading."}].filter(i=>i.label.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e.label,cls:"suggestion-content"}),t.createEl("small",{text:e.description,cls:"suggestion-note"})}onChooseSuggestion(e){this.onChoose(e.value)}};var v="claude-chat-view",y="wechat-export-preview-view";function Be(p,s){let e=p.length,t=s.length,i=Array.from({length:e+1},()=>new Array(t+1).fill(0));for(let n=1;n<=e;n++)for(let o=1;o<=t;o++)p[n-1]===s[o-1]?i[n][o]=i[n-1][o-1]+1:i[n][o]=Math.max(i[n-1][o],i[n][o-1]);return i}function j(p,s,e,t,i,n){t>0&&i>0&&s[t-1]===e[i-1]?(j(p,s,e,t-1,i-1,n),n.push({type:"equal",line:s[t-1],oldIdx:t,newIdx:i})):i>0&&(t===0||p[t][i-1]>=p[t-1][i])?(j(p,s,e,t,i-1,n),n.push({type:"insert",line:e[i-1],oldIdx:t,newIdx:i})):t>0&&(j(p,s,e,t-1,i,n),n.push({type:"delete",line:s[t-1],oldIdx:t,newIdx:i}))}function Oe(p,s){let e=[];for(let o=0;o<p.length;o++)p[o].type!=="equal"&&e.push(o);if(e.length===0)return[];let t=[],i=Math.max(0,e[0]-s),n=Math.min(p.length-1,e[0]+s);for(let o=1;o<e.length;o++){let a=Math.max(0,e[o]-s);a<=n+1||(t.push(pe(p,i,n)),i=a),n=Math.min(p.length-1,e[o]+s)}return t.push(pe(p,i,n)),t}function pe(p,s,e){let t=[],i=0,n=0,o=0,a=0,r=!0,l=!0;for(let c=s;c<=e;c++){let d=p[c];switch(d.type){case"equal":t.push(` ${d.line}`),r&&(i=d.oldIdx,r=!1),l&&(o=d.newIdx,l=!1),n++,a++;break;case"delete":t.push(`-${d.line}`),r&&(i=d.oldIdx,r=!1),n++;break;case"insert":t.push(`+${d.line}`),l&&(o=d.newIdx,l=!1),a++;break}}return{oldStart:i,oldCount:n,newStart:o,newCount:a,lines:t}}function ue(p,s,e,t,i=3){let n=p.split(`
`),o=s.split(`
`),a=Be(n,o),r=[];j(a,n,o,n.length,o.length,r);let l=Oe(r,i);if(l.length===0)return null;let c=[`--- ${e}`,`+++ ${t}`];for(let d of l)c.push(`@@ -${d.oldStart},${d.oldCount} +${d.newStart},${d.newCount} @@`),c.push(...d.lines);return c.join(`
`)}var Fe=[{permission:"bash",pattern:"*",action:"ask"},{permission:"write",pattern:"*",action:"ask"},{permission:"edit",pattern:"*",action:"ask"}],We={start:"discover",discover:"discover",outline:"outline",draft:"draft",evidence:"evidence",polish:"polish",publish:"publish"},K=["discover","outline","draft","evidence","polish","publish"],He=["full","broken","orphan","duplicate","stale"],Q=class extends T.ItemView{constructor(e,t){super(e);this.writingTaskPanel=null;this.isProcessing=!1;this.statusBadgeEl=null;this.pendingMetaByServerSessionId=new Map;this.citationReportBySessionId=new Map;this.plugin=t,this.sessionManager=t.sessionManager,this.contextResolver=new A(t.app),this.writingWorkflow=new F,this.citationQualityService=new P,this.publishAssistant=new B(t.app),this.knowledgeBaseService=new O(t.app),this.weChatExporter=new k(t.app),this.boundHandlers={onTextDelta:this.handleTextDelta.bind(this),onSessionIdle:this.handleSessionIdle.bind(this),onSessionStatus:this.handleSessionStatus.bind(this),onSessionError:this.handleSessionError.bind(this),onToolUpdated:this.handleToolUpdated.bind(this),onDiffUpdated:this.handleDiffUpdated.bind(this),onPermissionAsked:this.handlePermissionAsked.bind(this),onQuestionAsked:this.handleQuestionAsked.bind(this),onStepStart:this.handleStepStart.bind(this),onStepFinish:this.handleStepFinish.bind(this),onConnected:this.handleConnected.bind(this),onDisconnected:this.handleDisconnected.bind(this),onError:this.handleError.bind(this)}}getViewType(){return v}getDisplayText(){return"OpenCode Chat"}getIcon(){return"message-square"}get server(){return this.plugin.server}get currentServerSessionId(){return this.sessionManager.getCurrentServerSessionId()}isCurrentSession(e){return this.currentServerSessionId===e}async onOpen(){var r;let e=this.containerEl.children[1];e.empty(),e.addClass("claude-chat-container");let i=e.createEl("div",{cls:"claude-chat-main-layout"}).createEl("div",{cls:"claude-chat-content"}),n=i.createEl("div",{cls:"claude-session-tabs-wrapper"});this.sessionTabs=new z(n,{onSessionSelect:l=>this.loadSession(l),onNewSession:()=>this.createNewSession(),onSessionDelete:l=>this.deleteSession(l),onSessionRename:(l,c)=>this.renameSession(l,c)}),this.updateSessionList(),this.statusBadgeEl=i.createEl("div",{cls:"claude-server-status claude-server-status-connecting"}),this.statusBadgeEl.setText("Connecting..."),this.writingTaskPanel=new U(i,{onStartTask:()=>this.queueCommandTemplate("/write start "),onRunStage:l=>this.queueCommandTemplate(`/write ${l} `),onPauseTask:()=>this.updateCurrentWritingTaskStatus("paused"),onResumeTask:()=>this.updateCurrentWritingTaskStatus("active"),onCompleteTask:()=>this.updateCurrentWritingTaskStatus("completed"),onRollbackDraftVersion:l=>this.rollbackToDraftVersion(l),onCompareDraftVersion:l=>this.compareDraftVersion(l),onUpdateTaskProperty:(l,c)=>{let d=this.sessionManager.getCurrentWritingTask();d&&(l==="audience"||l==="tone"||l==="targetLength")&&(d[l]=c,this.sessionManager.setCurrentWritingTask(d),this.refreshWritingTaskPanel())}}),this.syncWorkflowTaskFromSession(),this.refreshWritingTaskPanel(),this.messageContainer=new V(i,this.app),this.messageContainer.setOnEditMessage(async(l,c)=>{await this.handleEditMessage(l,c)}),this.loadCurrentSessionMessages();let a=i.createEl("div",{cls:"claude-chat-input-actions"}).createEl("button",{cls:"claude-chat-action-button claude-workflow-menu-btn",attr:{"aria-label":"Open workflow actions"}});a.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
            <span>Writing Workflows</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
        `,a.addEventListener("click",l=>{let c=new T.Menu;c.addItem(d=>d.setTitle("Start Writing Task").setIcon("pen-tool").onClick(()=>this.queueCommandTemplate("/write start "))),c.addItem(d=>d.setTitle("Generate Outline").setIcon("list").onClick(()=>this.queueCommandTemplate("/write outline "))),c.addItem(d=>d.setTitle("Draft Content").setIcon("file-text").onClick(()=>this.queueCommandTemplate("/write draft "))),c.addItem(d=>d.setTitle("Evidence Review").setIcon("check-circle").onClick(()=>this.queueCommandTemplate("/write evidence "))),c.addSeparator(),c.addItem(d=>d.setTitle("Export to WeChat HTML").setIcon("share").onClick(()=>this.handleExportWeChat())),c.addSeparator(),c.addItem(d=>d.setTitle("Knowledge Base Audit").setIcon("database").onClick(()=>this.queueCommandTemplate("/kb audit full "))),c.addItem(d=>d.setTitle("Ask QA").setIcon("help-circle").onClick(()=>this.queueCommandTemplate("/qa "))),c.showAtMouseEvent(l)}),this.chatInput=new W(i,this.app,async l=>{await this.handleCommand(l)},()=>{this.handleStop()}),this.subscribeToServer(),(r=this.server)!=null&&r.connected&&this.updateStatusBadge(!0)}createActionButton(e,t,i,n){let o=e.createEl("button",{cls:"claude-chat-action-button"});o.textContent=t,o.setAttribute("aria-label",i),o.setAttribute("title",i),o.addEventListener("click",n)}queueCommandTemplate(e){!this.chatInput||this.isProcessing||(this.chatInput.setValue(e),this.chatInput.focus())}subscribeToServer(){let e=this.server;e&&(e.on("text.delta",this.boundHandlers.onTextDelta),e.on("session.idle",this.boundHandlers.onSessionIdle),e.on("session.status",this.boundHandlers.onSessionStatus),e.on("session.error",this.boundHandlers.onSessionError),e.on("tool.updated",this.boundHandlers.onToolUpdated),e.on("diff.updated",this.boundHandlers.onDiffUpdated),e.on("permission.asked",this.boundHandlers.onPermissionAsked),e.on("question.asked",this.boundHandlers.onQuestionAsked),e.on("step.start",this.boundHandlers.onStepStart),e.on("step.finish",this.boundHandlers.onStepFinish),e.on("connected",this.boundHandlers.onConnected),e.on("disconnected",this.boundHandlers.onDisconnected),e.on("error",this.boundHandlers.onError))}unsubscribeFromServer(){let e=this.server;e&&(e.off("text.delta",this.boundHandlers.onTextDelta),e.off("session.idle",this.boundHandlers.onSessionIdle),e.off("session.status",this.boundHandlers.onSessionStatus),e.off("session.error",this.boundHandlers.onSessionError),e.off("tool.updated",this.boundHandlers.onToolUpdated),e.off("diff.updated",this.boundHandlers.onDiffUpdated),e.off("permission.asked",this.boundHandlers.onPermissionAsked),e.off("question.asked",this.boundHandlers.onQuestionAsked),e.off("step.start",this.boundHandlers.onStepStart),e.off("step.finish",this.boundHandlers.onStepFinish),e.off("connected",this.boundHandlers.onConnected),e.off("disconnected",this.boundHandlers.onDisconnected),e.off("error",this.boundHandlers.onError))}handleTextDelta(e,t,i,n){this.isCurrentSession(e)&&this.messageContainer.appendToAssistantMessage(i)}handleSessionIdle(e){let t=this.pendingMetaByServerSessionId.get(e);if(this.pendingMetaByServerSessionId.delete(e),!this.isCurrentSession(e))return;this.messageContainer.finalizeAssistantMessage();let i=this.messageContainer.getMessages(),n=i[i.length-1];if(n&&n.role==="assistant"){this.sessionManager.addMessage(n);let o=n.content.match(/<stage_completed>([\w-]+)<\/stage_completed>/);if(o){let r=o[1],l=this.getCurrentWritingTask();if(l&&l.stage===r){let c=K.indexOf(r);if(c>=0&&c<K.length-1){let d=K[c+1],h=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(h,l),this.writingWorkflow.updateStage(h,d),this.sessionManager.setCurrentWritingTask(l),this.refreshWritingTaskPanel(),this.addSystemNotice(`Stage **${r}** completed. Advancing to **${d}**.`)}else c===K.length-1&&this.updateCurrentWritingTaskStatus("completed")}}let a=null;t!=null&&t.requiresCitationCheck&&(a=this.citationQualityService.evaluate(n.content),this.citationReportBySessionId.set(e,a),this.addSystemNotice(this.buildCitationCoverageNotice(a))),t!=null&&t.shouldCaptureDraftVersion&&t.stage&&this.captureDraftVersionFromAssistant(t.stage,n.content,a)}this.updateSessionList(),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}handleSessionStatus(e,t){this.isCurrentSession(e)&&(t.type==="busy"?(this.isProcessing=!0,this.chatInput.setProcessing(!0)):t.type==="idle"?(this.isProcessing=!1,this.chatInput.setProcessing(!1),this.messageContainer.hideThinking()):t.type==="retry"&&(this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

_Retrying (${t.attempt}): ${t.message}_`)))}handleSessionError(e,t){if(e&&this.pendingMetaByServerSessionId.delete(e),e&&!this.isCurrentSession(e))return;let i=(t==null?void 0:t.message)||"Unknown error";console.error("OpenCodeChatView: Session error:",i),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${i}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),o=n[n.length-1];o&&o.role==="assistant"&&this.sessionManager.addMessage(o),this.isProcessing=!1,this.chatInput.setProcessing(!1)}handleToolUpdated(e,t){this.isCurrentSession(e)&&this.messageContainer.addToolCall(t)}handleDiffUpdated(e,t){this.isCurrentSession(e)&&this.messageContainer.addFileDiffs(e,t)}handlePermissionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let t=this.server;t&&this.messageContainer.addPermissionDialog(e,i=>{t.approvePermission(e.sessionID,e.id,i).catch(n=>{console.error("OpenCodeChatView: Failed to reply to permission:",n)})})}handleQuestionAsked(e){if(!this.isCurrentSession(e.sessionID))return;let t=this.server;t&&this.messageContainer.addQuestionDialog(e,i=>{t.replyToQuestion(e.sessionID,e.id,i).catch(n=>{console.error("OpenCodeChatView: Failed to reply to question:",n)})},()=>{t.rejectQuestion(e.id).catch(i=>{console.error("OpenCodeChatView: Failed to reject question:",i)})})}handleStepStart(e,t){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(t)}handleStepFinish(e,t){this.isCurrentSession(e)&&this.messageContainer.addStepIndicator(t)}handleConnected(){this.updateStatusBadge(!0)}handleDisconnected(){this.updateStatusBadge(!1)}handleError(e){console.error("OpenCodeChatView: Server error:",e)}updateStatusBadge(e){this.statusBadgeEl&&(this.statusBadgeEl.classList.remove("claude-server-status-connected","claude-server-status-disconnected","claude-server-status-connecting"),e?(this.statusBadgeEl.classList.add("claude-server-status-connected"),this.statusBadgeEl.setText("Connected")):(this.statusBadgeEl.classList.add("claude-server-status-disconnected"),this.statusBadgeEl.setText("Disconnected")))}loadCurrentSessionMessages(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - Enter commands to interact with OpenCode\n\n**Keyboard Shortcuts:**\n\u2022 `Ctrl+Shift+N` - New session\n\u2022 `Ctrl+Shift+E` - Export conversation\n\u2022 `Ctrl+K` - Clear history\n\u2022 `Ctrl+L` - Focus input\n\u2022 `\u2191/\u2193` - Browse command history\n\u2022 `Shift+Enter` - New line\n\u2022 `Escape` - Stop generation\n\n**Workflow Commands:**\n\u2022 `/write start <topic>` - Start a writing task discovery\n\u2022 `/write outline [requirements]` - Create source-aware outline\n\u2022 `/write draft [requirements]` - Produce full draft with citations\n\u2022 `/write evidence [question]` - Run evidence QA audit\n\u2022 `/kb audit [full|broken|orphan|duplicate|stale]` - Run KB health audit\n\u2022 `/qa <question>` - Ask source-backed QA in current context\n\n**Tips:**\n\u2022 Click on user messages to edit and resend\n\u2022 Hover over messages to copy content\n\u2022 Type `@` in input to reference vault files\n\u2022 Use the toolbar buttons for quick actions\n\u2022 Tool calls and permissions will appear inline",timestamp:new Date});else for(let t of e)this.messageContainer.addMessage(t)}updateSessionList(){var e;this.sessionTabs.updateSessions(this.sessionManager.getSessions(),((e=this.sessionManager.getCurrentSession())==null?void 0:e.id)||null),this.refreshWritingTaskPanel()}addSystemNotice(e){this.messageContainer.addMessage({role:"system",content:e,timestamp:new Date})}getCurrentSessionKey(){var e;return((e=this.sessionManager.getCurrentSession())==null?void 0:e.id)||"default-session"}getCurrentWritingTask(){return this.sessionManager.getCurrentWritingTask()}syncWorkflowTaskFromSession(){let e=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(e,this.getCurrentWritingTask())}refreshWritingTaskPanel(){if(!this.writingTaskPanel)return;let e=this.currentServerSessionId||"",t=e&&this.citationReportBySessionId.get(e)||null;this.writingTaskPanel.update(this.getCurrentWritingTask(),t)}updateCurrentWritingTaskStatus(e){let t=this.getCurrentWritingTask();if(!t){this.addSystemNotice("No active writing task. Use `/write start <topic>` first."),this.queueCommandTemplate("/write start ");return}let i={...t,status:e,updatedAt:new Date},n=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(n,i),this.sessionManager.setCurrentWritingTask(i),this.refreshWritingTaskPanel(),this.addSystemNotice(`Writing task status updated to **${e}**.`)}rollbackToDraftVersion(e){let t=this.getCurrentSessionKey();this.syncWorkflowTaskFromSession();let i=this.writingWorkflow.rollbackToDraftVersion(t,e);if(!i){this.addSystemNotice("Rollback failed: draft version not found.");return}this.sessionManager.setCurrentWritingTask(i.task),this.refreshWritingTaskPanel(),this.addSystemNotice(`Rolled back to **${i.version.label}**. Use \`/write ${i.version.stage}\` to continue from this baseline.`)}compareDraftVersion(e){let t=this.getCurrentWritingTask();if(!t){this.addSystemNotice("No active writing task.");return}let i=t.draftVersions.find(r=>r.id===e);if(!i){this.addSystemNotice("Draft version not found.");return}let n=t.draftVersions.find(r=>r.id===t.currentDraftVersionId);if(!n){this.addSystemNotice("No current draft version to compare against.");return}let o=ue(i.content,n.content,i.label,n.label);if(!o){this.addSystemNotice(`**${i.label}** and **${n.label}** are identical.`);return}let a=["## Draft Comparison",`Comparing **${i.label}** \u2192 **${n.label}**`,"","```diff",o,"```"].join(`
`);this.addSystemNotice(a)}captureDraftVersionFromAssistant(e,t,i){let n=this.getCurrentSessionKey();this.syncWorkflowTaskFromSession();let o=this.writingWorkflow.addDraftVersion(n,e,t,{citationCoverage:i==null?void 0:i.coverage,sourceCount:i==null?void 0:i.sourceCount});o&&(this.sessionManager.setCurrentWritingTask(o.task),this.refreshWritingTaskPanel(),o.created&&this.addSystemNotice(`Saved draft version: **${o.version.label}**`))}buildCitationCoverageNotice(e){let t=["## Citation Coverage Report",`- Coverage: ${Math.round(e.coverage*100)}% (${e.citedClaims}/${e.totalClaims})`,`- Sources listed: ${e.sourceCount}`];if(e.totalClaims===0)return t.push("- No claim lines detected for citation scoring."),t.join(`
`);if(e.uncitedClaims.length===0)return t.push("- Uncited claims: none"),t.join(`
`);t.push("### Uncited Claims");for(let i of e.uncitedClaims.slice(0,3))t.push(`- ${i}`);return t.push("- Action: add `[[source-note]]` links for uncited claims."),t.join(`
`)}async prepareWorkflowCommand(e){let t=e.trim();return/^\/help(?:\s+workflow)?$/i.test(t)?{displayCommand:t,promptToSend:null,localNotice:this.writingWorkflow.buildWorkflowHelp(),meta:{source:"plain",requiresCitationCheck:!1}}:/^\/write\b/i.test(t)?this.prepareWriteWorkflowCommand(t):/^\/kb\s+audit\b/i.test(t)?await this.prepareKbAuditCommand(t):/^\/qa\b/i.test(t)?this.prepareEvidenceQaCommand(t):{displayCommand:t,promptToSend:t,meta:{source:"plain",requiresCitationCheck:!1}}}prepareWriteWorkflowCommand(e){let t=e.match(/^\/write\s+([^\s]+)(?:\s+([\s\S]+))?$/i);if(!t)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/write start <topic>` or `/write outline|draft|evidence|polish|publish [requirements]`",meta:{source:"write",requiresCitationCheck:!1}};let i=t[1].toLowerCase(),n=(t[2]||"").trim(),o=We[i];if(!o)return{displayCommand:e,promptToSend:null,localNotice:`Unknown /write action: ${i}. Use \`/help workflow\` for available commands.`,meta:{source:"write",requiresCitationCheck:!1}};let a=this.getCurrentSessionKey();this.writingWorkflow.hydrateTask(a,this.getCurrentWritingTask());let r=this.contextResolver.resolveSnapshot(e),l=this.contextResolver.buildContextBlock(r),c=this.writingWorkflow.getTask(a);if(o==="discover"){if(!n&&!c)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/write start <topic>` (or create one task first, then use `/write discover`)",meta:{source:"write",stage:o,requiresCitationCheck:!1}};let L={...n?this.writingWorkflow.createTask(a,n):this.writingWorkflow.ensureTask(a,(c==null?void 0:c.objective)||"Untitled writing objective"),stage:"discover",status:"active",updatedAt:new Date};this.writingWorkflow.hydrateTask(a,L),this.sessionManager.setCurrentWritingTask(L),n&&this.currentServerSessionId&&this.citationReportBySessionId.delete(this.currentServerSessionId);let we=n||`Re-run discovery for writing task "${L.title}".`,xe=this.writingWorkflow.buildStagePrompt("discover",we,r,L,l);return{displayCommand:e,promptToSend:xe,localNotice:n?`Writing task created: **${L.title}**`:`Workflow stage: **discover** \xB7 Task: **${L.title}**`,meta:{source:"write",stage:o,requiresCitationCheck:!1}}}let d=this.writingWorkflow.ensureTask(a,n||"Untitled writing objective");this.writingWorkflow.updateStage(a,o);let h={...d,stage:o,status:"active",updatedAt:new Date};if(this.writingWorkflow.hydrateTask(a,h),this.sessionManager.setCurrentWritingTask(h),o==="evidence"){let oe=n||`Audit factual grounding for writing task "${h.title}".`;return{displayCommand:e,promptToSend:this.writingWorkflow.buildEvidencePrompt(oe,l),localNotice:`Workflow stage: **evidence** \xB7 Task: **${h.title}**`,meta:{source:"write",stage:o,requiresCitationCheck:!0}}}let g=n||`Continue task "${h.title}" in ${o} stage.`,x=o==="publish"?this.publishAssistant.buildPublishContextBlock(this.publishAssistant.gatherVaultContext()):void 0,C=this.writingWorkflow.buildStagePrompt(o,g,r,h,l,x),ve=o==="draft"||o==="polish"||o==="publish";return{displayCommand:e,promptToSend:C,localNotice:`Workflow stage: **${o}** \xB7 Task: **${h.title}**`,meta:{source:"write",stage:o,requiresCitationCheck:!0,shouldCaptureDraftVersion:ve}}}async prepareKbAuditCommand(e){let t=e.match(/^\/kb\s+audit(?:\s+([^\s]+))?(?:\s+([\s\S]+))?$/i);if(!t)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/kb audit [full|broken|orphan|duplicate|stale] [extra requirements]`",meta:{source:"kb",requiresCitationCheck:!1}};let i=(t[1]||"").toLowerCase(),n=(t[2]||"").trim(),o="full",a="";He.includes(i)?(o=i,a=n):a=[i,n].filter(g=>g.length>0).join(" ").trim();let r=await this.knowledgeBaseService.runAudit(),l=this.knowledgeBaseService.formatReport(r),c=this.contextResolver.resolveSnapshot(e),d=this.contextResolver.buildContextBlock(c),h=this.writingWorkflow.buildKbAuditPrompt(o,a,d,l);return{displayCommand:e,promptToSend:h,localNotice:`Knowledge base audit scope: **${o}** (Found ${r.issues.length} issues)`,meta:{source:"kb",requiresCitationCheck:!1}}}prepareEvidenceQaCommand(e){let t=e.match(/^\/qa(?:\s+([\s\S]+))?$/i),i=((t==null?void 0:t[1])||"").trim();if(!i)return{displayCommand:e,promptToSend:null,localNotice:"Usage: `/qa <question>`",meta:{source:"qa",requiresCitationCheck:!1}};let n=this.contextResolver.resolveSnapshot(e,i),o=this.contextResolver.buildContextBlock(n),a=this.writingWorkflow.buildEvidencePrompt(i,o);return{displayCommand:e,promptToSend:a,localNotice:"Running evidence QA workflow with strict citation checks.",meta:{source:"qa",requiresCitationCheck:!0}}}async handleCommand(e){if(this.isProcessing)return;let t=await this.prepareWorkflowCommand(e);if(!t.promptToSend){t.localNotice&&this.addSystemNotice(t.localNotice),this.refreshWritingTaskPanel();return}if(this.refreshWritingTaskPanel(),!this.server){console.error("OpenCodeChatView: Server not available");return}this.isProcessing=!0,this.chatInput.setProcessing(!0),this.messageContainer.addUserMessage(t.displayCommand),this.sessionManager.addMessage({role:"user",content:t.displayCommand,timestamp:new Date}),t.localNotice&&this.addSystemNotice(t.localNotice),this.messageContainer.createAssistantMessage();try{let i=this.currentServerSessionId;i||(i=(await this.server.createSession(Fe)).id,this.sessionManager.updateServerSessionId(i)),await this.server.sendMessage(i,t.promptToSend),this.pendingMetaByServerSessionId.set(i,t.meta||{source:"plain",requiresCitationCheck:!1})}catch(i){console.error("OpenCodeChatView: Command error:",i),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

**Error:** ${i.message}`),this.messageContainer.finalizeAssistantMessage();let n=this.messageContainer.getMessages(),o=n[n.length-1];o&&o.role==="assistant"&&this.sessionManager.addMessage(o),this.isProcessing=!1,this.chatInput.setProcessing(!1),this.chatInput.focus()}}handleStop(){if(!this.isProcessing)return;let e=this.currentServerSessionId;e&&this.pendingMetaByServerSessionId.delete(e),e&&this.server&&this.server.abortSession(e).catch(t=>{console.error("OpenCodeChatView: Failed to abort session:",t)}),this.messageContainer.hideThinking(),this.messageContainer.appendToAssistantMessage(`

_Stopped by user_`),this.messageContainer.finalizeAssistantMessage(),this.isProcessing=!1,this.chatInput.setProcessing(!1)}clearHistory(){let e=this.getCurrentSessionKey();this.sessionManager.clearCurrentSession(),this.sessionManager.setCurrentWritingTask(null),this.writingWorkflow.hydrateTask(e,null);let t=this.currentServerSessionId;t&&(this.citationReportBySessionId.delete(t),this.pendingMetaByServerSessionId.delete(t)),this.messageContainer.clear(),this.messageContainer.addMessage({role:"system",content:"OpenCode Chat - History cleared",timestamp:new Date}),this.updateSessionList()}focusInput(){this.chatInput.focus()}loadSession(e){if(this.isProcessing&&this.handleStop(),!this.sessionManager.switchSession(e)){console.error("OpenCodeChatView: Failed to switch to session:",e);return}this.syncWorkflowTaskFromSession(),this.messageContainer.clear(),this.loadCurrentSessionMessages(),this.updateSessionList(),this.chatInput.focus()}createNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length}`);this.loadSession(e.id)}deleteSession(e){if(this.writingWorkflow.hydrateTask(e,null),!this.sessionManager.deleteSession(e)){console.error("OpenCodeChatView: Failed to delete session:",e);return}let i=this.sessionManager.getCurrentSession();i?this.loadSession(i.id):this.createNewSession()}renameSession(e,t){this.sessionManager.updateSessionName(e,t)&&this.updateSessionList()}async exportConversation(){let e=this.sessionManager.getCurrentMessages();if(e.length===0)return;let t=this.sessionManager.getCurrentSession(),i=(t==null?void 0:t.name)||"Conversation",n=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),a=`opencode-chat-${i.replace(/[^a-zA-Z0-9]/g,"-")}-${n}.md`,r=`# OpenCode Chat Conversation

`;r+=`**Session:** ${i}

`,r+=`*Exported: ${new Date().toLocaleString()}*

`,r+=`*Server Session ID: ${(t==null?void 0:t.serverSessionId)||"N/A"}*

`,r+=`---

`;for(let d of e){if(d.role==="system")continue;let h=d.role==="user"?"\u{1F464} User":"\u{1F916} Assistant",g=d.timestamp.toLocaleTimeString();r+=`## ${h}

`,r+=`*${g}*

`,r+=`${d.content}

`,r+=`---

`}let l=this.app.vault;await l.create(a,r),l.getAbstractFileByPath(a)&&await this.app.workspace.openLinkText(a,"",!0)}async handleEditMessage(e,t){this.messageContainer.removeMessagesAfter(e),await this.handleCommand(t)}async regenerateLast(){let e=this.messageContainer.getMessages(),t=-1;for(let i=e.length-1;i>=0;i--)if(e[i].role==="user"){t=i;break}t>=0&&(this.messageContainer.removeMessagesAfter(t-1),await this.handleCommand(e[t].content))}async onClose(){this.writingTaskPanel&&(this.writingTaskPanel.destroy(),this.writingTaskPanel=null),this.unsubscribeFromServer()}handleExportWeChat(){let e=this.sessionManager.getCurrentWritingTask();if(!e||!e.currentDraftVersionId){new T.Notice("No active draft to export.");return}let t=e.draftVersions.find(n=>n.id===e.currentDraftVersionId);if(!t){new T.Notice("Draft version content not found.");return}new _(this.app,n=>{let a=`${e.title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5-_]/g,"").slice(0,50)} - WeChat ${n}`;this.weChatExporter.exportToHtml(t.content,n,a,"")}).open()}};var f=require("obsidian");var $e=[{label:"Default (\u9ED8\u8BA4)",value:"default",description:"Blue accent, clear structure. Good for tech/general."},{label:"Elegant (\u6587\u827A)",value:"elegant",description:"Brown tone, serif fonts. Good for essays/reviews."},{label:"Tech (\u6781\u5BA2)",value:"tech",description:"Dark theme, terminal style. Good for coding tutorials."},{label:"Vibrant (\u6D3B\u6CFC)",value:"vibrant",description:"Gradients, lively colors. Good for lifestyle/products."},{label:"Minimal (\u6781\u7B80)",value:"minimal",description:"Black & white, spacious. Good for serious reading."},{label:"AI Blue (AI \u84DD)",value:"aiBlue",description:"Deep sea tech feel. Perfect for AI/deep learning topics."},{label:"Matrix Green (\u9ED1\u5BA2\u7EFF)",value:"matrixGreen",description:"Hacker style. Great for programming/security."},{label:"Cyber Purple (\u8D5B\u535A\u7D2B)",value:"cyberPurple",description:"Cyberpunk style. For cutting-edge tech/AI."},{label:"Ocean Teal (\u6D77\u6D0B\u9752)",value:"oceanTeal",description:"Fresh & professional. Clean tech style."}],G=class p extends f.ItemView{constructor(e){super(e);this.currentFile=null;this.currentStyle="default";this.previewContainer=null;this.styleSelector=null;this.weChatExporter=new k(this.app)}getViewType(){return y}getDisplayText(){return this.currentFile?`Export Preview: ${this.currentFile.name}`:"Export Preview"}getIcon(){return"file-output"}async onOpen(){this.containerEl.empty(),this.containerEl.addClass("wechat-preview-container");let e=this.containerEl.createEl("div",{cls:"wechat-preview-header"}),t=e.createEl("h3",{cls:"wechat-preview-title",text:"WeChat Export Preview"}),i=e.createEl("div",{cls:"wechat-preview-style-selector"});i.createEl("label",{text:"Style: ",cls:"wechat-preview-style-label"}),this.styleSelector=i.createEl("select",{cls:"wechat-preview-style-dropdown"}),$e.forEach(c=>{this.styleSelector.createEl("option",{value:c.value,text:c.label}).setAttribute("data-description",c.description)}),this.styleSelector.value=this.currentStyle,this.styleSelector.addEventListener("change",()=>{this.currentStyle=this.styleSelector.value,this.updatePreview()});let n=e.createEl("div",{cls:"wechat-preview-actions"});n.createEl("button",{cls:"wechat-preview-action-btn",text:"Copy for WeChat"}).addEventListener("click",()=>this.copyForWeChat()),n.createEl("button",{cls:"wechat-preview-action-btn mod-cta",text:"Export HTML"}).addEventListener("click",()=>this.exportToFile());let r=this.containerEl.createEl("div",{cls:"wechat-preview-area"});this.previewContainer=r.createEl("div",{cls:"wechat-preview-content"}),this.registerEvent(this.app.workspace.on("active-leaf-change",c=>{var h;if((c==null?void 0:c.view)instanceof p)return;let d=(h=c==null?void 0:c.view)==null?void 0:h.file;d&&d instanceof f.TFile&&this.setFile(d)}));let l=this.app.workspace.getActiveFile();l&&this.setFile(l)}async setFile(e){this.currentFile=e,this.updateDisplayText(),await this.updatePreview()}async updatePreview(){var e,t;if(!this.currentFile||!this.previewContainer){(e=this.previewContainer)==null||e.empty(),(t=this.previewContainer)==null||t.createEl("div",{cls:"wechat-preview-empty",text:"No file selected"});return}this.previewContainer.empty(),this.previewContainer.createEl("div",{cls:"wechat-preview-loading",text:"Loading preview..."});try{let i=await this.app.vault.cachedRead(this.currentFile),n=this.currentStyle,o=await this.weChatExporter.generateStyledHtml(i,n,this.currentFile.path);this.previewContainer.empty();let a=this.previewContainer.createEl("div",{cls:"wechat-article"});a.innerHTML=o}catch(i){this.previewContainer.empty(),this.previewContainer.createEl("div",{cls:"wechat-preview-error",text:`Failed to load preview: ${i}`}),new f.Notice("Failed to load preview")}}async exportToFile(){if(!this.currentFile){new f.Notice("No file to export");return}try{let e=await this.app.vault.read(this.currentFile),t=this.currentFile.basename,i=new k(this.app);new f.Notice("Exporting to HTML...");let n=await i.exportToHtml(e,this.currentStyle,t,this.currentFile.path);n&&(new f.Notice(`Exported: ${n.name}`),await this.app.workspace.getLeaf(!1).openFile(n))}catch(e){console.error("Export failed:",e),new f.Notice("Export failed. Check console for details.")}}async copyForWeChat(){var e;if(!this.currentFile){new f.Notice("No file to copy");return}if(!this.previewContainer){new f.Notice("Preview not ready");return}try{new f.Notice("Preparing content for copy...");let t=await this.app.vault.read(this.currentFile),i=await this.weChatExporter.generateFullHtml(t,this.currentStyle,this.currentFile.basename,this.currentFile.path),n=document.createElement("iframe");n.style.position="fixed",n.style.left="-9999px",n.style.top="0",n.style.width="1px",n.style.height="1px",n.style.border="none",document.body.appendChild(n);let o=n.contentDocument;if(o){o.open(),o.write('<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>'+i+"</body></html>"),o.close();let a=o.createRange();a.selectNodeContents(o.body);let r=(e=o.defaultView)==null?void 0:e.getSelection();r==null||r.removeAllRanges(),r==null||r.addRange(a);try{if(o.execCommand("copy"))new f.Notice("Copied! Now paste into WeChat Official Account editor.");else throw new Error("execCommand failed")}catch(l){await navigator.clipboard.writeText(i),new f.Notice("Copied (HTML)! Now paste into WeChat Official Account editor.")}}document.body.removeChild(n)}catch(t){console.error("Copy failed:",t),new f.Notice("Copy failed. Check console for details.")}}updateDisplayText(){let e=this.containerEl.querySelector(".view-header-title");e&&(e.textContent=this.currentFile?`Export: ${this.currentFile.name}`:"Export Preview")}};var J=class{constructor(){this.sessions=[];this.currentSessionId=null;this.onChangeCallbacks=[];this.loadSessions()}loadSessions(s=[],e=null){this.sessions=s.map(t=>({...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),writingTask:t.writingTask?{...t.writingTask,draftVersions:(t.writingTask.draftVersions||[]).map(i=>({...i,createdAt:new Date(i.createdAt)})),stageHistory:(t.writingTask.stageHistory||[]).map(i=>({...i,timestamp:new Date(i.timestamp)})),currentDraftVersionId:t.writingTask.currentDraftVersionId||null,createdAt:new Date(t.writingTask.createdAt),updatedAt:new Date(t.writingTask.updatedAt)}:null,messages:t.messages.map(i=>({...i,timestamp:new Date(i.timestamp)}))})),this.currentSessionId=e,this.sessions.length===0?this.createSession("Default Session"):this.currentSessionId||(this.currentSessionId=this.sessions[0].id)}getSessions(){return[...this.sessions]}getCurrentSession(){return this.currentSessionId&&this.sessions.find(s=>s.id===this.currentSessionId)||null}getSession(s){return this.sessions.find(e=>e.id===s)||null}createSession(s){let e={id:this.generateId(),name:s,sessionId:null,serverSessionId:null,writingTask:null,createdAt:new Date,updatedAt:new Date,messages:[]};return this.sessions.push(e),this.currentSessionId=e.id,this.notifyChange(),e}updateSessionName(s,e){let t=this.getSession(s);return t?(t.name=e,t.updatedAt=new Date,this.notifyChange(),!0):!1}deleteSession(s){let e=this.sessions.findIndex(t=>t.id===s);return e!==-1?(this.sessions.splice(e,1),this.currentSessionId===s&&(this.currentSessionId=this.sessions.length>0?this.sessions[0].id:null,this.sessions.length===0&&this.createSession("Default Session")),this.notifyChange(),!0):!1}switchSession(s){return this.getSession(s)?(this.currentSessionId=s,this.notifyChange(),!0):!1}addMessage(s){let e=this.getCurrentSession();e&&(e.messages.push(s),e.updatedAt=new Date,this.notifyChange())}updateCliSessionId(s){let e=this.getCurrentSession();e&&(e.sessionId=s,e.updatedAt=new Date,this.notifyChange())}updateServerSessionId(s){let e=this.getCurrentSession();e&&(e.serverSessionId=s,e.updatedAt=new Date,this.notifyChange())}getCurrentServerSessionId(){let s=this.getCurrentSession();return s?s.serverSessionId:null}getCurrentWritingTask(){let s=this.getCurrentSession();return(s==null?void 0:s.writingTask)||null}setCurrentWritingTask(s){let e=this.getCurrentSession();if(e){if(!s){e.writingTask=null,e.updatedAt=new Date,this.notifyChange();return}e.writingTask={...s,draftVersions:(s.draftVersions||[]).map(t=>({...t,createdAt:new Date(t.createdAt)})),stageHistory:(s.stageHistory||[]).map(t=>({...t,timestamp:new Date(t.timestamp)})),currentDraftVersionId:s.currentDraftVersionId||null,createdAt:new Date(s.createdAt),updatedAt:new Date(s.updatedAt)},e.updatedAt=new Date,this.notifyChange()}}clearCurrentSession(){let s=this.getCurrentSession();s&&(s.messages=[],s.updatedAt=new Date,this.notifyChange())}getCurrentMessages(){let s=this.getCurrentSession();return s?s.messages:[]}getCurrentCliSessionId(){let s=this.getCurrentSession();return s?s.sessionId:null}onChange(s){this.onChangeCallbacks.push(s)}exportForSave(){return{sessions:this.sessions,currentSessionId:this.currentSessionId}}notifyChange(){for(let s of this.onChangeCallbacks)s()}generateId(){return`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}};var se=require("child_process"),I=ae(require("fs")),ie=ae(require("path")),ge=require("http"),fe=require("obsidian"),ne=class{constructor(){this.listeners={}}on(s,e){let t=this.listeners[s];if(t){t.add(e);return}this.listeners[s]=new Set([e])}off(s,e){let t=this.listeners[s];t&&(t.delete(e),t.size===0&&delete this.listeners[s])}emit(s,...e){let t=this.listeners[s];if(t)for(let i of t)i(...e)}removeAllListeners(){this.listeners={}}},M=class M extends ne{constructor(e){super();this.serverProcess=null;this.sseRequest=null;this.port=0;this.baseUrl="";this.isConnected=!1;this.reconnectTimer=null;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.sseBuffer="";this.textAccumulator=new Map;this.messageRoles=new Map;this.stopping=!1;this.opencodeModel="";this.ohMyOpencodeModel="";this.enableOhMyOpencode=!0;this.vaultPath=e}static getInstance(e){return M.instance||(M.instance=new M(e)),M.instance}setModels(e,t,i){this.opencodeModel=e,this.ohMyOpencodeModel=t,this.enableOhMyOpencode=i}async listModels(){return new Promise((e,t)=>{var a,r;let i=(0,se.spawn)("opencode",["models"],{env:{...process.env,PATH:this.buildAugmentedPath()},windowsHide:!0}),n="",o="";(a=i.stdout)==null||a.on("data",l=>{n+=l.toString()}),(r=i.stderr)==null||r.on("data",l=>{o+=l.toString()}),i.on("close",l=>{if(l===0){let c=n.split(`
`).map(d=>d.trim()).filter(d=>d.length>0);e(c)}else t(new Error(`Failed to list models: ${o||"Unknown error"}`))}),i.on("error",l=>{t(l)})})}get connected(){return this.isConnected}get serverPort(){return this.port}async start(){if(this.serverProcess)return;this.stopping=!1;let e=null,t=5;for(let i=0;i<t;i+=1){let n=14e3+i;try{await this.startServerOnPort(n);return}catch(o){let a=o instanceof Error?o:new Error("Failed to start OpenCode server");if(e=a,console.error(`OpenCodeServer: Port ${n} failed:`,a.message),a.message.includes("ENOENT"))throw new Error("OpenCode CLI not found. Please install it: curl -fsSL https://opencode.ai/install | bash")}}throw e||new Error("Failed to start OpenCode server")}async restart(){if(console.log("OpenCodeServer: Restarting service..."),this.stopping=!0,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.sseRequest&&(this.sseRequest.destroy(),this.sseRequest=null),this.sseBuffer="",this.textAccumulator.clear(),this.messageRoles.clear(),this.isConnected=!1,this.serverProcess){try{this.serverProcess.kill("SIGTERM")}catch(e){}await new Promise(e=>setTimeout(e,500));try{this.serverProcess.kill("SIGKILL")}catch(e){}this.serverProcess=null}this.port=0,this.baseUrl="",this.reconnectAttempts=0,this.stopping=!1,console.log("OpenCodeServer: Waiting for port release (3s)..."),await new Promise(e=>setTimeout(e,3e3)),await this.start()}async stop(){this.stopping=!0,this.disconnectSSE(),this.textAccumulator.clear(),this.messageRoles.clear(),this.isConnected=!1,await this.killServerProcess(),this.port=0,this.baseUrl="",this.reconnectAttempts=0,this.stopping=!1}async startServerOnPort(e){var o,a,r,l;this.port=e,this.baseUrl=`http://127.0.0.1:${e}`,console.log(`OpenCodeServer: Starting on port ${e}, cwd: ${this.vaultPath}`);let t={...process.env,PATH:this.buildAugmentedPath()};this.opencodeModel&&(t.OPENCODE_MODEL=this.opencodeModel),this.enableOhMyOpencode&&this.ohMyOpencodeModel&&(t.OH_MY_OPENCODE_MODEL=this.ohMyOpencodeModel),await this.writeLocalConfig();let i=(0,se.spawn)("opencode",["serve","--port",String(e)],{cwd:this.vaultPath,env:t,stdio:["ignore","pipe","pipe"],windowsHide:!0});this.serverProcess=i,(o=i.stdout)==null||o.setEncoding("utf8"),(a=i.stderr)==null||a.setEncoding("utf8"),(r=i.stdout)==null||r.on("data",()=>{});let n="";(l=i.stderr)==null||l.on("data",c=>{let d=c.toString().trim();d&&(console.error("OpenCodeServer: stderr:",d),n+=d+`
`)}),i.on("exit",(c,d)=>{console.error(`OpenCodeServer: Process exited (code: ${c}, signal: ${d})`)});try{await this.waitForServerReady(i,()=>n)}catch(c){throw await this.stop(),c}console.log(`OpenCodeServer: Server ready on port ${e}`),await this.connectSSE()}async writeLocalConfig(){let e=ie.join(this.vaultPath,".opencode"),t=ie.join(e,"opencode.json");try{I.existsSync(e)||I.mkdirSync(e,{recursive:!0});let i={};this.enableOhMyOpencode||(i.plugin=[]),I.writeFileSync(t,JSON.stringify(i,null,2))}catch(i){console.error("OpenCodeServer: Failed to write local config:",i)}}buildAugmentedPath(){let e=process.env.HOME||process.env.USERPROFILE||"",t=e?`${e}/.opencode/bin`:"",i=process.env.PATH||"";return t&&!i.includes(t)?`${t}:${i}`:i}async waitForServerReady(e,t){let i=Date.now(),n=1e4,o=null,a=(l,c)=>{let d=t?t():"",h=d?` (stderr: ${d})`:"";o=new Error(`OpenCode server exited before ready (code: ${l!=null?l:"unknown"}, signal: ${c!=null?c:"none"})${h}`)},r=l=>{o=l};e.once("exit",a),e.once("error",r);try{for(;Date.now()-i<n;){if(o)throw o;try{await this.httpRequest("GET","/session");return}catch(l){await this.delay(500)}}}finally{e.off("exit",a),e.off("error",r)}throw o||new Error("OpenCode server did not become ready in time")}delay(e){return new Promise(t=>setTimeout(t,e))}async connectSSE(){this.disconnectSSE(),this.sseBuffer="";let e=new Promise((i,n)=>{let o=(0,ge.request)(`${this.baseUrl}/event`,{method:"GET",headers:{Accept:"text/event-stream"}},a=>{var d;let r=(d=a.statusCode)!=null?d:0;if(r>=400){let h=new Error(`SSE connection failed with status ${r}`);this.handleSseDisconnect(h),n(h);return}let l=!1,c=h=>{l||(l=!0,this.handleSseDisconnect(h))};console.log("OpenCodeServer: SSE connected"),this.reconnectAttempts=0,this.markConnected(),a.setEncoding("utf8"),a.on("data",h=>{this.handleSseData(h.toString())}),a.once("end",()=>{c(new Error("SSE connection ended"))}),a.once("close",()=>{c(new Error("SSE connection closed"))}),a.once("error",h=>{c(h)}),i()});this.sseRequest=o,o.on("error",a=>{this.handleSseDisconnect(a),n(a)}),o.end()}),t=new Promise((i,n)=>{setTimeout(()=>n(new Error("SSE connection timeout")),5e3)});return Promise.race([e,t])}disconnectSSE(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.sseRequest&&(this.sseRequest.destroy(),this.sseRequest=null),this.sseBuffer="",this.isConnected&&(this.isConnected=!1,this.emit("disconnected"))}markConnected(){this.isConnected||(this.isConnected=!0,this.emit("connected"))}handleSseDisconnect(e){this.disconnectSSE(),!this.stopping&&(e?(console.error("OpenCodeServer: SSE disconnected",e),this.emit("error",e)):console.log("OpenCodeServer: SSE disconnected"),this.scheduleReconnect())}scheduleReconnect(){this.stopping||!this.serverProcess||this.reconnectAttempts>=this.maxReconnectAttempts||this.reconnectTimer||(this.reconnectAttempts+=1,this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connectSSE().catch(e=>{let t=e instanceof Error?e:new Error("Failed to reconnect SSE");this.handleSseDisconnect(t)})},2e3))}handleSseData(e){var i;if(this.stopping)return;this.sseBuffer+=e;let t=this.sseBuffer.split(/\r?\n\r?\n/);this.sseBuffer=(i=t.pop())!=null?i:"";for(let n of t){let o=n.split(/\r?\n/).filter(r=>r.startsWith("data:")).map(r=>r.replace(/^data:\s?/,""));if(o.length===0)continue;let a=o.join(`
`);this.handleSsePayload(a)}}handleSsePayload(e){if(!this.stopping)try{let t=JSON.parse(e);this.handleEvent(t)}catch(t){let i=t instanceof Error?t:new Error("Failed to parse SSE payload");this.emit("error",i)}}handleEvent(e){switch(e.type){case"session.status":{let{sessionID:t,status:i}=e.properties;this.emit("session.status",t,i);break}case"session.idle":{this.emit("session.idle",e.properties.sessionID);break}case"session.error":{this.emit("session.error",e.properties.sessionID,e.properties.error);break}case"session.diff":{let{sessionID:t,diff:i}=e.properties;this.emit("diff.updated",t,i);break}case"message.updated":{let t=e.properties.info;t.role&&this.messageRoles.set(t.id,t.role),this.emit("message.updated",t);break}case"message.part.updated":{this.handlePartUpdated(e.properties.part,e.properties.delta);break}case"permission.asked":{this.emit("permission.asked",e.properties);break}case"question.asked":{this.emit("question.asked",e.properties);break}case"todo.updated":{let{sessionID:t,todos:i}=e.properties;this.emit("todo.updated",t,i);break}case"server.connected":{this.markConnected();break}default:break}}handlePartUpdated(e,t){var i,n;if(e.type==="text"){if(this.messageRoles.get(e.messageID)==="user")return;let a=e.id,r=(i=this.textAccumulator.get(a))!=null?i:"",l=r,c="";typeof t=="string"?(c=t,l=r+t):typeof e.text=="string"&&(l=e.text,e.text.startsWith(r)?c=e.text.slice(r.length):c=e.text),this.textAccumulator.set(a,l),this.emit("text.delta",e.sessionID,a,c,l),((n=e.time)==null?void 0:n.end)!==void 0&&this.emit("text.done",e.sessionID,a,l);return}if(e.type==="tool"){this.emit("tool.updated",e.sessionID,e);return}if(e.type==="step-start"){this.emit("step.start",e.sessionID,e);return}e.type==="step-finish"&&this.emit("step.finish",e.sessionID,e)}async httpRequest(e,t,i){if(!this.baseUrl)throw new Error("OpenCode server is not started");let n=`${this.baseUrl}${t}`,o={"Content-Type":"application/json"},a=i!==void 0?JSON.stringify(i):void 0,r=await(0,fe.requestUrl)({url:n,method:e,headers:o,body:a,throw:!1});if(r.status>=400)throw new Error(`HTTP ${r.status}: ${r.text||"Request failed"}`);if(!(r.status===204||r.text.trim()===""))try{return JSON.parse(r.text)}catch(l){throw l instanceof Error?l:new Error("Failed to parse JSON response")}}async createSession(e){let t=e?{permission:e}:{};return this.httpRequest("POST","/session",t)}async listSessions(){return this.httpRequest("GET","/session")}async sendMessage(e,t){let i={parts:[{type:"text",text:t}]};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/prompt_async`,i)}async getMessages(e){return this.httpRequest("GET",`/session/${encodeURIComponent(e)}/message`)}async abortSession(e){await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/abort`)}async approvePermission(e,t,i){let n={response:i};await this.httpRequest("POST",`/session/${encodeURIComponent(e)}/permissions/${encodeURIComponent(t)}`,n)}async replyToQuestion(e,t,i){let{requestId:n,answers:o}=this.normalizeQuestionReplyArgs(e,t,i),a={answers:o};await this.httpRequest("POST",`/question/${encodeURIComponent(n)}/reply`,a)}async rejectQuestion(e){await this.httpRequest("POST",`/question/${encodeURIComponent(e)}/reject`)}normalizeQuestionReplyArgs(e,t,i){if(Array.isArray(t))return{requestId:e,answers:t};if(!i)throw new Error("Question reply requires answers");return{requestId:t,answers:i}}async killServerProcess(){let e=this.serverProcess;e&&(this.serverProcess=null,await new Promise(t=>{let i=!1,n=()=>{i||(i=!0,clearTimeout(o),t())},o=setTimeout(()=>{if(!i)try{e.kill("SIGKILL")}catch(a){n()}},3e3);e.once("exit",n),e.once("close",n);try{e.kill("SIGTERM")}catch(a){n()}}))}};M.instance=null;var X=M;var b=require("obsidian"),Y=class extends b.PluginSettingTab{constructor(e,t){super(e,t);this.ohMyOpencodeModelSetting=null;this.tempSettings=null;this.opencodeModelDropdown=null;this.ohMyOpencodeToggle=null;this.ohMyOpencodeModelDropdown=null;this.applyBtn=null;this.cancelBtn=null;this.isApplying=!1;this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"OpenCode Chat Settings"}),this.tempSettings={...this.plugin.settings};let t=e.createEl("div",{text:"Loading available models...",cls:"setting-item-description"});this.plugin.server?this.plugin.server.listModels().then(i=>{t.remove(),this.renderModelSettings(e,i),this.renderButtons(e)}).catch(i=>{t.setText(`Error loading models: ${i.message}`)}):t.setText("OpenCode server not initialized.")}renderModelSettings(e,t){new b.Setting(e).setName("OpenCode Model").setDesc("The model ID to use for the OpenCode server (e.g. opencode/gpt-4o).").addDropdown(i=>{i.addOption("","Default (System)"),t.forEach(o=>i.addOption(o,o));let n=this.tempSettings.opencodeModel;n&&!t.includes(n)&&i.addOption(n,n),i.setValue(n).onChange(o=>{this.tempSettings.opencodeModel=o}),this.opencodeModelDropdown=i}),new b.Setting(e).setName("Enable Oh-My-OpenCode").setDesc("Enable or disable the Oh-My-OpenCode plugin integration.").addToggle(i=>{i.setValue(this.tempSettings.enableOhMyOpencode).onChange(n=>{this.tempSettings.enableOhMyOpencode=n,this.updateOhMyOpencodeModelState()}),this.ohMyOpencodeToggle=i}),this.ohMyOpencodeModelSetting=new b.Setting(e).setName("Oh-My-OpenCode Model").setDesc("The model ID to use for Oh-My-OpenCode agents.").addDropdown(i=>{i.addOption("","Default (System)"),t.forEach(o=>i.addOption(o,o));let n=this.tempSettings.ohMyOpencodeModel;n&&!t.includes(n)&&i.addOption(n,n),i.setValue(n).onChange(o=>{this.tempSettings.ohMyOpencodeModel=o}),this.ohMyOpencodeModelDropdown=i}),this.updateOhMyOpencodeModelState()}renderButtons(e){new b.Setting(e).addButton(t=>{this.applyBtn=t,t.setButtonText("Apply").setCta().onClick(()=>{this.handleApply()})}).addButton(t=>{this.cancelBtn=t,t.setButtonText("Cancel").onClick(()=>{this.handleCancel()})})}async handleApply(){if(!this.isApplying){this.isApplying=!0,this.applyBtn.setDisabled(!0).setButtonText("Applying..."),this.cancelBtn.setDisabled(!0),this.plugin.settings={...this.tempSettings},await this.plugin.saveSettings();try{await this.plugin.reloadServer(),new b.Notice("Settings applied successfully.")}catch(e){let t=e instanceof Error?e.message:String(e);new b.Notice(`Restart failed: ${t}. Please restart Obsidian manually.`)}finally{this.isApplying=!1,this.applyBtn.setDisabled(!1).setButtonText("Apply"),this.cancelBtn.setDisabled(!1)}}}handleCancel(){this.isApplying||(this.tempSettings={...this.plugin.settings},this.resetControlsToTemp())}updateOhMyOpencodeModelState(){if(this.ohMyOpencodeModelSetting){let e=this.tempSettings.enableOhMyOpencode;this.ohMyOpencodeModelSetting.setDisabled(!e),e?this.ohMyOpencodeModelSetting.settingEl.style.opacity="1":this.ohMyOpencodeModelSetting.settingEl.style.opacity="0.5"}}resetControlsToTemp(){this.opencodeModelDropdown&&this.opencodeModelDropdown.setValue(this.tempSettings.opencodeModel),this.ohMyOpencodeToggle&&this.ohMyOpencodeToggle.setValue(this.tempSettings.enableOhMyOpencode),this.ohMyOpencodeModelDropdown&&this.ohMyOpencodeModelDropdown.setValue(this.tempSettings.ohMyOpencodeModel),this.updateOhMyOpencodeModelState()}};var me={opencodeModel:"",ohMyOpencodeModel:"",enableOhMyOpencode:!0},Z=class extends ee.Plugin{constructor(){super(...arguments);this.data={sessionId:null,version:"1.0.0",sessions:[],currentSessionId:null};this.settings=me;this.sessionManager=new J;this.server=null}async onload(){await this.loadPluginData(),await this.loadSettings(),this.syncBundledSkillsToVault();let e=this.getVaultPath();this.server=X.getInstance(e),this.server.setModels(this.settings.opencodeModel,this.settings.ohMyOpencodeModel,this.settings.enableOhMyOpencode),this.server.start().then(()=>{var t;console.log("OpenCodeChat: Server started on port",(t=this.server)==null?void 0:t.serverPort)}).catch(t=>{console.error("OpenCodeChat: Failed to start OpenCode server:",t)}),this.addSettingTab(new Y(this.app,this)),this.registerView(v,t=>new Q(t,this)),this.registerView(y,t=>new G(t)),this.addRibbonIcon("message-square","Open OpenCode Chat",()=>{this.activateView()}),this.addRibbonIcon("file-output","Open WeChat Export Preview",()=>{this.activateWeChatPreview()}),this.addCommand({id:"open-claude-chat",name:"Open OpenCode Chat",callback:()=>this.activateView()}),this.addCommand({id:"claude-chat-clear-history",name:"Clear chat history",hotkeys:[{modifiers:["Mod"],key:"k"}],callback:()=>this.clearChatHistory()}),this.addCommand({id:"claude-chat-focus-input",name:"Focus chat input",hotkeys:[{modifiers:["Mod"],key:"l"}],callback:()=>this.focusInput()}),this.addCommand({id:"claude-chat-stop",name:"Stop generation",hotkeys:[{modifiers:[],key:"Escape"}],callback:()=>this.stopGeneration()}),this.addCommand({id:"claude-chat-new-session",name:"Start new session",hotkeys:[{modifiers:["Mod","Shift"],key:"n"}],callback:()=>this.startNewSession()}),this.addCommand({id:"claude-chat-export",name:"Export conversation to Markdown",hotkeys:[{modifiers:["Mod","Shift"],key:"e"}],callback:()=>this.exportConversation()}),this.addCommand({id:"wechat-export-preview",name:"Open WeChat Export Preview",callback:()=>this.activateWeChatPreview()}),this.registerEvent(this.app.workspace.on("file-menu",(t,i)=>{i.extension==="md"&&t.addItem(n=>{n.setTitle("WeChat Export Preview").setIcon("file-output").onClick(()=>this.openWeChatPreviewForFile(i))})}))}async loadSettings(){this.settings=Object.assign({},me,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async reloadServer(){this.server&&(this.server.setModels(this.settings.opencodeModel,this.settings.ohMyOpencodeModel,this.settings.enableOhMyOpencode),await this.server.restart())}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t)e.revealLeaf(t);else{let i=e.getRightLeaf(!1);i&&await i.setViewState({type:v,active:!0})}}async activateWeChatPreview(){let{workspace:e}=this.app,t=e.getActiveFile();if(!t){new ee.Notice("No active file to preview");return}let i=e.getLeavesOfType(y)[0];if(i)e.revealLeaf(i),await i.view.setFile(t);else{let n=e.getRightLeaf(!1);n&&(await n.setViewState({type:y,active:!0}),await n.view.setFile(t))}}async openWeChatPreviewForFile(e){let{workspace:t}=this.app,i=t.getLeavesOfType(y)[0];if(i)t.revealLeaf(i),await i.view.setFile(e);else{let n=t.getRightLeaf(!1);n&&(await n.setViewState({type:y,active:!0}),await n.view.setFile(e))}}onunload(){this.server&&(this.server.stop(),this.server=null)}async loadPluginData(){let e=await this.loadData();if(e){if(this.data=e,!this.data.sessions||this.data.sessions.length===0){let t={id:"session-migrated",name:"Migrated Session",sessionId:this.data.sessionId,serverSessionId:null,writingTask:null,createdAt:new Date,updatedAt:new Date,messages:[]};this.data.sessions=[t],this.data.currentSessionId=t.id}this.sessionManager.loadSessions(this.data.sessions,this.data.currentSessionId),this.sessionManager.onChange(()=>{this.saveSessions()}),console.log("OpenCodeChat: Loaded data, sessions:",this.data.sessions.length)}else console.log("OpenCodeChat: No saved data found, starting fresh"),this.sessionManager.onChange(()=>{this.saveSessions()})}async saveSessions(){let e=this.sessionManager.exportForSave();this.data.sessions=e.sessions,this.data.currentSessionId=e.currentSessionId,await this.saveData(this.data)}async updateSessionId(e){this.sessionManager.updateCliSessionId(e)}getSessionId(){return this.sessionManager.getCurrentCliSessionId()}clearChatHistory(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let i=t.view;i.clearHistory&&i.clearHistory()}}focusInput(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let i=t.view;i.focusInput&&i.focusInput()}}stopGeneration(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let i=t.view;i.handleStop&&i.handleStop()}}startNewSession(){let e=this.sessionManager.createSession(`Session ${this.sessionManager.getSessions().length+1}`),{workspace:t}=this.app,i=t.getLeavesOfType(v)[0];if(i){let n=i.view;n.loadSession&&n.loadSession(e.id)}}async exportConversation(){let{workspace:e}=this.app,t=e.getLeavesOfType(v)[0];if(t){let i=t.view;i.exportConversation&&await i.exportConversation()}}getVaultPath(){return this.app.vault.adapter.basePath||""}syncBundledSkillsToVault(){let e=this.getVaultPath();if(!e)return;let t=(0,E.join)(e,".obsidian","plugins",this.manifest.id),i=(0,E.join)(t,"opencode-skills");if(!(0,w.existsSync)(i))return;let n=(0,E.join)(e,".opencode","skills");(0,w.mkdirSync)(n,{recursive:!0});let o=(0,w.readdirSync)(i,{withFileTypes:!0});for(let a of o){if(!a.isDirectory())continue;let r=(0,E.join)(i,a.name),l=(0,E.join)(r,"SKILL.md");if(!(0,w.existsSync)(l))continue;let c=(0,E.join)(n,a.name);this.copyDirectoryRecursive(r,c)}}copyDirectoryRecursive(e,t){(0,w.mkdirSync)(t,{recursive:!0});let i=(0,w.readdirSync)(e,{withFileTypes:!0});for(let n of i){let o=(0,E.join)(e,n.name),a=(0,E.join)(t,n.name);if(n.isDirectory()){this.copyDirectoryRecursive(o,a);continue}n.isFile()&&(0,w.copyFileSync)(o,a)}}};
