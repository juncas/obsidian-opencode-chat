# 写作工作流 — 使用指南

写作工作流将聊天面板升级为结构化写作助手，以你的 Obsidian 仓库（Vault）作为证据库。它提供从调研到发布的六阶段流水线、自动引用追踪，以及知识库健康审计功能。

---

## 目录

- [快速开始](#快速开始)
- [命令参考](#命令参考)
  - [`/write` — 六阶段写作流水线](#write--六阶段写作流水线)
  - [`/kb audit` — 知识库健康检查](#kb-audit--知识库健康检查)
  - [`/qa` — 基于证据的问答](#qa--基于证据的问答)
- [上下文捆绑](#上下文捆绑)
- [写作任务面板](#写作任务面板)
  - [阶段导航](#阶段导航)
  - [行内元数据编辑](#行内元数据编辑)
  - [阶段历史时间线](#阶段历史时间线)
  - [引用覆盖率指标](#引用覆盖率指标)
  - [草稿版本管理](#草稿版本管理)
- [引用质量系统](#引用质量系统)
- [使用技巧与最佳实践](#使用技巧与最佳实践)

---

## 快速开始

1. 在 Obsidian 中打开插件的聊天面板。
2. 输入 `/write start 我的文章主题` 并按回车。
3. 助手进入**调研（Discover）**阶段——明确范围、受众、约束条件，并识别笔记中的证据缺口。
4. 依次推进各阶段（`/write outline`、`/write draft`、……），或直接点击写作任务面板中的阶段按钮。
5. 随时使用 `@文件名` 将特定笔记引入上下文。

---

## 命令参考

### `/write` — 六阶段写作流水线

每个阶段都建立在前一阶段的基础上。你可以跳转到任意阶段，但建议按顺序推进。

| 命令 | 阶段 | 功能说明 |
|------|------|----------|
| `/write start <主题>` | **调研（Discover）** | 创建（或重置）写作任务。明确范围、受众、约束条件，并在开始写作前识别缺失的证据。 |
| `/write outline [额外要求]` | **大纲（Outline）** | 生成与证据关联的结构化大纲，规划读者阅读流程。可附加额外要求来引导结构。 |
| `/write draft [额外要求]` | **草稿（Draft）** | 基于已有笔记撰写完整草稿，附带明确的引用标注。系统自动保存草稿版本快照。 |
| `/write evidence [问题]` | **论证（Evidence）** | 审计每个关键论断的来源覆盖率和置信度。可传入特定问题来聚焦审计范围。 |
| `/write polish [风格提示]` | **润色（Polish）** | 提升可读性、连贯性和风格，同时保留事实依据。系统自动保存草稿版本快照。 |
| `/write publish [备注]` | **发布（Publish）** | 打包最终输出，生成元数据和操作清单，准备发布到仓库。系统自动保存草稿版本快照。 |

**示例：**

```
/write start 分布式共识算法
/write outline 重点对比 Raft 和 Paxos
/write draft 控制在 3000 字以内
/write evidence 性能相关的论断是否都有来源？
/write polish 语气更口语化一些
/write publish 发布到 knowledge-base/distributed-systems/
```

每个阶段的回复都包含对仓库笔记的明确来源引用。缺失的证据会被标记，**绝不捏造**。

### `/kb audit` — 知识库健康检查

对仓库进行健康审计，发现结构性问题。**系统会使用 Obsidian 元数据缓存进行快速全量分析，生成一份详细的自动化报告供助手分析。**

```
/kb audit [范围] [约束条件]
```

| 范围 | 检查内容 |
|------|----------|
| `full` | 以下所有检查的合集（默认） |
| `broken` | 断链——`[[引用]]` 指向不存在的笔记 |
| `orphan` | 孤立笔记——没有被其他笔记链接引用的文件 |
| `duplicate` | 重复或近似重复的内容 |
| `stale` | 过时笔记——长时间未更新的文件 |

**示例：**

```
/kb audit full
/kb audit broken
/kb audit orphan 在 projects/ 目录下
/kb audit stale 超过 6 个月未更新的笔记
```

### `/qa` — 基于证据的问答

提出问题，获得基于仓库内容的回答，附带引用来源。**系统会自动根据问题关键词检索仓库中相关的笔记（基于标题匹配），增强回答的上下文。**

```
/qa <问题>
```

**示例：**

```
/qa Raft 和 Paxos 各有什么优缺点？
/qa 总结一下我关于 React Server Components 的笔记
```

回复会引用具体的仓库笔记作为来源。如果仓库中没有足够的证据，回答会明确指出。

---

## 上下文捆绑

工作流会自动从多个来源捆绑上下文，为助手提供最佳的事实基础：

| 来源 | 工作方式 |
|------|----------|
| **当前文件** | 编辑器中正在打开的笔记会自动包含在内。 |
| **编辑器选区** | 如果在执行命令前选中了文本，则只发送选中部分（而非整个文件）。 |
| **`@` 提及** | 在命令中输入 `@文件名` 来将特定笔记固定到上下文中。支持多个提及。 |
| **最近文件** | 最多包含 5 个最近更新的笔记，提供更广泛的上下文。 |

**提示：**

- 使用 `@` 提及来引导助手关注当前阶段最相关的笔记。
- 选区上下文适用于让助手处理某个特定段落。
- 所有工作流命令都可以与普通聊天输入组合使用——你可以在命令后面添加自由文本指令。

---

## 写作任务面板

当写作任务处于活动状态时，聊天输入框上方会出现一个专用面板，显示任务状态、元数据和控制按钮。

### 阶段导航

面板按顺序显示六个阶段按钮：**调研 → 大纲 → 草稿 → 论证 → 润色 → 发布**。

- **当前阶段**会高亮显示。
- **已完成的阶段**有独特的视觉样式。
- 点击任意阶段按钮可直接跳转到该阶段（会自动发送对应的 `/write` 命令）。

### 行内元数据编辑

面板中显示三个可直接编辑的元数据字段：

| 字段 | 用途 | 编辑方式 |
|------|------|----------|
| **受众（Audience）** | 文章的目标读者 | 点击字段值进行行内编辑，按回车或点击其他区域保存 |
| **语气（Tone）** | 写作风格（如：正式、口语化、技术性） | 同上 |
| **目标长度（Target Length）** | 期望的字数或篇幅描述 | 同上 |

这些值会包含在每个阶段发送给助手的上下文中，帮助助手调整输出风格。

### 阶段历史时间线

面板显示所有阶段转换的时间线：

- 每条记录显示**阶段名称**和**时间戳**。
- 提供写作任务推进过程的清晰审计轨迹。
- 历史记录跨会话持久保存——关闭并重新打开 Obsidian 后，历史记录仍然保留。

### 引用覆盖率指标

在产出书面内容的阶段（草稿、论证、润色、发布）之后，会出现引用覆盖率进度条：

| 覆盖率 | 颜色 | 含义 |
|--------|------|------|
| ≥ 80% | 🟢 绿色 | 强——大多数论断都有仓库来源支撑 |
| ≥ 50% | 🟡 黄色 | 中等——部分论断需要补充来源 |
| < 50% | 🔴 红色 | 弱——证据存在明显缺口 |

进度条显示精确百分比，并在每个相关阶段后自动更新。

### 草稿版本管理

草稿快照在三个阶段自动捕获：**草稿**、**润色**和**发布**。

- 每个版本记录**阶段**、**时间戳**和**完整内容**。
- 历史版本在面板中列出，方便查阅。
- 你可以对比不同迭代的差异，如果润色或发布阶段改动了你想保留的内容，可以回滚到之前的版本。

#### 版本对比

每个非当前版本旁边会显示 **Compare** 按钮。点击后，系统会在聊天区域中以 unified diff 格式展示该版本与当前版本之间的差异：

- 绿色 (`+`) 行表示当前版本新增的内容。
- 红色 (`-`) 行表示当前版本删除的内容。
- 灰色行是未变动的上下文。

如果两个版本内容完全相同，系统会提示"内容相同"。

#### 版本回滚

每个非当前版本旁边也有 **Rollback** 按钮。点击后，当前草稿基线切换回该版本，同时写作阶段回退到该版本对应的阶段。

---

### 发布助手（Publish Assistant）

当你执行 `/write publish` 时，系统会自动收集仓库元数据，注入到发布阶段的提示词中，帮助助手生成更贴合你仓库结构的发布建议。

自动收集的仓库元数据包括：

| 元数据 | 说明 |
|--------|------|
| **文件夹结构** | 仓库中前两层的目录结构（最多 40 个），用于建议合适的文件存放路径。 |
| **标签体系** | 仓库中使用频率最高的标签（最多 50 个），包括 frontmatter 标签和行内标签。助手优先复用已有标签，只在确实没有合适标签时才建议新标签。 |
| **最近笔记路径** | 最近更新的 10 篇笔记的路径，用于参考命名模式。 |

发布阶段的输出合约要求助手提供：

- 完整的 **YAML frontmatter** 块（`title`、`date`、`tags`、`summary`、`author`）
- 基于仓库标签体系的**标签建议**
- 匹配仓库目录结构的**文件路径建议**
- 发布前的**操作清单**（引用验证、链接验证、格式审查、frontmatter 完整性检查）

---

## 引用质量系统

引用系统在后台工作，确保写作的可信度：

1. **论断检测**——在产出内容的阶段之后，系统扫描输出，识别关键的事实性论断。
2. **来源匹配**——将每个论断与上下文中的仓库笔记进行比对。
3. **覆盖率评分**——计算百分比：有引用的论断 ÷ 总论断数。
4. **未引用论断报告**——没有来源支撑的论断会被明确标记，让你知道哪些内容还需要补充证据。

该系统执行核心规则：**缺失的证据会被标记，绝不捏造。**

---

## 使用技巧与最佳实践

1. **先充实仓库。** 写作工作流在你的仓库中已经包含研究笔记、参考资料和原始素材时最为强大。

2. **大量使用 `@` 提及。** 助手只能引用它能看到的内容。用 `@` 将最重要的来源笔记固定到上下文中。

3. **不要跳过调研阶段。** 调研阶段能尽早发现证据缺口——在起草之前找到缺失的证据，比起草之后再找要高效得多。

4. **在草稿之后运行论证。** 论证审计在你有了具体草稿之后最为有用。它会准确告诉你哪些论断缺乏来源支撑。

5. **谨慎迭代润色。** 每次润色都会捕获快照，所以你可以随时对比。如果语气偏离了预期，试试给出更具体的风格提示：`/write polish 更直接，减少模糊表达`。

6. **定期使用知识库审计。** 定期运行 `/kb audit full` 保持仓库健康——断链和孤立笔记会降低助手找到相关上下文的能力。

7. **命令与自由文本组合使用。** 命令是可组合的：`/write draft 重点写安全性影响，引言部分简短一些` 完全可以正常工作。

8. **关注引用覆盖率。** 如果起草后进度条是黄色或红色，运行 `/write evidence` 获取详细报告，然后在润色之前向仓库补充来源笔记。
