# 用户指南

本指南详细介绍 OpenCode Chat for Obsidian 插件的所有功能和使用技巧。

## 📖 目录

1. [快速开始](#快速开始)
2. [基本聊天功能](#基本聊天功能)
3. [命令系统](#命令系统)
4. [@提及语法](#提及语法)
5. [写作工作流](#写作工作流)
6. [知识库工具](#知识库工具)
7. [导出功能](#导出功能)
8. [会话管理](#会话管理)
9. [快捷键](#快捷键)
10. [常见问题](#常见问题)

---

## 快速开始

### 1. 安装插件

```bash
# 从 Obsidian 社区插件商店安装
设置 → 第三方插件 → 浏览 → 搜索 "OpenCode Chat" → 安装
```

### 2. 配置 OpenCode

确保已安装 OpenCode CLI：
```bash
# 验证安装
opencode --version
```

### 3. 打开聊天面板

- 点击左侧 Ribbon 图标
- 或使用命令面板：`Cmd/Ctrl + P` → "OpenCode Chat: Open panel"

### 4. 发送第一条消息

在输入框中输入问题，按 `Enter` 发送。

---

## 基本聊天功能

### 发送消息

```
┌─────────────────────────────────────┐
│  [Session 1]  [Session 2]  [+]     │  ← 会话标签
├─────────────────────────────────────┤
│                                     │
│  👤 你好，帮我解释一下这个代码      │  ← 用户消息
│                                     │
│  🤖 当然可以！这是...              │  ← AI 响应（流式输出）
│     第一段内容...                   │
│     第二段内容...                   │
│                                     │
├─────────────────────────────────────┤
│  [输入消息...]                    │  ← 输入框
│  [发送]                            │
└─────────────────────────────────────┘
```

### 编辑消息

点击已发送的消息，可以编辑内容并重新发送。

### 导出对话

```bash
# 快捷键
Ctrl + Shift + E

# 或右键菜单
右键点击会话 → "导出对话"
```

### 流式响应

AI 响应会逐字显示，无需等待完整响应。

---

## 命令系统

### 命令列表

| 命令 | 描述 | 示例 |
|------|------|------|
| `/write` | 写作工作流 | `/write start 主题` |
| `/kb` | 知识库工具 | `/kb audit` |
| `/qa` | 证据检索 | `/qa 如何配置插件` |

### 使用方式

```
/命令名 [参数]
```

按 `Tab` 键可以自动补全命令。

---

## @提及语法

### 基本语法

在输入框中使用 `@` 提及文件，将其作为上下文发送给 AI：

```
@文件名 请帮我分析这个文件的内容
```

### 自动补全

输入 `@` 后会显示文件列表供选择：

```
@  # 输入 @ 后显示
├─ 📄 file1.md
├─ 📄 file2.md
├─ 📁 folder1/
└─ 📄 file3.md
```

### 上下文捆绑优先级

当发送消息时，插件会自动捆绑以下上下文（按优先级）：

```
1. 当前打开文件 (active)
    │
2. @提及的文件 (mention)
    │
3. 编辑器选中的文本 (selection)
    │
4. 最近修改的文件 (recent, 最多 5 个)
    │
5. 搜索相关的文件 (search, 基于关键词)
```

### 示例

````markdown
# 场景 1: 分析当前文件
@当前文件 这段代码有什么问题？

# 场景 2: 比较两个文件
@file1.md @file2.md 这两个文件有什么区别？

# 场景 3: 基于选中内容提问
[选中一段代码]
这段代码如何优化？
````

---

## 写作工作流

### 六阶段概览

```
调研 (Discover) → 大纲 (Outline) → 草稿 (Draft)
                                              ↓
发布 (Publish) ← 润色 (Polish) ← 论证 (Evidence)
```

### 阶段详解

#### 1. 调研阶段 (Discover)

```bash
/write start <主题>
```

**功能**:
- 创建写作任务
- 捆绑相关上下文
- AI 帮助收集背景信息

**输出示例**:
```
📝 写作任务已创建

主题：如何在 Obsidian 中管理知识
阶段：调研

当前打开的文件：
- knowledge-management.md

最近修改的文件：
- zettelkasten.md
- linking-thinking.md
```

#### 2. 大纲阶段 (Outline)

```bash
/write outline [要求]
```

**功能**:
- 生成结构化大纲
- 关联证据到大纲条目

**示例**:
```bash
/write outline 要求包含实践案例
```

#### 3. 草稿阶段 (Draft)

```bash
/write draft [要求]
```

**功能**:
- 根据大纲撰写初稿
- 自动创建草稿版本快照
- 引用标注提示

#### 4. 论证阶段 (Evidence)

```bash
/write evidence [问题]
```

**功能**:
- 检索知识库中的证据
- 计算引用覆盖率
- 标记未引用的论断

**输出示例**:
```
📊 引用覆盖率：75%

已引用论断：15/20
未引用论断：
- "知识管理需要系统化方法"（第 3 段）
- "双向链接是核心功能"（第 7 段）
```

#### 5. 润色阶段 (Polish)

```bash
/write polish [风格提示]
```

**功能**:
- 调整语气和风格
- 优化表达
- 创建新版本快照

#### 6. 发布阶段 (Publish)

```bash
/write publish [备注]
```

**功能**:
- 生成 YAML frontmatter
- 建议标签体系
- 推荐文件夹分类

### 任务面板

```
┌─────────────────────────────────────┐
│ 📝 写作任务：如何在 Obsidian 中管理知识 │
├─────────────────────────────────────┤
│ 阶段：[大纲] → [草稿] → [论证] → ... │  ← 阶段导航
├─────────────────────────────────────┤
│ 受众：[开发者]  语气：[专业]  长度：[中]│  ← 元数据
├─────────────────────────────────────┤
│ 📚 草稿版本                          │
│  - draft v1 (2026-02-19 10:30)      │
│  - polish v1 (2026-02-19 11:45)     │  ← 版本历史
└─────────────────────────────────────┘
```

### 阶段跳转

可以直接跳转到任意阶段：

```bash
# 从任意阶段跳转到草稿
/write draft 继续之前的内容
```

---

## 知识库工具

### KB 健康审计

```bash
/kb audit [范围] [约束]
```

**功能**:
- 检测断链（`[[unresolved]]`）
- 检测孤儿笔记（无入链）
- 检测陈旧笔记（超过 90 天未修改）
- 生成优先级报告

**输出示例**:
```
📊 KB 健康审计报告

🔴 高优先级
- 断链：15 个
  - [[未创建的笔记 1]]
  - [[未创建的笔记 2]]

🟡 中优先级
- 孤儿笔记：8 个
  - old-note-2023.md
  - unused-draft.md

🟢 低优先级
- 陈旧笔记：23 个（>90 天未修改）
```

### 证据检索 (QA)

```bash
/qa <问题>
```

**功能**:
- 检索相关知识库内容
- 回答附带引用
- 显示引用来源

**输出示例**:
```
根据知识库内容，Obsidian 的核心功能包括：

1. **双向链接** - 支持 [[wiki-link]] 语法 [来源：links.md]
2. **图谱视图** - 可视化知识网络 [来源：graph-view.md]
3. **插件系统** - 支持社区插件 [来源：plugins.md]
```

### 引用覆盖率

在写作工作流中，自动显示引用覆盖率：

```
📊 引用覆盖率：85% ████████████████░░
```

---

## 导出功能

### Markdown 导出

```bash
# 快捷键
Ctrl + Shift + E
```

导出当前会话为 Markdown 文件。

### 微信导出

**入口**:
- Writing Workflows 菜单 → "导出为微信文章"
- 右键 markdown 文件 → "导出为微信"

**步骤**:
1. 选择样式模板（5 种可选）
2. 预览效果
3. 复制 HTML 到剪贴板
4. 粘贴到微信编辑器

**样式模板**:
| 样式 | 适用场景 |
|------|---------|
| 简洁风格 | 通用文章 |
| 技术文章 | 代码教程 |
| 文艺风格 | 散文随笔 |
| 商务风格 | 报告文档 |
| 活泼风格 | 营销文案 |

---

## 会话管理

### 创建会话

```
┌─────────────────────────────────┐
│  [Session 1]  [Session 2]  [+] │  ← 点击 [+] 创建新会话
└─────────────────────────────────┘
```

### 切换会话

点击会话标签即可切换。

### 重命名会话

双击会话标签，输入新名称。

### 删除会话

右键点击会话标签 → "删除会话"。

### 会话持久化

会话数据自动保存到 `data.json`，重启 Obsidian 后自动恢复。

---

## 快捷键

| 快捷键 | 功能 | 平台 |
|--------|------|------|
| `Cmd/Ctrl + P` | 打开命令面板 | 全部 |
| `Cmd/Ctrl + Shift + E` | 导出对话 | 全部 |
| `Enter` | 发送消息 | 全部 |
| `Shift + Enter` | 换行 | 全部 |
| `Tab` | 命令补全 | 全部 |
| `Esc` | 关闭面板 | 全部 |

### 自定义快捷键

在 Obsidian 设置中配置：
```
设置 → 快捷键 → OpenCode Chat
```

---

## 常见问题

### Q1: 找不到 OpenCode CLI

**症状**: 提示 "Cannot find opencode command"

**解决**:
```bash
# 验证安装
opencode --version

# 检查 PATH
echo $PATH | grep -o '\.opencode/bin'

# 重新安装 OpenCode
# 参考 https://opencode.ai 安装指南
```

### Q2: SSE 连接断开

**症状**: AI 响应中断，无法继续

**解决**:
- 自动重连（最多 5 次）
- 如仍失败，重启 OpenCode Server：
  ```bash
  # 终止现有进程
  pkill -f "opencode serve"

  # 重新发送消息，自动启动新服务
  ```

### Q3: 端口冲突

**症状**: "Port 14000 already in use"

**解决**:
- 自动故障转移到 14001-14004
- 或手动指定端口（在设置中配置）

### Q4: 引用覆盖率低

**症状**: 写作时引用覆盖率低于 50%

**解决**:
1. 使用 `/qa` 检索更多证据
2. 手动添加引用 `[[笔记名]]`
3. 检查论断是否过于宽泛

### Q5: 微信导出图片无法显示

**症状**: 导出的 HTML 中图片无法显示

**解决**:
- 使用绝对路径
- 或将图片上传到图床
- 或使用 base64 嵌入（导出设置中启用）

---

## 进阶技巧

### 1. 上下文优化

**技巧**: 使用 `@` 精确控制上下文

```markdown
# 好：精确指定文件
@architecture.md 解释这个设计模式

# 避免：依赖自动捆绑（可能包含不相关文件）
这个设计模式怎么用？
```

### 2. 阶段快速跳转

**技巧**: 在任意阶段输入下一阶段命令

```bash
# 在大纲阶段直接开始草稿
/write draft 基于当前大纲
```

### 3. 批量 KB 审计

**技巧**: 定期运行 KB 审计

```bash
# 每周审计
/kb audit --scope=all
```

### 4. 导出格式化

**技巧**: 自定义导出格式

在设置中配置导出模板，添加个人品牌元素。

---

## 支持与反馈

### 获取帮助

- [GitHub Issues](https://github.com/your-repo/obsidian-claude-chat/issues)
- [贡献指南](./CONTRIBUTING.md)
- [故障排查](./troubleshooting.md)

### 报告问题

请参考 [CONTRIBUTING.md](./CONTRIBUTING.md) 中的 Bug 报告模板。

### 功能建议

欢迎在 Issues 中提交功能请求，描述使用场景和期望行为。

---

*最后更新：2026-02-19*
